<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

    <title>CifFile.StarFile API documentation</title>
    <meta name="description" content="" />

  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
  
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}

  </style>

  <style type="text/css">
  
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  } 

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; } 

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;
      
      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/

  </style>

  <style type="text/css">
  .codehilite .hll { background-color: #ffffcc }
.codehilite  { background: #f8f8f8; }
.codehilite .c { color: #408080; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #BC7A00 } /* Comment.Preproc */
.codehilite .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #408080; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #408080; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #FF0000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #00A000 } /* Generic.Inserted */
.codehilite .go { color: #888888 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #7D9029 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #999999; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #A0A000 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mb { color: #666666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #BB6688 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #0000FF } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */
  </style>

  <style type="text/css">
  
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}

  </style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>

<div id="container">
    
  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">

    <li class="set"><h3><a href="#header-functions">Functions</a></h3>
      
  <ul>
    <li class="mono"><a href="#CifFile.StarFile.ReadStar">ReadStar</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-classes">Classes</a></h3>
      <ul>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.StarFile.BlockCollection">BlockCollection</a></span>
        
          
  <ul>
    <li class="mono"><a href="#CifFile.StarFile.BlockCollection.NewBlock">NewBlock</a></li>
    <li class="mono"><a href="#CifFile.StarFile.BlockCollection.SetTemplate">SetTemplate</a></li>
    <li class="mono"><a href="#CifFile.StarFile.BlockCollection.WriteOut">WriteOut</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.StarFile.CIFStringIO">CIFStringIO</a></span>
        
        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.StarFile.LoopBlock">LoopBlock</a></span>
        
          
  <ul>
    <li class="mono"><a href="#CifFile.StarFile.LoopBlock.AddPacket">AddPacket</a></li>
    <li class="mono"><a href="#CifFile.StarFile.LoopBlock.AddToLoop">AddToLoop</a></li>
    <li class="mono"><a href="#CifFile.StarFile.LoopBlock.ChangeItemOrder">ChangeItemOrder</a></li>
    <li class="mono"><a href="#CifFile.StarFile.LoopBlock.GetItemOrder">GetItemOrder</a></li>
    <li class="mono"><a href="#CifFile.StarFile.LoopBlock.GetItemPosition">GetItemPosition</a></li>
    <li class="mono"><a href="#CifFile.StarFile.LoopBlock.GetLoop">GetLoop</a></li>
    <li class="mono"><a href="#CifFile.StarFile.LoopBlock.GetLoopNames">GetLoopNames</a></li>
    <li class="mono"><a href="#CifFile.StarFile.LoopBlock.GetPacket">GetPacket</a></li>
    <li class="mono"><a href="#CifFile.StarFile.LoopBlock.RemoveItem">RemoveItem</a></li>
    <li class="mono"><a href="#CifFile.StarFile.LoopBlock.RemoveLoopItem">RemoveLoopItem</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.StarFile.StarBlock">StarBlock</a></span>
        
          
  <ul>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.AddItem">AddItem</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.AddLoopItem">AddLoopItem</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.AddLoopName">AddLoopName</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.AddToLoop">AddToLoop</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.ChangeItemOrder">ChangeItemOrder</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.CreateLoop">CreateLoop</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.FindLoop">FindLoop</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.GetCompoundKeyedPacket">GetCompoundKeyedPacket</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.GetFullItemValue">GetFullItemValue</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.GetItemOrder">GetItemOrder</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.GetItemPosition">GetItemPosition</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.GetItemValue">GetItemValue</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.GetKeyedPacket">GetKeyedPacket</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.GetKeyedSemanticPacket">GetKeyedSemanticPacket</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.GetLoop">GetLoop</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.GetLoopNames">GetLoopNames</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.GetMultiKeyedSemanticPacket">GetMultiKeyedSemanticPacket</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.RemoveItem">RemoveItem</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.RemoveKeyedPacket">RemoveKeyedPacket</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.RemoveLoopItem">RemoveLoopItem</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarBlock.SetOutputLength">SetOutputLength</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.StarFile.StarDerivationError">StarDerivationError</a></span>
        
        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.StarFile.StarDerivationFailure">StarDerivationFailure</a></span>
        
        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.StarFile.StarDict">StarDict</a></span>
        
        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.StarFile.StarError">StarError</a></span>
        
        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.StarFile.StarFile">StarFile</a></span>
        
          
  <ul>
    <li class="mono"><a href="#CifFile.StarFile.StarFile.NewBlock">NewBlock</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarFile.SetTemplate">SetTemplate</a></li>
    <li class="mono"><a href="#CifFile.StarFile.StarFile.WriteOut">WriteOut</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.StarFile.StarLengthError">StarLengthError</a></span>
        
        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.StarFile.StarList">StarList</a></span>
        
        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.StarFile.StarPacket">StarPacket</a></span>
        
        </li>
      </ul>
    </li>

    </ul>
  </div>

    <article id="content">
      
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">CifFile.StarFile</span> module</h1>
  
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile" class="source">
    <div class="codehilite"><pre><span></span><span class="c1"># To maximize python3/python2 compatibility</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="n">__copyright</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">PYCIFRW License Agreement (Python License, Version 2)</span>
<span class="s2">-----------------------------------------------------</span>

<span class="s2">1. This LICENSE AGREEMENT is between the Australian Nuclear Science</span>
<span class="s2">and Technology Organisation (&quot;ANSTO&quot;), and the Individual or</span>
<span class="s2">Organization (&quot;Licensee&quot;) accessing and otherwise using this software</span>
<span class="s2">(&quot;PyCIFRW&quot;) in source or binary form and its associated documentation.</span>

<span class="s2">2. Subject to the terms and conditions of this License Agreement,</span>
<span class="s2">ANSTO hereby grants Licensee a nonexclusive, royalty-free, world-wide</span>
<span class="s2">license to reproduce, analyze, test, perform and/or display publicly,</span>
<span class="s2">prepare derivative works, distribute, and otherwise use PyCIFRW alone</span>
<span class="s2">or in any derivative version, provided, however, that this License</span>
<span class="s2">Agreement and ANSTO&#39;s notice of copyright, i.e., &quot;Copyright (c)</span>
<span class="s2">2001-2014 ANSTO; All Rights Reserved&quot; are retained in PyCIFRW alone or</span>
<span class="s2">in any derivative version prepared by Licensee.</span>

<span class="s2">3. In the event Licensee prepares a derivative work that is based on</span>
<span class="s2">or incorporates PyCIFRW or any part thereof, and wants to make the</span>
<span class="s2">derivative work available to others as provided herein, then Licensee</span>
<span class="s2">hereby agrees to include in any such work a brief summary of the</span>
<span class="s2">changes made to PyCIFRW.</span>

<span class="s2">4. ANSTO is making PyCIFRW available to Licensee on an &quot;AS IS&quot;</span>
<span class="s2">basis. ANSTO MAKES NO REPRESENTATIONS OR WARRANTIES, EXPRESS OR</span>
<span class="s2">IMPLIED. BY WAY OF EXAMPLE, BUT NOT LIMITATION, ANSTO MAKES NO AND</span>
<span class="s2">DISCLAIMS ANY REPRESENTATION OR WARRANTY OF MERCHANTABILITY OR FITNESS</span>
<span class="s2">FOR ANY PARTICULAR PURPOSE OR THAT THE USE OF PYCIFRW WILL NOT</span>
<span class="s2">INFRINGE ANY THIRD PARTY RIGHTS.</span>

<span class="s2">5. ANSTO SHALL NOT BE LIABLE TO LICENSEE OR ANY OTHER USERS OF PYCIFRW</span>
<span class="s2">FOR ANY INCIDENTAL, SPECIAL, OR CONSEQUENTIAL DAMAGES OR LOSS AS A</span>
<span class="s2">RESULT OF MODIFYING, DISTRIBUTING, OR OTHERWISE USING PYCIFRW, OR ANY</span>
<span class="s2">DERIVATIVE THEREOF, EVEN IF ADVISED OF THE POSSIBILITY THEREOF.</span>

<span class="s2">6. This License Agreement will automatically terminate upon a material</span>
<span class="s2">breach of its terms and conditions.</span>

<span class="s2">7. Nothing in this License Agreement shall be deemed to create any</span>
<span class="s2">relationship of agency, partnership, or joint venture between ANSTO</span>
<span class="s2">and Licensee. This License Agreement does not grant permission to use</span>
<span class="s2">ANSTO trademarks or trade name in a trademark sense to endorse or</span>
<span class="s2">promote products or services of Licensee, or any third party.</span>

<span class="s2">8. By copying, installing or otherwise using PyCIFRW, Licensee agrees</span>
<span class="s2">to be bound by the terms and conditions of this License Agreement.</span>

<span class="s2">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># Python 2,3 compatibility</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">urlopen</span>         <span class="c1"># for arbitrary opening</span>
    <span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">urlunparse</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
    <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span><span class="p">,</span><span class="n">urlunparse</span>
<span class="kn">import</span> <span class="nn">re</span><span class="o">,</span><span class="nn">os</span>
<span class="kn">import</span> <span class="nn">textwrap</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span> <span class="c1">#not cStringIO as we cannot subclass</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;abc&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>   <span class="c1">#Python 3</span>
    <span class="nb">unicode</span> <span class="o">=</span> <span class="nb">str</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">numpy</span>
    <span class="n">have_numpy</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">have_numpy</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">StarList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">slice</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">StarList</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>   <span class="c1">#extended comma notation</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">StarList</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">StarList</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;SL(&quot;</span><span class="o">+</span><span class="nb">super</span><span class="p">(</span><span class="n">StarList</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>

<span class="k">class</span> <span class="nc">StarDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">LoopBlock</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent_block</span><span class="p">,</span><span class="n">dataname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span> <span class="o">=</span> <span class="n">parent_block</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not in a loop structure&#39;</span> <span class="o">%</span> <span class="n">dataname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span> <span class="o">=</span> <span class="n">parent_block</span>

    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

    <span class="c1">#Avoid iterator even though that is Python3-esque</span>
    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataname</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>   <span class="c1">#a packet request</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetPacket</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dataname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not in loop block&#39;</span> <span class="o">%</span> <span class="n">dataname</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">AddLoopName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">dataname</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">has_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">packet_list</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">packet_list</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">names</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="n">r</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
            <span class="k">yield</span> <span class="n">r</span>

    <span class="c1"># for compatibility</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attname</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="p">,</span><span class="n">attname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">coords</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>        <span class="c1">#to create packet index</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">popout</span><span class="p">:</span>
            <span class="c1"># ok, we have a new packet:  append a list to our subloops</span>
            <span class="k">for</span> <span class="n">aloop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
                <span class="n">aloop</span><span class="o">.</span><span class="n">new_enclosing_packet</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">iname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iname</span><span class="p">,</span><span class="n">LoopBlock</span><span class="p">):</span>       <span class="c1">#into a nested loop</span>
                    <span class="k">for</span> <span class="n">subitems</span> <span class="ow">in</span> <span class="n">iname</span><span class="o">.</span><span class="n">load_iter</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="o">+</span><span class="p">[</span><span class="n">count</span><span class="p">]):</span>
                        <span class="c1"># print &#39;Yielding %s&#39; % `subitems`</span>
                        <span class="k">yield</span> <span class="n">subitems</span>
                    <span class="c1"># print &#39;End of internal loop&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># print &#39;Yielding %s&#39; % `self[iname]`</span>
                        <span class="k">yield</span> <span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="n">iname</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">backval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">iname</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)):</span>
                           <span class="c1"># print &#39;backval, coords: %s, %s&#39; % (`backval`,`coords`)</span>
                           <span class="n">backval</span> <span class="o">=</span> <span class="n">backval</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                        <span class="k">yield</span> <span class="bp">self</span><span class="p">,</span><span class="n">backval</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>      <span class="c1"># count packets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">popout</span> <span class="o">=</span> <span class="bp">False</span>        <span class="c1"># reinitialise</span>
        <span class="c1"># print &#39;Finished iterating&#39;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="p">,</span><span class="s1">&#39;###Blank###&#39;</span>     <span class="c1">#this value should never be used</span>

    <span class="c1"># an experimental fast iterator for level-1 loops (ie CIF)</span>
    <span class="k">def</span> <span class="nf">fast_load_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">targets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="p">,</span><span class="n">target</span>

    <span class="c1"># Add another list of the required shape to take into account a new outer packet</span>
    <span class="k">def</span> <span class="nf">new_enclosing_packet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>      <span class="c1">#otherwise have a top-level list</span>
            <span class="k">for</span> <span class="n">iname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1">#includes lower levels</span>
                <span class="n">target_list</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">iname</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">):</span> <span class="c1">#dim 2 upwards are lists of lists of...</span>
                    <span class="n">target_list</span> <span class="o">=</span> <span class="n">target_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">target_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="c1"># print &#39;%s now %s&#39; % (iname,`self[iname]`)</span>

    <span class="k">def</span> <span class="nf">recursive_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dict_so_far</span><span class="o">=</span><span class="p">{},</span><span class="n">coord</span><span class="o">=</span><span class="p">[]):</span>
        <span class="c1"># print &quot;Recursive iter: coord %s, keys %s, dim %d&quot; % (`coord`,`self.block.keys()`,self.dimension)</span>
        <span class="n">my_length</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">top_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="n">top_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>       <span class="c1">#same order as items</span>
        <span class="n">drill_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dimup</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">):</span>  <span class="c1">#look higher in the tree</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drill_values</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>            <span class="c1">#this block has values</span>
                <span class="n">drill_values</span><span class="o">=</span><span class="n">drill_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="c1">#drill in</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;Malformed loop packet </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">top_items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">))</span>
        <span class="n">my_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">drill_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>       <span class="c1">#length of &#39;string&#39; entry</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                <span class="c1">#top level</span>
            <span class="k">for</span> <span class="n">aloop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">apacket</span> <span class="ow">in</span> <span class="n">aloop</span><span class="o">.</span><span class="n">recursive_iter</span><span class="p">():</span>
                    <span class="c1"># print &quot;Recursive yielding %s&quot; % repr( dict(top_items + apacket.items()) )</span>
                    <span class="n">prep_yield</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">(</span><span class="n">top_values</span><span class="o">+</span><span class="n">apacket</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>  <span class="c1">#straight list</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">top_items</span> <span class="o">+</span> <span class="n">apacket</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">prep_yield</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">prep_yield</span>
        <span class="k">else</span><span class="p">:</span>                                  <span class="c1">#in some loop</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">my_length</span><span class="p">):</span>
                <span class="n">kvpairs</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:(</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_to_group</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">coord</span><span class="p">)[</span><span class="n">i</span><span class="p">]),</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">kvvals</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">kvpairs</span><span class="p">)</span>   <span class="c1">#just values</span>
                <span class="c1"># print &quot;Recursive kvpairs at %d: %s&quot; % (i,repr( kvpairs ))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
                  <span class="k">for</span> <span class="n">aloop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">apacket</span> <span class="ow">in</span> <span class="n">aloop</span><span class="o">.</span><span class="n">recursive_iter</span><span class="p">(</span><span class="n">coord</span><span class="o">=</span><span class="n">coord</span><span class="o">+</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        <span class="c1"># print &quot;Recursive yielding %s&quot; % repr( dict(kvpairs + apacket.items()) )</span>
                        <span class="n">prep_yield</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">(</span><span class="n">kvvals</span><span class="o">+</span><span class="n">apacket</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">kvpairs</span> <span class="o">+</span> <span class="n">apacket</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="n">prep_yield</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="n">prep_yield</span>
                <span class="k">else</span><span class="p">:</span>           <span class="c1"># we&#39;re at the bottom of the tree</span>
                    <span class="c1"># print &quot;Recursive yielding %s&quot; % repr( dict(kvpairs) )</span>
                    <span class="n">prep_yield</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">(</span><span class="n">kvvals</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">kvpairs</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">prep_yield</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">prep_yield</span>

    <span class="c1"># small function to use the coordinates.</span>
    <span class="k">def</span> <span class="nf">coord_to_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">coords</span><span class="p">):</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataname</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
             <span class="k">return</span> <span class="n">dataname</span>     <span class="c1"># flag inner loop processing</span>
          <span class="n">newm</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span>          <span class="c1"># newm must be a list or tuple</span>
          <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
              <span class="c1"># print &quot;Coord_to_group: %s -&gt;&quot; % (repr( newm )),</span>
              <span class="n">newm</span> <span class="o">=</span> <span class="n">newm</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
              <span class="c1"># print repr( newm )</span>
          <span class="k">return</span> <span class="n">newm</span>

    <span class="k">def</span> <span class="nf">flat_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">my_length</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">top_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_keys</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">my_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">top_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">pack_no</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">my_length</span><span class="p">):</span>
                <span class="k">yield</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collapse</span><span class="p">(</span><span class="n">pack_no</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">RemoveItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove `itemname` from the block.&quot;&quot;&quot;</span>
        <span class="c1"># first check any loops</span>
        <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>
        <span class="n">testkey</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">testkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
            <span class="c1"># now remove from loop</span>
            <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">loop_no</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1">#will appear in order list</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">RemoveLoopItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `RemoveItem` instead&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RemoveItem</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GetLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a `StarFile.LoopBlock` object constructed from the loop containing `keyname`.</span>
<span class="sd">        `keyname` is only significant as a way to specify the loop.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">LoopBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GetPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>
        <span class="n">thispack</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">myitem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]:</span>
            <span class="n">thispack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">myitem</span><span class="p">][</span><span class="n">index</span><span class="p">])</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">thispack</span><span class="p">,</span><span class="n">myitem</span><span class="p">,</span><span class="n">thispack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">thispack</span>

    <span class="k">def</span> <span class="nf">AddPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">packet</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">myitem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]:</span>
            <span class="n">old_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="p">[</span><span class="n">myitem</span><span class="p">]</span>
            <span class="n">old_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">myitem</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="p">[</span><span class="n">myitem</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_values</span>

    <span class="k">def</span> <span class="nf">GetItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of datanames in this `LoopBlock` in the order that they will be</span>
<span class="sd">        printed&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">][:]</span>


    <span class="k">def</span> <span class="nf">ChangeItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">,</span><span class="n">newpos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change the position at which `itemname` appears when printing out to `newpos`.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">newpos</span><span class="p">,</span><span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">GetItemPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A utility function to get the numerical order in the printout</span>
<span class="sd">        of `itemname`.  An item has coordinate `(loop_no,pos)` with</span>
<span class="sd">        the top level having a `loop_no` of -1.  If an integer is passed to</span>
<span class="sd">        the routine then it will return the position of the loop</span>
<span class="sd">        referenced by that number.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemname</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
            <span class="c1"># return loop position</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">itemname</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">itemname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No such dataname </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">itemname</span><span class="p">)</span>
        <span class="n">testname</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">testname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">))</span>
        <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
        <span class="n">loop_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loop_no</span><span class="p">,</span><span class="n">loop_pos</span>

    <span class="k">def</span> <span class="nf">GetLoopNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keyname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">aloop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">aloop</span><span class="o">.</span><span class="n">GetLoopNames</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Item does not exist&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GetLoopNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all datanames appearing together with `keyname`&quot;&quot;&quot;</span>
        <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not in any loop&#39;</span> <span class="o">%</span> <span class="n">keyname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">):</span>
        <span class="n">thisloop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itemname</span><span class="p">,</span><span class="n">itemvalue</span> <span class="ow">in</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">thisloop</span><span class="p">[</span><span class="n">itemname</span><span class="p">]</span> <span class="o">=</span> <span class="n">itemvalue</span>

    <span class="k">def</span> <span class="nf">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` followed by calls to `AddLoopName`.</span>

<span class="sd">        Add multiple columns to the loop containing `dataname`. `loopdata` is a</span>
<span class="sd">        collection of (key,value) pairs, where `key` is the new dataname and `value`</span>
<span class="sd">        is a list of values for that dataname&quot;&quot;&quot;</span>
        <span class="c1"># check lengths</span>
        <span class="n">thisloop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
        <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">dataname</span><span class="p">])</span>
        <span class="n">bad_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">!=</span><span class="n">loop_len</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_vals</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
           <span class="k">raise</span> <span class="n">StarLengthError</span><span class="p">(</span><span class="s2">&quot;Number of values for looped datanames </span><span class="si">%s</span><span class="s2"> not equal to </span><span class="si">%d</span><span class="s2">&quot;</span> \
               <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">bad_vals</span> <span class="p">),</span><span class="n">loop_len</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loopdata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">thisloop</span><span class="p">]</span><span class="o">+=</span><span class="n">loopdata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">StarBlock</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span> <span class="o">=</span> <span class="p">(),</span> <span class="n">maxoutlength</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">wraplength</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">characterset</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span><span class="n">maxnamelength</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1">#the actual data storage (lower case keys)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1">#each loop is indexed by a number and contains a list of datanames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">#lower case, loops referenced by integer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#transform lower case to supplied case</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c1">#prefer string version always</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="bp">None</span>      <span class="c1">#DDLm dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">popout</span> <span class="o">=</span> <span class="bp">False</span>         <span class="c1">#used during load iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curitem</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>           <span class="c1">#used during iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_vals</span> <span class="o">=</span> <span class="bp">True</span>      <span class="c1">#store all calculated values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span> <span class="o">=</span> <span class="n">maxoutlength</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setmaxnamelength</span><span class="p">(</span><span class="n">maxnamelength</span><span class="p">)</span>  <span class="c1">#to enforce CIF limit of 75 characters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_characterset</span><span class="p">(</span><span class="n">characterset</span><span class="p">)</span>   <span class="c1">#to check input names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wraplength</span> <span class="o">=</span> <span class="n">wraplength</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="n">overwrite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">string_delimiters</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">;&quot;</span><span class="p">]</span>   <span class="c1">#universal CIF set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_delimiter</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>                 <span class="c1">#CIF2 default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">TextWrapper</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">StarBlock</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">item_order</span><span class="p">[:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">true_case</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># loops as well</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">setmaxnamelength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">maxlength</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the maximum allowable dataname length (-1 for no check)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxnamelength</span> <span class="o">=</span> <span class="n">maxlength</span>
        <span class="k">if</span> <span class="n">maxlength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bad_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">maxnamelength</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Datanames too long: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">bad_names</span> <span class="p">))</span>

    <span class="k">def</span> <span class="nf">set_characterset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">characterset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the characterset for checking datanames: may be `ascii` or `unicode`&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">characterset</span> <span class="o">=</span> <span class="n">characterset</span>
        <span class="k">if</span> <span class="n">characterset</span> <span class="o">==</span> <span class="s1">&#39;ascii&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">char_check</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;[][ </span><span class="se">\n\r\t</span><span class="s2">!%&amp;\(\)*+,./:&lt;=&gt;?@0-9A-Za-z</span><span class="se">\\\\</span><span class="s2">^`{}\|~</span><span class="se">\&quot;</span><span class="s2">#$&#39;;_-]+&quot;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">characterset</span> <span class="o">==</span> <span class="s1">&#39;unicode&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxunicode</span> <span class="o">&lt;</span> <span class="mi">1114111</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">char_check</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;[][ </span><span class="se">\n\r\t</span><span class="s2">!%&amp;\(\)*+,./:&lt;=&gt;?@0-9A-Za-z</span><span class="se">\\\\</span><span class="s2">^`{}\|~</span><span class="se">\&quot;</span><span class="s2">#$&#39;;_</span><span class="se">\u00A0</span><span class="s2">-</span><span class="se">\uD7FF\uE000</span><span class="s2">-</span><span class="se">\uFDCF\uFDF0</span><span class="s2">-</span><span class="se">\uFFFD</span><span class="s2">-]+&quot;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">char_check</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;[][ </span><span class="se">\n\r\t</span><span class="s2">!%&amp;\(\)*+,./:&lt;=&gt;?@0-9A-Za-z</span><span class="se">\\\\</span><span class="s2">^`{}\|~</span><span class="se">\&quot;</span><span class="s2">#$&#39;;_</span><span class="se">\u00A0</span><span class="s2">-</span><span class="se">\uD7FF\uE000</span><span class="s2">-</span><span class="se">\uFDCF\uFDF0</span><span class="s2">-</span><span class="se">\uFFFD\U00010000</span><span class="s2">-</span><span class="se">\U0010FFFD</span><span class="s2">-]+&quot;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">printsection</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;saves&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Setting the saves key is deprecated. Add the save block to</span>
<span class="s2">    an enclosing block collection (e.g. CIF or STAR file) with this block as child&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;saves&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;The saves key is deprecated. Access the save block from</span>
<span class="s2">    the enclosing block collection (e.g. CIF or STAR file object)&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
           <span class="n">rawitem</span><span class="p">,</span><span class="n">is_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetFullItemValue</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
           <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">:</span>
               <span class="c1"># send the dictionary the required key and a pointer to us</span>
               <span class="k">try</span><span class="p">:</span>
                   <span class="n">new_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">derive_item</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_vals</span><span class="p">,</span><span class="n">allow_defaults</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
               <span class="k">except</span> <span class="n">StarDerivationFailure</span><span class="p">:</span>   <span class="c1">#try now with defaults included</span>
                   <span class="k">try</span><span class="p">:</span>
                       <span class="n">new_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">derive_item</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_vals</span><span class="p">,</span><span class="n">allow_defaults</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                   <span class="k">except</span> <span class="n">StarDerivationFailure</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                       <span class="k">print</span><span class="p">(</span><span class="s2">&quot;In StarBlock.__getitem__, &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
                       <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No such item: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
               <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Set </span><span class="si">%s</span><span class="s1"> to derived value </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">new_value</span><span class="p">)))</span>
               <span class="k">return</span> <span class="n">new_value</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No such item: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="c1"># we now have an item, we can try to convert it to a number if that is appropriate</span>
        <span class="c1"># note numpy values are never stored but are converted to lists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">:</span> <span class="k">return</span> <span class="n">rawitem</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: is_value </span><span class="si">%s</span><span class="s1"> provide_value </span><span class="si">%s</span><span class="s1"> value </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span> <span class="n">is_value</span> <span class="p">),</span><span class="nb">repr</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="p">),</span><span class="nb">repr</span><span class="p">(</span> <span class="n">rawitem</span> <span class="p">)))</span>
        <span class="k">if</span> <span class="n">is_value</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span><span class="p">:</span> <span class="k">return</span> <span class="n">rawitem</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Turning </span><span class="si">%s</span><span class="s1"> into string&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">rawitem</span> <span class="p">))</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_to_string</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>    <span class="c1"># a string</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="ow">and</span> <span class="p">((</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rawitem</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rawitem</span> <span class="o">!=</span> <span class="s1">&#39;?&#39;</span> <span class="ow">and</span> <span class="n">rawitem</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="ow">or</span> \
                                      <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rawitem</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;?&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rawitem</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rawitem</span><span class="p">)):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">change_type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">rawitem</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span><span class="p">:</span> <span class="c1"># catch the question marks</span>
                <span class="n">do_calculate</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rawitem</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">known</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rawitem</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="s1">&#39;?&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">known</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>   <span class="c1">#all questions</span>
                        <span class="n">do_calculate</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">elif</span> <span class="n">rawitem</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
                        <span class="n">do_calculate</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">do_calculate</span><span class="p">:</span>
                   <span class="c1"># remove old value</span>
                   <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                   <span class="k">try</span><span class="p">:</span>
                       <span class="n">new_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">derive_item</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">allow_defaults</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                   <span class="k">except</span> <span class="n">StarDerivationFailure</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                       <span class="k">try</span><span class="p">:</span>
                           <span class="n">new_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">derive_item</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">allow_defaults</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                       <span class="k">except</span> <span class="n">StarDerivationFailure</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>

                           <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Could not turn </span><span class="si">%s</span><span class="s2"> into a value:&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
                           <span class="k">return</span> <span class="n">rawitem</span>
                   <span class="k">else</span><span class="p">:</span>
                       <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Set </span><span class="si">%s</span><span class="s1"> to derived value </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">new_value</span> <span class="p">)))</span>
                       <span class="k">return</span> <span class="n">new_value</span>
            <span class="k">return</span> <span class="n">rawitem</span>   <span class="c1">#can&#39;t do anything</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RemoveItem</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">blen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blen</span>

    <span class="k">def</span> <span class="fm">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="c1"># keys returns all internal keys</span>
    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>    <span class="c1">#always lower case</span>

    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">))</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">has_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">has_key_or_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if a dataname or alias is available in the block&quot;&quot;&quot;</span>
        <span class="n">initial_test</span> <span class="o">=</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">initial_test</span><span class="p">:</span> <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">:</span>
            <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">alias_table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,[])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aliases</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">default</span>
        <span class="k">return</span> <span class="n">retval</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># doesn&#39;t appear to work</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">newcopy</span> <span class="o">=</span> <span class="n">StarBlock</span><span class="p">()</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">loops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">item_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">[:]</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">true_case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">loops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1">#    return self.copy.im_class(newcopy)   #catch inheritance</span>
        <span class="k">return</span> <span class="n">newcopy</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">adict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">adict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">adict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">GetItemPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A utility function to get the numerical order in the printout</span>
<span class="sd">        of `itemname`.  An item has coordinate `(loop_no,pos)` with</span>
<span class="sd">        the top level having a `loop_no` of -1.  If an integer is passed to</span>
<span class="sd">        the routine then it will return the position of the loop</span>
<span class="sd">        referenced by that number.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemname</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
            <span class="c1"># return loop position</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">itemname</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">itemname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No such dataname </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">itemname</span><span class="p">)</span>
        <span class="n">testname</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">testname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">))</span>
        <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
        <span class="n">loop_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loop_no</span><span class="p">,</span><span class="n">loop_pos</span>

    <span class="k">def</span> <span class="nf">ChangeItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">,</span><span class="n">newpos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Move the printout order of `itemname` to `newpos`. If `itemname` is</span>
<span class="sd">        in a loop, `newpos` refers to the order within the loop.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemname</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
            <span class="n">true_name</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">true_name</span> <span class="o">=</span> <span class="n">itemname</span>
        <span class="n">loopno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">true_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loopno</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1">#top level</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">true_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">newpos</span><span class="p">,</span><span class="n">true_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loopno</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">true_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loopno</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">newpos</span><span class="p">,</span><span class="n">true_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GetItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of datanames in the order in which they will be printed.  Loops are</span>
<span class="sd">        referred to by numerical index&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">[:]</span>

    <span class="k">def</span> <span class="nf">AddItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">precheck</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add dataname `key` to block with value `value`.  `value` may be</span>
<span class="sd">        a single value, a list or a tuple. If `precheck` is False (the default),</span>
<span class="sd">        all values will be checked and converted to unicode strings as necessary. If</span>
<span class="sd">        `precheck` is True, this checking is bypassed.  No checking is necessary</span>
<span class="sd">        when values are read from a CIF file as they are already in correct form.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
             <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Star datanames are strings only (got </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">key</span> <span class="p">))</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>    <span class="c1">#everything is unicode internally</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">precheck</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">check_data_name</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxnamelength</span><span class="p">)</span>    <span class="c1"># make sure no nasty characters</span>
        <span class="c1"># check for overwriting</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
             <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
                 <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Attempt to insert duplicate item name </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">precheck</span><span class="p">:</span>   <span class="c1">#need to sanitise</span>
            <span class="n">regval</span><span class="p">,</span><span class="n">empty_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularise_data</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">pure_string</span> <span class="o">=</span> <span class="n">check_stringiness</span><span class="p">(</span><span class="n">regval</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_item_value</span><span class="p">(</span><span class="n">regval</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">regval</span><span class="p">,</span><span class="n">empty_val</span> <span class="o">=</span> <span class="n">value</span><span class="p">,</span><span class="bp">None</span>
            <span class="n">pure_string</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># update ancillary information first</span>
        <span class="n">lower_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lower_key</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">lower_key</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>      <span class="c1">#need to add to order</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lower_key</span><span class="p">)</span>
        <span class="c1"># always remove from our case table in case the case is different</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">lower_key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">lower_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">if</span> <span class="n">pure_string</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">lower_key</span><span class="p">:[</span><span class="n">regval</span><span class="p">,</span><span class="n">empty_val</span><span class="p">]})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">lower_key</span><span class="p">:[</span><span class="n">empty_val</span><span class="p">,</span><span class="n">regval</span><span class="p">]})</span>

    <span class="k">def</span> <span class="nf">AddLoopItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">incomingdata</span><span class="p">,</span><span class="n">precheck</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">maxlength</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` followed by `CreateLoop` if</span>
<span class="sd">        necessary.&quot;&quot;&quot;</span>
        <span class="c1"># print &quot;Received data %s&quot; % `incomingdata`</span>
        <span class="c1"># we accept tuples, strings, lists and dicts!!</span>
        <span class="c1"># Direct insertion: we have a string-valued key, with an array</span>
        <span class="c1"># of values -&gt; single-item into our loop</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
           <span class="c1"># a whole loop</span>
           <span class="n">keyvallist</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
           <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">keyvallist</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
             <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Star datanames are strings only (got </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">check_data_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">maxlength</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">maxlength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_name_length</span><span class="p">(</span><span class="n">dataname</span><span class="p">,</span><span class="n">maxlength</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dataname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;_&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Dataname &#39;</span> <span class="o">+</span> <span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; does not begin with _&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">characterset</span><span class="o">==</span><span class="s1">&#39;ascii&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span> <span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataname</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">33</span> <span class="ow">or</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">126</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Dataname &#39;</span> <span class="o">+</span> <span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; contains forbidden characters&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># print &#39;Checking %s for unicode characterset conformance&#39; % dataname</span>
            <span class="k">if</span> <span class="nb">len</span> <span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataname</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">33</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Dataname &#39;</span> <span class="o">+</span> <span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; contains forbidden characters (below code point 33)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span> <span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataname</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">126</span> <span class="ow">and</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">160</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Dataname &#39;</span> <span class="o">+</span> <span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; contains forbidden characters (between code point 127-159)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span> <span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataname</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0xD7FF</span> <span class="ow">and</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0xE000</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Dataname &#39;</span> <span class="o">+</span> <span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; contains unsupported characters (between U+D800 and U+E000)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span> <span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataname</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0xFDCF</span> <span class="ow">and</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0xFDF0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Dataname &#39;</span> <span class="o">+</span> <span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; contains unsupported characters (between U+FDD0 and U+FDEF)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span> <span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataname</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xFFFE</span> <span class="ow">or</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Dataname &#39;</span> <span class="o">+</span> <span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; contains unsupported characters (U+FFFE and/or U+FFFF)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span> <span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataname</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x10000</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xE</span> <span class="o">==</span> <span class="mh">0xE</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> fails&#39;</span> <span class="o">%</span> <span class="n">dataname</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataname</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="sa">u</span><span class="s1">&#39;Dataname &#39;</span> <span class="o">+</span> <span class="n">dataname</span> <span class="o">+</span> <span class="sa">u</span><span class="s1">&#39; contains unsupported characters (U+xFFFE and/or U+xFFFF)&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_name_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">maxlength</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span><span class="o">&gt;</span><span class="n">maxlength</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Dataname </span><span class="si">%s</span><span class="s1"> exceeds maximum length </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dataname</span><span class="p">,</span><span class="n">maxlength</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">check_item_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item</span><span class="p">):</span>
        <span class="n">test_item</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">dict</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span>
           <span class="n">test_item</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>         <span class="c1">#single item list</span>
        <span class="k">def</span> <span class="nf">check_one</span> <span class="p">(</span><span class="n">it</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">it</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">it</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="k">return</span>
                <span class="n">me</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">char_check</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">me</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Fail value check: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">it</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Bad character in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">it</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">me</span><span class="o">.</span><span class="n">span</span><span class="p">()</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">it</span><span class="p">)):</span>
                        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Fail value check, match only </span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2"> in string </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">me</span><span class="o">.</span><span class="n">span</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">me</span><span class="o">.</span><span class="n">span</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span><span class="nb">repr</span><span class="p">(</span> <span class="n">it</span> <span class="p">)))</span>
                        <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Data item &quot;&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">it</span> <span class="p">)</span> <span class="o">+</span>  <span class="sa">u</span><span class="s1">&#39;&quot;... contains forbidden characters&#39;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">check_one</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">test_item</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">regularise_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataitem</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place dataitem into a list if necessary&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataitem</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">dataitem</span><span class="p">),</span><span class="bp">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataitem</span><span class="p">,(</span><span class="n">Number</span><span class="p">,</span><span class="nb">unicode</span><span class="p">,</span><span class="n">StarList</span><span class="p">,</span><span class="n">StarDict</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">dataitem</span><span class="p">,</span><span class="bp">None</span>  <span class="c1">#assume StarList/StarDict contain unicode if necessary</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataitem</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
            <span class="n">v</span><span class="p">,</span><span class="n">s</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">regularise_data</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataitem</span><span class="p">]))</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">),</span><span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="c1">#return dataitem,[None]*len(dataitem)</span>
        <span class="c1"># so try to make into a list</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">regval</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataitem</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">dataitem</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; is wrong type for data value</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span>
        <span class="n">v</span><span class="p">,</span><span class="n">s</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">regularise_data</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">regval</span><span class="p">]))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">),</span><span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">RemoveItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove `itemname` from the block.&quot;&quot;&quot;</span>
        <span class="c1"># first check any loops</span>
        <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>
        <span class="n">testkey</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">testkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
            <span class="c1"># now remove from loop</span>
            <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">loop_no</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1">#will appear in order list</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">RemoveLoopItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `RemoveItem` instead&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RemoveItem</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GetItemValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return value of `itemname`.  If `itemname` is looped, a list</span>
<span class="sd">        of all values will be returned.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetFullItemValue</span><span class="p">(</span><span class="n">itemname</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">GetFullItemValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the value associated with `itemname`, and a boolean flagging whether</span>
<span class="sd">        (True) or not (False) it is in a form suitable for calculation.  False is</span>
<span class="sd">        always returned for strings and `StarList` objects.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Itemname </span><span class="si">%s</span><span class="s1"> not in datablock&#39;</span> <span class="o">%</span> <span class="n">itemname</span><span class="p">)</span>
        <span class="c1"># prefer string value unless all are None</span>
        <span class="c1"># are we a looped value?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">StarList</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">not_none</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">s</span><span class="p">,</span><span class="bp">False</span>    <span class="c1">#a string value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">StarList</span><span class="p">)</span>  <span class="c1">#a StarList is not calculation-ready</span>
        <span class="k">elif</span> <span class="n">not_none</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">,</span><span class="bp">False</span>         <span class="c1">#a list of string values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">StarList</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="bp">True</span>

    <span class="k">def</span> <span class="nf">CreateLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">datanames</span><span class="p">,</span><span class="n">order</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">length_check</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
           <span class="sd">&quot;&quot;&quot;Create a loop in the datablock. `datanames` is a list of datanames that</span>
<span class="sd">           together form a loop.  If length_check is True, they should have been initialised in the block</span>
<span class="sd">           to have the same number of elements (possibly 0). If `order` is given,</span>
<span class="sd">           the loop will appear at this position in the block when printing</span>
<span class="sd">           out. A loop counts as a single position.&quot;&quot;&quot;</span>

           <span class="k">if</span> <span class="n">length_check</span><span class="p">:</span>
               <span class="c1"># check lengths: these datanames should exist</span>
               <span class="n">listed_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">datanames</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">StarList</span><span class="p">)]</span>
               <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listed_values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">datanames</span><span class="p">):</span>
                   <span class="n">len_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">datanames</span><span class="p">])</span>
                   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">len_set</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                       <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Request to loop datanames </span><span class="si">%s</span><span class="s1"> with different lengths: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">datanames</span> <span class="p">),</span><span class="nb">repr</span><span class="p">(</span> <span class="n">len_set</span> <span class="p">)))</span>
               <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">listed_values</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                   <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Request to loop datanames where some are single values and some are not&#39;</span><span class="p">)</span>
           <span class="c1"># store as lower case</span>
           <span class="n">lc_datanames</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datanames</span><span class="p">]</span>
           <span class="c1"># remove these datanames from all other loops</span>
           <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">lc_datanames</span> <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
           <span class="c1"># remove empty loops</span>
           <span class="n">empty_loops</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
           <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">empty_loops</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
               <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
           <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
               <span class="n">loopno</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="n">loopno</span> <span class="o">=</span> <span class="mi">1</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loopno</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lc_datanames</span><span class="p">)</span>
           <span class="k">if</span> <span class="n">order</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="n">loopno</span><span class="p">)</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loopno</span><span class="p">)</span>
           <span class="c1"># remove these datanames from item ordering</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lc_datanames</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">AddLoopName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldname</span><span class="p">,</span> <span class="n">newname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add `newname` to the loop containing `oldname`. If it is already in the new loop, no</span>
<span class="sd">        error is raised.  If `newname` is in a different loop, it is removed from that loop.</span>
<span class="sd">        The number of values associated with `newname` must match the number of values associated</span>
<span class="sd">        with all other columns of the new loop or a `ValueError` will be raised.&quot;&quot;&quot;</span>
        <span class="n">lower_newname</span> <span class="o">=</span> <span class="n">newname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">oldname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not in loop&#39;</span> <span class="o">%</span> <span class="n">oldname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lower_newname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="c1"># check length</span>
        <span class="n">old_provides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">oldname</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="n">old_provides</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">newname</span><span class="p">])</span> <span class="o">!=</span> <span class="n">loop_len</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Mismatch of loop column lengths for </span><span class="si">%s</span><span class="s1">: should be </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="n">loop_len</span><span class="p">))</span>
        <span class="c1"># remove from any other loops</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="k">if</span> <span class="n">lower_newname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
        <span class="c1"># and add to this loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span>
        <span class="c1"># remove from item_order if present</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">FindLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the loop that contains `keyname` and return its numerical index or</span>
<span class="sd">        -1 if not present. The numerical index can be used to refer to the loop in</span>
<span class="sd">        other routines.&quot;&quot;&quot;</span>
        <span class="n">loop_no</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">keyname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loop_no</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">loop_no</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">GetLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a `StarFile.LoopBlock` object constructed from the loop containing `keyname`.</span>
<span class="sd">        `keyname` is only significant as a way to specify the loop.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">LoopBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GetLoopNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keyname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">aloop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">aloop</span><span class="o">.</span><span class="n">GetLoopNames</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Item does not exist&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GetLoopNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all datanames appearing together with `keyname`&quot;&quot;&quot;</span>
        <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not in any loop&#39;</span> <span class="o">%</span> <span class="n">keyname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">AddLoopName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldname</span><span class="p">,</span> <span class="n">newname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add `newname` to the loop containing `oldname`. If it is already in the new loop, no</span>
<span class="sd">        error is raised.  If `newname` is in a different loop, it is removed from that loop.</span>
<span class="sd">        The number of values associated with `newname` must match the number of values associated</span>
<span class="sd">        with all other columns of the new loop or a `ValueError` will be raised.&quot;&quot;&quot;</span>
        <span class="n">lower_newname</span> <span class="o">=</span> <span class="n">newname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">oldname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not in loop&#39;</span> <span class="o">%</span> <span class="n">oldname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lower_newname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="c1"># check length</span>
        <span class="n">old_provides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">oldname</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="n">old_provides</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">newname</span><span class="p">])</span> <span class="o">!=</span> <span class="n">loop_len</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Mismatch of loop column lengths for </span><span class="si">%s</span><span class="s1">: should be </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="n">loop_len</span><span class="p">))</span>
        <span class="c1"># remove from any other loops</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="k">if</span> <span class="n">lower_newname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
        <span class="c1"># and add to this loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span>
        <span class="c1"># remove from item_order if present</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">):</span>
        <span class="n">thisloop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itemname</span><span class="p">,</span><span class="n">itemvalue</span> <span class="ow">in</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">thisloop</span><span class="p">[</span><span class="n">itemname</span><span class="p">]</span> <span class="o">=</span> <span class="n">itemvalue</span>

    <span class="k">def</span> <span class="nf">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` followed by calls to `AddLoopName`.</span>

<span class="sd">        Add multiple columns to the loop containing `dataname`. `loopdata` is a</span>
<span class="sd">        collection of (key,value) pairs, where `key` is the new dataname and `value`</span>
<span class="sd">        is a list of values for that dataname&quot;&quot;&quot;</span>
        <span class="c1"># check lengths</span>
        <span class="n">thisloop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
        <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">dataname</span><span class="p">])</span>
        <span class="n">bad_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">!=</span><span class="n">loop_len</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_vals</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
           <span class="k">raise</span> <span class="n">StarLengthError</span><span class="p">(</span><span class="s2">&quot;Number of values for looped datanames </span><span class="si">%s</span><span class="s2"> not equal to </span><span class="si">%d</span><span class="s2">&quot;</span> \
               <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">bad_vals</span> <span class="p">),</span><span class="n">loop_len</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loopdata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">thisloop</span><span class="p">]</span><span class="o">+=</span><span class="n">loopdata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">RemoveKeyedPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the packet for which dataname `keyname` takes</span>
<span class="sd">        value `keyvalue`.  Only the first such occurrence is</span>
<span class="sd">        removed.&quot;&quot;&quot;</span>
        <span class="n">packet_coord</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">keyname</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">keyvalue</span><span class="p">)</span>
        <span class="n">loopnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoopNames</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dataname</span> <span class="ow">in</span> <span class="n">loopnames</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">packet_coord</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">packet_coord</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">GetKeyedPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">no_case</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the loop packet (a `StarPacket` object) where `keyname` has value</span>
<span class="sd">        `keyvalue`. Ignore case in `keyvalue` if `no_case` is True.  `ValueError`</span>
<span class="sd">        is raised if no packet is found or more than one packet is found.&quot;&quot;&quot;</span>
        <span class="n">my_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
        <span class="c1">#print(&quot;Looking for %s in %s&quot; % (keyvalue, my_loop.parent_block))</span>
        <span class="c1">#print(&#39;Packet check on:&#39; + keyname)</span>
        <span class="c1">#[print(repr(getattr(a,keyname))) for a in my_loop]</span>
        <span class="k">if</span> <span class="n">no_case</span><span class="p">:</span>
           <span class="n">one_pack</span><span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="n">keyvalue</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">one_pack</span><span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span><span class="o">==</span><span class="n">keyvalue</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">one_pack</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad packet key </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">: returned </span><span class="si">%d</span><span class="s2"> packets&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">keyname</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">one_pack</span><span class="p">)))</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Keyed packet: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">one_pack</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">one_pack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">GetCompoundKeyedPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keydict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the loop packet (a `StarPacket` object) where the `{key:(value,caseless)}` pairs</span>
<span class="sd">        in `keydict` take the appropriate values. Ignore case for a given `key` if `caseless` is</span>
<span class="sd">        True.  `ValueError` is raised if no packet is found or more than one packet is found.&quot;&quot;&quot;</span>
        <span class="c1">#print &quot;Looking for %s in %s&quot; % (keyvalue, self.parent_block[keyname])</span>
        <span class="n">keynames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keydict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">my_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">keynames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="n">keynames</span><span class="p">:</span>
            <span class="n">keyval</span><span class="p">,</span><span class="n">no_case</span> <span class="o">=</span> <span class="n">keydict</span><span class="p">[</span><span class="n">one_key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">no_case</span><span class="p">:</span>
               <span class="n">my_loop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">one_key</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="nb">str</span><span class="p">(</span><span class="n">keyval</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">my_loop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">one_key</span><span class="p">)</span><span class="o">==</span><span class="n">keyval</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_loop</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad packet keys </span><span class="si">%s</span><span class="s2">: returned </span><span class="si">%d</span><span class="s2"> packets&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">keydict</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">my_loop</span><span class="p">)))</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Compound keyed packet: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">my_loop</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">my_loop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">GetKeyedSemanticPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">cat_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a complete packet for category `cat_id` where the</span>
<span class="sd">        category key for the category equals `keyvalue`.  This routine</span>
<span class="sd">        will understand any joined loops, so if separate loops in the</span>
<span class="sd">        datafile belong to the</span>
<span class="sd">        same category hierarchy (e.g. `_atom_site` and `_atom_site_aniso`),</span>
<span class="sd">        the returned `StarPacket` object will contain datanames from</span>
<span class="sd">        both categories.&quot;&quot;&quot;</span>
        <span class="n">target_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">[</span><span class="n">cat_id</span><span class="p">]</span>
        <span class="n">target_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">]</span> <span class="c1">#one only in each list</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">()</span>
        <span class="c1"># set case-sensitivity flag</span>
        <span class="n">lcase</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;_type.contents&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Code&#39;</span><span class="p">,</span><span class="s1">&#39;Tag&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">]:</span>
            <span class="n">lcase</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">cat_key</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">extra_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetKeyedPacket</span><span class="p">(</span><span class="n">cat_key</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">no_case</span><span class="o">=</span><span class="n">lcase</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>        <span class="c1">#missing key</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">test_key</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">cat_key</span><span class="p">]</span>  <span class="c1">#generate key if possible</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Test key is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">test_key</span> <span class="p">))</span>
                    <span class="k">if</span> <span class="n">test_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>\
                    <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">test_key</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">None</span> <span class="ow">in</span> <span class="n">test_key</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_key</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)):</span>
                        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Getting packet for key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">keyvalue</span> <span class="p">))</span>
                        <span class="n">extra_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetKeyedPacket</span><span class="p">(</span><span class="n">cat_key</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">no_case</span><span class="o">=</span><span class="n">lcase</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>             <span class="c1">#cannot be generated</span>
                    <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>      <span class="c1">#none/more than one, assume none</span>
                <span class="k">continue</span>
                <span class="c1">#extra_packet = self.dictionary.generate_default_packet(cat_id,cat_key,keyvalue)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">merge_packet</span><span class="p">(</span><span class="n">extra_packet</span><span class="p">)</span>
        <span class="c1"># the following attributes used to calculate missing values</span>
        <span class="k">for</span> <span class="n">keyname</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="n">keyname</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No key found for </span><span class="si">%s</span><span class="s2">, packet is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cat_id</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
        <span class="n">p</span><span class="o">.</span><span class="n">cif_dictionary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span>
        <span class="n">p</span><span class="o">.</span><span class="n">fulldata</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">GetMultiKeyedSemanticPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keydict</span><span class="p">,</span><span class="n">cat_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a complete packet for category `cat_id` where the keyvalues are</span>
<span class="sd">        provided as a dictionary of key:(value,caseless) pairs</span>
<span class="sd">        This routine</span>
<span class="sd">        will understand any joined loops, so if separate loops in the</span>
<span class="sd">        datafile belong to the</span>
<span class="sd">        same category hierarchy (e.g. `_atom_site` and `_atom_site_aniso`),</span>
<span class="sd">        the returned `StarPacket` object will contain datanames from</span>
<span class="sd">        the requested category and any children.&quot;&quot;&quot;</span>
        <span class="c1">#if len(keyvalues)==1:   #simplification</span>
        <span class="c1">#    return self.GetKeyedSemanticPacket(keydict[1][0],cat_id)</span>
        <span class="n">target_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">[</span><span class="n">cat_id</span><span class="p">]</span>
        <span class="c1"># update the dictionary passed to us with all equivalents, for</span>
        <span class="c1"># simplicity.</span>
        <span class="n">parallel_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">target_keys</span><span class="p">))</span>  <span class="c1">#transpose</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Parallel keys:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">parallel_keys</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Keydict:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">keydict</span><span class="p">))</span>
        <span class="n">start_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keydict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">one_name</span> <span class="ow">in</span> <span class="n">start_keys</span><span class="p">:</span>
            <span class="n">key_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">parallel_keys</span> <span class="k">if</span> <span class="n">one_name</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="n">key_set</span><span class="p">:</span>
                <span class="n">keydict</span><span class="p">[</span><span class="n">one_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">keydict</span><span class="p">[</span><span class="n">one_name</span><span class="p">]</span>
        <span class="c1"># target_keys is a list of lists, each of which is a compound key</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">()</span>
        <span class="c1"># a little function to return the dataname for a key</span>
        <span class="k">def</span> <span class="nf">find_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">key_equivs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,[])</span><span class="o">+</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">one_key</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">one_key</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">one_set</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">:</span> <span class="c1">#loop down the categories</span>
            <span class="n">true_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">find_key</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">one_set</span><span class="p">]</span>
            <span class="n">true_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">true_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_keys</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">one_set</span><span class="p">):</span>
                <span class="n">truekeydict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">t</span><span class="p">,</span><span class="n">keydict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">true_keys</span><span class="p">,</span><span class="n">one_set</span><span class="p">)])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">extra_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetCompoundKeyedPacket</span><span class="p">(</span><span class="n">truekeydict</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>     <span class="c1">#one or more are missing</span>
                    <span class="k">continue</span>         <span class="c1">#should try harder?</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Merging packet for keys &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">one_set</span><span class="p">))</span>
            <span class="n">p</span><span class="o">.</span><span class="n">merge_packet</span><span class="p">(</span><span class="n">extra_packet</span><span class="p">)</span>
        <span class="c1"># the following attributes used to calculate missing values</span>
        <span class="n">p</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">true_keys</span>
        <span class="n">p</span><span class="o">.</span><span class="n">cif_dictionary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span>
        <span class="n">p</span><span class="o">.</span><span class="n">fulldata</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">p</span>


    <span class="k">def</span> <span class="nf">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">new_grammar</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">string_delimiters</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">;&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">new_grammar</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;STAR2&#39;</span><span class="p">,</span><span class="s1">&#39;2.0&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">string_delimiters</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">,</span><span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">new_grammar</span> <span class="o">==</span> <span class="s1">&#39;2.0&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_delimiter</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">elif</span> <span class="n">new_grammar</span> <span class="o">==</span> <span class="s1">&#39;STAR2&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_delimiter</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span>
        <span class="k">elif</span> <span class="n">new_grammar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span><span class="s1">&#39;1.1&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Request to set unknown grammar </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">new_grammar</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">SetOutputLength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wraplength</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">maxoutlength</span><span class="o">=</span><span class="mi">2048</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the maximum output line length (`maxoutlength`) and the line length to</span>
<span class="sd">        wrap at (`wraplength`).  The wrap length is a target only and may not always be</span>
<span class="sd">        possible.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">wraplength</span> <span class="o">&gt;</span> <span class="n">maxoutlength</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;Wrap length (requested </span><span class="si">%d</span><span class="s2">) must be &lt;= Maximum line length (requested </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wraplength</span><span class="p">,</span><span class="n">maxoutlength</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wraplength</span> <span class="o">=</span> <span class="n">wraplength</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span> <span class="o">=</span> <span class="n">maxoutlength</span>

    <span class="k">def</span> <span class="nf">printsection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">instring</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">blockstart</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">blockend</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">finish_at</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">start_from</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># first make an ordering</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_ordering</span><span class="p">(</span><span class="n">finish_at</span><span class="p">,</span><span class="n">start_from</span><span class="p">)</span>  <span class="c1">#create self.output_order</span>
        <span class="c1"># now do it...</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">instring</span><span class="p">:</span>
            <span class="n">outstring</span> <span class="o">=</span> <span class="n">CIFStringIO</span><span class="p">(</span><span class="n">target_width</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>       <span class="c1"># the returned string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outstring</span> <span class="o">=</span> <span class="n">instring</span>
        <span class="c1"># print block delimiter</span>
        <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">blockstart</span><span class="p">,</span><span class="n">canbreak</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
           <span class="c1">#print &quot;Remaining to output &quot; + `self.output_order`</span>
           <span class="n">itemname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
           <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemname</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>  <span class="c1">#no loop</span>
                   <span class="n">item_spec</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;dataname&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item_spec</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                       <span class="n">item_spec</span> <span class="o">=</span> <span class="n">item_spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                       <span class="n">col_pos</span> <span class="o">=</span> <span class="n">item_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column&#39;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                       <span class="n">name_pos</span> <span class="o">=</span> <span class="n">item_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name_pos&#39;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                   <span class="k">else</span><span class="p">:</span>
                       <span class="n">col_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                       <span class="n">item_spec</span> <span class="o">=</span> <span class="p">{}</span>
                       <span class="n">name_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                   <span class="k">if</span> <span class="n">col_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">col_pos</span> <span class="o">=</span> <span class="mi">40</span>
                   <span class="n">outstring</span><span class="o">.</span><span class="n">set_tab</span><span class="p">(</span><span class="n">col_pos</span><span class="p">)</span>
                   <span class="n">itemvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">itemname</span><span class="p">]</span>
                   <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">itemname</span><span class="p">],</span><span class="n">mustbreak</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">do_tab</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">startcol</span><span class="o">=</span><span class="n">name_pos</span><span class="p">)</span>
                   <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">canbreak</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">do_tab</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>    <span class="c1">#space after itemname</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">format_value</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="n">hints</span><span class="o">=</span><span class="n">item_spec</span><span class="p">)</span>
           <span class="k">else</span><span class="p">:</span><span class="c1"># we are asked to print a loop block</span>
                    <span class="n">outstring</span><span class="o">.</span><span class="n">set_tab</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>       <span class="c1">#guess this is OK?</span>
                    <span class="n">loop_spec</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;name_pos&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;dataname&quot;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;loop&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">loop_spec</span><span class="p">:</span>
                        <span class="n">loop_indent</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">loop_spec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">loop_indent</span> <span class="o">=</span> <span class="n">indent</span>
                    <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;loop_</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">mustbreak</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">do_tab</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">startcol</span><span class="o">=</span><span class="n">loop_indent</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">format_names</span><span class="p">(</span><span class="n">outstring</span><span class="p">,</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">loop_no</span><span class="o">=</span><span class="n">itemname</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">format_packets</span><span class="p">(</span><span class="n">outstring</span><span class="p">,</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">loop_no</span><span class="o">=</span><span class="n">itemname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">returnstring</span> <span class="o">=</span> <span class="n">outstring</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">outstring</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">returnstring</span>

    <span class="k">def</span> <span class="nf">format_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">loop_no</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print datanames from `loop_no` one per line&quot;&quot;&quot;</span>
        <span class="n">temp_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">][:]</span>   <span class="c1">#copy</span>
        <span class="n">format_hints</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;dataname&#39;</span><span class="p">],</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;dataname&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">temp_order</span><span class="p">])</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_order</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">itemname</span> <span class="o">=</span> <span class="n">temp_order</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">req_indent</span> <span class="o">=</span> <span class="n">format_hints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">itemname</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name_pos&#39;</span><span class="p">,</span><span class="n">indent</span><span class="p">)</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">req_indent</span><span class="p">,</span><span class="n">do_tab</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">itemname</span><span class="p">],</span><span class="n">do_tab</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">do_tab</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">format_packets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">loop_no</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
       <span class="n">alldata</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]]</span>
       <span class="n">loopnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
       <span class="c1">#print &#39;Alldata: %s&#39; % `alldata`</span>
       <span class="n">packet_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">alldata</span><span class="p">))</span>
       <span class="c1">#print &#39;Packet data: %s&#39; % `packet_data`</span>
       <span class="c1">#create a dictionary for quick lookup of formatting requirements</span>
       <span class="n">format_hints</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;dataname&#39;</span><span class="p">],</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;dataname&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">loopnames</span><span class="p">])</span>
       <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">packet_data</span><span class="p">)):</span>
           <span class="k">if</span> <span class="n">position</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
               <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>    <span class="c1">#new line each packet except first</span>
           <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">packet_data</span><span class="p">[</span><span class="n">position</span><span class="p">])):</span>
               <span class="n">datapoint</span> <span class="o">=</span> <span class="n">packet_data</span><span class="p">[</span><span class="n">position</span><span class="p">][</span><span class="n">point</span><span class="p">]</span>
               <span class="n">format_hint</span> <span class="o">=</span> <span class="n">format_hints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">loopnames</span><span class="p">[</span><span class="n">point</span><span class="p">],{})</span>
               <span class="n">packstring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_packet_item</span><span class="p">(</span><span class="n">datapoint</span><span class="p">,</span><span class="n">indent</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="n">format_hint</span><span class="p">)</span>
               <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">canbreak</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">do_tab</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">format_packet_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pack_item</span><span class="p">,</span><span class="n">indent</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="n">format_hint</span><span class="p">):</span>
           <span class="c1"># print &#39;Formatting %s&#39; % `pack_item`</span>
           <span class="c1"># temporary check for any non-unicode items</span>
           <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pack_item</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pack_item</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
               <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;Item {0!r} is not unicode&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pack_item</span><span class="p">))</span>
           <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pack_item</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
               <span class="n">delimiter</span> <span class="o">=</span> <span class="n">format_hint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;delimiter&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
               <span class="n">startcol</span> <span class="o">=</span> <span class="n">format_hint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column&#39;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
               <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatstring</span><span class="p">(</span><span class="n">pack_item</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">),</span><span class="n">startcol</span><span class="o">=</span><span class="n">startcol</span><span class="p">)</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">format_value</span><span class="p">(</span><span class="n">pack_item</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="n">hints</span> <span class="o">=</span> <span class="n">format_hint</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_formatstring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">instring</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">standard</span><span class="o">=</span><span class="s1">&#39;CIF1&#39;</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">hints</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">if</span> <span class="n">hints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reformat&quot;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">instring</span><span class="p">:</span>
            <span class="n">instring</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">do_wrapping</span><span class="p">(</span><span class="n">instring</span><span class="p">,</span><span class="n">hints</span><span class="p">[</span><span class="s2">&quot;reformat_indent&quot;</span><span class="p">])</span>
        <span class="n">allowed_delimiters</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">string_delimiters</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instring</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">allowed_delimiters</span><span class="o">.</span><span class="n">difference_update</span><span class="p">([</span><span class="bp">None</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">instring</span><span class="p">:</span>
                <span class="n">allowed_delimiters</span><span class="o">.</span><span class="n">intersection_update</span><span class="p">([</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">;&quot;</span><span class="p">,</span><span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">instring</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">instring</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="se">\v</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">instring</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instring</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">instring</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;_$#;([{&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">instring</span><span class="p">:</span>
                <span class="n">allowed_delimiters</span><span class="o">.</span><span class="n">difference_update</span><span class="p">([</span><span class="bp">None</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instring</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">3</span> <span class="ow">and</span> <span class="p">(</span><span class="n">instring</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;data&#39;</span> <span class="ow">or</span> <span class="n">instring</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;save&#39;</span><span class="p">):</span>
                <span class="n">allowed_delimiters</span><span class="o">.</span><span class="n">difference_update</span><span class="p">([</span><span class="bp">None</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instring</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">5</span> <span class="ow">and</span> <span class="n">instring</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;global&#39;</span><span class="p">:</span>
                <span class="n">allowed_delimiters</span><span class="o">.</span><span class="n">difference_update</span><span class="p">([</span><span class="bp">None</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">instring</span><span class="p">:</span> <span class="n">allowed_delimiters</span><span class="o">.</span><span class="n">difference_update</span><span class="p">([</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">in</span> <span class="n">instring</span><span class="p">:</span> <span class="n">allowed_delimiters</span><span class="o">.</span><span class="n">difference_update</span><span class="p">([</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">])</span>
        <span class="n">out_delimiter</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">;&quot;</span>  <span class="c1">#default (most conservative)</span>
        <span class="k">if</span> <span class="n">delimiter</span> <span class="ow">in</span> <span class="n">allowed_delimiters</span><span class="p">:</span>
            <span class="n">out_delimiter</span> <span class="o">=</span> <span class="n">delimiter</span>
        <span class="k">elif</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">in</span> <span class="n">allowed_delimiters</span><span class="p">:</span> <span class="n">out_delimiter</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span>
        <span class="k">elif</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">allowed_delimiters</span><span class="p">:</span> <span class="n">out_delimiter</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span>
        <span class="k">if</span> <span class="n">out_delimiter</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">,</span><span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">]:</span> <span class="k">return</span> <span class="n">out_delimiter</span> <span class="o">+</span> <span class="n">instring</span> <span class="o">+</span> <span class="n">out_delimiter</span>
        <span class="k">elif</span> <span class="n">out_delimiter</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">instring</span>
        <span class="c1"># we are left with semicolon strings</span>
        <span class="c1"># use our protocols:</span>
        <span class="n">maxlinelength</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">instring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">maxlinelength</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span><span class="p">:</span>
            <span class="n">protocol_string</span> <span class="o">=</span> <span class="n">apply_line_folding</span><span class="p">(</span><span class="n">instring</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">protocol_string</span> <span class="o">=</span> <span class="n">instring</span>
        <span class="c1"># now check for embedded delimiters</span>
        <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">;&quot;</span> <span class="ow">in</span> <span class="n">protocol_string</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;CIF:&quot;</span>
            <span class="k">while</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">protocol_string</span><span class="p">:</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span>
            <span class="n">protocol_string</span> <span class="o">=</span> <span class="n">apply_line_prefix</span><span class="p">(</span><span class="n">protocol_string</span><span class="p">,</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;&gt; &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">;&quot;</span> <span class="o">+</span> <span class="n">protocol_string</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">;&quot;</span>

    <span class="k">def</span> <span class="nf">format_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemvalue</span><span class="p">,</span><span class="n">stringsink</span><span class="p">,</span><span class="n">compound</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">hints</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Format a Star data value&quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">have_numpy</span>
        <span class="n">delimiter</span> <span class="o">=</span> <span class="n">hints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;delimiter&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">startcol</span> <span class="o">=</span> <span class="n">hints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column&#39;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span> <span class="c1">#not allowed</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;Non-unicode value {0} found in block&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>  <span class="c1">#need to sanitize</span>
            <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatstring</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span><span class="n">hints</span><span class="o">=</span><span class="n">hints</span><span class="p">),</span><span class="n">canbreak</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span><span class="n">startcol</span><span class="o">=</span><span class="n">startcol</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,(</span><span class="nb">list</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,</span><span class="s1">&#39;dtype&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,</span><span class="s1">&#39;__iter__&#39;</span><span class="p">)):</span> <span class="c1">#numpy</span>
           <span class="n">stringsink</span><span class="o">.</span><span class="n">set_tab</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
           <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span><span class="n">canbreak</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">newindent</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">mustbreak</span><span class="o">=</span><span class="n">compound</span><span class="p">,</span><span class="n">startcol</span><span class="o">=</span><span class="n">startcol</span><span class="p">)</span>
           <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">format_value</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">stringsink</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">listval</span> <span class="ow">in</span> <span class="n">itemvalue</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                  <span class="c1"># print &#39;Formatting %s&#39; % `listval`</span>
                  <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_delimiter</span><span class="p">,</span><span class="n">do_tab</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">format_value</span><span class="p">(</span><span class="n">listval</span><span class="p">,</span><span class="n">stringsink</span><span class="p">,</span><span class="n">compound</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
           <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span><span class="n">unindent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
           <span class="n">stringsink</span><span class="o">.</span><span class="n">set_tab</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
           <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="n">newindent</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">mustbreak</span><span class="o">=</span><span class="n">compound</span><span class="p">,</span><span class="n">startcol</span><span class="o">=</span><span class="n">startcol</span><span class="p">)</span>  <span class="c1">#start a new line inside</span>
           <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itemvalue</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
           <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
               <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="o">+</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">canbreak</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">format_value</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">stringsink</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                   <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_delimiter</span><span class="p">)</span>
                   <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="o">+</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="p">,</span><span class="n">canbreak</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">format_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">stringsink</span><span class="p">)</span>   <span class="c1">#never break between key and value</span>
           <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span><span class="n">unindent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,(</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">))</span> <span class="ow">or</span> \
             <span class="p">(</span><span class="n">have_numpy</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,(</span><span class="n">numpy</span><span class="o">.</span><span class="n">number</span><span class="p">))):</span>  <span class="c1">#TODO - handle uncertainties</span>
           <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">),</span><span class="n">canbreak</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">startcol</span><span class="o">=</span><span class="n">startcol</span><span class="p">)</span>   <span class="c1">#numbers</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Value in unexpected format for output: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">itemvalue</span> <span class="p">))</span>

    <span class="k">def</span> <span class="nf">create_ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">finish_at</span><span class="p">,</span><span class="n">start_from</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a canonical ordering that includes loops using our formatting hints dictionary&quot;&quot;&quot;</span>
        <span class="n">requested_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;dataname&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;dataname&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;loop&#39;</span><span class="p">])</span>
        <span class="n">new_order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">requested_order</span><span class="p">:</span>
           <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="nb">unicode</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">:</span>
               <span class="n">new_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
           <span class="k">elif</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>    <span class="c1">#in a loop somewhere</span>
               <span class="n">target_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
               <span class="k">if</span> <span class="n">target_loop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_order</span><span class="p">:</span>
                   <span class="n">new_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_loop</span><span class="p">)</span>
                   <span class="c1"># adjust loop name order</span>
                   <span class="n">loopnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">target_loop</span><span class="p">]</span>
                   <span class="n">loop_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">requested_order</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">loopnames</span><span class="p">]</span>
                   <span class="n">unordered</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">loopnames</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loop_order</span><span class="p">]</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">target_loop</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop_order</span> <span class="o">+</span> <span class="n">unordered</span>
        <span class="n">extras</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_order</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span> <span class="o">=</span> <span class="n">new_order</span> <span class="o">+</span> <span class="n">extras</span>
        <span class="c1"># now handle partial output</span>
        <span class="k">if</span> <span class="n">start_from</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">start_from</span> <span class="ow">in</span> <span class="n">requested_order</span><span class="p">:</span>
                <span class="n">sfi</span> <span class="o">=</span> <span class="n">requested_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">start_from</span><span class="p">)</span>
                <span class="n">loop_order</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">requested_order</span><span class="p">[</span><span class="n">sfi</span><span class="p">:]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">requested_order</span><span class="p">[</span><span class="n">sfi</span><span class="p">:]])</span>
                <span class="n">cand_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_order</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">cand_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loop_order</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">cand_pos</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cand_pos</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">loop_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">cand_pos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Output starts from </span><span class="si">%s</span><span class="s1">, requested </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="p">[</span><span class="n">cand_pos</span><span class="p">],</span><span class="n">start_from</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="p">[</span><span class="n">cand_pos</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Start is beyond end of output list&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">start_from</span> <span class="ow">in</span> <span class="n">extras</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">start_from</span><span class="p">):]</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">finish_at</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">finish_at</span> <span class="ow">in</span> <span class="n">requested_order</span><span class="p">:</span>
                <span class="n">fai</span> <span class="o">=</span> <span class="n">requested_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">finish_at</span><span class="p">)</span>
                <span class="n">loop_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">requested_order</span><span class="p">[</span><span class="n">fai</span><span class="p">:]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">requested_order</span><span class="p">[</span><span class="n">fai</span><span class="p">:]])</span>
                <span class="n">cand_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_order</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">cand_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loop_order</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">cand_pos</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cand_pos</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">loop_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">cand_pos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Output finishes before </span><span class="si">%s</span><span class="s1">, requested before </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="p">[</span><span class="n">cand_pos</span><span class="p">],</span><span class="n">finish_at</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="p">[:</span><span class="n">cand_pos</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;All of block output&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">finish_at</span> <span class="ow">in</span> <span class="n">extras</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">finish_at</span><span class="p">)]</span>
        <span class="c1">#print(&#39;Final order: &#39; + repr(self.output_order))</span>

    <span class="k">def</span> <span class="nf">convert_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert values held in dataname value fork to string version&quot;&quot;&quot;</span>
        <span class="n">v</span><span class="p">,</span><span class="n">is_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetFullItemValue</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
        <span class="k">if</span> <span class="n">check_stringiness</span><span class="p">(</span><span class="n">v</span><span class="p">):</span> <span class="k">return</span> <span class="n">v</span>   <span class="c1">#already strings</span>
        <span class="c1"># TODO...something else</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">do_wrapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">instring</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrap the provided string&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;   &quot;</span> <span class="ow">in</span> <span class="n">instring</span><span class="p">:</span>   <span class="c1">#already formatted</span>
            <span class="k">return</span> <span class="n">instring</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span><span class="o">.</span><span class="n">initial_indent</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">*</span><span class="n">indent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span><span class="o">.</span><span class="n">subsequent_indent</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">*</span><span class="n">indent</span>
        <span class="c1"># remove leading and trailing space</span>
        <span class="n">instring</span> <span class="o">=</span> <span class="n">instring</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># split into paragraphs</span>
        <span class="n">paras</span> <span class="o">=</span> <span class="n">instring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">wrapped_paras</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paras</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wrapped_paras</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">new_block</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;strict&quot;</span><span class="p">,</span><span class="n">match_att</span><span class="o">=</span><span class="p">[],</span><span class="n">match_function</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">rel_keys</span> <span class="o">=</span> <span class="p">[]):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;strict&#39;</span><span class="p">:</span>
           <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_block</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
               <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">match_att</span><span class="p">:</span>
                  <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s2">&quot;Identical keys </span><span class="si">%s</span><span class="s2"> in strict merge mode&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
               <span class="k">elif</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">match_att</span><span class="p">:</span>           <span class="c1">#a new dataname</span>
                   <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_block</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
           <span class="c1"># we get here if there are no keys in common, so we can now copy</span>
           <span class="c1"># the loops and not worry about overlaps</span>
           <span class="k">for</span> <span class="n">one_loop</span> <span class="ow">in</span> <span class="n">new_block</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">(</span><span class="n">one_loop</span><span class="p">)</span>
           <span class="c1"># we have lost case information</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_block</span><span class="o">.</span><span class="n">true_case</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span>
           <span class="n">newkeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_block</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
           <span class="k">for</span> <span class="n">ma</span> <span class="ow">in</span> <span class="n">match_att</span><span class="p">:</span>
              <span class="k">try</span><span class="p">:</span>
                   <span class="n">newkeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ma</span><span class="p">)</span>        <span class="c1">#don&#39;t touch the special ones</span>
              <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                   <span class="k">pass</span>
           <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_block</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
                      <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_block</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
           <span class="c1"># creating the loop will remove items from other loops</span>
           <span class="k">for</span> <span class="n">one_loop</span> <span class="ow">in</span> <span class="n">new_block</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">(</span><span class="n">one_loop</span><span class="p">)</span>
           <span class="c1"># we have lost case information</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_block</span><span class="o">.</span><span class="n">true_case</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;overlay&#39;</span><span class="p">:</span>
           <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Overlay mode, current overwrite is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">)</span>
           <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Overlay block merge mode not implemented&#39;</span><span class="p">)</span>
           <span class="n">save_overwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="bp">True</span>
           <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">new_block</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
               <span class="k">if</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">match_att</span><span class="p">:</span> <span class="k">continue</span>      <span class="c1">#ignore this one</span>
               <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_block</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span>
               <span class="c1">#non-looped items</span>
               <span class="k">if</span> <span class="n">new_block</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>     <span class="c1">#not looped</span>
                  <span class="bp">self</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
           <span class="n">my_loops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
           <span class="n">perfect_overlaps</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">new_block</span><span class="o">.</span><span class="n">loops</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loops</span><span class="p">]</span>
           <span class="k">for</span> <span class="n">po</span> <span class="ow">in</span> <span class="n">perfect_overlaps</span><span class="p">:</span>
              <span class="n">loop_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">po</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rel_keys</span><span class="p">]</span>  <span class="c1">#do we have a key?</span>
              <span class="k">try</span><span class="p">:</span>
                  <span class="n">newkeypos</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">newkeys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="n">loop_keys</span><span class="p">)</span>
                  <span class="n">newkeypos</span> <span class="o">=</span> <span class="n">newkeypos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>      <span class="c1">#one key per loop for now</span>
                  <span class="n">loop_keys</span> <span class="o">=</span> <span class="n">loop_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
              <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span><span class="ne">IndexError</span><span class="p">):</span>
                  <span class="n">newkeypos</span> <span class="o">=</span> <span class="p">[]</span>
                  <span class="n">overlap_data</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]),</span><span class="n">overlaps</span><span class="p">)</span> <span class="c1">#old packet data</span>
                  <span class="n">new_data</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">new_block</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">overlaps</span><span class="p">)</span> <span class="c1">#new packet data</span>
                  <span class="n">packet_data</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">overlap_data</span><span class="p">)</span>
                  <span class="n">new_p_data</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
                  <span class="c1"># remove any packets for which the keys match between old and new; we</span>
                  <span class="c1"># make the arbitrary choice that the old data stays</span>
                  <span class="k">if</span> <span class="n">newkeypos</span><span class="p">:</span>
                      <span class="c1"># get matching values in new list</span>
                      <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Old, new data:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">overlap_data</span><span class="p">[</span><span class="n">newkeypos</span><span class="p">]),</span><span class="nb">repr</span><span class="p">(</span><span class="n">new_data</span><span class="p">[</span><span class="n">newkeypos</span><span class="p">])))</span>
                      <span class="n">key_matches</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">a</span> <span class="ow">in</span> <span class="n">overlap_data</span><span class="p">[</span><span class="n">newkeypos</span><span class="p">],</span><span class="n">new_data</span><span class="p">[</span><span class="n">newkeypos</span><span class="p">])</span>
                      <span class="c1"># filter out any new data with these key values</span>
                      <span class="n">new_p_data</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">a</span><span class="p">[</span><span class="n">newkeypos</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key_matches</span><span class="p">,</span><span class="n">new_p_data</span><span class="p">)</span>
                      <span class="k">if</span> <span class="n">new_p_data</span><span class="p">:</span>
                          <span class="n">new_data</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">new_p_data</span><span class="p">)</span>
                      <span class="k">else</span><span class="p">:</span> <span class="n">new_data</span> <span class="o">=</span> <span class="p">[]</span>
                  <span class="c1"># wipe out the old data and enter the new stuff</span>
                  <span class="n">byebyeloop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">overlaps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                  <span class="c1"># print(&quot;Removing &#39;%r&#39; with overlaps &#39;%r&#39;&quot; % (byebyeloop, overlaps))</span>
                  <span class="c1"># Note that if, in the original dictionary, overlaps are not</span>
                  <span class="c1"># looped, GetLoop will return the block itself.  So we check</span>
                  <span class="c1"># for this case...</span>
                  <span class="k">if</span> <span class="n">byebyeloop</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">remove_loop</span><span class="p">(</span><span class="n">byebyeloop</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">((</span><span class="n">overlaps</span><span class="p">,</span><span class="n">overlap_data</span><span class="p">))</span>  <span class="c1">#adding old packets</span>
                  <span class="k">for</span> <span class="n">pd</span> <span class="ow">in</span> <span class="n">new_p_data</span><span class="p">:</span>                             <span class="c1">#adding new packets</span>
                     <span class="k">if</span> <span class="n">pd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">packet_data</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">overlaps</span><span class="p">)):</span>
                            <span class="c1">#don&#39;t do this at home; we are appending</span>
                            <span class="c1">#to something in place</span>
                            <span class="bp">self</span><span class="p">[</span><span class="n">overlaps</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="n">save_overwrite</span>

    <span class="k">def</span> <span class="nf">assign_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dic</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dic</span><span class="o">.</span><span class="n">diclang</span><span class="o">==</span><span class="s2">&quot;DDLm&quot;</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Warning: ignoring dictionary </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dic</span><span class="o">.</span><span class="n">my_uri</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="n">dic</span>

    <span class="k">def</span> <span class="nf">unassign_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove dictionary-dependent behaviour&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="bp">None</span>



<span class="k">class</span> <span class="nc">StarPacket</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">merge_packet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">incoming</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merge contents of incoming packet with this packet&quot;&quot;&quot;</span>
        <span class="n">new_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">incoming</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span> <span class="ow">and</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;_&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">incoming</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="n">new_attrs</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">na</span><span class="p">,</span><span class="nb">getattr</span><span class="p">(</span><span class="n">incoming</span><span class="p">,</span><span class="n">na</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">att_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Derive a missing attribute&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">att_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">att_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">att_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;cif_dictionary&#39;</span><span class="p">,</span><span class="s1">&#39;fulldata&#39;</span><span class="p">,</span><span class="s1">&#39;key&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Programming error: can only assign value of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">att_name</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cif_dictionary</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulldata</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">derive_item</span><span class="p">(</span><span class="n">att_name</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># now pick out the new value</span>
        <span class="c1"># self.key is a list of the key values</span>
        <span class="n">keydict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">v</span><span class="p">,(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="p">),</span><span class="bp">True</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">k</span><span class="p">])</span>
        <span class="n">full_pack</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">GetCompoundKeyedPacket</span><span class="p">(</span><span class="n">keydict</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">full_pack</span><span class="p">,</span><span class="n">att_name</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BlockCollection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A container for StarBlock objects. The constructor takes</span>
<span class="sd">    one non-keyword argument `datasource` to set the initial data.  If</span>
<span class="sd">    `datasource` is a Python dictionary, the values must be `StarBlock`</span>
<span class="sd">    objects and the keys will be blocknames in the new object. Keyword</span>
<span class="sd">    arguments:</span>

<span class="sd">    standard:</span>
<span class="sd">        `CIF` or `Dic`.  `CIF` enforces 75-character blocknames, and will</span>
<span class="sd">        print block contents before that block&#39;s save frame.</span>

<span class="sd">    blocktype:</span>
<span class="sd">        The type of blocks held in this container. Normally `StarBlock`</span>
<span class="sd">        or `CifBlock`.</span>

<span class="sd">    characterset:</span>
<span class="sd">        `ascii` or `unicode`.  Blocknames and datanames appearing within</span>
<span class="sd">        blocks are restricted to the appropriate characterset. Note that</span>
<span class="sd">        only characters in the basic multilingual plane are accepted. This</span>
<span class="sd">        restriction will be lifted when PyCIFRW is ported to Python3.</span>

<span class="sd">    scoping:</span>
<span class="sd">        `instance` or `dictionary`: `instance` implies that save frames are</span>
<span class="sd">        hidden from save frames lower in the hierarchy or in sibling</span>
<span class="sd">        hierarchies. `dictionary` makes all save frames visible everywhere</span>
<span class="sd">        within a data block.  This setting is only relevant for STAR2 dictionaries and</span>
<span class="sd">        STAR2 data files, as save frames are currently not used in plain CIF data</span>
<span class="sd">        files.</span>

<span class="sd">&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">datasource</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">standard</span><span class="o">=</span><span class="s1">&#39;CIF&#39;</span><span class="p">,</span><span class="n">blocktype</span> <span class="o">=</span> <span class="n">StarBlock</span><span class="p">,</span>
                 <span class="n">characterset</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span><span class="n">scoping</span><span class="o">=</span><span class="s1">&#39;instance&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">collections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">=</span> <span class="n">standard</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>           <span class="c1"># short_cuts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PC</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;PC&#39;</span><span class="p">,[</span><span class="s1">&#39;block_id&#39;</span><span class="p">,</span><span class="s1">&#39;parent&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span> <span class="o">=</span> <span class="p">[]</span>            <span class="c1"># for efficiency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span> <span class="o">=</span> <span class="p">[]</span>       <span class="c1"># to output in same order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="n">scoping</span>  <span class="c1">#will trigger setting of child table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocktype</span> <span class="o">=</span> <span class="n">blocktype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1">#for outputting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="s1">&#39;2.0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_characterset</span><span class="p">(</span><span class="n">characterset</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span><span class="n">BlockCollection</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">merge_fast</span><span class="p">(</span><span class="n">datasource</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="n">scoping</span>   <span class="c1">#reset visibility</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">datasource</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                 <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_comment</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">new_grammar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the syntax and grammar for output to `new_grammar`&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_grammar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1.1&#39;</span><span class="p">,</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span><span class="s1">&#39;2.0&#39;</span><span class="p">,</span><span class="s1">&#39;STAR2&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Unrecognised output grammar </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">new_grammar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">=</span> <span class="n">new_grammar</span>

    <span class="k">def</span> <span class="nf">set_characterset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">characterset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the allowed characters for datanames and datablocks: may be `ascii` or `unicode`. If datanames</span>
<span class="sd">        have already been added to any datablocks, they are not checked.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">characterset</span> <span class="o">=</span> <span class="n">characterset</span>
        <span class="k">for</span> <span class="n">one_block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">one_block</span><span class="p">]</span><span class="o">.</span><span class="n">set_characterset</span><span class="p">(</span><span class="n">characterset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">unlock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow overwriting of all blocks in this collection&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">overwrite</span><span class="o">=</span><span class="bp">True</span>

    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Disallow overwriting for all blocks in this collection&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">WriteOut</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NewBlock</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
           <span class="n">lowerkey</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
           <span class="k">if</span> <span class="n">lowerkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">lowerkey</span><span class="p">]</span>
           <span class="c1">#print &#39;Visible keys:&#39; + `self.visible_keys`</span>
           <span class="c1">#print &#39;All keys&#39; + `self.lower_keys`</span>
           <span class="c1">#print &#39;Child table&#39; + `self.child_table`</span>
           <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No such item </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

    <span class="c1"># we have to get an ordered list of the current keys,</span>
    <span class="c1"># as we&#39;ll have to delete one of them anyway.</span>
    <span class="c1"># Deletion will delete any key regardless of visibility</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="n">dummy</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>   <span class="c1">#raise error if not present</span>
        <span class="n">lowerkey</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1"># get rid of all children recursively as well</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">lowerkey</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">child</span><span class="p">]</span>   <span class="c1">#recursive call</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">lowerkey</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">lowerkey</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lowerkey</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lowerkey</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lowerkey</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Support the &#39;in&#39; operator&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="c1"># We iterate over all visible</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">one_block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="p">[</span><span class="n">one_block</span><span class="p">]</span>

    <span class="c1"># TODO: handle different case</span>
    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span>

    <span class="c1"># Note that has_key does not exist in 3.5</span>
    <span class="k">def</span> <span class="nf">has_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>     <span class="c1"># take account of case</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">newcopy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1">#all blocks</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">newcopy</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newcopy</span> <span class="o">=</span> <span class="n">BlockCollection</span><span class="p">(</span><span class="n">newcopy</span><span class="p">)</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">child_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">lower_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">block_input_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">characterset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">characterset</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">SetTemplate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_template</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span>  <span class="c1">#this sets visible keys</span>
        <span class="k">return</span> <span class="n">newcopy</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">adict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">adict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">adict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">first_block</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the &#39;first&#39; block.  This is not necessarily the first block in the file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">NewBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blockname</span><span class="p">,</span><span class="n">blockcontents</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">fix</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a new block named `blockname` with contents `blockcontents`. If `fix`</span>
<span class="sd">        is True, `blockname` will have spaces and tabs replaced by underscores. `parent`</span>
<span class="sd">        allows a parent block to be set so that block hierarchies can be created.  Depending on</span>
<span class="sd">        the output standard, these blocks will be printed out as nested save frames or</span>
<span class="sd">        ignored.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">blockcontents</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">blockcontents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocktype</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">==</span> <span class="s2">&quot;CIF&quot;</span><span class="p">:</span>
            <span class="n">blockcontents</span><span class="o">.</span><span class="n">setmaxnamelength</span><span class="p">(</span><span class="mi">75</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blockname</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">75</span><span class="p">:</span>
                 <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Blockname </span><span class="si">%s</span><span class="s1"> is longer than 75 characters&#39;</span> <span class="o">%</span> <span class="n">blockname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fix</span><span class="p">:</span>
            <span class="n">newblockname</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[  </span><span class="se">\t</span><span class="s1">]&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">blockname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">newblockname</span> <span class="o">=</span> <span class="n">blockname</span>
        <span class="n">new_lowerbn</span> <span class="o">=</span> <span class="n">newblockname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">new_lowerbn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>   <span class="c1">#already there</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
               <span class="n">toplevelnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">==</span><span class="bp">None</span><span class="p">]</span>
               <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">new_lowerbn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">toplevelnames</span><span class="p">:</span>  <span class="c1">#can give a new key to this one</span>
                  <span class="k">while</span> <span class="n">new_lowerbn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span> <span class="n">new_lowerbn</span> <span class="o">=</span> <span class="n">new_lowerbn</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span>
               <span class="k">elif</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">new_lowerbn</span> <span class="ow">in</span> <span class="n">toplevelnames</span><span class="p">:</span> <span class="c1">#can fix a different one</span>
                  <span class="n">replace_name</span> <span class="o">=</span> <span class="n">new_lowerbn</span>
                  <span class="k">while</span> <span class="n">replace_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span> <span class="n">replace_name</span> <span class="o">=</span> <span class="n">replace_name</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_rekey</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">,</span><span class="n">replace_name</span><span class="p">)</span>
                  <span class="c1"># now continue on to add in the new block</span>
                  <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">new_lowerbn</span><span class="p">:</span>        <span class="c1">#the new block&#39;s requested parent just got renamed!!</span>
                      <span class="n">parent</span> <span class="o">=</span> <span class="n">replace_name</span>
               <span class="k">else</span><span class="p">:</span>
                  <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s2">&quot;Attempt to replace existing block &quot;</span> <span class="o">+</span> <span class="n">blockname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">new_lowerbn</span><span class="p">:</span><span class="n">blockcontents</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">newblockname</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">==</span> <span class="s1">&#39;instance&#39;</span><span class="p">:</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">newblockname</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
              <span class="k">else</span><span class="p">:</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">newblockname</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Warning:Parent block </span><span class="si">%s</span><span class="s1"> does not exist for child </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">newblockname</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">.</span><span class="n">set_characterset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">characterset</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span>
        <span class="k">return</span> <span class="n">new_lowerbn</span>  <span class="c1">#in case calling routine wants to know</span>

    <span class="k">def</span> <span class="nf">_rekey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldname</span><span class="p">,</span><span class="n">newname</span><span class="p">,</span><span class="n">block_id</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The block with key [[oldname]] gets [[newname]] as a new key, but the printed name</span>
<span class="sd">           does not change unless [[block_id]] is given.  Prefer [[rename]] for a safe version.&quot;&quot;&quot;</span>
        <span class="n">move_block</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">oldname</span><span class="p">]</span>    <span class="c1">#old block</span>
        <span class="n">is_visible</span> <span class="o">=</span> <span class="n">oldname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span>
        <span class="n">move_block_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">oldname</span><span class="p">]</span>    <span class="c1">#old info</span>
        <span class="n">move_block_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">==</span><span class="n">oldname</span><span class="p">]</span>
        <span class="c1"># now rewrite the necessary bits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">([(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span><span class="p">,</span><span class="n">newname</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">move_block_children</span><span class="p">]))</span>
        <span class="n">oldpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">oldname</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">oldname</span><span class="p">]</span>   <span class="c1">#do this after updating child table so we don&#39;t delete children</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">newname</span><span class="p">:</span><span class="n">move_block</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">newname</span><span class="p">)</span>
        <span class="c1">#print &#39;Block input order was: &#39; + `self.block_input_order`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span><span class="p">[</span><span class="n">oldpos</span><span class="p">:</span><span class="n">oldpos</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">newname</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">block_id</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">newname</span><span class="p">:</span><span class="n">move_block_info</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">newname</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">block_id</span><span class="p">,</span><span class="n">move_block_info</span><span class="o">.</span><span class="n">parent</span><span class="p">)})</span>
        <span class="k">if</span> <span class="n">is_visible</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span> <span class="o">+=</span> <span class="p">[</span><span class="n">newname</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldname</span><span class="p">,</span><span class="n">newname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rename datablock from [[oldname]] to [[newname]]. Both key and printed name are changed.  No</span>
<span class="sd">           conformance checks are conducted.&quot;&quot;&quot;</span>
        <span class="n">realoldname</span> <span class="o">=</span> <span class="n">oldname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">realnewname</span> <span class="o">=</span> <span class="n">newname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">realnewname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Cannot change blockname </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> as </span><span class="si">%s</span><span class="s1"> already present&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">oldname</span><span class="p">,</span><span class="n">newname</span><span class="p">,</span><span class="n">newname</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">realoldname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Cannot find old block </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">realoldname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rekey</span><span class="p">(</span><span class="n">realoldname</span><span class="p">,</span><span class="n">realnewname</span><span class="p">,</span><span class="n">block_id</span><span class="o">=</span><span class="n">newname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">makebc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">namelist</span><span class="p">,</span><span class="n">scoping</span><span class="o">=</span><span class="s1">&#39;dictionary&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a block collection from a list of block names&quot;&quot;&quot;</span>
        <span class="n">newbc</span> <span class="o">=</span> <span class="n">BlockCollection</span><span class="p">()</span>
        <span class="n">block_lower</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">namelist</span><span class="p">]</span>
        <span class="n">proto_child_table</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">block_lower</span><span class="p">]</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">child_table</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">proto_child_table</span><span class="p">)</span>
        <span class="n">new_top_level</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span><span class="p">,</span><span class="bp">None</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">newbc</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">block_lower</span><span class="p">]</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">new_top_level</span><span class="p">))</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">lower_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">proto_child_table</span><span class="p">])</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">proto_child_table</span><span class="p">)</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="n">scoping</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">block_input_order</span> <span class="o">=</span> <span class="n">block_lower</span>
        <span class="k">return</span> <span class="n">newbc</span>


    <span class="k">def</span> <span class="nf">merge_fast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">new_bc</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do a fast merge. WARNING: this may change one or more of its frame headers in order to</span>
<span class="sd">        remove duplicate frames.  Please keep a handle to the block object instead of the text of</span>
<span class="sd">        the header.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;replace&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;strict&#39;</span>
        <span class="n">overlap_flag</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">new_bc</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">parent_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">parent</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent_name</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent_name</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;Unable to find unique parent block name: have </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">parent_name</span><span class="p">))</span>
            <span class="n">parent_name</span> <span class="o">=</span> <span class="n">parent_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent_name</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1">#an error will be thrown if we treat as a string</span>
        <span class="k">if</span> <span class="n">overlap_flag</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span>
            <span class="n">double_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">new_bc</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dup_key</span> <span class="ow">in</span> <span class="n">double_keys</span><span class="p">:</span>
                  <span class="n">our_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">dup_key</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span>
                  <span class="n">their_parent</span> <span class="o">=</span> <span class="n">new_bc</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">dup_key</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">our_parent</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">their_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span>\
                      <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="c1">#rename our block</span>
                    <span class="n">start_key</span> <span class="o">=</span> <span class="n">dup_key</span>
                    <span class="k">while</span> <span class="n">start_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span> <span class="n">start_key</span> <span class="o">=</span> <span class="n">start_key</span><span class="o">+</span><span class="s1">&#39;+&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rekey</span><span class="p">(</span><span class="n">dup_key</span><span class="p">,</span><span class="n">start_key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">parent_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">dup_key</span><span class="p">:</span>  <span class="c1">#we just renamed the prospective parent!</span>
                        <span class="n">parent_name</span> <span class="o">=</span> <span class="n">start_key</span>
                  <span class="k">elif</span> <span class="n">our_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">their_parent</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">start_key</span> <span class="o">=</span> <span class="n">dup_key</span>
                    <span class="k">while</span> <span class="n">start_key</span> <span class="ow">in</span> <span class="n">new_bc</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span> <span class="n">start_key</span> <span class="o">=</span> <span class="n">start_key</span><span class="o">+</span><span class="s1">&#39;+&#39;</span>
                    <span class="n">new_bc</span><span class="o">.</span><span class="n">_rekey</span><span class="p">(</span><span class="n">dup_key</span><span class="p">,</span><span class="n">start_key</span><span class="p">)</span>
                  <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;In strict merge mode:duplicate keys </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dup_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_bc</span><span class="o">.</span><span class="n">dictionary</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_bc</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">new_bc</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span> <span class="o">+=</span> <span class="n">new_bc</span><span class="o">.</span><span class="n">block_input_order</span>
        <span class="c1">#print(&#39;Block input order now:&#39; + repr(self.block_input_order))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_bc</span><span class="o">.</span><span class="n">child_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>     <span class="c1">#redo the child_table entries</span>
              <span class="n">reparent_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">new_bc</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">==</span><span class="bp">None</span><span class="p">]</span>
              <span class="n">reparent_dict</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">parent_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">reparent_list</span><span class="p">]</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">reparent_dict</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">new_bc</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">single_block</span><span class="o">=</span><span class="p">[],</span>
                   <span class="n">idblock</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">match_att</span><span class="o">=</span><span class="p">[],</span><span class="n">match_function</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
               <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;replace&#39;</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;strict&#39;</span>
        <span class="k">if</span> <span class="n">single_block</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">single_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">new_bc</span><span class="p">[</span><span class="n">single_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">mode</span><span class="p">,</span>
                                                   <span class="n">match_att</span><span class="o">=</span><span class="n">match_att</span><span class="p">,</span>
                                                   <span class="n">match_function</span><span class="o">=</span><span class="n">match_function</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">base_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">block_to_item</span> <span class="o">=</span> <span class="n">base_keys</span>   <span class="c1">#default</span>
        <span class="n">new_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">new_bc</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>    <span class="c1">#get list of incoming blocks</span>
        <span class="k">if</span> <span class="n">match_att</span><span class="p">:</span>
            <span class="c1">#make a blockname -&gt; item name map</span>
            <span class="k">if</span> <span class="n">match_function</span><span class="p">:</span>
                <span class="n">block_to_item</span> <span class="o">=</span> <span class="p">[</span><span class="n">match_function</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">block_to_item</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">match_att</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="c1">#print `block_to_item`</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_keys</span><span class="p">:</span>        <span class="c1">#run over incoming blocknames</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">idblock</span><span class="p">:</span> <span class="k">continue</span>    <span class="c1">#skip dictionary id</span>
            <span class="n">basekey</span> <span class="o">=</span> <span class="n">key</span>           <span class="c1">#default value</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_att</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
               <span class="n">attval</span> <span class="o">=</span> <span class="n">new_bc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">match_att</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>  <span class="c1">#0 if ignoring matching</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">attval</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">block_to_item</span><span class="p">)):</span>  <span class="c1">#do this way to get looped names</span>
                <span class="n">thisatt</span> <span class="o">=</span> <span class="n">block_to_item</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>       <span class="c1">#keyname in old block</span>
                <span class="c1">#print &quot;Looking for %s in %s&quot; % (attval,thisatt)</span>
                <span class="k">if</span> <span class="n">attval</span> <span class="o">==</span> <span class="n">thisatt</span> <span class="ow">or</span> \
                   <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">thisatt</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attval</span> <span class="ow">in</span> <span class="n">thisatt</span><span class="p">):</span>
                      <span class="n">basekey</span> <span class="o">=</span> <span class="n">base_keys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                      <span class="n">block_to_item</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thisatt</span><span class="p">)</span>
                      <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">basekey</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">or</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;replace&quot;</span><span class="p">:</span>
                <span class="n">new_parent</span> <span class="o">=</span> <span class="n">new_bc</span><span class="o">.</span><span class="n">get_parent</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">new_parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                   <span class="n">new_parent</span> <span class="o">=</span> <span class="n">parent</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">NewBlock</span><span class="p">(</span><span class="n">basekey</span><span class="p">,</span><span class="n">new_bc</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="n">parent</span><span class="o">=</span><span class="n">new_parent</span><span class="p">)</span>   <span class="c1">#add the block</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;strict&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s2">&quot;In strict merge mode: block </span><span class="si">%s</span><span class="s2"> in old and block </span><span class="si">%s</span><span class="s2"> in new files&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">basekey</span><span class="p">,</span><span class="n">key</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;overlay&quot;</span><span class="p">:</span>
                    <span class="c1"># print &quot;Merging block %s with %s&quot; % (basekey,key)</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">basekey</span><span class="p">]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">new_bc</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="n">mode</span><span class="p">,</span><span class="n">match_att</span><span class="o">=</span><span class="n">match_att</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s2">&quot;Merge called with unknown mode </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">checknamelengths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">target_block</span><span class="p">,</span><span class="n">maxlength</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">maxlength</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">toolong</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">target_block</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">&gt;</span><span class="n">maxlength</span><span class="p">]</span>
        <span class="n">outstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">toolong</span><span class="p">:</span>
           <span class="n">outstring</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolong</span><span class="p">)</span>
           <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Following data names too long:&#39;</span> <span class="o">+</span> <span class="n">outstring</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">):</span>
        <span class="n">raw_values</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">raw_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">raw_values</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">]</span>
        <span class="n">ret_vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rv</span> <span class="ow">in</span> <span class="n">raw_values</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">rvv</span> <span class="ow">in</span> <span class="n">rv</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rvv</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ret_vals</span><span class="p">:</span> <span class="n">ret_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rvv</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rv</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ret_vals</span><span class="p">:</span> <span class="n">ret_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret_vals</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attr_name</span><span class="p">,</span><span class="n">newval</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr_name</span> <span class="o">==</span> <span class="s1">&#39;scoping&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">newval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;dictionary&#39;</span><span class="p">,</span><span class="s1">&#39;instance&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;Star file may only have &#39;dictionary&#39; or &#39;instance&#39; scoping, not </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">newval</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newval</span> <span class="o">==</span> <span class="s1">&#39;dictionary&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#only top-level datablocks visible</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">==</span><span class="bp">None</span><span class="p">]</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attr_name</span><span class="p">,</span><span class="n">newval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blockname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the name of the block enclosing [[blockname]] in canonical form (lower case)&quot;&quot;&quot;</span>
        <span class="n">possibles</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">blockname</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">first</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">possibles</span><span class="p">)</span>   <span class="c1">#get first one</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;no parent for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">blockname</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
           <span class="n">second</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">possibles</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
           <span class="k">return</span> <span class="n">first</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;More than one parent for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">blockname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_roots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the top-level blocks&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">==</span><span class="bp">None</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blockname</span><span class="p">,</span><span class="n">include_parent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">scoping</span><span class="o">=</span><span class="s1">&#39;dictionary&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all children of [[blockname]] as a block collection. If [[include_parent]] is</span>
<span class="sd">        True, the parent block will also be included in the block collection as the root.&quot;&quot;&quot;</span>
        <span class="n">newbc</span> <span class="o">=</span> <span class="n">BlockCollection</span><span class="p">()</span>
        <span class="n">block_lower</span> <span class="o">=</span> <span class="n">blockname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">proto_child_table</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_child_of_parent</span><span class="p">(</span><span class="n">block_lower</span><span class="p">,</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span><span class="p">)]</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">child_table</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">proto_child_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_parent</span><span class="p">:</span>
           <span class="n">newbc</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">([(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span><span class="p">,</span><span class="bp">None</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">proto_child_table</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">block_lower</span><span class="p">]))</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">lower_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">proto_child_table</span><span class="p">])</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">proto_child_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_parent</span><span class="p">:</span>
            <span class="n">newbc</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">block_lower</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">block_lower</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span><span class="p">,</span><span class="bp">None</span><span class="p">)})</span>
            <span class="n">newbc</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">block_lower</span><span class="p">)</span>
            <span class="n">newbc</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">block_lower</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">block_lower</span><span class="p">]})</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="n">scoping</span>
        <span class="k">return</span> <span class="n">newbc</span>

    <span class="k">def</span> <span class="nf">get_immediate_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parentname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the next level of children of the given block as a list, without nested levels&quot;&quot;&quot;</span>
        <span class="n">child_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">parentname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">child_handles</span>

    <span class="c1"># This takes time</span>
    <span class="k">def</span> <span class="nf">get_child_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parentname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of all child categories in alphabetical order&quot;&quot;&quot;</span>
        <span class="n">child_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_child_of_parent</span><span class="p">(</span><span class="n">parentname</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">child_handles</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">child_handles</span>

    <span class="k">def</span> <span class="nf">is_child_of_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parentname</span><span class="p">,</span><span class="n">blockname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return `True` if `blockname` is a child of `parentname`&quot;&quot;&quot;</span>
        <span class="n">checkname</span> <span class="o">=</span> <span class="n">parentname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">more_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">checkname</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">blockname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">more_children</span><span class="p">:</span>
           <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="k">for</span> <span class="n">one_child</span> <span class="ow">in</span> <span class="n">more_children</span><span class="p">:</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_child_of_parent</span><span class="p">(</span><span class="n">one_child</span><span class="p">,</span><span class="n">blockname</span><span class="p">):</span> <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parentname</span><span class="p">,</span><span class="n">childname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the parent block&quot;&quot;&quot;</span>
        <span class="c1"># first check that both blocks exist</span>
        <span class="k">if</span> <span class="n">parentname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Parent block </span><span class="si">%s</span><span class="s1"> does not exist&#39;</span> <span class="o">%</span> <span class="n">parentname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">childname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Child block </span><span class="si">%s</span><span class="s1"> does not exist&#39;</span> <span class="o">%</span> <span class="n">childname</span><span class="p">)</span>
        <span class="n">old_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">childname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">childname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">old_entry</span><span class="o">.</span><span class="n">block_id</span><span class="p">,</span>
               <span class="n">parentname</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="c1">#reset visibility</span>

    <span class="k">def</span> <span class="nf">SetTemplate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">template_file</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Use `template_file` as a template for all block output&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span> <span class="o">=</span> <span class="n">process_template</span><span class="p">(</span><span class="n">template_file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">b</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span>

    <span class="k">def</span> <span class="nf">WriteOut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">comment</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">wraplength</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">maxoutlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">blockorder</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">saves_after</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the contents of this file as a string, wrapping if possible at `wraplength`</span>
<span class="sd">        characters and restricting maximum line length to `maxoutlength`.  Delimiters and</span>
<span class="sd">        save frame nesting are controlled by `self.grammar`. If `blockorder` is</span>
<span class="sd">        provided, blocks are output in this order unless nested save frames have been</span>
<span class="sd">        requested (STAR2). The default block order is the order in which blocks were input.</span>
<span class="sd">        `saves_after` inserts all save frames after the given dataname,</span>
<span class="sd">        which allows less important items to appear later.  Useful in conjunction with a</span>
<span class="sd">        template for dictionary files.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">maxoutlength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SetOutputLength</span><span class="p">(</span><span class="n">maxoutlength</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_comment</span>
        <span class="n">outstring</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">==</span> <span class="s2">&quot;2.0&quot;</span> <span class="ow">and</span> <span class="n">comment</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">!=</span> <span class="sa">r</span><span class="s2">&quot;#\#CIF_2.0&quot;</span><span class="p">:</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;#\#CIF_2.0&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="c1"># prepare all blocks</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">b</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span>
            <span class="n">b</span><span class="o">.</span><span class="n">SetOutputLength</span><span class="p">(</span><span class="n">wraplength</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span><span class="p">)</span>
        <span class="c1"># loop over top-level</span>
        <span class="c1"># monitor output</span>
        <span class="n">all_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>   <span class="c1">#i.e. lower case</span>
        <span class="k">if</span> <span class="n">blockorder</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">blockorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span>
        <span class="n">top_block_names</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">blockorder</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">blockref</span><span class="p">,</span><span class="n">blockname</span> <span class="ow">in</span> <span class="n">top_block_names</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">%s</span><span class="s1">, &#39;</span> <span class="o">%</span> <span class="n">blockname</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]))</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;data_&#39;</span> <span class="o">+</span><span class="n">blockname</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">all_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">blockref</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">==</span> <span class="s1">&#39;Dic&#39;</span><span class="p">:</span>              <span class="c1">#put contents before save frames</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]</span><span class="o">.</span><span class="n">printsection</span><span class="p">(</span><span class="n">finish_at</span><span class="o">=</span><span class="s1">&#39;_dictionary_valid.application&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">==</span> <span class="s1">&#39;STAR2&#39;</span><span class="p">:</span>  <span class="c1">#nested save frames</span>
                <span class="n">child_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_immediate_children</span><span class="p">(</span><span class="n">blockref</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">child_ref</span><span class="p">,</span><span class="n">child_info</span> <span class="ow">in</span> <span class="n">child_refs</span><span class="p">:</span>
                    <span class="n">child_name</span> <span class="o">=</span> <span class="n">child_info</span><span class="o">.</span><span class="n">block_id</span>
                    <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="n">child_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">block_to_string_nested</span><span class="p">(</span><span class="n">child_ref</span><span class="p">,</span><span class="n">child_name</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                    <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span><span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span><span class="s1">&#39;1.1&#39;</span><span class="p">,</span><span class="s1">&#39;2.0&#39;</span><span class="p">):</span>                   <span class="c1">#non-nested save frames</span>
                <span class="n">child_refs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">blockorder</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_child_of_parent</span><span class="p">(</span><span class="n">blockref</span><span class="p">,</span><span class="n">a</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">child_ref</span> <span class="ow">in</span> <span class="n">child_refs</span><span class="p">:</span>
                    <span class="n">child_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">child_ref</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span>
                    <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="n">child_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">child_ref</span><span class="p">]))</span>
                    <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">all_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">child_ref</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Grammar </span><span class="si">%s</span><span class="s1"> is not recognised for output&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">!=</span> <span class="s1">&#39;Dic&#39;</span><span class="p">:</span>              <span class="c1">#put contents after save frames</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]</span><span class="o">.</span><span class="n">printsection</span><span class="p">(</span><span class="n">start_from</span><span class="o">=</span><span class="s1">&#39;_dictionary_valid.application&#39;</span><span class="p">))</span>
        <span class="n">returnstring</span> <span class="o">=</span>  <span class="n">outstring</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">outstring</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;WARNING: following blocks not output: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">all_names</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;All blocks output.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">returnstring</span>

    <span class="k">def</span> <span class="nf">block_to_string_nested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">block_ref</span><span class="p">,</span><span class="n">block_id</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="n">indentlevel</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Output a complete datablock indexed by [[block_ref]] and named [[block_id]], including children,</span>
<span class="sd">           and syntactically nesting save frames&quot;&quot;&quot;</span>
        <span class="n">child_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_immediate_children</span><span class="p">(</span><span class="n">block_ref</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">block_ref</span><span class="p">]</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">==</span> <span class="s1">&#39;Dic&#39;</span><span class="p">:</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">block_ref</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">child_ref</span><span class="p">,</span><span class="n">child_info</span> <span class="ow">in</span> <span class="n">child_refs</span><span class="p">:</span>
            <span class="n">child_name</span> <span class="o">=</span> <span class="n">child_info</span><span class="o">.</span><span class="n">block_id</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="n">child_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_to_string_nested</span><span class="p">(</span><span class="n">child_ref</span><span class="p">,</span><span class="n">child_name</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="n">indentlevel</span><span class="p">)</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span><span class="o">*</span><span class="n">indentlevel</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">!=</span> <span class="s1">&#39;Dic&#39;</span><span class="p">:</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">block_ref</span><span class="p">]))</span>


<span class="k">class</span> <span class="nc">StarFile</span><span class="p">(</span><span class="n">BlockCollection</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">datasource</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">maxinlength</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">maxoutlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">scoping</span><span class="o">=</span><span class="s1">&#39;instance&#39;</span><span class="p">,</span><span class="n">grammar</span><span class="o">=</span><span class="s1">&#39;1.1&#39;</span><span class="p">,</span><span class="n">scantype</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span>
                 <span class="n">permissive</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StarFile</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">datasource</span><span class="o">=</span><span class="n">datasource</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_uri</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span><span class="s1">&#39;my_uri&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maxoutlength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span> <span class="o">=</span> <span class="mi">2048</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span> <span class="o">=</span> <span class="n">maxoutlength</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="n">scoping</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datasource</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span><span class="s2">&quot;read&quot;</span><span class="p">):</span>
            <span class="n">ReadStar</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span><span class="n">prepared</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">grammar</span><span class="o">=</span><span class="n">grammar</span><span class="p">,</span><span class="n">scantype</span><span class="o">=</span><span class="n">scantype</span><span class="p">,</span>
                     <span class="n">maxlength</span> <span class="o">=</span> <span class="n">maxinlength</span><span class="p">,</span><span class="n">permissive</span><span class="o">=</span><span class="n">permissive</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_comment</span> <span class="o">=</span> \
<span class="sd">&quot;&quot;&quot;#\\#STAR</span>
<span class="sd">##########################################################################</span>
<span class="sd">#               STAR Format file</span>
<span class="sd">#               Produced by PySTARRW module</span>
<span class="sd">#</span>
<span class="sd">#  This is a STAR file.  STAR is a superset of the CIF file type.  For</span>
<span class="sd">#  more information, please refer to International Tables for Crystallography,</span>
<span class="sd">#  Volume G, Chapter 2.1</span>
<span class="sd">#</span>
<span class="sd">##########################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">set_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">my_uri</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_uri</span> <span class="o">=</span> <span class="n">my_uri</span>


<span class="k">class</span> <span class="nc">CIFStringIO</span><span class="p">(</span><span class="n">StringIO</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">target_width</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">StringIO</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_width</span> <span class="o">=</span> <span class="n">target_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabwidth</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_char</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="n">canbreak</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">mustbreak</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">do_tab</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">newindent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">unindent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                             <span class="n">delimiter</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">startcol</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a string with correct linebreak, tabs and indents&quot;&quot;&quot;</span>
        <span class="c1"># do we need to break?</span>
        <span class="k">if</span> <span class="n">delimiter</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outstring</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Delimiter </span><span class="si">%s</span><span class="s1"> is longer than one character&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">outstring</span> <span class="p">))</span>
            <span class="n">output_delimiter</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">mustbreak</span><span class="p">:</span>    <span class="c1">#insert a new line and indent</span>
            <span class="n">temp_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">StringIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">temp_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_char</span> <span class="o">=</span> <span class="n">temp_string</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">outstring</span><span class="p">)</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">target_width</span><span class="p">:</span> <span class="c1">#try to break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">delimiter</span> <span class="ow">and</span> <span class="n">outstring</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>          <span class="c1">#ie &lt;cr&gt;;</span>
              <span class="k">if</span> <span class="n">canbreak</span><span class="p">:</span>
                <span class="n">temp_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">StringIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">temp_string</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_char</span> <span class="o">=</span> <span class="n">temp_string</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>        <span class="c1">#assume a break will be forced on next value</span>
                <span class="n">output_delimiter</span> <span class="o">=</span> <span class="bp">False</span>    <span class="c1">#the line break becomes the delimiter</span>
        <span class="c1">#try to match requested column</span>
        <span class="k">if</span> <span class="n">startcol</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">&lt;</span> <span class="n">startcol</span><span class="p">:</span>
                <span class="n">StringIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,(</span><span class="n">startcol</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span><span class="p">)</span><span class="o">*</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">=</span> <span class="n">startcol</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_char</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Could not format </span><span class="si">%s</span><span class="s1"> at column </span><span class="si">%d</span><span class="s1"> as already at </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outstring</span><span class="p">,</span><span class="n">startcol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span><span class="p">))</span>
                <span class="n">startcol</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>   <span class="c1">#so that tabbing works as a backup</span>
        <span class="c1">#handle tabs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tabwidth</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">do_tab</span> <span class="ow">and</span> <span class="n">startcol</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">next_stop</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">tabwidth</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">tabwidth</span>
            <span class="c1">#print &#39;Currentpos %d: Next tab stop at %d&#39; % (self.currentpos,next_stop)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">&lt;</span> <span class="n">next_stop</span><span class="p">:</span>
                <span class="n">StringIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,(</span><span class="n">next_stop</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">=</span> <span class="n">next_stop</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_char</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
        <span class="c1">#calculate indentation after tabs and col setting applied</span>
        <span class="k">if</span> <span class="n">newindent</span><span class="p">:</span>           <span class="c1">#indent by current amount</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>    <span class="c1">#first time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span><span class="p">)</span>
                <span class="c1"># print &#39;Indentlist: &#39; + `self.indentlist`</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">unindent</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Warning: cannot unindent any further&#39;</span><span class="p">)</span>
        <span class="c1">#check that we still need a delimiter</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_char</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">]:</span>
            <span class="n">output_delimiter</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1">#now output the string - every invocation comes through here</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">delimiter</span> <span class="ow">and</span> <span class="n">output_delimiter</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">delimiter</span><span class="p">:</span>
            <span class="n">StringIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outstring</span><span class="p">)</span>
        <span class="n">last_line_break</span> <span class="o">=</span> <span class="n">outstring</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last_line_break</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">outstring</span><span class="p">)</span><span class="o">-</span><span class="n">last_line_break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">outstring</span><span class="p">)</span>
        <span class="c1">#remember the last character</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outstring</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_char</span> <span class="o">=</span> <span class="n">outstring</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">set_tab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tabwidth</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the tab stop position&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabwidth</span> <span class="o">=</span> <span class="n">tabwidth</span>

<span class="k">class</span> <span class="nc">StarError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Star Format error: &#39;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

<span class="k">class</span> <span class="nc">StarLengthError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Star length error: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

<span class="k">class</span> <span class="nc">StarDerivationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fail_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_name</span> <span class="o">=</span> <span class="n">fail_name</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Derivation of </span><span class="si">%s</span><span class="s2"> failed, None returned&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_name</span>

<span class="c1">#</span>
<span class="c1"># This is subclassed from AttributeError in order to allow hasattr</span>
<span class="c1"># to work.</span>
<span class="c1">#</span>
<span class="k">class</span> <span class="nc">StarDerivationFailure</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fail_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_name</span> <span class="o">=</span> <span class="n">fail_name</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Derivation of </span><span class="si">%s</span><span class="s2"> failed&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_name</span>

<span class="k">def</span> <span class="nf">ReadStar</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">prepared</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">maxlength</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
             <span class="n">scantype</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span><span class="n">grammar</span><span class="o">=</span><span class="s1">&#39;STAR2&#39;</span><span class="p">,</span><span class="n">CBF</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">permissive</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; Read in a STAR file, returning the contents in the `prepared` object.</span>

<span class="sd">    * `filename` may be a URL, a file</span>
<span class="sd">    path on the local system, or any object with a `read` method.</span>

<span class="sd">    * `prepared` provides a `StarFile` or `CifFile` object that the contents of `filename`</span>
<span class="sd">    will be added to.</span>

<span class="sd">    * `maxlength` is the maximum allowable line length in the input file. This has been set at</span>
<span class="sd">    2048 characters for CIF but is unlimited (-1) for STAR files.</span>

<span class="sd">    * `grammar` chooses the STAR grammar variant. `1.0` is the original 1992 CIF/STAR grammar and `1.1`</span>
<span class="sd">    is identical except for the exclusion of square brackets as the first characters in</span>
<span class="sd">    undelimited datanames. `2.0` will read files in the CIF2.0 standard, and `STAR2` will</span>
<span class="sd">    read files according to the STAR2 publication.  If grammar is `None` or `auto`, autodetection</span>
<span class="sd">    will be attempted in the order `2.0`, `1.1` and `1.0`. This will always succeed for conformant CIF2.0 files.</span>
<span class="sd">    Note that (nested) save frames are read in all grammar variations and then flagged afterwards if</span>
<span class="sd">    they do not match the requested grammar.</span>

<span class="sd">    * `scantype` can be `standard` or `flex`.  `standard` provides pure Python parsing at the</span>
<span class="sd">    cost of a factor of 10 or so in speed.  `flex` will tokenise the input CIF file using</span>
<span class="sd">    fast C routines.  Note that running PyCIFRW in Jython uses native Java regular expressions</span>
<span class="sd">    to provide a speedup regardless of this argument.</span>

<span class="sd">    * `CBF` flags that the input file is in Crystallographic Binary File format. The binary block is</span>
<span class="sd">    excised from the input data stream before parsing and is not available in the returned object.</span>

<span class="sd">    * `permissive` allows non UTF8 encodings (currently only latin1) in the input file. These are a </span>
<span class="sd">    violation of the standard.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># save desired scoping</span>
    <span class="n">save_scoping</span> <span class="o">=</span> <span class="n">prepared</span><span class="o">.</span><span class="n">scoping</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">YappsStarParser_1_1</span> <span class="k">as</span> <span class="n">Y11</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">YappsStarParser_1_0</span> <span class="k">as</span> <span class="n">Y10</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">YappsStarParser_2_0</span> <span class="k">as</span> <span class="n">Y20</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">YappsStarParser_STAR2</span> <span class="k">as</span> <span class="n">YST</span>
    <span class="k">if</span> <span class="n">prepared</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">prepared</span> <span class="o">=</span> <span class="n">StarFile</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">grammar</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span> <span class="ow">or</span> <span class="n">grammar</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">try_list</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;2.0&#39;</span><span class="p">,</span><span class="n">Y20</span><span class="p">),(</span><span class="s1">&#39;1.1&#39;</span><span class="p">,</span><span class="n">Y11</span><span class="p">),(</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span><span class="n">Y10</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">grammar</span> <span class="o">==</span> <span class="s1">&#39;1.0&#39;</span><span class="p">:</span>
        <span class="n">try_list</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span><span class="n">Y10</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">grammar</span> <span class="o">==</span> <span class="s1">&#39;1.1&#39;</span><span class="p">:</span>
        <span class="n">try_list</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;1.1&#39;</span><span class="p">,</span><span class="n">Y11</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">grammar</span> <span class="o">==</span> <span class="s1">&#39;2.0&#39;</span><span class="p">:</span>
        <span class="n">try_list</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;2.0&#39;</span><span class="p">,</span><span class="n">Y20</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">grammar</span> <span class="o">==</span> <span class="s1">&#39;STAR2&#39;</span><span class="p">:</span>
        <span class="n">try_list</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;STAR2&#39;</span><span class="p">,</span><span class="n">YST</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Unknown STAR/CIF grammar requested, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">grammar</span> <span class="p">))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
        <span class="c1"># create an absolute URL</span>
        <span class="n">relpath</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">relpath</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="n">fullpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fullpath</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="n">newrel</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span>
            <span class="n">newrel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;file&quot;</span>
            <span class="n">newrel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">fullpath</span>
            <span class="n">my_uri</span> <span class="o">=</span> <span class="n">urlunparse</span><span class="p">(</span><span class="n">newrel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">my_uri</span> <span class="o">=</span> <span class="n">urlunparse</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span>
        <span class="c1"># print(&quot;Full URL is: &quot; + my_uri)</span>
        <span class="n">filestream</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">my_uri</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">filestream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8-sig&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">permissive</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">filestream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: bad encoding (must be utf8 or ascii)&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">filestream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filestream</span> <span class="o">=</span> <span class="n">filename</span>   <span class="c1">#already opened for us</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">filestream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8-sig&#39;</span><span class="p">)</span>  <span class="c1">#CIF is always ascii/utf8</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">permissive</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">filestream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;Bad input encoding (must be utf8 or ascii)&quot;</span><span class="p">)</span>
        <span class="n">my_uri</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>      <span class="c1"># empty file, return empty block</span>
        <span class="k">return</span> <span class="n">prepared</span><span class="o">.</span><span class="n">set_uri</span><span class="p">(</span><span class="n">my_uri</span><span class="p">)</span>
    <span class="c1"># filter out non-ASCII characters in CBF files if required.  We assume</span>
    <span class="c1"># that the binary is enclosed in a fixed string that occurs</span>
    <span class="c1"># nowhere else.</span>
    <span class="k">if</span> <span class="n">CBF</span><span class="p">:</span>
       <span class="n">text_bits</span>  <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-BINARY-FORMAT-SECTION-&quot;</span><span class="p">)</span>
       <span class="n">text</span> <span class="o">=</span> <span class="n">text_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
       <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">text_bits</span><span class="p">),</span><span class="mi">2</span><span class="p">):</span>
           <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">+</span><span class="s2">&quot; (binary omitted)&quot;</span><span class="o">+</span><span class="n">text_bits</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
    <span class="c1"># we recognise ctrl-Z as end of file</span>
    <span class="n">endoffile</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">26</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">endoffile</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="n">endoffile</span><span class="p">]</span>
    <span class="n">split</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxlength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">toolong</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">split</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">&gt;</span><span class="n">maxlength</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">toolong</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">split</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">toolong</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Line </span><span class="si">%d</span><span class="s1"> contains more than </span><span class="si">%d</span><span class="s1"> characters&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">maxlength</span><span class="p">))</span>
    <span class="c1"># honour the header string</span>
    <span class="k">if</span> <span class="n">text</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;#\#CIF_2.0&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;2.0&#39;</span><span class="p">,</span><span class="n">Y20</span><span class="p">)</span> <span class="ow">in</span> <span class="n">try_list</span><span class="p">:</span>
        <span class="n">try_list</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="s1">&#39;2.0&#39;</span><span class="p">,</span><span class="n">Y20</span><span class="p">),)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">try_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">%s</span><span class="s1"> missing CIF2.0 header&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">grammar_name</span><span class="p">,</span><span class="n">Y</span> <span class="ow">in</span> <span class="n">try_list</span><span class="p">:</span>
       <span class="k">if</span> <span class="n">scantype</span> <span class="o">==</span> <span class="s1">&#39;standard&#39;</span> <span class="ow">or</span> <span class="n">grammar_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;2.0&#39;</span><span class="p">,</span><span class="s1">&#39;STAR2&#39;</span><span class="p">]:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">StarParser</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">StarParserScanner</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
       <span class="k">else</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">StarParser</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">yappsrt</span><span class="o">.</span><span class="n">Scanner</span><span class="p">(</span><span class="bp">None</span><span class="p">,[],</span><span class="n">text</span><span class="p">,</span><span class="n">scantype</span><span class="o">=</span><span class="s1">&#39;flex&#39;</span><span class="p">))</span>
       <span class="c1"># handle encoding switch</span>
       <span class="k">if</span> <span class="n">grammar_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;2.0&#39;</span><span class="p">,</span><span class="s1">&#39;STAR2&#39;</span><span class="p">]:</span>
           <span class="n">prepared</span><span class="o">.</span><span class="n">set_characterset</span><span class="p">(</span><span class="s1">&#39;unicode&#39;</span><span class="p">)</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="n">prepared</span><span class="o">.</span><span class="n">set_characterset</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
       <span class="n">proto_star</span> <span class="o">=</span> <span class="bp">None</span>
       <span class="k">try</span><span class="p">:</span>
           <span class="n">proto_star</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span><span class="s2">&quot;input&quot;</span><span class="p">)(</span><span class="n">prepared</span><span class="p">)</span>
       <span class="k">except</span> <span class="n">Y</span><span class="o">.</span><span class="n">yappsrt</span><span class="o">.</span><span class="n">YappsSyntaxError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
           <span class="nb">input</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_scanner</span><span class="o">.</span><span class="n">input</span>
           <span class="n">Y</span><span class="o">.</span><span class="n">yappsrt</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">parser</span><span class="o">.</span><span class="n">_scanner</span><span class="p">)</span>
       <span class="k">except</span> <span class="n">Y</span><span class="o">.</span><span class="n">yappsrt</span><span class="o">.</span><span class="n">NoMoreTokens</span><span class="p">:</span>
           <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Could not complete parsing; stopped around here:&#39;</span><span class="p">,</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
           <span class="k">print</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">_scanner</span><span class="p">,</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
       <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
           <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Unexpected error:&#39;</span><span class="p">)</span>
           <span class="kn">import</span> <span class="nn">traceback</span>
           <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
       <span class="k">if</span> <span class="n">proto_star</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
           <span class="n">proto_star</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="n">grammar_name</span><span class="p">)</span>   <span class="c1">#remember for output</span>
           <span class="k">break</span>
    <span class="k">if</span> <span class="n">proto_star</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">errorstring</span> <span class="o">=</span> <span class="s1">&#39;Syntax error in input file: last value parsed was </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Y</span><span class="o">.</span><span class="n">lastval</span>
        <span class="n">errorstring</span> <span class="o">=</span> <span class="n">errorstring</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Parser status: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">parser</span><span class="o">.</span><span class="n">_scanner</span> <span class="p">)</span>
        <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="n">errorstring</span><span class="p">)</span>
    <span class="c1"># set visibility correctly</span>
    <span class="n">proto_star</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="s1">&#39;dictionary&#39;</span>
    <span class="n">proto_star</span><span class="o">.</span><span class="n">set_uri</span><span class="p">(</span><span class="n">my_uri</span><span class="p">)</span>
    <span class="n">proto_star</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="n">save_scoping</span>
    <span class="k">return</span> <span class="n">proto_star</span>

<span class="k">def</span> <span class="nf">get_dim</span><span class="p">(</span><span class="n">dataitem</span><span class="p">,</span><span class="n">current</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">packlen</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">zerotypes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataitem</span><span class="p">)</span> <span class="ow">in</span> <span class="n">zerotypes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">current</span><span class="p">,</span> <span class="n">packlen</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dataitem</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="p">()</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">and</span> \
       <span class="ow">not</span> <span class="n">dataitem</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="p">[]</span><span class="o">.</span><span class="vm">__class__</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">current</span><span class="p">,</span> <span class="n">packlen</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataitem</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
    <span class="c1">#    print &quot;Get_dim: %d: %s&quot; % (current,`dataitem`)</span>
        <span class="k">return</span> <span class="n">get_dim</span><span class="p">(</span><span class="n">dataitem</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">current</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">dataitem</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">current</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span>

<span class="k">def</span> <span class="nf">apply_line_folding</span><span class="p">(</span><span class="n">instring</span><span class="p">,</span><span class="n">minwraplength</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span><span class="n">maxwraplength</span><span class="o">=</span><span class="mi">80</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Insert line folding characters into instring between min/max wraplength&quot;&quot;&quot;</span>
    <span class="c1"># first check that we need to do this</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">instring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">line_len</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">line_len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">maxwraplength</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">[ </span><span class="se">\v\t\f</span><span class="s2">]*</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">instring</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">instring</span>
    <span class="n">outstring</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\\n</span><span class="s2">&quot;</span>   <span class="c1">#header</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">maxwraplength</span><span class="p">:</span>
            <span class="n">outstring</span> <span class="o">=</span> <span class="n">outstring</span> <span class="o">+</span> <span class="n">l</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">:</span> <span class="c1">#who&#39;da thunk it?  A line ending with a backslash</span>
                    <span class="n">outstring</span> <span class="o">=</span> <span class="n">outstring</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\\n</span><span class="s2">&quot;</span>  <span class="c1">#</span>
            <span class="n">outstring</span> <span class="o">=</span> <span class="n">outstring</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>  <span class="c1">#  put back the split character</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_bit</span> <span class="o">=</span> <span class="n">l</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_bit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxwraplength</span><span class="p">:</span>
                <span class="n">space_pos</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;[ </span><span class="se">\v\f\t</span><span class="s1">]+&#39;</span><span class="p">,</span><span class="n">current_bit</span><span class="p">[</span><span class="n">minwraplength</span><span class="p">:])</span>
                <span class="k">if</span> <span class="n">space_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">space_pos</span><span class="o">.</span><span class="n">start</span><span class="p">()</span><span class="o">&lt;</span><span class="n">maxwraplength</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">outstring</span> <span class="o">=</span> <span class="n">outstring</span> <span class="o">+</span> <span class="n">current_bit</span><span class="p">[:</span><span class="n">minwraplength</span><span class="o">+</span><span class="n">space_pos</span><span class="o">.</span><span class="n">start</span><span class="p">()]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\\n</span><span class="s2">&quot;</span>
                    <span class="n">current_bit</span> <span class="o">=</span> <span class="n">current_bit</span><span class="p">[</span><span class="n">minwraplength</span><span class="o">+</span><span class="n">space_pos</span><span class="o">.</span><span class="n">start</span><span class="p">():]</span>
                <span class="k">else</span><span class="p">:</span>    <span class="c1">#just blindly insert</span>
                    <span class="n">outstring</span> <span class="o">=</span> <span class="n">outstring</span> <span class="o">+</span> <span class="n">current_bit</span><span class="p">[:</span><span class="n">maxwraplength</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\\n</span><span class="s2">&quot;</span>
                    <span class="n">current_bit</span> <span class="o">=</span> <span class="n">current_bit</span><span class="p">[</span><span class="n">maxwraplength</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">outstring</span> <span class="o">=</span> <span class="n">outstring</span> <span class="o">+</span> <span class="n">current_bit</span>
            <span class="k">if</span> <span class="n">current_bit</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">:</span>  <span class="c1">#a backslash just happens to be here</span>
                <span class="n">outstring</span> <span class="o">=</span> <span class="n">outstring</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\\n</span><span class="s2">&quot;</span>
            <span class="n">outstring</span> <span class="o">=</span> <span class="n">outstring</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">outstring</span> <span class="o">=</span> <span class="n">outstring</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1">#remove final newline</span>
    <span class="k">return</span> <span class="n">outstring</span>

<span class="k">def</span> <span class="nf">remove_line_folding</span><span class="p">(</span><span class="n">instring</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove line folding from instring&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">[ \v\t\f]*&quot;</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">instring</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">[ \v\t\f]*$&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">?&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">instring</span><span class="p">,</span><span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">instring</span>

<span class="k">def</span> <span class="nf">apply_line_prefix</span><span class="p">(</span><span class="n">instring</span><span class="p">,</span><span class="n">prefix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prefix every line in instring with prefix&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">prefix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;;&quot;</span> <span class="ow">and</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prefix</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">[ \v\t\f]*&quot;</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">)&quot;</span><span class="p">,</span><span class="n">instring</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Found line folded string for prefixing...&#39;</span><span class="p">)</span>
            <span class="n">not_header</span> <span class="o">=</span> <span class="n">instring</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">end</span><span class="p">():]</span>
            <span class="n">outstring</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\\\\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">prefix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;No folding in input string...&#39;</span><span class="p">)</span>
            <span class="n">not_header</span> <span class="o">=</span> <span class="n">instring</span>
            <span class="n">outstring</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">prefix</span>
        <span class="n">outstring</span> <span class="o">=</span> <span class="n">outstring</span> <span class="o">+</span> <span class="n">not_header</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outstring</span>
    <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;Requested prefix starts with semicolon or contains a backslash: &quot;</span> <span class="o">+</span> <span class="n">prefix</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">remove_line_prefix</span><span class="p">(</span><span class="n">instring</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove prefix from every line if present&quot;&quot;&quot;</span>
    <span class="n">prefix_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;(?P&lt;prefix&gt;[^;</span><span class="se">\\\n</span><span class="s2">][^</span><span class="se">\n\\\\</span><span class="s2">]+)(?P&lt;folding&gt;</span><span class="se">\\\\</span><span class="s2">{1,2}[ </span><span class="se">\t\v\f</span><span class="s2">]*</span><span class="se">\n</span><span class="s2">)&quot;</span><span class="p">,</span><span class="n">instring</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prefix_match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">prefix_text</span> <span class="o">=</span> <span class="n">prefix_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;prefix&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Found prefix </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">prefix_text</span><span class="p">)</span>
        <span class="n">prefix_end</span> <span class="o">=</span> <span class="n">prefix_match</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="s1">&#39;folding&#39;</span><span class="p">)</span>
        <span class="c1"># keep any line folding instructions</span>
        <span class="k">if</span> <span class="n">prefix_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;folding&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">:</span>  <span class="c1">#two backslashes</span>
            <span class="n">outstring</span> <span class="o">=</span> <span class="n">instring</span><span class="p">[</span><span class="n">prefix_match</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="s1">&#39;folding&#39;</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">prefix_text</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">outstring</span>  <span class="c1">#keep line folding first line</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outstring</span> <span class="o">=</span> <span class="n">instring</span><span class="p">[</span><span class="n">prefix_match</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="s1">&#39;folding&#39;</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">prefix_text</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">outstring</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>   <span class="c1">#drop first line ending, no longer necessary</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">instring</span>


<span class="k">def</span> <span class="nf">listify</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span> <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">item</span>

<span class="c1">#Transpose the list of lists passed to us</span>
<span class="k">def</span> <span class="nf">transpose</span><span class="p">(</span><span class="n">base_list</span><span class="p">):</span>
    <span class="n">new_lofl</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">full_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_list</span><span class="p">)</span>
    <span class="n">opt_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">full_length</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
       <span class="n">new_packet</span> <span class="o">=</span> <span class="p">[]</span>
       <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">opt_range</span><span class="p">:</span>
          <span class="n">new_packet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
       <span class="n">new_lofl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_packet</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_lofl</span>

<span class="c1"># This routine optimised to return as quickly as possible</span>
<span class="c1"># as it is called a lot.</span>
<span class="k">def</span> <span class="nf">not_none</span><span class="p">(</span><span class="n">itemlist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return true only if no values of None are present&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">itemlist</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemlist</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">itemlist</span><span class="p">:</span>
       <span class="k">if</span> <span class="ow">not</span> <span class="n">not_none</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>


<span class="k">def</span> <span class="nf">check_stringiness</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;Check that the contents of data are all strings&quot;&quot;&quot;</span>
   <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="s1">&#39;dtype&#39;</span><span class="p">):</span>   <span class="c1">#so not Numpy</span>
       <span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span>
       <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">Number</span><span class="p">):</span> <span class="k">return</span> <span class="bp">False</span>
       <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span> <span class="k">return</span> <span class="bp">True</span>
       <span class="k">elif</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span><span class="k">return</span> <span class="bp">False</span>  <span class="c1">#should be data are None :)</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="k">for</span> <span class="n">one_item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
               <span class="k">if</span> <span class="ow">not</span> <span class="n">check_stringiness</span><span class="p">(</span><span class="n">one_item</span><span class="p">):</span> <span class="k">return</span> <span class="bp">False</span>
           <span class="k">return</span> <span class="bp">True</span>   <span class="c1">#all must be strings</span>
   <span class="k">else</span><span class="p">:</span>   <span class="c1">#numerical python</span>
       <span class="kn">import</span> <span class="nn">numpy</span>
       <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>    <span class="c1">#a bare value</span>
           <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">,</span><span class="s1">&#39;U&#39;</span><span class="p">]:</span> <span class="k">return</span> <span class="bp">True</span>
           <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="k">for</span> <span class="n">one_item</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nditer</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
               <span class="k">print</span><span class="p">(</span><span class="s1">&#39;numpy data: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">one_item</span> <span class="p">))</span>
               <span class="k">if</span> <span class="ow">not</span> <span class="n">check_stringiness</span><span class="p">(</span><span class="n">one_item</span><span class="p">):</span> <span class="k">return</span> <span class="bp">False</span>
           <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">process_template</span><span class="p">(</span><span class="n">template_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Process a template datafile to formatting instructions&quot;&quot;&quot;</span>
    <span class="n">template_as_cif</span> <span class="o">=</span> <span class="n">StarFile</span><span class="p">(</span><span class="n">template_file</span><span class="p">,</span><span class="n">grammar</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first_block</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template_file</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
        <span class="n">template_string</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">template_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>   <span class="c1">#a StringIO object</span>
        <span class="n">template_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>   <span class="c1">#reset</span>
        <span class="n">template_string</span> <span class="o">=</span> <span class="n">template_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="c1">#template_as_lines = template_string.split(&quot;\n&quot;)</span>
    <span class="c1">#template_as_lines = [l for l in template_as_lines if len(l)&gt;0 and l[0]!=&#39;#&#39;]</span>
    <span class="c1">#template_as_lines = [l for l in template_as_lines if l.split()[0] != &#39;loop_&#39;]</span>
    <span class="c1">#template_full_lines = dict([(l.split()[0],l) for l in template_as_lines if len(l.split())&gt;0])</span>
    <span class="n">form_hints</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1">#ordered array of hint dictionaries</span>
    <span class="n">find_indent</span> <span class="o">=</span> <span class="s2">&quot;^ +&quot;</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">template_as_cif</span><span class="o">.</span><span class="n">item_order</span><span class="p">:</span>  <span class="c1">#order of input</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>    <span class="c1">#not nested</span>
            <span class="n">hint_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dataname&quot;</span><span class="p">:</span><span class="n">item</span><span class="p">}</span>
            <span class="c1"># find the line in the file</span>
            <span class="n">start_pos</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;(^[ </span><span class="se">\t</span><span class="s2">]*(?P&lt;name&gt;&quot;</span> <span class="o">+</span> <span class="n">item</span> <span class="o">+</span> <span class="s2">&quot;)[ </span><span class="se">\t\n</span><span class="s2">]+)(?P&lt;spec&gt;([\S]+)|(^;))&quot;</span><span class="p">,</span><span class="n">template_string</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="o">|</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">start_pos</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;spec&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">spec_pos</span> <span class="o">=</span> <span class="n">start_pos</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s2">&quot;spec&quot;</span><span class="p">)</span><span class="o">-</span><span class="n">start_pos</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">spec_char</span> <span class="o">=</span> <span class="n">template_string</span><span class="p">[</span><span class="n">start_pos</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s2">&quot;spec&quot;</span><span class="p">):</span><span class="n">start_pos</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s2">&quot;spec&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">spec_char</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&quot;;&#39;</span><span class="p">:</span>
                    <span class="n">hint_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;delimiter&quot;</span><span class="p">:</span><span class="n">spec_char</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
                    <span class="k">if</span> <span class="n">spec_char</span> <span class="o">==</span> <span class="s1">&#39;&quot;&quot;&quot;&#39;</span> <span class="ow">or</span> <span class="n">spec_char</span> <span class="o">==</span> <span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">:</span>
                        <span class="n">hint_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;delimiter&quot;</span><span class="p">:</span><span class="n">spec_char</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">spec_char</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;;&quot;</span><span class="p">:</span>   <span class="c1">#so we need to work out the column number</span>
                    <span class="n">hint_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;column&quot;</span><span class="p">:</span><span class="n">spec_pos</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>                  <span class="c1">#need to put in the carriage return</span>
                    <span class="n">hint_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;delimiter&quot;</span><span class="p">:</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">;&quot;</span><span class="p">})</span>
                    <span class="c1"># can we format the text?</span>
                    <span class="n">text_val</span> <span class="o">=</span> <span class="n">template_as_cif</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
                    <span class="n">hint_dict</span><span class="p">[</span><span class="s2">&quot;reformat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">text_val</span> <span class="ow">or</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="ow">in</span> <span class="n">text_val</span>
                    <span class="k">if</span> <span class="n">hint_dict</span><span class="p">[</span><span class="s2">&quot;reformat&quot;</span><span class="p">]:</span>   <span class="c1">#find the indentation</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">find_indent</span><span class="p">,</span><span class="n">text_val</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">group</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">hint_dict</span><span class="p">[</span><span class="s2">&quot;reformat_indent&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">end</span><span class="p">()</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">start_pos</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">name_pos</span> <span class="o">=</span> <span class="n">start_pos</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">start_pos</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">hint_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;name_pos&quot;</span><span class="p">:</span><span class="n">name_pos</span><span class="p">})</span>
            <span class="c1">#print &#39;%s: %s&#39; % (item,`hint_dict`)</span>
            <span class="n">form_hints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hint_dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>           <span class="c1">#loop block</span>
            <span class="n">testnames</span> <span class="o">=</span> <span class="n">template_as_cif</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
            <span class="n">total_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">template_as_cif</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
            <span class="n">testname</span> <span class="o">=</span> <span class="n">testnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1">#find the loop spec line in the file</span>
            <span class="n">loop_regex</span> <span class="o">=</span> <span class="s2">&quot;(^[ </span><span class="se">\t</span><span class="s2">]*(?P&lt;loop&gt;loop_)[ </span><span class="se">\t\n\r</span><span class="s2">]+(?P&lt;name&gt;&quot;</span> <span class="o">+</span> <span class="n">testname</span> <span class="o">+</span> <span class="s2">&quot;)([ </span><span class="se">\t\n\r</span><span class="s2">]+_[\S]+){</span><span class="si">%d</span><span class="s2">}[ </span><span class="se">\t</span><span class="s2">]*$(?P&lt;packet&gt;(.(?!_loop|_[\S]+))*))&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">total_items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">loop_line</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">loop_regex</span><span class="p">,</span><span class="n">template_string</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="o">|</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="o">|</span><span class="n">re</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>
            <span class="n">loop_so_far</span> <span class="o">=</span> <span class="n">loop_line</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="n">packet_text</span> <span class="o">=</span> <span class="n">loop_line</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;packet&#39;</span><span class="p">)</span>
            <span class="n">loop_indent</span> <span class="o">=</span> <span class="n">loop_line</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;loop&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">loop_line</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">form_hints</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;dataname&quot;</span><span class="p">:</span><span class="s1">&#39;loop&#39;</span><span class="p">,</span><span class="s1">&#39;name_pos&#39;</span><span class="p">:</span><span class="n">loop_indent</span><span class="p">})</span>
            <span class="n">packet_regex</span> <span class="o">=</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]*(?P&lt;all&gt;(?P&lt;sqqq&gt;&#39;&#39;&#39;([^</span><span class="se">\n\r\f</span><span class="s2">&#39;]*)&#39;&#39;&#39;)|(?P&lt;sq&gt;&#39;([^</span><span class="se">\n\r\f</span><span class="s2">&#39;]*)&#39;+)|(?P&lt;dq&gt;</span><span class="se">\&quot;</span><span class="s2">([^</span><span class="se">\n\r\&quot;</span><span class="s2">]*)</span><span class="se">\&quot;</span><span class="s2">+)|(?P&lt;none&gt;[^\s]+))&quot;</span>
            <span class="n">packet_pos</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">packet_regex</span><span class="p">,</span><span class="n">packet_text</span><span class="p">)</span>
            <span class="n">line_end_pos</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">,</span><span class="n">packet_text</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
            <span class="n">next_end</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">line_end_pos</span><span class="p">)</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="n">last_end</span> <span class="o">=</span> <span class="n">next_end</span>
            <span class="k">for</span> <span class="n">loopname</span> <span class="ow">in</span> <span class="n">testnames</span><span class="p">:</span>
                <span class="c1">#find the name in the file for name pos</span>
                <span class="n">name_regex</span> <span class="o">=</span> <span class="s2">&quot;(^[ </span><span class="se">\t</span><span class="s2">]*(?P&lt;name&gt;&quot;</span> <span class="o">+</span> <span class="n">loopname</span> <span class="o">+</span> <span class="s2">&quot;))&quot;</span>
                <span class="n">name_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">name_regex</span><span class="p">,</span><span class="n">template_string</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="o">|</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="o">|</span><span class="n">re</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>
                <span class="n">loop_name_indent</span> <span class="o">=</span> <span class="n">name_match</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">-</span><span class="n">name_match</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">hint_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dataname&quot;</span><span class="p">:</span><span class="n">loopname</span><span class="p">,</span><span class="s2">&quot;name_pos&quot;</span><span class="p">:</span><span class="n">loop_name_indent</span><span class="p">}</span>
                <span class="c1">#find the value</span>
                <span class="n">thismatch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">packet_pos</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">thismatch</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">next_end</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">last_end</span> <span class="o">=</span> <span class="n">next_end</span>
                        <span class="n">next_end</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">line_end_pos</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;next end </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">next_end</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Start </span><span class="si">%d</span><span class="s1">, last_end </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thismatch</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">),</span><span class="n">last_end</span><span class="p">))</span>
                <span class="n">col_pos</span> <span class="o">=</span> <span class="n">thismatch</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">last_end</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">thismatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">thismatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;sqqq&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">hint_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;delimiter&#39;</span><span class="p">:</span><span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">hint_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;delimiter&#39;</span><span class="p">:</span><span class="n">thismatch</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]})</span>
                <span class="n">hint_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;column&#39;</span><span class="p">:</span><span class="n">col_pos</span><span class="p">})</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">loopname</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span> <span class="n">hint_dict</span> <span class="p">)))</span>
                <span class="n">form_hints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hint_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">form_hints</span>


<span class="c1">#No documentation flags</span>
</pre></div>

  </div>

  </header>

  <section id="section-items">

    <h2 class="section-title" id="header-functions">Functions</h2>
      
  <div class="item">
    <div class="name def" id="CifFile.StarFile.ReadStar">
    <p>def <span class="ident">ReadStar</span>(</p><p>filename, prepared=None, maxlength=-1, scantype=u&#39;standard&#39;, grammar=u&#39;STAR2&#39;, CBF=False, permissive=False)</p>
    </div>
    

    
  
    <div class="desc"><p>Read in a STAR file, returning the contents in the <code>prepared</code> object.</p>
<ul>
<li>
<p><code>filename</code> may be a URL, a file
path on the local system, or any object with a <code>read</code> method.</p>
</li>
<li>
<p><code>prepared</code> provides a <code>StarFile</code> or <code>CifFile</code> object that the contents of <code>filename</code>
will be added to.</p>
</li>
<li>
<p><code>maxlength</code> is the maximum allowable line length in the input file. This has been set at
2048 characters for CIF but is unlimited (-1) for STAR files.</p>
</li>
<li>
<p><code>grammar</code> chooses the STAR grammar variant. <code>1.0</code> is the original 1992 CIF/STAR grammar and <code>1.1</code>
is identical except for the exclusion of square brackets as the first characters in
undelimited datanames. <code>2.0</code> will read files in the CIF2.0 standard, and <code>STAR2</code> will
read files according to the STAR2 publication.  If grammar is <code>None</code> or <code>auto</code>, autodetection
will be attempted in the order <code>2.0</code>, <code>1.1</code> and <code>1.0</code>. This will always succeed for conformant CIF2.0 files.
Note that (nested) save frames are read in all grammar variations and then flagged afterwards if
they do not match the requested grammar.</p>
</li>
<li>
<p><code>scantype</code> can be <code>standard</code> or <code>flex</code>.  <code>standard</code> provides pure Python parsing at the
cost of a factor of 10 or so in speed.  <code>flex</code> will tokenise the input CIF file using
fast C routines.  Note that running PyCIFRW in Jython uses native Java regular expressions
to provide a speedup regardless of this argument.</p>
</li>
<li>
<p><code>CBF</code> flags that the input file is in Crystallographic Binary File format. The binary block is
excised from the input data stream before parsing and is not available in the returned object.</p>
</li>
<li>
<p><code>permissive</code> allows non UTF8 encodings (currently only latin1) in the input file. These are a 
violation of the standard.</p>
</li>
</ul></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.ReadStar', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.ReadStar" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">ReadStar</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">prepared</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">maxlength</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
             <span class="n">scantype</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span><span class="n">grammar</span><span class="o">=</span><span class="s1">&#39;STAR2&#39;</span><span class="p">,</span><span class="n">CBF</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">permissive</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; Read in a STAR file, returning the contents in the `prepared` object.</span>

<span class="sd">    * `filename` may be a URL, a file</span>
<span class="sd">    path on the local system, or any object with a `read` method.</span>

<span class="sd">    * `prepared` provides a `StarFile` or `CifFile` object that the contents of `filename`</span>
<span class="sd">    will be added to.</span>

<span class="sd">    * `maxlength` is the maximum allowable line length in the input file. This has been set at</span>
<span class="sd">    2048 characters for CIF but is unlimited (-1) for STAR files.</span>

<span class="sd">    * `grammar` chooses the STAR grammar variant. `1.0` is the original 1992 CIF/STAR grammar and `1.1`</span>
<span class="sd">    is identical except for the exclusion of square brackets as the first characters in</span>
<span class="sd">    undelimited datanames. `2.0` will read files in the CIF2.0 standard, and `STAR2` will</span>
<span class="sd">    read files according to the STAR2 publication.  If grammar is `None` or `auto`, autodetection</span>
<span class="sd">    will be attempted in the order `2.0`, `1.1` and `1.0`. This will always succeed for conformant CIF2.0 files.</span>
<span class="sd">    Note that (nested) save frames are read in all grammar variations and then flagged afterwards if</span>
<span class="sd">    they do not match the requested grammar.</span>

<span class="sd">    * `scantype` can be `standard` or `flex`.  `standard` provides pure Python parsing at the</span>
<span class="sd">    cost of a factor of 10 or so in speed.  `flex` will tokenise the input CIF file using</span>
<span class="sd">    fast C routines.  Note that running PyCIFRW in Jython uses native Java regular expressions</span>
<span class="sd">    to provide a speedup regardless of this argument.</span>

<span class="sd">    * `CBF` flags that the input file is in Crystallographic Binary File format. The binary block is</span>
<span class="sd">    excised from the input data stream before parsing and is not available in the returned object.</span>

<span class="sd">    * `permissive` allows non UTF8 encodings (currently only latin1) in the input file. These are a </span>
<span class="sd">    violation of the standard.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># save desired scoping</span>
    <span class="n">save_scoping</span> <span class="o">=</span> <span class="n">prepared</span><span class="o">.</span><span class="n">scoping</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">YappsStarParser_1_1</span> <span class="k">as</span> <span class="n">Y11</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">YappsStarParser_1_0</span> <span class="k">as</span> <span class="n">Y10</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">YappsStarParser_2_0</span> <span class="k">as</span> <span class="n">Y20</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">YappsStarParser_STAR2</span> <span class="k">as</span> <span class="n">YST</span>
    <span class="k">if</span> <span class="n">prepared</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">prepared</span> <span class="o">=</span> <span class="n">StarFile</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">grammar</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span> <span class="ow">or</span> <span class="n">grammar</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">try_list</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;2.0&#39;</span><span class="p">,</span><span class="n">Y20</span><span class="p">),(</span><span class="s1">&#39;1.1&#39;</span><span class="p">,</span><span class="n">Y11</span><span class="p">),(</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span><span class="n">Y10</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">grammar</span> <span class="o">==</span> <span class="s1">&#39;1.0&#39;</span><span class="p">:</span>
        <span class="n">try_list</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span><span class="n">Y10</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">grammar</span> <span class="o">==</span> <span class="s1">&#39;1.1&#39;</span><span class="p">:</span>
        <span class="n">try_list</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;1.1&#39;</span><span class="p">,</span><span class="n">Y11</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">grammar</span> <span class="o">==</span> <span class="s1">&#39;2.0&#39;</span><span class="p">:</span>
        <span class="n">try_list</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;2.0&#39;</span><span class="p">,</span><span class="n">Y20</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">grammar</span> <span class="o">==</span> <span class="s1">&#39;STAR2&#39;</span><span class="p">:</span>
        <span class="n">try_list</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;STAR2&#39;</span><span class="p">,</span><span class="n">YST</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Unknown STAR/CIF grammar requested, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">grammar</span> <span class="p">))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
        <span class="c1"># create an absolute URL</span>
        <span class="n">relpath</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">relpath</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="n">fullpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fullpath</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="n">newrel</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span>
            <span class="n">newrel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;file&quot;</span>
            <span class="n">newrel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">fullpath</span>
            <span class="n">my_uri</span> <span class="o">=</span> <span class="n">urlunparse</span><span class="p">(</span><span class="n">newrel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">my_uri</span> <span class="o">=</span> <span class="n">urlunparse</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span>
        <span class="c1"># print(&quot;Full URL is: &quot; + my_uri)</span>
        <span class="n">filestream</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">my_uri</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">filestream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8-sig&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">permissive</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">filestream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: bad encoding (must be utf8 or ascii)&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">filestream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filestream</span> <span class="o">=</span> <span class="n">filename</span>   <span class="c1">#already opened for us</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">filestream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8-sig&#39;</span><span class="p">)</span>  <span class="c1">#CIF is always ascii/utf8</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">permissive</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">filestream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;Bad input encoding (must be utf8 or ascii)&quot;</span><span class="p">)</span>
        <span class="n">my_uri</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>      <span class="c1"># empty file, return empty block</span>
        <span class="k">return</span> <span class="n">prepared</span><span class="o">.</span><span class="n">set_uri</span><span class="p">(</span><span class="n">my_uri</span><span class="p">)</span>
    <span class="c1"># filter out non-ASCII characters in CBF files if required.  We assume</span>
    <span class="c1"># that the binary is enclosed in a fixed string that occurs</span>
    <span class="c1"># nowhere else.</span>
    <span class="k">if</span> <span class="n">CBF</span><span class="p">:</span>
       <span class="n">text_bits</span>  <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-BINARY-FORMAT-SECTION-&quot;</span><span class="p">)</span>
       <span class="n">text</span> <span class="o">=</span> <span class="n">text_bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
       <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">text_bits</span><span class="p">),</span><span class="mi">2</span><span class="p">):</span>
           <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">+</span><span class="s2">&quot; (binary omitted)&quot;</span><span class="o">+</span><span class="n">text_bits</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
    <span class="c1"># we recognise ctrl-Z as end of file</span>
    <span class="n">endoffile</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">26</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">endoffile</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="n">endoffile</span><span class="p">]</span>
    <span class="n">split</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxlength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">toolong</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">split</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">&gt;</span><span class="n">maxlength</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">toolong</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">split</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">toolong</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Line </span><span class="si">%d</span><span class="s1"> contains more than </span><span class="si">%d</span><span class="s1"> characters&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">maxlength</span><span class="p">))</span>
    <span class="c1"># honour the header string</span>
    <span class="k">if</span> <span class="n">text</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;#\#CIF_2.0&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;2.0&#39;</span><span class="p">,</span><span class="n">Y20</span><span class="p">)</span> <span class="ow">in</span> <span class="n">try_list</span><span class="p">:</span>
        <span class="n">try_list</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="s1">&#39;2.0&#39;</span><span class="p">,</span><span class="n">Y20</span><span class="p">),)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">try_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">%s</span><span class="s1"> missing CIF2.0 header&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">grammar_name</span><span class="p">,</span><span class="n">Y</span> <span class="ow">in</span> <span class="n">try_list</span><span class="p">:</span>
       <span class="k">if</span> <span class="n">scantype</span> <span class="o">==</span> <span class="s1">&#39;standard&#39;</span> <span class="ow">or</span> <span class="n">grammar_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;2.0&#39;</span><span class="p">,</span><span class="s1">&#39;STAR2&#39;</span><span class="p">]:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">StarParser</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">StarParserScanner</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
       <span class="k">else</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">StarParser</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">yappsrt</span><span class="o">.</span><span class="n">Scanner</span><span class="p">(</span><span class="bp">None</span><span class="p">,[],</span><span class="n">text</span><span class="p">,</span><span class="n">scantype</span><span class="o">=</span><span class="s1">&#39;flex&#39;</span><span class="p">))</span>
       <span class="c1"># handle encoding switch</span>
       <span class="k">if</span> <span class="n">grammar_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;2.0&#39;</span><span class="p">,</span><span class="s1">&#39;STAR2&#39;</span><span class="p">]:</span>
           <span class="n">prepared</span><span class="o">.</span><span class="n">set_characterset</span><span class="p">(</span><span class="s1">&#39;unicode&#39;</span><span class="p">)</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="n">prepared</span><span class="o">.</span><span class="n">set_characterset</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
       <span class="n">proto_star</span> <span class="o">=</span> <span class="bp">None</span>
       <span class="k">try</span><span class="p">:</span>
           <span class="n">proto_star</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span><span class="s2">&quot;input&quot;</span><span class="p">)(</span><span class="n">prepared</span><span class="p">)</span>
       <span class="k">except</span> <span class="n">Y</span><span class="o">.</span><span class="n">yappsrt</span><span class="o">.</span><span class="n">YappsSyntaxError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
           <span class="nb">input</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">_scanner</span><span class="o">.</span><span class="n">input</span>
           <span class="n">Y</span><span class="o">.</span><span class="n">yappsrt</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">parser</span><span class="o">.</span><span class="n">_scanner</span><span class="p">)</span>
       <span class="k">except</span> <span class="n">Y</span><span class="o">.</span><span class="n">yappsrt</span><span class="o">.</span><span class="n">NoMoreTokens</span><span class="p">:</span>
           <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Could not complete parsing; stopped around here:&#39;</span><span class="p">,</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
           <span class="k">print</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">_scanner</span><span class="p">,</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
       <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
           <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Unexpected error:&#39;</span><span class="p">)</span>
           <span class="kn">import</span> <span class="nn">traceback</span>
           <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
       <span class="k">if</span> <span class="n">proto_star</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
           <span class="n">proto_star</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="n">grammar_name</span><span class="p">)</span>   <span class="c1">#remember for output</span>
           <span class="k">break</span>
    <span class="k">if</span> <span class="n">proto_star</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">errorstring</span> <span class="o">=</span> <span class="s1">&#39;Syntax error in input file: last value parsed was </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Y</span><span class="o">.</span><span class="n">lastval</span>
        <span class="n">errorstring</span> <span class="o">=</span> <span class="n">errorstring</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Parser status: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">parser</span><span class="o">.</span><span class="n">_scanner</span> <span class="p">)</span>
        <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="n">errorstring</span><span class="p">)</span>
    <span class="c1"># set visibility correctly</span>
    <span class="n">proto_star</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="s1">&#39;dictionary&#39;</span>
    <span class="n">proto_star</span><span class="o">.</span><span class="n">set_uri</span><span class="p">(</span><span class="n">my_uri</span><span class="p">)</span>
    <span class="n">proto_star</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="n">save_scoping</span>
    <span class="k">return</span> <span class="n">proto_star</span>
</pre></div>

  </div>
</div>

  </div>
  

    <h2 class="section-title" id="header-classes">Classes</h2>
      
      <div class="item">
      <p id="CifFile.StarFile.BlockCollection" class="name">class <span class="ident">BlockCollection</span></p>
      
  
    <div class="desc"><p>A container for StarBlock objects. The constructor takes
one non-keyword argument <code>datasource</code> to set the initial data.  If
<code>datasource</code> is a Python dictionary, the values must be <code>StarBlock</code>
objects and the keys will be blocknames in the new object. Keyword
arguments:</p>
<p>standard:
    <code>CIF</code> or <code>Dic</code>.  <code>CIF</code> enforces 75-character blocknames, and will
    print block contents before that block's save frame.</p>
<p>blocktype:
    The type of blocks held in this container. Normally <code>StarBlock</code>
    or <code>CifBlock</code>.</p>
<p>characterset:
    <code>ascii</code> or <code>unicode</code>.  Blocknames and datanames appearing within
    blocks are restricted to the appropriate characterset. Note that
    only characters in the basic multilingual plane are accepted. This
    restriction will be lifted when PyCIFRW is ported to Python3.</p>
<p>scoping:
    <code>instance</code> or <code>dictionary</code>: <code>instance</code> implies that save frames are
    hidden from save frames lower in the hierarchy or in sibling
    hierarchies. <code>dictionary</code> makes all save frames visible everywhere
    within a data block.  This setting is only relevant for STAR2 dictionaries and
    STAR2 data files, as save frames are currently not used in plain CIF data
    files.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.BlockCollection', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.BlockCollection" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">BlockCollection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A container for StarBlock objects. The constructor takes</span>
<span class="sd">    one non-keyword argument `datasource` to set the initial data.  If</span>
<span class="sd">    `datasource` is a Python dictionary, the values must be `StarBlock`</span>
<span class="sd">    objects and the keys will be blocknames in the new object. Keyword</span>
<span class="sd">    arguments:</span>

<span class="sd">    standard:</span>
<span class="sd">        `CIF` or `Dic`.  `CIF` enforces 75-character blocknames, and will</span>
<span class="sd">        print block contents before that block&#39;s save frame.</span>

<span class="sd">    blocktype:</span>
<span class="sd">        The type of blocks held in this container. Normally `StarBlock`</span>
<span class="sd">        or `CifBlock`.</span>

<span class="sd">    characterset:</span>
<span class="sd">        `ascii` or `unicode`.  Blocknames and datanames appearing within</span>
<span class="sd">        blocks are restricted to the appropriate characterset. Note that</span>
<span class="sd">        only characters in the basic multilingual plane are accepted. This</span>
<span class="sd">        restriction will be lifted when PyCIFRW is ported to Python3.</span>

<span class="sd">    scoping:</span>
<span class="sd">        `instance` or `dictionary`: `instance` implies that save frames are</span>
<span class="sd">        hidden from save frames lower in the hierarchy or in sibling</span>
<span class="sd">        hierarchies. `dictionary` makes all save frames visible everywhere</span>
<span class="sd">        within a data block.  This setting is only relevant for STAR2 dictionaries and</span>
<span class="sd">        STAR2 data files, as save frames are currently not used in plain CIF data</span>
<span class="sd">        files.</span>

<span class="sd">&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">datasource</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">standard</span><span class="o">=</span><span class="s1">&#39;CIF&#39;</span><span class="p">,</span><span class="n">blocktype</span> <span class="o">=</span> <span class="n">StarBlock</span><span class="p">,</span>
                 <span class="n">characterset</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span><span class="n">scoping</span><span class="o">=</span><span class="s1">&#39;instance&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">collections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">=</span> <span class="n">standard</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>           <span class="c1"># short_cuts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PC</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;PC&#39;</span><span class="p">,[</span><span class="s1">&#39;block_id&#39;</span><span class="p">,</span><span class="s1">&#39;parent&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span> <span class="o">=</span> <span class="p">[]</span>            <span class="c1"># for efficiency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span> <span class="o">=</span> <span class="p">[]</span>       <span class="c1"># to output in same order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="n">scoping</span>  <span class="c1">#will trigger setting of child table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocktype</span> <span class="o">=</span> <span class="n">blocktype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1">#for outputting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="s1">&#39;2.0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_characterset</span><span class="p">(</span><span class="n">characterset</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span><span class="n">BlockCollection</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">merge_fast</span><span class="p">(</span><span class="n">datasource</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="n">scoping</span>   <span class="c1">#reset visibility</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">datasource</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                 <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_comment</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">new_grammar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the syntax and grammar for output to `new_grammar`&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_grammar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1.1&#39;</span><span class="p">,</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span><span class="s1">&#39;2.0&#39;</span><span class="p">,</span><span class="s1">&#39;STAR2&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Unrecognised output grammar </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">new_grammar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">=</span> <span class="n">new_grammar</span>

    <span class="k">def</span> <span class="nf">set_characterset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">characterset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the allowed characters for datanames and datablocks: may be `ascii` or `unicode`. If datanames</span>
<span class="sd">        have already been added to any datablocks, they are not checked.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">characterset</span> <span class="o">=</span> <span class="n">characterset</span>
        <span class="k">for</span> <span class="n">one_block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">one_block</span><span class="p">]</span><span class="o">.</span><span class="n">set_characterset</span><span class="p">(</span><span class="n">characterset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">unlock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow overwriting of all blocks in this collection&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">overwrite</span><span class="o">=</span><span class="bp">True</span>

    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Disallow overwriting for all blocks in this collection&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">WriteOut</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NewBlock</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
           <span class="n">lowerkey</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
           <span class="k">if</span> <span class="n">lowerkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">lowerkey</span><span class="p">]</span>
           <span class="c1">#print &#39;Visible keys:&#39; + `self.visible_keys`</span>
           <span class="c1">#print &#39;All keys&#39; + `self.lower_keys`</span>
           <span class="c1">#print &#39;Child table&#39; + `self.child_table`</span>
           <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No such item </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

    <span class="c1"># we have to get an ordered list of the current keys,</span>
    <span class="c1"># as we&#39;ll have to delete one of them anyway.</span>
    <span class="c1"># Deletion will delete any key regardless of visibility</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="n">dummy</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>   <span class="c1">#raise error if not present</span>
        <span class="n">lowerkey</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1"># get rid of all children recursively as well</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">lowerkey</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">child</span><span class="p">]</span>   <span class="c1">#recursive call</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">lowerkey</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">lowerkey</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lowerkey</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lowerkey</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lowerkey</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Support the &#39;in&#39; operator&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="c1"># We iterate over all visible</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">one_block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="p">[</span><span class="n">one_block</span><span class="p">]</span>

    <span class="c1"># TODO: handle different case</span>
    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span>

    <span class="c1"># Note that has_key does not exist in 3.5</span>
    <span class="k">def</span> <span class="nf">has_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>     <span class="c1"># take account of case</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">newcopy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1">#all blocks</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">newcopy</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newcopy</span> <span class="o">=</span> <span class="n">BlockCollection</span><span class="p">(</span><span class="n">newcopy</span><span class="p">)</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">child_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">lower_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">block_input_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">characterset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">characterset</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">SetTemplate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_template</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span>  <span class="c1">#this sets visible keys</span>
        <span class="k">return</span> <span class="n">newcopy</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">adict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">adict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">adict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">first_block</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the &#39;first&#39; block.  This is not necessarily the first block in the file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">NewBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blockname</span><span class="p">,</span><span class="n">blockcontents</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">fix</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a new block named `blockname` with contents `blockcontents`. If `fix`</span>
<span class="sd">        is True, `blockname` will have spaces and tabs replaced by underscores. `parent`</span>
<span class="sd">        allows a parent block to be set so that block hierarchies can be created.  Depending on</span>
<span class="sd">        the output standard, these blocks will be printed out as nested save frames or</span>
<span class="sd">        ignored.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">blockcontents</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">blockcontents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocktype</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">==</span> <span class="s2">&quot;CIF&quot;</span><span class="p">:</span>
            <span class="n">blockcontents</span><span class="o">.</span><span class="n">setmaxnamelength</span><span class="p">(</span><span class="mi">75</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blockname</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">75</span><span class="p">:</span>
                 <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Blockname </span><span class="si">%s</span><span class="s1"> is longer than 75 characters&#39;</span> <span class="o">%</span> <span class="n">blockname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fix</span><span class="p">:</span>
            <span class="n">newblockname</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[  </span><span class="se">\t</span><span class="s1">]&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">blockname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">newblockname</span> <span class="o">=</span> <span class="n">blockname</span>
        <span class="n">new_lowerbn</span> <span class="o">=</span> <span class="n">newblockname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">new_lowerbn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>   <span class="c1">#already there</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
               <span class="n">toplevelnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">==</span><span class="bp">None</span><span class="p">]</span>
               <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">new_lowerbn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">toplevelnames</span><span class="p">:</span>  <span class="c1">#can give a new key to this one</span>
                  <span class="k">while</span> <span class="n">new_lowerbn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span> <span class="n">new_lowerbn</span> <span class="o">=</span> <span class="n">new_lowerbn</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span>
               <span class="k">elif</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">new_lowerbn</span> <span class="ow">in</span> <span class="n">toplevelnames</span><span class="p">:</span> <span class="c1">#can fix a different one</span>
                  <span class="n">replace_name</span> <span class="o">=</span> <span class="n">new_lowerbn</span>
                  <span class="k">while</span> <span class="n">replace_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span> <span class="n">replace_name</span> <span class="o">=</span> <span class="n">replace_name</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_rekey</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">,</span><span class="n">replace_name</span><span class="p">)</span>
                  <span class="c1"># now continue on to add in the new block</span>
                  <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">new_lowerbn</span><span class="p">:</span>        <span class="c1">#the new block&#39;s requested parent just got renamed!!</span>
                      <span class="n">parent</span> <span class="o">=</span> <span class="n">replace_name</span>
               <span class="k">else</span><span class="p">:</span>
                  <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s2">&quot;Attempt to replace existing block &quot;</span> <span class="o">+</span> <span class="n">blockname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">new_lowerbn</span><span class="p">:</span><span class="n">blockcontents</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">newblockname</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">==</span> <span class="s1">&#39;instance&#39;</span><span class="p">:</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">newblockname</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
              <span class="k">else</span><span class="p">:</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">newblockname</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Warning:Parent block </span><span class="si">%s</span><span class="s1"> does not exist for child </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">newblockname</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">.</span><span class="n">set_characterset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">characterset</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span>
        <span class="k">return</span> <span class="n">new_lowerbn</span>  <span class="c1">#in case calling routine wants to know</span>

    <span class="k">def</span> <span class="nf">_rekey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldname</span><span class="p">,</span><span class="n">newname</span><span class="p">,</span><span class="n">block_id</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The block with key [[oldname]] gets [[newname]] as a new key, but the printed name</span>
<span class="sd">           does not change unless [[block_id]] is given.  Prefer [[rename]] for a safe version.&quot;&quot;&quot;</span>
        <span class="n">move_block</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">oldname</span><span class="p">]</span>    <span class="c1">#old block</span>
        <span class="n">is_visible</span> <span class="o">=</span> <span class="n">oldname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span>
        <span class="n">move_block_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">oldname</span><span class="p">]</span>    <span class="c1">#old info</span>
        <span class="n">move_block_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">==</span><span class="n">oldname</span><span class="p">]</span>
        <span class="c1"># now rewrite the necessary bits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">([(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span><span class="p">,</span><span class="n">newname</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">move_block_children</span><span class="p">]))</span>
        <span class="n">oldpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">oldname</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">oldname</span><span class="p">]</span>   <span class="c1">#do this after updating child table so we don&#39;t delete children</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">newname</span><span class="p">:</span><span class="n">move_block</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">newname</span><span class="p">)</span>
        <span class="c1">#print &#39;Block input order was: &#39; + `self.block_input_order`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span><span class="p">[</span><span class="n">oldpos</span><span class="p">:</span><span class="n">oldpos</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">newname</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">block_id</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">newname</span><span class="p">:</span><span class="n">move_block_info</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">newname</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">block_id</span><span class="p">,</span><span class="n">move_block_info</span><span class="o">.</span><span class="n">parent</span><span class="p">)})</span>
        <span class="k">if</span> <span class="n">is_visible</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span> <span class="o">+=</span> <span class="p">[</span><span class="n">newname</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldname</span><span class="p">,</span><span class="n">newname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rename datablock from [[oldname]] to [[newname]]. Both key and printed name are changed.  No</span>
<span class="sd">           conformance checks are conducted.&quot;&quot;&quot;</span>
        <span class="n">realoldname</span> <span class="o">=</span> <span class="n">oldname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">realnewname</span> <span class="o">=</span> <span class="n">newname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">realnewname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Cannot change blockname </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> as </span><span class="si">%s</span><span class="s1"> already present&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">oldname</span><span class="p">,</span><span class="n">newname</span><span class="p">,</span><span class="n">newname</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">realoldname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Cannot find old block </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">realoldname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rekey</span><span class="p">(</span><span class="n">realoldname</span><span class="p">,</span><span class="n">realnewname</span><span class="p">,</span><span class="n">block_id</span><span class="o">=</span><span class="n">newname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">makebc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">namelist</span><span class="p">,</span><span class="n">scoping</span><span class="o">=</span><span class="s1">&#39;dictionary&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a block collection from a list of block names&quot;&quot;&quot;</span>
        <span class="n">newbc</span> <span class="o">=</span> <span class="n">BlockCollection</span><span class="p">()</span>
        <span class="n">block_lower</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">namelist</span><span class="p">]</span>
        <span class="n">proto_child_table</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">block_lower</span><span class="p">]</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">child_table</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">proto_child_table</span><span class="p">)</span>
        <span class="n">new_top_level</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span><span class="p">,</span><span class="bp">None</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">newbc</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">block_lower</span><span class="p">]</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">new_top_level</span><span class="p">))</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">lower_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">proto_child_table</span><span class="p">])</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">proto_child_table</span><span class="p">)</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="n">scoping</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">block_input_order</span> <span class="o">=</span> <span class="n">block_lower</span>
        <span class="k">return</span> <span class="n">newbc</span>


    <span class="k">def</span> <span class="nf">merge_fast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">new_bc</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do a fast merge. WARNING: this may change one or more of its frame headers in order to</span>
<span class="sd">        remove duplicate frames.  Please keep a handle to the block object instead of the text of</span>
<span class="sd">        the header.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;replace&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;strict&#39;</span>
        <span class="n">overlap_flag</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">new_bc</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">parent_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">parent</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent_name</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent_name</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;Unable to find unique parent block name: have </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">parent_name</span><span class="p">))</span>
            <span class="n">parent_name</span> <span class="o">=</span> <span class="n">parent_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent_name</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1">#an error will be thrown if we treat as a string</span>
        <span class="k">if</span> <span class="n">overlap_flag</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span>
            <span class="n">double_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">new_bc</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dup_key</span> <span class="ow">in</span> <span class="n">double_keys</span><span class="p">:</span>
                  <span class="n">our_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">dup_key</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span>
                  <span class="n">their_parent</span> <span class="o">=</span> <span class="n">new_bc</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">dup_key</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">our_parent</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">their_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span>\
                      <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="c1">#rename our block</span>
                    <span class="n">start_key</span> <span class="o">=</span> <span class="n">dup_key</span>
                    <span class="k">while</span> <span class="n">start_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span> <span class="n">start_key</span> <span class="o">=</span> <span class="n">start_key</span><span class="o">+</span><span class="s1">&#39;+&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rekey</span><span class="p">(</span><span class="n">dup_key</span><span class="p">,</span><span class="n">start_key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">parent_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">dup_key</span><span class="p">:</span>  <span class="c1">#we just renamed the prospective parent!</span>
                        <span class="n">parent_name</span> <span class="o">=</span> <span class="n">start_key</span>
                  <span class="k">elif</span> <span class="n">our_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">their_parent</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">start_key</span> <span class="o">=</span> <span class="n">dup_key</span>
                    <span class="k">while</span> <span class="n">start_key</span> <span class="ow">in</span> <span class="n">new_bc</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span> <span class="n">start_key</span> <span class="o">=</span> <span class="n">start_key</span><span class="o">+</span><span class="s1">&#39;+&#39;</span>
                    <span class="n">new_bc</span><span class="o">.</span><span class="n">_rekey</span><span class="p">(</span><span class="n">dup_key</span><span class="p">,</span><span class="n">start_key</span><span class="p">)</span>
                  <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;In strict merge mode:duplicate keys </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dup_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_bc</span><span class="o">.</span><span class="n">dictionary</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_bc</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">new_bc</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span> <span class="o">+=</span> <span class="n">new_bc</span><span class="o">.</span><span class="n">block_input_order</span>
        <span class="c1">#print(&#39;Block input order now:&#39; + repr(self.block_input_order))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_bc</span><span class="o">.</span><span class="n">child_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>     <span class="c1">#redo the child_table entries</span>
              <span class="n">reparent_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">new_bc</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">==</span><span class="bp">None</span><span class="p">]</span>
              <span class="n">reparent_dict</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">parent_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">reparent_list</span><span class="p">]</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">reparent_dict</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">new_bc</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">single_block</span><span class="o">=</span><span class="p">[],</span>
                   <span class="n">idblock</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">match_att</span><span class="o">=</span><span class="p">[],</span><span class="n">match_function</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
               <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;replace&#39;</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;strict&#39;</span>
        <span class="k">if</span> <span class="n">single_block</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">single_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">new_bc</span><span class="p">[</span><span class="n">single_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">mode</span><span class="p">,</span>
                                                   <span class="n">match_att</span><span class="o">=</span><span class="n">match_att</span><span class="p">,</span>
                                                   <span class="n">match_function</span><span class="o">=</span><span class="n">match_function</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">base_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">block_to_item</span> <span class="o">=</span> <span class="n">base_keys</span>   <span class="c1">#default</span>
        <span class="n">new_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">new_bc</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>    <span class="c1">#get list of incoming blocks</span>
        <span class="k">if</span> <span class="n">match_att</span><span class="p">:</span>
            <span class="c1">#make a blockname -&gt; item name map</span>
            <span class="k">if</span> <span class="n">match_function</span><span class="p">:</span>
                <span class="n">block_to_item</span> <span class="o">=</span> <span class="p">[</span><span class="n">match_function</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">block_to_item</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">match_att</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="c1">#print `block_to_item`</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_keys</span><span class="p">:</span>        <span class="c1">#run over incoming blocknames</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">idblock</span><span class="p">:</span> <span class="k">continue</span>    <span class="c1">#skip dictionary id</span>
            <span class="n">basekey</span> <span class="o">=</span> <span class="n">key</span>           <span class="c1">#default value</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_att</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
               <span class="n">attval</span> <span class="o">=</span> <span class="n">new_bc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">match_att</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>  <span class="c1">#0 if ignoring matching</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">attval</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">block_to_item</span><span class="p">)):</span>  <span class="c1">#do this way to get looped names</span>
                <span class="n">thisatt</span> <span class="o">=</span> <span class="n">block_to_item</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>       <span class="c1">#keyname in old block</span>
                <span class="c1">#print &quot;Looking for %s in %s&quot; % (attval,thisatt)</span>
                <span class="k">if</span> <span class="n">attval</span> <span class="o">==</span> <span class="n">thisatt</span> <span class="ow">or</span> \
                   <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">thisatt</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attval</span> <span class="ow">in</span> <span class="n">thisatt</span><span class="p">):</span>
                      <span class="n">basekey</span> <span class="o">=</span> <span class="n">base_keys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                      <span class="n">block_to_item</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">thisatt</span><span class="p">)</span>
                      <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">basekey</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">or</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;replace&quot;</span><span class="p">:</span>
                <span class="n">new_parent</span> <span class="o">=</span> <span class="n">new_bc</span><span class="o">.</span><span class="n">get_parent</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">new_parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                   <span class="n">new_parent</span> <span class="o">=</span> <span class="n">parent</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">NewBlock</span><span class="p">(</span><span class="n">basekey</span><span class="p">,</span><span class="n">new_bc</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="n">parent</span><span class="o">=</span><span class="n">new_parent</span><span class="p">)</span>   <span class="c1">#add the block</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;strict&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s2">&quot;In strict merge mode: block </span><span class="si">%s</span><span class="s2"> in old and block </span><span class="si">%s</span><span class="s2"> in new files&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">basekey</span><span class="p">,</span><span class="n">key</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;overlay&quot;</span><span class="p">:</span>
                    <span class="c1"># print &quot;Merging block %s with %s&quot; % (basekey,key)</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">basekey</span><span class="p">]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">new_bc</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="n">mode</span><span class="p">,</span><span class="n">match_att</span><span class="o">=</span><span class="n">match_att</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s2">&quot;Merge called with unknown mode </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">checknamelengths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">target_block</span><span class="p">,</span><span class="n">maxlength</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">maxlength</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">toolong</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">target_block</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">&gt;</span><span class="n">maxlength</span><span class="p">]</span>
        <span class="n">outstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">toolong</span><span class="p">:</span>
           <span class="n">outstring</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolong</span><span class="p">)</span>
           <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Following data names too long:&#39;</span> <span class="o">+</span> <span class="n">outstring</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">):</span>
        <span class="n">raw_values</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">raw_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">raw_values</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">]</span>
        <span class="n">ret_vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rv</span> <span class="ow">in</span> <span class="n">raw_values</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">rvv</span> <span class="ow">in</span> <span class="n">rv</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rvv</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ret_vals</span><span class="p">:</span> <span class="n">ret_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rvv</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rv</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ret_vals</span><span class="p">:</span> <span class="n">ret_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret_vals</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attr_name</span><span class="p">,</span><span class="n">newval</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr_name</span> <span class="o">==</span> <span class="s1">&#39;scoping&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">newval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;dictionary&#39;</span><span class="p">,</span><span class="s1">&#39;instance&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;Star file may only have &#39;dictionary&#39; or &#39;instance&#39; scoping, not </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">newval</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newval</span> <span class="o">==</span> <span class="s1">&#39;dictionary&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#only top-level datablocks visible</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">==</span><span class="bp">None</span><span class="p">]</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attr_name</span><span class="p">,</span><span class="n">newval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blockname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the name of the block enclosing [[blockname]] in canonical form (lower case)&quot;&quot;&quot;</span>
        <span class="n">possibles</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">blockname</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">first</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">possibles</span><span class="p">)</span>   <span class="c1">#get first one</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;no parent for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">blockname</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
           <span class="n">second</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">possibles</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
           <span class="k">return</span> <span class="n">first</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;More than one parent for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">blockname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_roots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the top-level blocks&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">==</span><span class="bp">None</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blockname</span><span class="p">,</span><span class="n">include_parent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">scoping</span><span class="o">=</span><span class="s1">&#39;dictionary&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all children of [[blockname]] as a block collection. If [[include_parent]] is</span>
<span class="sd">        True, the parent block will also be included in the block collection as the root.&quot;&quot;&quot;</span>
        <span class="n">newbc</span> <span class="o">=</span> <span class="n">BlockCollection</span><span class="p">()</span>
        <span class="n">block_lower</span> <span class="o">=</span> <span class="n">blockname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">proto_child_table</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_child_of_parent</span><span class="p">(</span><span class="n">block_lower</span><span class="p">,</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span><span class="p">)]</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">child_table</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">proto_child_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_parent</span><span class="p">:</span>
           <span class="n">newbc</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">([(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span><span class="p">,</span><span class="bp">None</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">proto_child_table</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">block_lower</span><span class="p">]))</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">lower_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">proto_child_table</span><span class="p">])</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">proto_child_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_parent</span><span class="p">:</span>
            <span class="n">newbc</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">block_lower</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">block_lower</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span><span class="p">,</span><span class="bp">None</span><span class="p">)})</span>
            <span class="n">newbc</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">block_lower</span><span class="p">)</span>
            <span class="n">newbc</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">block_lower</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">block_lower</span><span class="p">]})</span>
        <span class="n">newbc</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="n">scoping</span>
        <span class="k">return</span> <span class="n">newbc</span>

    <span class="k">def</span> <span class="nf">get_immediate_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parentname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the next level of children of the given block as a list, without nested levels&quot;&quot;&quot;</span>
        <span class="n">child_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">parentname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">child_handles</span>

    <span class="c1"># This takes time</span>
    <span class="k">def</span> <span class="nf">get_child_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parentname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of all child categories in alphabetical order&quot;&quot;&quot;</span>
        <span class="n">child_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_child_of_parent</span><span class="p">(</span><span class="n">parentname</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">child_handles</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">child_handles</span>

    <span class="k">def</span> <span class="nf">is_child_of_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parentname</span><span class="p">,</span><span class="n">blockname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return `True` if `blockname` is a child of `parentname`&quot;&quot;&quot;</span>
        <span class="n">checkname</span> <span class="o">=</span> <span class="n">parentname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">more_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">checkname</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">blockname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">more_children</span><span class="p">:</span>
           <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="k">for</span> <span class="n">one_child</span> <span class="ow">in</span> <span class="n">more_children</span><span class="p">:</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_child_of_parent</span><span class="p">(</span><span class="n">one_child</span><span class="p">,</span><span class="n">blockname</span><span class="p">):</span> <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parentname</span><span class="p">,</span><span class="n">childname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the parent block&quot;&quot;&quot;</span>
        <span class="c1"># first check that both blocks exist</span>
        <span class="k">if</span> <span class="n">parentname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Parent block </span><span class="si">%s</span><span class="s1"> does not exist&#39;</span> <span class="o">%</span> <span class="n">parentname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">childname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Child block </span><span class="si">%s</span><span class="s1"> does not exist&#39;</span> <span class="o">%</span> <span class="n">childname</span><span class="p">)</span>
        <span class="n">old_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">childname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">childname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">old_entry</span><span class="o">.</span><span class="n">block_id</span><span class="p">,</span>
               <span class="n">parentname</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="c1">#reset visibility</span>

    <span class="k">def</span> <span class="nf">SetTemplate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">template_file</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Use `template_file` as a template for all block output&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span> <span class="o">=</span> <span class="n">process_template</span><span class="p">(</span><span class="n">template_file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">b</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span>

    <span class="k">def</span> <span class="nf">WriteOut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">comment</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">wraplength</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">maxoutlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">blockorder</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">saves_after</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the contents of this file as a string, wrapping if possible at `wraplength`</span>
<span class="sd">        characters and restricting maximum line length to `maxoutlength`.  Delimiters and</span>
<span class="sd">        save frame nesting are controlled by `self.grammar`. If `blockorder` is</span>
<span class="sd">        provided, blocks are output in this order unless nested save frames have been</span>
<span class="sd">        requested (STAR2). The default block order is the order in which blocks were input.</span>
<span class="sd">        `saves_after` inserts all save frames after the given dataname,</span>
<span class="sd">        which allows less important items to appear later.  Useful in conjunction with a</span>
<span class="sd">        template for dictionary files.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">maxoutlength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SetOutputLength</span><span class="p">(</span><span class="n">maxoutlength</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">comment</span><span class="p">:</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_comment</span>
        <span class="n">outstring</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">==</span> <span class="s2">&quot;2.0&quot;</span> <span class="ow">and</span> <span class="n">comment</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">!=</span> <span class="sa">r</span><span class="s2">&quot;#\#CIF_2.0&quot;</span><span class="p">:</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;#\#CIF_2.0&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="c1"># prepare all blocks</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">b</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span>
            <span class="n">b</span><span class="o">.</span><span class="n">SetOutputLength</span><span class="p">(</span><span class="n">wraplength</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span><span class="p">)</span>
        <span class="c1"># loop over top-level</span>
        <span class="c1"># monitor output</span>
        <span class="n">all_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>   <span class="c1">#i.e. lower case</span>
        <span class="k">if</span> <span class="n">blockorder</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">blockorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span>
        <span class="n">top_block_names</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">blockorder</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">blockref</span><span class="p">,</span><span class="n">blockname</span> <span class="ow">in</span> <span class="n">top_block_names</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">%s</span><span class="s1">, &#39;</span> <span class="o">%</span> <span class="n">blockname</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]))</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;data_&#39;</span> <span class="o">+</span><span class="n">blockname</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">all_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">blockref</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">==</span> <span class="s1">&#39;Dic&#39;</span><span class="p">:</span>              <span class="c1">#put contents before save frames</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]</span><span class="o">.</span><span class="n">printsection</span><span class="p">(</span><span class="n">finish_at</span><span class="o">=</span><span class="s1">&#39;_dictionary_valid.application&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">==</span> <span class="s1">&#39;STAR2&#39;</span><span class="p">:</span>  <span class="c1">#nested save frames</span>
                <span class="n">child_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_immediate_children</span><span class="p">(</span><span class="n">blockref</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">child_ref</span><span class="p">,</span><span class="n">child_info</span> <span class="ow">in</span> <span class="n">child_refs</span><span class="p">:</span>
                    <span class="n">child_name</span> <span class="o">=</span> <span class="n">child_info</span><span class="o">.</span><span class="n">block_id</span>
                    <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="n">child_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">block_to_string_nested</span><span class="p">(</span><span class="n">child_ref</span><span class="p">,</span><span class="n">child_name</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                    <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span><span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span><span class="s1">&#39;1.1&#39;</span><span class="p">,</span><span class="s1">&#39;2.0&#39;</span><span class="p">):</span>                   <span class="c1">#non-nested save frames</span>
                <span class="n">child_refs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">blockorder</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_child_of_parent</span><span class="p">(</span><span class="n">blockref</span><span class="p">,</span><span class="n">a</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">child_ref</span> <span class="ow">in</span> <span class="n">child_refs</span><span class="p">:</span>
                    <span class="n">child_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">child_ref</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span>
                    <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="n">child_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">child_ref</span><span class="p">]))</span>
                    <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">all_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">child_ref</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Grammar </span><span class="si">%s</span><span class="s1"> is not recognised for output&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">!=</span> <span class="s1">&#39;Dic&#39;</span><span class="p">:</span>              <span class="c1">#put contents after save frames</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]</span><span class="o">.</span><span class="n">printsection</span><span class="p">(</span><span class="n">start_from</span><span class="o">=</span><span class="s1">&#39;_dictionary_valid.application&#39;</span><span class="p">))</span>
        <span class="n">returnstring</span> <span class="o">=</span>  <span class="n">outstring</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">outstring</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;WARNING: following blocks not output: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">all_names</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;All blocks output.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">returnstring</span>

    <span class="k">def</span> <span class="nf">block_to_string_nested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">block_ref</span><span class="p">,</span><span class="n">block_id</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="n">indentlevel</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Output a complete datablock indexed by [[block_ref]] and named [[block_id]], including children,</span>
<span class="sd">           and syntactically nesting save frames&quot;&quot;&quot;</span>
        <span class="n">child_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_immediate_children</span><span class="p">(</span><span class="n">block_ref</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">block_ref</span><span class="p">]</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">==</span> <span class="s1">&#39;Dic&#39;</span><span class="p">:</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">block_ref</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">child_ref</span><span class="p">,</span><span class="n">child_info</span> <span class="ow">in</span> <span class="n">child_refs</span><span class="p">:</span>
            <span class="n">child_name</span> <span class="o">=</span> <span class="n">child_info</span><span class="o">.</span><span class="n">block_id</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="n">child_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_to_string_nested</span><span class="p">(</span><span class="n">child_ref</span><span class="p">,</span><span class="n">child_name</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="n">indentlevel</span><span class="p">)</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span><span class="o">*</span><span class="n">indentlevel</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">!=</span> <span class="s1">&#39;Dic&#39;</span><span class="p">:</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">block_ref</span><span class="p">]))</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.StarFile.BlockCollection">BlockCollection</a></li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Instance variables</h3>
            <div class="item">
            <p id="CifFile.StarFile.BlockCollection.PC" class="name">var <span class="ident">PC</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.BlockCollection.NewBlock">
    <p>def <span class="ident">NewBlock</span>(</p><p>self, blockname, blockcontents=None, fix=True, parent=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Add a new block named <code>blockname</code> with contents <code>blockcontents</code>. If <code>fix</code>
is True, <code>blockname</code> will have spaces and tabs replaced by underscores. <code>parent</code>
allows a parent block to be set so that block hierarchies can be created.  Depending on
the output standard, these blocks will be printed out as nested save frames or
ignored.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.BlockCollection.NewBlock', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.BlockCollection.NewBlock" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">NewBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blockname</span><span class="p">,</span><span class="n">blockcontents</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">fix</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add a new block named `blockname` with contents `blockcontents`. If `fix`</span>
<span class="sd">    is True, `blockname` will have spaces and tabs replaced by underscores. `parent`</span>
<span class="sd">    allows a parent block to be set so that block hierarchies can be created.  Depending on</span>
<span class="sd">    the output standard, these blocks will be printed out as nested save frames or</span>
<span class="sd">    ignored.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">blockcontents</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">blockcontents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocktype</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">==</span> <span class="s2">&quot;CIF&quot;</span><span class="p">:</span>
        <span class="n">blockcontents</span><span class="o">.</span><span class="n">setmaxnamelength</span><span class="p">(</span><span class="mi">75</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blockname</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">75</span><span class="p">:</span>
             <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Blockname </span><span class="si">%s</span><span class="s1"> is longer than 75 characters&#39;</span> <span class="o">%</span> <span class="n">blockname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fix</span><span class="p">:</span>
        <span class="n">newblockname</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[  </span><span class="se">\t</span><span class="s1">]&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">blockname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">newblockname</span> <span class="o">=</span> <span class="n">blockname</span>
    <span class="n">new_lowerbn</span> <span class="o">=</span> <span class="n">newblockname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">new_lowerbn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>   <span class="c1">#already there</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
           <span class="n">toplevelnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">==</span><span class="bp">None</span><span class="p">]</span>
           <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">new_lowerbn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">toplevelnames</span><span class="p">:</span>  <span class="c1">#can give a new key to this one</span>
              <span class="k">while</span> <span class="n">new_lowerbn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span> <span class="n">new_lowerbn</span> <span class="o">=</span> <span class="n">new_lowerbn</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span>
           <span class="k">elif</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">new_lowerbn</span> <span class="ow">in</span> <span class="n">toplevelnames</span><span class="p">:</span> <span class="c1">#can fix a different one</span>
              <span class="n">replace_name</span> <span class="o">=</span> <span class="n">new_lowerbn</span>
              <span class="k">while</span> <span class="n">replace_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span> <span class="n">replace_name</span> <span class="o">=</span> <span class="n">replace_name</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">_rekey</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">,</span><span class="n">replace_name</span><span class="p">)</span>
              <span class="c1"># now continue on to add in the new block</span>
              <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">new_lowerbn</span><span class="p">:</span>        <span class="c1">#the new block&#39;s requested parent just got renamed!!</span>
                  <span class="n">parent</span> <span class="o">=</span> <span class="n">replace_name</span>
           <span class="k">else</span><span class="p">:</span>
              <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s2">&quot;Attempt to replace existing block &quot;</span> <span class="o">+</span> <span class="n">blockname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">new_lowerbn</span><span class="p">:</span><span class="n">blockcontents</span><span class="p">})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">newblockname</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
       <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">==</span> <span class="s1">&#39;instance&#39;</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">newblockname</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
          <span class="k">else</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">newblockname</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Warning:Parent block </span><span class="si">%s</span><span class="s1"> does not exist for child </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">newblockname</span><span class="p">))</span>
    <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">.</span><span class="n">set_characterset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">characterset</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span>
    <span class="k">return</span> <span class="n">new_lowerbn</span>  <span class="c1">#in case calling routine wants to know</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.BlockCollection.SetTemplate">
    <p>def <span class="ident">SetTemplate</span>(</p><p>self, template_file)</p>
    </div>
    

    
  
    <div class="desc"><p>Use <code>template_file</code> as a template for all block output</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.BlockCollection.SetTemplate', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.BlockCollection.SetTemplate" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">SetTemplate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">template_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use `template_file` as a template for all block output&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span> <span class="o">=</span> <span class="n">process_template</span><span class="p">(</span><span class="n">template_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">b</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.BlockCollection.WriteOut">
    <p>def <span class="ident">WriteOut</span>(</p><p>self, comment=u&#39;&#39;, wraplength=80, maxoutlength=0, blockorder=None, saves_after=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Return the contents of this file as a string, wrapping if possible at <code>wraplength</code>
characters and restricting maximum line length to <code>maxoutlength</code>.  Delimiters and
save frame nesting are controlled by <code>self.grammar</code>. If <code>blockorder</code> is
provided, blocks are output in this order unless nested save frames have been
requested (STAR2). The default block order is the order in which blocks were input.
<code>saves_after</code> inserts all save frames after the given dataname,
which allows less important items to appear later.  Useful in conjunction with a
template for dictionary files.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.BlockCollection.WriteOut', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.BlockCollection.WriteOut" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">WriteOut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">comment</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">wraplength</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">maxoutlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">blockorder</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">saves_after</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the contents of this file as a string, wrapping if possible at `wraplength`</span>
<span class="sd">    characters and restricting maximum line length to `maxoutlength`.  Delimiters and</span>
<span class="sd">    save frame nesting are controlled by `self.grammar`. If `blockorder` is</span>
<span class="sd">    provided, blocks are output in this order unless nested save frames have been</span>
<span class="sd">    requested (STAR2). The default block order is the order in which blocks were input.</span>
<span class="sd">    `saves_after` inserts all save frames after the given dataname,</span>
<span class="sd">    which allows less important items to appear later.  Useful in conjunction with a</span>
<span class="sd">    template for dictionary files.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">maxoutlength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetOutputLength</span><span class="p">(</span><span class="n">maxoutlength</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">comment</span><span class="p">:</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_comment</span>
    <span class="n">outstring</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">==</span> <span class="s2">&quot;2.0&quot;</span> <span class="ow">and</span> <span class="n">comment</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">!=</span> <span class="sa">r</span><span class="s2">&quot;#\#CIF_2.0&quot;</span><span class="p">:</span>
        <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;#\#CIF_2.0&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
    <span class="c1"># prepare all blocks</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span>
        <span class="n">b</span><span class="o">.</span><span class="n">SetOutputLength</span><span class="p">(</span><span class="n">wraplength</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span><span class="p">)</span>
    <span class="c1"># loop over top-level</span>
    <span class="c1"># monitor output</span>
    <span class="n">all_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>   <span class="c1">#i.e. lower case</span>
    <span class="k">if</span> <span class="n">blockorder</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">blockorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span>
    <span class="n">top_block_names</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">blockorder</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">blockref</span><span class="p">,</span><span class="n">blockname</span> <span class="ow">in</span> <span class="n">top_block_names</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">%s</span><span class="s1">, &#39;</span> <span class="o">%</span> <span class="n">blockname</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]))</span>
        <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;data_&#39;</span> <span class="o">+</span><span class="n">blockname</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">all_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">blockref</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">==</span> <span class="s1">&#39;Dic&#39;</span><span class="p">:</span>              <span class="c1">#put contents before save frames</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]</span><span class="o">.</span><span class="n">printsection</span><span class="p">(</span><span class="n">finish_at</span><span class="o">=</span><span class="s1">&#39;_dictionary_valid.application&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">==</span> <span class="s1">&#39;STAR2&#39;</span><span class="p">:</span>  <span class="c1">#nested save frames</span>
            <span class="n">child_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_immediate_children</span><span class="p">(</span><span class="n">blockref</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">child_ref</span><span class="p">,</span><span class="n">child_info</span> <span class="ow">in</span> <span class="n">child_refs</span><span class="p">:</span>
                <span class="n">child_name</span> <span class="o">=</span> <span class="n">child_info</span><span class="o">.</span><span class="n">block_id</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="n">child_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">block_to_string_nested</span><span class="p">(</span><span class="n">child_ref</span><span class="p">,</span><span class="n">child_name</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span><span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span><span class="s1">&#39;1.1&#39;</span><span class="p">,</span><span class="s1">&#39;2.0&#39;</span><span class="p">):</span>                   <span class="c1">#non-nested save frames</span>
            <span class="n">child_refs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">blockorder</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_child_of_parent</span><span class="p">(</span><span class="n">blockref</span><span class="p">,</span><span class="n">a</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">child_ref</span> <span class="ow">in</span> <span class="n">child_refs</span><span class="p">:</span>
                <span class="n">child_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">child_ref</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="n">child_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">child_ref</span><span class="p">]))</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">all_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">child_ref</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Grammar </span><span class="si">%s</span><span class="s1"> is not recognised for output&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">!=</span> <span class="s1">&#39;Dic&#39;</span><span class="p">:</span>              <span class="c1">#put contents after save frames</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]</span><span class="o">.</span><span class="n">printsection</span><span class="p">(</span><span class="n">start_from</span><span class="o">=</span><span class="s1">&#39;_dictionary_valid.application&#39;</span><span class="p">))</span>
    <span class="n">returnstring</span> <span class="o">=</span>  <span class="n">outstring</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="n">outstring</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;WARNING: following blocks not output: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">all_names</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;All blocks output.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">returnstring</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.StarFile.CIFStringIO" class="name">class <span class="ident">CIFStringIO</span></p>
      
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.CIFStringIO', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.CIFStringIO" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CIFStringIO</span><span class="p">(</span><span class="n">StringIO</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">target_width</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">StringIO</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_width</span> <span class="o">=</span> <span class="n">target_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabwidth</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_char</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="n">canbreak</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">mustbreak</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">do_tab</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">newindent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">unindent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                             <span class="n">delimiter</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">startcol</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a string with correct linebreak, tabs and indents&quot;&quot;&quot;</span>
        <span class="c1"># do we need to break?</span>
        <span class="k">if</span> <span class="n">delimiter</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outstring</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Delimiter </span><span class="si">%s</span><span class="s1"> is longer than one character&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">outstring</span> <span class="p">))</span>
            <span class="n">output_delimiter</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">mustbreak</span><span class="p">:</span>    <span class="c1">#insert a new line and indent</span>
            <span class="n">temp_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">StringIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">temp_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_char</span> <span class="o">=</span> <span class="n">temp_string</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">outstring</span><span class="p">)</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">target_width</span><span class="p">:</span> <span class="c1">#try to break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">delimiter</span> <span class="ow">and</span> <span class="n">outstring</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>          <span class="c1">#ie &lt;cr&gt;;</span>
              <span class="k">if</span> <span class="n">canbreak</span><span class="p">:</span>
                <span class="n">temp_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">StringIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">temp_string</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_char</span> <span class="o">=</span> <span class="n">temp_string</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>        <span class="c1">#assume a break will be forced on next value</span>
                <span class="n">output_delimiter</span> <span class="o">=</span> <span class="bp">False</span>    <span class="c1">#the line break becomes the delimiter</span>
        <span class="c1">#try to match requested column</span>
        <span class="k">if</span> <span class="n">startcol</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">&lt;</span> <span class="n">startcol</span><span class="p">:</span>
                <span class="n">StringIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,(</span><span class="n">startcol</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span><span class="p">)</span><span class="o">*</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">=</span> <span class="n">startcol</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_char</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Could not format </span><span class="si">%s</span><span class="s1"> at column </span><span class="si">%d</span><span class="s1"> as already at </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outstring</span><span class="p">,</span><span class="n">startcol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span><span class="p">))</span>
                <span class="n">startcol</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>   <span class="c1">#so that tabbing works as a backup</span>
        <span class="c1">#handle tabs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tabwidth</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">do_tab</span> <span class="ow">and</span> <span class="n">startcol</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">next_stop</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">tabwidth</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">tabwidth</span>
            <span class="c1">#print &#39;Currentpos %d: Next tab stop at %d&#39; % (self.currentpos,next_stop)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">&lt;</span> <span class="n">next_stop</span><span class="p">:</span>
                <span class="n">StringIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,(</span><span class="n">next_stop</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">=</span> <span class="n">next_stop</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_char</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
        <span class="c1">#calculate indentation after tabs and col setting applied</span>
        <span class="k">if</span> <span class="n">newindent</span><span class="p">:</span>           <span class="c1">#indent by current amount</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>    <span class="c1">#first time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span><span class="p">)</span>
                <span class="c1"># print &#39;Indentlist: &#39; + `self.indentlist`</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">unindent</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indentlist</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Warning: cannot unindent any further&#39;</span><span class="p">)</span>
        <span class="c1">#check that we still need a delimiter</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_char</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">]:</span>
            <span class="n">output_delimiter</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1">#now output the string - every invocation comes through here</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">delimiter</span> <span class="ow">and</span> <span class="n">output_delimiter</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">delimiter</span><span class="p">:</span>
            <span class="n">StringIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outstring</span><span class="p">)</span>
        <span class="n">last_line_break</span> <span class="o">=</span> <span class="n">outstring</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last_line_break</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">outstring</span><span class="p">)</span><span class="o">-</span><span class="n">last_line_break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentpos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">outstring</span><span class="p">)</span>
        <span class="c1">#remember the last character</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outstring</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_char</span> <span class="o">=</span> <span class="n">outstring</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">set_tab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tabwidth</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the tab stop position&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabwidth</span> <span class="o">=</span> <span class="n">tabwidth</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.StarFile.CIFStringIO">CIFStringIO</a></li>
          <li>StringIO.StringIO</li>
          </ul>
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.StarFile.LoopBlock" class="name">class <span class="ident">LoopBlock</span></p>
      
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.LoopBlock', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.LoopBlock" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">LoopBlock</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent_block</span><span class="p">,</span><span class="n">dataname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span> <span class="o">=</span> <span class="n">parent_block</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not in a loop structure&#39;</span> <span class="o">%</span> <span class="n">dataname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span> <span class="o">=</span> <span class="n">parent_block</span>

    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

    <span class="c1">#Avoid iterator even though that is Python3-esque</span>
    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataname</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>   <span class="c1">#a packet request</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetPacket</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dataname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not in loop block&#39;</span> <span class="o">%</span> <span class="n">dataname</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">AddLoopName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">dataname</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">has_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">packet_list</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">packet_list</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">names</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="n">r</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
            <span class="k">yield</span> <span class="n">r</span>

    <span class="c1"># for compatibility</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attname</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="p">,</span><span class="n">attname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">coords</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>        <span class="c1">#to create packet index</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">popout</span><span class="p">:</span>
            <span class="c1"># ok, we have a new packet:  append a list to our subloops</span>
            <span class="k">for</span> <span class="n">aloop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
                <span class="n">aloop</span><span class="o">.</span><span class="n">new_enclosing_packet</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">iname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iname</span><span class="p">,</span><span class="n">LoopBlock</span><span class="p">):</span>       <span class="c1">#into a nested loop</span>
                    <span class="k">for</span> <span class="n">subitems</span> <span class="ow">in</span> <span class="n">iname</span><span class="o">.</span><span class="n">load_iter</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="o">+</span><span class="p">[</span><span class="n">count</span><span class="p">]):</span>
                        <span class="c1"># print &#39;Yielding %s&#39; % `subitems`</span>
                        <span class="k">yield</span> <span class="n">subitems</span>
                    <span class="c1"># print &#39;End of internal loop&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># print &#39;Yielding %s&#39; % `self[iname]`</span>
                        <span class="k">yield</span> <span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="n">iname</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">backval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">iname</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)):</span>
                           <span class="c1"># print &#39;backval, coords: %s, %s&#39; % (`backval`,`coords`)</span>
                           <span class="n">backval</span> <span class="o">=</span> <span class="n">backval</span><span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                        <span class="k">yield</span> <span class="bp">self</span><span class="p">,</span><span class="n">backval</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>      <span class="c1"># count packets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">popout</span> <span class="o">=</span> <span class="bp">False</span>        <span class="c1"># reinitialise</span>
        <span class="c1"># print &#39;Finished iterating&#39;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="p">,</span><span class="s1">&#39;###Blank###&#39;</span>     <span class="c1">#this value should never be used</span>

    <span class="c1"># an experimental fast iterator for level-1 loops (ie CIF)</span>
    <span class="k">def</span> <span class="nf">fast_load_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">targets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="p">,</span><span class="n">target</span>

    <span class="c1"># Add another list of the required shape to take into account a new outer packet</span>
    <span class="k">def</span> <span class="nf">new_enclosing_packet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>      <span class="c1">#otherwise have a top-level list</span>
            <span class="k">for</span> <span class="n">iname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1">#includes lower levels</span>
                <span class="n">target_list</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">iname</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">):</span> <span class="c1">#dim 2 upwards are lists of lists of...</span>
                    <span class="n">target_list</span> <span class="o">=</span> <span class="n">target_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">target_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="c1"># print &#39;%s now %s&#39; % (iname,`self[iname]`)</span>

    <span class="k">def</span> <span class="nf">recursive_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dict_so_far</span><span class="o">=</span><span class="p">{},</span><span class="n">coord</span><span class="o">=</span><span class="p">[]):</span>
        <span class="c1"># print &quot;Recursive iter: coord %s, keys %s, dim %d&quot; % (`coord`,`self.block.keys()`,self.dimension)</span>
        <span class="n">my_length</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">top_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="n">top_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>       <span class="c1">#same order as items</span>
        <span class="n">drill_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dimup</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">):</span>  <span class="c1">#look higher in the tree</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drill_values</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>            <span class="c1">#this block has values</span>
                <span class="n">drill_values</span><span class="o">=</span><span class="n">drill_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="c1">#drill in</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;Malformed loop packet </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">top_items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">))</span>
        <span class="n">my_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">drill_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>       <span class="c1">#length of &#39;string&#39; entry</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                <span class="c1">#top level</span>
            <span class="k">for</span> <span class="n">aloop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">apacket</span> <span class="ow">in</span> <span class="n">aloop</span><span class="o">.</span><span class="n">recursive_iter</span><span class="p">():</span>
                    <span class="c1"># print &quot;Recursive yielding %s&quot; % repr( dict(top_items + apacket.items()) )</span>
                    <span class="n">prep_yield</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">(</span><span class="n">top_values</span><span class="o">+</span><span class="n">apacket</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>  <span class="c1">#straight list</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">top_items</span> <span class="o">+</span> <span class="n">apacket</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">prep_yield</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">prep_yield</span>
        <span class="k">else</span><span class="p">:</span>                                  <span class="c1">#in some loop</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">my_length</span><span class="p">):</span>
                <span class="n">kvpairs</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:(</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_to_group</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">coord</span><span class="p">)[</span><span class="n">i</span><span class="p">]),</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">kvvals</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">kvpairs</span><span class="p">)</span>   <span class="c1">#just values</span>
                <span class="c1"># print &quot;Recursive kvpairs at %d: %s&quot; % (i,repr( kvpairs ))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
                  <span class="k">for</span> <span class="n">aloop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">apacket</span> <span class="ow">in</span> <span class="n">aloop</span><span class="o">.</span><span class="n">recursive_iter</span><span class="p">(</span><span class="n">coord</span><span class="o">=</span><span class="n">coord</span><span class="o">+</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        <span class="c1"># print &quot;Recursive yielding %s&quot; % repr( dict(kvpairs + apacket.items()) )</span>
                        <span class="n">prep_yield</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">(</span><span class="n">kvvals</span><span class="o">+</span><span class="n">apacket</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">kvpairs</span> <span class="o">+</span> <span class="n">apacket</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="n">prep_yield</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="n">prep_yield</span>
                <span class="k">else</span><span class="p">:</span>           <span class="c1"># we&#39;re at the bottom of the tree</span>
                    <span class="c1"># print &quot;Recursive yielding %s&quot; % repr( dict(kvpairs) )</span>
                    <span class="n">prep_yield</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">(</span><span class="n">kvvals</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">kvpairs</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">prep_yield</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">prep_yield</span>

    <span class="c1"># small function to use the coordinates.</span>
    <span class="k">def</span> <span class="nf">coord_to_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">coords</span><span class="p">):</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataname</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
             <span class="k">return</span> <span class="n">dataname</span>     <span class="c1"># flag inner loop processing</span>
          <span class="n">newm</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span>          <span class="c1"># newm must be a list or tuple</span>
          <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
              <span class="c1"># print &quot;Coord_to_group: %s -&gt;&quot; % (repr( newm )),</span>
              <span class="n">newm</span> <span class="o">=</span> <span class="n">newm</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
              <span class="c1"># print repr( newm )</span>
          <span class="k">return</span> <span class="n">newm</span>

    <span class="k">def</span> <span class="nf">flat_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">my_length</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">top_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_keys</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">my_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">top_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">pack_no</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">my_length</span><span class="p">):</span>
                <span class="k">yield</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collapse</span><span class="p">(</span><span class="n">pack_no</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">RemoveItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove `itemname` from the block.&quot;&quot;&quot;</span>
        <span class="c1"># first check any loops</span>
        <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>
        <span class="n">testkey</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">testkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
            <span class="c1"># now remove from loop</span>
            <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">loop_no</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1">#will appear in order list</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">RemoveLoopItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `RemoveItem` instead&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RemoveItem</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GetLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a `StarFile.LoopBlock` object constructed from the loop containing `keyname`.</span>
<span class="sd">        `keyname` is only significant as a way to specify the loop.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">LoopBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GetPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>
        <span class="n">thispack</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">myitem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]:</span>
            <span class="n">thispack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">myitem</span><span class="p">][</span><span class="n">index</span><span class="p">])</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">thispack</span><span class="p">,</span><span class="n">myitem</span><span class="p">,</span><span class="n">thispack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">thispack</span>

    <span class="k">def</span> <span class="nf">AddPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">packet</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">myitem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]:</span>
            <span class="n">old_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="p">[</span><span class="n">myitem</span><span class="p">]</span>
            <span class="n">old_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">myitem</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="p">[</span><span class="n">myitem</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_values</span>

    <span class="k">def</span> <span class="nf">GetItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of datanames in this `LoopBlock` in the order that they will be</span>
<span class="sd">        printed&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">][:]</span>


    <span class="k">def</span> <span class="nf">ChangeItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">,</span><span class="n">newpos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change the position at which `itemname` appears when printing out to `newpos`.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">newpos</span><span class="p">,</span><span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">GetItemPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A utility function to get the numerical order in the printout</span>
<span class="sd">        of `itemname`.  An item has coordinate `(loop_no,pos)` with</span>
<span class="sd">        the top level having a `loop_no` of -1.  If an integer is passed to</span>
<span class="sd">        the routine then it will return the position of the loop</span>
<span class="sd">        referenced by that number.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemname</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
            <span class="c1"># return loop position</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">itemname</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">itemname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No such dataname </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">itemname</span><span class="p">)</span>
        <span class="n">testname</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">testname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">))</span>
        <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
        <span class="n">loop_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loop_no</span><span class="p">,</span><span class="n">loop_pos</span>

    <span class="k">def</span> <span class="nf">GetLoopNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keyname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">aloop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">aloop</span><span class="o">.</span><span class="n">GetLoopNames</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Item does not exist&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GetLoopNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all datanames appearing together with `keyname`&quot;&quot;&quot;</span>
        <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not in any loop&#39;</span> <span class="o">%</span> <span class="n">keyname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">):</span>
        <span class="n">thisloop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itemname</span><span class="p">,</span><span class="n">itemvalue</span> <span class="ow">in</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">thisloop</span><span class="p">[</span><span class="n">itemname</span><span class="p">]</span> <span class="o">=</span> <span class="n">itemvalue</span>

    <span class="k">def</span> <span class="nf">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` followed by calls to `AddLoopName`.</span>

<span class="sd">        Add multiple columns to the loop containing `dataname`. `loopdata` is a</span>
<span class="sd">        collection of (key,value) pairs, where `key` is the new dataname and `value`</span>
<span class="sd">        is a list of values for that dataname&quot;&quot;&quot;</span>
        <span class="c1"># check lengths</span>
        <span class="n">thisloop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
        <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">dataname</span><span class="p">])</span>
        <span class="n">bad_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">!=</span><span class="n">loop_len</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_vals</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
           <span class="k">raise</span> <span class="n">StarLengthError</span><span class="p">(</span><span class="s2">&quot;Number of values for looped datanames </span><span class="si">%s</span><span class="s2"> not equal to </span><span class="si">%d</span><span class="s2">&quot;</span> \
               <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">bad_vals</span> <span class="p">),</span><span class="n">loop_len</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loopdata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">thisloop</span><span class="p">]</span><span class="o">+=</span><span class="n">loopdata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.StarFile.LoopBlock">LoopBlock</a></li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.LoopBlock.AddPacket">
    <p>def <span class="ident">AddPacket</span>(</p><p>self, packet)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.LoopBlock.AddPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.LoopBlock.AddPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">packet</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">myitem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]:</span>
        <span class="n">old_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="p">[</span><span class="n">myitem</span><span class="p">]</span>
        <span class="n">old_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">myitem</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="p">[</span><span class="n">myitem</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_values</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.LoopBlock.AddToLoop">
    <p>def <span class="ident">AddToLoop</span>(</p><p>self, dataname, loopdata)</p>
    </div>
    

    
  
    <div class="desc"><p><em>Deprecated</em>. Use <code>AddItem</code> followed by calls to <code>AddLoopName</code>.</p>
<p>Add multiple columns to the loop containing <code>dataname</code>. <code>loopdata</code> is a
collection of (key,value) pairs, where <code>key</code> is the new dataname and <code>value</code>
is a list of values for that dataname</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.LoopBlock.AddToLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.LoopBlock.AddToLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` followed by calls to `AddLoopName`.</span>
<span class="sd">    Add multiple columns to the loop containing `dataname`. `loopdata` is a</span>
<span class="sd">    collection of (key,value) pairs, where `key` is the new dataname and `value`</span>
<span class="sd">    is a list of values for that dataname&quot;&quot;&quot;</span>
    <span class="c1"># check lengths</span>
    <span class="n">thisloop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
    <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">dataname</span><span class="p">])</span>
    <span class="n">bad_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">!=</span><span class="n">loop_len</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_vals</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
       <span class="k">raise</span> <span class="n">StarLengthError</span><span class="p">(</span><span class="s2">&quot;Number of values for looped datanames </span><span class="si">%s</span><span class="s2"> not equal to </span><span class="si">%d</span><span class="s2">&quot;</span> \
           <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">bad_vals</span> <span class="p">),</span><span class="n">loop_len</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loopdata</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">thisloop</span><span class="p">]</span><span class="o">+=</span><span class="n">loopdata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.LoopBlock.ChangeItemOrder">
    <p>def <span class="ident">ChangeItemOrder</span>(</p><p>self, itemname, newpos)</p>
    </div>
    

    
  
    <div class="desc"><p>Change the position at which <code>itemname</code> appears when printing out to <code>newpos</code>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.LoopBlock.ChangeItemOrder', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.LoopBlock.ChangeItemOrder" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">ChangeItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">,</span><span class="n">newpos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Change the position at which `itemname` appears when printing out to `newpos`.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">newpos</span><span class="p">,</span><span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.LoopBlock.GetItemOrder">
    <p>def <span class="ident">GetItemOrder</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a list of datanames in this <code>LoopBlock</code> in the order that they will be
printed</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.LoopBlock.GetItemOrder', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.LoopBlock.GetItemOrder" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a list of datanames in this `LoopBlock` in the order that they will be</span>
<span class="sd">    printed&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">][:]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.LoopBlock.GetItemPosition">
    <p>def <span class="ident">GetItemPosition</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p>A utility function to get the numerical order in the printout
of <code>itemname</code>.  An item has coordinate <code>(loop_no,pos)</code> with
the top level having a <code>loop_no</code> of -1.  If an integer is passed to
the routine then it will return the position of the loop
referenced by that number.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.LoopBlock.GetItemPosition', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.LoopBlock.GetItemPosition" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetItemPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A utility function to get the numerical order in the printout</span>
<span class="sd">    of `itemname`.  An item has coordinate `(loop_no,pos)` with</span>
<span class="sd">    the top level having a `loop_no` of -1.  If an integer is passed to</span>
<span class="sd">    the routine then it will return the position of the loop</span>
<span class="sd">    referenced by that number.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemname</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
        <span class="c1"># return loop position</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">itemname</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">itemname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No such dataname </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">itemname</span><span class="p">)</span>
    <span class="n">testname</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">testname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">))</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
    <span class="n">loop_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loop_no</span><span class="p">,</span><span class="n">loop_pos</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.LoopBlock.GetLoop">
    <p>def <span class="ident">GetLoop</span>(</p><p>self, keyname)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a <code>StarFile.LoopBlock</code> object constructed from the loop containing <code>keyname</code>.
<code>keyname</code> is only significant as a way to specify the loop.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.LoopBlock.GetLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.LoopBlock.GetLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a `StarFile.LoopBlock` object constructed from the loop containing `keyname`.</span>
<span class="sd">    `keyname` is only significant as a way to specify the loop.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">LoopBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.LoopBlock.GetLoopNames">
    <p>def <span class="ident">GetLoopNames</span>(</p><p>self, keyname)</p>
    </div>
    

    
  
    <div class="desc"><p>Return all datanames appearing together with <code>keyname</code></p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.LoopBlock.GetLoopNames', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.LoopBlock.GetLoopNames" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetLoopNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return all datanames appearing together with `keyname`&quot;&quot;&quot;</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not in any loop&#39;</span> <span class="o">%</span> <span class="n">keyname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.LoopBlock.GetPacket">
    <p>def <span class="ident">GetPacket</span>(</p><p>self, index)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.LoopBlock.GetPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.LoopBlock.GetPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>
    <span class="n">thispack</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">myitem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]:</span>
        <span class="n">thispack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">myitem</span><span class="p">][</span><span class="n">index</span><span class="p">])</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">thispack</span><span class="p">,</span><span class="n">myitem</span><span class="p">,</span><span class="n">thispack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">thispack</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.LoopBlock.RemoveItem">
    <p>def <span class="ident">RemoveItem</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p>Remove <code>itemname</code> from the block.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.LoopBlock.RemoveItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.LoopBlock.RemoveItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">RemoveItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove `itemname` from the block.&quot;&quot;&quot;</span>
    <span class="c1"># first check any loops</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>
    <span class="n">testkey</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">testkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
        <span class="c1"># now remove from loop</span>
        <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">loop_no</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1">#will appear in order list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.LoopBlock.RemoveLoopItem">
    <p>def <span class="ident">RemoveLoopItem</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p><em>Deprecated</em>. Use <code>RemoveItem</code> instead</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.LoopBlock.RemoveLoopItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.LoopBlock.RemoveLoopItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">RemoveLoopItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `RemoveItem` instead&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">RemoveItem</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.StarFile.StarBlock" class="name">class <span class="ident">StarBlock</span></p>
      
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">StarBlock</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span> <span class="o">=</span> <span class="p">(),</span> <span class="n">maxoutlength</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">wraplength</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">characterset</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span><span class="n">maxnamelength</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1">#the actual data storage (lower case keys)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1">#each loop is indexed by a number and contains a list of datanames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">#lower case, loops referenced by integer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#transform lower case to supplied case</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c1">#prefer string version always</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="bp">None</span>      <span class="c1">#DDLm dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">popout</span> <span class="o">=</span> <span class="bp">False</span>         <span class="c1">#used during load iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curitem</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>           <span class="c1">#used during iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_vals</span> <span class="o">=</span> <span class="bp">True</span>      <span class="c1">#store all calculated values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span> <span class="o">=</span> <span class="n">maxoutlength</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setmaxnamelength</span><span class="p">(</span><span class="n">maxnamelength</span><span class="p">)</span>  <span class="c1">#to enforce CIF limit of 75 characters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_characterset</span><span class="p">(</span><span class="n">characterset</span><span class="p">)</span>   <span class="c1">#to check input names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wraplength</span> <span class="o">=</span> <span class="n">wraplength</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="n">overwrite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">string_delimiters</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">;&quot;</span><span class="p">]</span>   <span class="c1">#universal CIF set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_delimiter</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>                 <span class="c1">#CIF2 default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">TextWrapper</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">StarBlock</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">item_order</span><span class="p">[:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">true_case</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># loops as well</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">setmaxnamelength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">maxlength</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the maximum allowable dataname length (-1 for no check)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxnamelength</span> <span class="o">=</span> <span class="n">maxlength</span>
        <span class="k">if</span> <span class="n">maxlength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bad_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">maxnamelength</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Datanames too long: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">bad_names</span> <span class="p">))</span>

    <span class="k">def</span> <span class="nf">set_characterset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">characterset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the characterset for checking datanames: may be `ascii` or `unicode`&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">characterset</span> <span class="o">=</span> <span class="n">characterset</span>
        <span class="k">if</span> <span class="n">characterset</span> <span class="o">==</span> <span class="s1">&#39;ascii&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">char_check</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;[][ </span><span class="se">\n\r\t</span><span class="s2">!%&amp;\(\)*+,./:&lt;=&gt;?@0-9A-Za-z</span><span class="se">\\\\</span><span class="s2">^`{}\|~</span><span class="se">\&quot;</span><span class="s2">#$&#39;;_-]+&quot;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">characterset</span> <span class="o">==</span> <span class="s1">&#39;unicode&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxunicode</span> <span class="o">&lt;</span> <span class="mi">1114111</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">char_check</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;[][ </span><span class="se">\n\r\t</span><span class="s2">!%&amp;\(\)*+,./:&lt;=&gt;?@0-9A-Za-z</span><span class="se">\\\\</span><span class="s2">^`{}\|~</span><span class="se">\&quot;</span><span class="s2">#$&#39;;_</span><span class="se">\u00A0</span><span class="s2">-</span><span class="se">\uD7FF\uE000</span><span class="s2">-</span><span class="se">\uFDCF\uFDF0</span><span class="s2">-</span><span class="se">\uFFFD</span><span class="s2">-]+&quot;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">char_check</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;[][ </span><span class="se">\n\r\t</span><span class="s2">!%&amp;\(\)*+,./:&lt;=&gt;?@0-9A-Za-z</span><span class="se">\\\\</span><span class="s2">^`{}\|~</span><span class="se">\&quot;</span><span class="s2">#$&#39;;_</span><span class="se">\u00A0</span><span class="s2">-</span><span class="se">\uD7FF\uE000</span><span class="s2">-</span><span class="se">\uFDCF\uFDF0</span><span class="s2">-</span><span class="se">\uFFFD\U00010000</span><span class="s2">-</span><span class="se">\U0010FFFD</span><span class="s2">-]+&quot;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">printsection</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;saves&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Setting the saves key is deprecated. Add the save block to</span>
<span class="s2">    an enclosing block collection (e.g. CIF or STAR file) with this block as child&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;saves&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;The saves key is deprecated. Access the save block from</span>
<span class="s2">    the enclosing block collection (e.g. CIF or STAR file object)&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
           <span class="n">rawitem</span><span class="p">,</span><span class="n">is_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetFullItemValue</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
           <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">:</span>
               <span class="c1"># send the dictionary the required key and a pointer to us</span>
               <span class="k">try</span><span class="p">:</span>
                   <span class="n">new_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">derive_item</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_vals</span><span class="p">,</span><span class="n">allow_defaults</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
               <span class="k">except</span> <span class="n">StarDerivationFailure</span><span class="p">:</span>   <span class="c1">#try now with defaults included</span>
                   <span class="k">try</span><span class="p">:</span>
                       <span class="n">new_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">derive_item</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_vals</span><span class="p">,</span><span class="n">allow_defaults</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                   <span class="k">except</span> <span class="n">StarDerivationFailure</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                       <span class="k">print</span><span class="p">(</span><span class="s2">&quot;In StarBlock.__getitem__, &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
                       <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No such item: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
               <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Set </span><span class="si">%s</span><span class="s1"> to derived value </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">new_value</span><span class="p">)))</span>
               <span class="k">return</span> <span class="n">new_value</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No such item: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="c1"># we now have an item, we can try to convert it to a number if that is appropriate</span>
        <span class="c1"># note numpy values are never stored but are converted to lists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">:</span> <span class="k">return</span> <span class="n">rawitem</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: is_value </span><span class="si">%s</span><span class="s1"> provide_value </span><span class="si">%s</span><span class="s1"> value </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span> <span class="n">is_value</span> <span class="p">),</span><span class="nb">repr</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="p">),</span><span class="nb">repr</span><span class="p">(</span> <span class="n">rawitem</span> <span class="p">)))</span>
        <span class="k">if</span> <span class="n">is_value</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span><span class="p">:</span> <span class="k">return</span> <span class="n">rawitem</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Turning </span><span class="si">%s</span><span class="s1"> into string&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">rawitem</span> <span class="p">))</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_to_string</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>    <span class="c1"># a string</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="ow">and</span> <span class="p">((</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rawitem</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rawitem</span> <span class="o">!=</span> <span class="s1">&#39;?&#39;</span> <span class="ow">and</span> <span class="n">rawitem</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="ow">or</span> \
                                      <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rawitem</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;?&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rawitem</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rawitem</span><span class="p">)):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">change_type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">rawitem</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span><span class="p">:</span> <span class="c1"># catch the question marks</span>
                <span class="n">do_calculate</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rawitem</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">known</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rawitem</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="s1">&#39;?&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">known</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>   <span class="c1">#all questions</span>
                        <span class="n">do_calculate</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">elif</span> <span class="n">rawitem</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
                        <span class="n">do_calculate</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">do_calculate</span><span class="p">:</span>
                   <span class="c1"># remove old value</span>
                   <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                   <span class="k">try</span><span class="p">:</span>
                       <span class="n">new_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">derive_item</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">allow_defaults</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                   <span class="k">except</span> <span class="n">StarDerivationFailure</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                       <span class="k">try</span><span class="p">:</span>
                           <span class="n">new_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">derive_item</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">allow_defaults</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                       <span class="k">except</span> <span class="n">StarDerivationFailure</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>

                           <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Could not turn </span><span class="si">%s</span><span class="s2"> into a value:&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
                           <span class="k">return</span> <span class="n">rawitem</span>
                   <span class="k">else</span><span class="p">:</span>
                       <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Set </span><span class="si">%s</span><span class="s1"> to derived value </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">new_value</span> <span class="p">)))</span>
                       <span class="k">return</span> <span class="n">new_value</span>
            <span class="k">return</span> <span class="n">rawitem</span>   <span class="c1">#can&#39;t do anything</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RemoveItem</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">blen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blen</span>

    <span class="k">def</span> <span class="fm">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="c1"># keys returns all internal keys</span>
    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>    <span class="c1">#always lower case</span>

    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">))</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">has_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">has_key_or_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if a dataname or alias is available in the block&quot;&quot;&quot;</span>
        <span class="n">initial_test</span> <span class="o">=</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">initial_test</span><span class="p">:</span> <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">:</span>
            <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">alias_table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,[])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aliases</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
               <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">default</span>
        <span class="k">return</span> <span class="n">retval</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># doesn&#39;t appear to work</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">newcopy</span> <span class="o">=</span> <span class="n">StarBlock</span><span class="p">()</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">loops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">item_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">[:]</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">true_case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newcopy</span><span class="o">.</span><span class="n">loops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1">#    return self.copy.im_class(newcopy)   #catch inheritance</span>
        <span class="k">return</span> <span class="n">newcopy</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">adict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">adict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">adict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">GetItemPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A utility function to get the numerical order in the printout</span>
<span class="sd">        of `itemname`.  An item has coordinate `(loop_no,pos)` with</span>
<span class="sd">        the top level having a `loop_no` of -1.  If an integer is passed to</span>
<span class="sd">        the routine then it will return the position of the loop</span>
<span class="sd">        referenced by that number.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemname</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
            <span class="c1"># return loop position</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">itemname</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">itemname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No such dataname </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">itemname</span><span class="p">)</span>
        <span class="n">testname</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">testname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">))</span>
        <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
        <span class="n">loop_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loop_no</span><span class="p">,</span><span class="n">loop_pos</span>

    <span class="k">def</span> <span class="nf">ChangeItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">,</span><span class="n">newpos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Move the printout order of `itemname` to `newpos`. If `itemname` is</span>
<span class="sd">        in a loop, `newpos` refers to the order within the loop.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemname</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
            <span class="n">true_name</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">true_name</span> <span class="o">=</span> <span class="n">itemname</span>
        <span class="n">loopno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">true_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loopno</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1">#top level</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">true_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">newpos</span><span class="p">,</span><span class="n">true_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loopno</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">true_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loopno</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">newpos</span><span class="p">,</span><span class="n">true_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GetItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of datanames in the order in which they will be printed.  Loops are</span>
<span class="sd">        referred to by numerical index&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">[:]</span>

    <span class="k">def</span> <span class="nf">AddItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">precheck</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add dataname `key` to block with value `value`.  `value` may be</span>
<span class="sd">        a single value, a list or a tuple. If `precheck` is False (the default),</span>
<span class="sd">        all values will be checked and converted to unicode strings as necessary. If</span>
<span class="sd">        `precheck` is True, this checking is bypassed.  No checking is necessary</span>
<span class="sd">        when values are read from a CIF file as they are already in correct form.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
             <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Star datanames are strings only (got </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">key</span> <span class="p">))</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>    <span class="c1">#everything is unicode internally</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">precheck</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">check_data_name</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxnamelength</span><span class="p">)</span>    <span class="c1"># make sure no nasty characters</span>
        <span class="c1"># check for overwriting</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
             <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
                 <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Attempt to insert duplicate item name </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">precheck</span><span class="p">:</span>   <span class="c1">#need to sanitise</span>
            <span class="n">regval</span><span class="p">,</span><span class="n">empty_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularise_data</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">pure_string</span> <span class="o">=</span> <span class="n">check_stringiness</span><span class="p">(</span><span class="n">regval</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_item_value</span><span class="p">(</span><span class="n">regval</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">regval</span><span class="p">,</span><span class="n">empty_val</span> <span class="o">=</span> <span class="n">value</span><span class="p">,</span><span class="bp">None</span>
            <span class="n">pure_string</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># update ancillary information first</span>
        <span class="n">lower_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lower_key</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">lower_key</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>      <span class="c1">#need to add to order</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lower_key</span><span class="p">)</span>
        <span class="c1"># always remove from our case table in case the case is different</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">lower_key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">lower_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">if</span> <span class="n">pure_string</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">lower_key</span><span class="p">:[</span><span class="n">regval</span><span class="p">,</span><span class="n">empty_val</span><span class="p">]})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">lower_key</span><span class="p">:[</span><span class="n">empty_val</span><span class="p">,</span><span class="n">regval</span><span class="p">]})</span>

    <span class="k">def</span> <span class="nf">AddLoopItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">incomingdata</span><span class="p">,</span><span class="n">precheck</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">maxlength</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` followed by `CreateLoop` if</span>
<span class="sd">        necessary.&quot;&quot;&quot;</span>
        <span class="c1"># print &quot;Received data %s&quot; % `incomingdata`</span>
        <span class="c1"># we accept tuples, strings, lists and dicts!!</span>
        <span class="c1"># Direct insertion: we have a string-valued key, with an array</span>
        <span class="c1"># of values -&gt; single-item into our loop</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
           <span class="c1"># a whole loop</span>
           <span class="n">keyvallist</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
           <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">keyvallist</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
             <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Star datanames are strings only (got </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">check_data_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">maxlength</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">maxlength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_name_length</span><span class="p">(</span><span class="n">dataname</span><span class="p">,</span><span class="n">maxlength</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dataname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;_&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Dataname &#39;</span> <span class="o">+</span> <span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; does not begin with _&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">characterset</span><span class="o">==</span><span class="s1">&#39;ascii&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span> <span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataname</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">33</span> <span class="ow">or</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">126</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Dataname &#39;</span> <span class="o">+</span> <span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; contains forbidden characters&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># print &#39;Checking %s for unicode characterset conformance&#39; % dataname</span>
            <span class="k">if</span> <span class="nb">len</span> <span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataname</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">33</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Dataname &#39;</span> <span class="o">+</span> <span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; contains forbidden characters (below code point 33)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span> <span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataname</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">126</span> <span class="ow">and</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">160</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Dataname &#39;</span> <span class="o">+</span> <span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; contains forbidden characters (between code point 127-159)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span> <span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataname</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0xD7FF</span> <span class="ow">and</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0xE000</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Dataname &#39;</span> <span class="o">+</span> <span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; contains unsupported characters (between U+D800 and U+E000)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span> <span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataname</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0xFDCF</span> <span class="ow">and</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0xFDF0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Dataname &#39;</span> <span class="o">+</span> <span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; contains unsupported characters (between U+FDD0 and U+FDEF)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span> <span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataname</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xFFFE</span> <span class="ow">or</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Dataname &#39;</span> <span class="o">+</span> <span class="n">dataname</span> <span class="o">+</span> <span class="s1">&#39; contains unsupported characters (U+FFFE and/or U+FFFF)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span> <span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataname</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x10000</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xE</span> <span class="o">==</span> <span class="mh">0xE</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> fails&#39;</span> <span class="o">%</span> <span class="n">dataname</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataname</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="sa">u</span><span class="s1">&#39;Dataname &#39;</span> <span class="o">+</span> <span class="n">dataname</span> <span class="o">+</span> <span class="sa">u</span><span class="s1">&#39; contains unsupported characters (U+xFFFE and/or U+xFFFF)&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_name_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">maxlength</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span><span class="o">&gt;</span><span class="n">maxlength</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Dataname </span><span class="si">%s</span><span class="s1"> exceeds maximum length </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dataname</span><span class="p">,</span><span class="n">maxlength</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">check_item_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item</span><span class="p">):</span>
        <span class="n">test_item</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">dict</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span>
           <span class="n">test_item</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>         <span class="c1">#single item list</span>
        <span class="k">def</span> <span class="nf">check_one</span> <span class="p">(</span><span class="n">it</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">it</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">it</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="k">return</span>
                <span class="n">me</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">char_check</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">me</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Fail value check: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">it</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Bad character in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">it</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">me</span><span class="o">.</span><span class="n">span</span><span class="p">()</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">it</span><span class="p">)):</span>
                        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Fail value check, match only </span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2"> in string </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">me</span><span class="o">.</span><span class="n">span</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">me</span><span class="o">.</span><span class="n">span</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span><span class="nb">repr</span><span class="p">(</span> <span class="n">it</span> <span class="p">)))</span>
                        <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Data item &quot;&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">it</span> <span class="p">)</span> <span class="o">+</span>  <span class="sa">u</span><span class="s1">&#39;&quot;... contains forbidden characters&#39;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">check_one</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">test_item</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">regularise_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataitem</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place dataitem into a list if necessary&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataitem</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">dataitem</span><span class="p">),</span><span class="bp">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataitem</span><span class="p">,(</span><span class="n">Number</span><span class="p">,</span><span class="nb">unicode</span><span class="p">,</span><span class="n">StarList</span><span class="p">,</span><span class="n">StarDict</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">dataitem</span><span class="p">,</span><span class="bp">None</span>  <span class="c1">#assume StarList/StarDict contain unicode if necessary</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataitem</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
            <span class="n">v</span><span class="p">,</span><span class="n">s</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">regularise_data</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dataitem</span><span class="p">]))</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">),</span><span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="c1">#return dataitem,[None]*len(dataitem)</span>
        <span class="c1"># so try to make into a list</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">regval</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataitem</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">dataitem</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; is wrong type for data value</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="p">)</span>
        <span class="n">v</span><span class="p">,</span><span class="n">s</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">regularise_data</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">regval</span><span class="p">]))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">),</span><span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">RemoveItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove `itemname` from the block.&quot;&quot;&quot;</span>
        <span class="c1"># first check any loops</span>
        <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>
        <span class="n">testkey</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">testkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
            <span class="c1"># now remove from loop</span>
            <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">loop_no</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1">#will appear in order list</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">RemoveLoopItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `RemoveItem` instead&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RemoveItem</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GetItemValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return value of `itemname`.  If `itemname` is looped, a list</span>
<span class="sd">        of all values will be returned.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetFullItemValue</span><span class="p">(</span><span class="n">itemname</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">GetFullItemValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the value associated with `itemname`, and a boolean flagging whether</span>
<span class="sd">        (True) or not (False) it is in a form suitable for calculation.  False is</span>
<span class="sd">        always returned for strings and `StarList` objects.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Itemname </span><span class="si">%s</span><span class="s1"> not in datablock&#39;</span> <span class="o">%</span> <span class="n">itemname</span><span class="p">)</span>
        <span class="c1"># prefer string value unless all are None</span>
        <span class="c1"># are we a looped value?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">StarList</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">not_none</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">s</span><span class="p">,</span><span class="bp">False</span>    <span class="c1">#a string value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">StarList</span><span class="p">)</span>  <span class="c1">#a StarList is not calculation-ready</span>
        <span class="k">elif</span> <span class="n">not_none</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">,</span><span class="bp">False</span>         <span class="c1">#a list of string values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">StarList</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="bp">True</span>

    <span class="k">def</span> <span class="nf">CreateLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">datanames</span><span class="p">,</span><span class="n">order</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">length_check</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
           <span class="sd">&quot;&quot;&quot;Create a loop in the datablock. `datanames` is a list of datanames that</span>
<span class="sd">           together form a loop.  If length_check is True, they should have been initialised in the block</span>
<span class="sd">           to have the same number of elements (possibly 0). If `order` is given,</span>
<span class="sd">           the loop will appear at this position in the block when printing</span>
<span class="sd">           out. A loop counts as a single position.&quot;&quot;&quot;</span>

           <span class="k">if</span> <span class="n">length_check</span><span class="p">:</span>
               <span class="c1"># check lengths: these datanames should exist</span>
               <span class="n">listed_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">datanames</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">StarList</span><span class="p">)]</span>
               <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listed_values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">datanames</span><span class="p">):</span>
                   <span class="n">len_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">datanames</span><span class="p">])</span>
                   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">len_set</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                       <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Request to loop datanames </span><span class="si">%s</span><span class="s1"> with different lengths: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">datanames</span> <span class="p">),</span><span class="nb">repr</span><span class="p">(</span> <span class="n">len_set</span> <span class="p">)))</span>
               <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">listed_values</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                   <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Request to loop datanames where some are single values and some are not&#39;</span><span class="p">)</span>
           <span class="c1"># store as lower case</span>
           <span class="n">lc_datanames</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datanames</span><span class="p">]</span>
           <span class="c1"># remove these datanames from all other loops</span>
           <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">lc_datanames</span> <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
           <span class="c1"># remove empty loops</span>
           <span class="n">empty_loops</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
           <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">empty_loops</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
               <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
           <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
               <span class="n">loopno</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="n">loopno</span> <span class="o">=</span> <span class="mi">1</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loopno</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lc_datanames</span><span class="p">)</span>
           <span class="k">if</span> <span class="n">order</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="n">loopno</span><span class="p">)</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loopno</span><span class="p">)</span>
           <span class="c1"># remove these datanames from item ordering</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lc_datanames</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">AddLoopName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldname</span><span class="p">,</span> <span class="n">newname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add `newname` to the loop containing `oldname`. If it is already in the new loop, no</span>
<span class="sd">        error is raised.  If `newname` is in a different loop, it is removed from that loop.</span>
<span class="sd">        The number of values associated with `newname` must match the number of values associated</span>
<span class="sd">        with all other columns of the new loop or a `ValueError` will be raised.&quot;&quot;&quot;</span>
        <span class="n">lower_newname</span> <span class="o">=</span> <span class="n">newname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">oldname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not in loop&#39;</span> <span class="o">%</span> <span class="n">oldname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lower_newname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="c1"># check length</span>
        <span class="n">old_provides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">oldname</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="n">old_provides</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">newname</span><span class="p">])</span> <span class="o">!=</span> <span class="n">loop_len</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Mismatch of loop column lengths for </span><span class="si">%s</span><span class="s1">: should be </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="n">loop_len</span><span class="p">))</span>
        <span class="c1"># remove from any other loops</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="k">if</span> <span class="n">lower_newname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
        <span class="c1"># and add to this loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span>
        <span class="c1"># remove from item_order if present</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">FindLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the loop that contains `keyname` and return its numerical index or</span>
<span class="sd">        -1 if not present. The numerical index can be used to refer to the loop in</span>
<span class="sd">        other routines.&quot;&quot;&quot;</span>
        <span class="n">loop_no</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">keyname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loop_no</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">loop_no</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">GetLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a `StarFile.LoopBlock` object constructed from the loop containing `keyname`.</span>
<span class="sd">        `keyname` is only significant as a way to specify the loop.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">LoopBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GetLoopNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keyname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">aloop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">aloop</span><span class="o">.</span><span class="n">GetLoopNames</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Item does not exist&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GetLoopNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all datanames appearing together with `keyname`&quot;&quot;&quot;</span>
        <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not in any loop&#39;</span> <span class="o">%</span> <span class="n">keyname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">AddLoopName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldname</span><span class="p">,</span> <span class="n">newname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add `newname` to the loop containing `oldname`. If it is already in the new loop, no</span>
<span class="sd">        error is raised.  If `newname` is in a different loop, it is removed from that loop.</span>
<span class="sd">        The number of values associated with `newname` must match the number of values associated</span>
<span class="sd">        with all other columns of the new loop or a `ValueError` will be raised.&quot;&quot;&quot;</span>
        <span class="n">lower_newname</span> <span class="o">=</span> <span class="n">newname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">oldname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not in loop&#39;</span> <span class="o">%</span> <span class="n">oldname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lower_newname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="c1"># check length</span>
        <span class="n">old_provides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">oldname</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="n">old_provides</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">newname</span><span class="p">])</span> <span class="o">!=</span> <span class="n">loop_len</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Mismatch of loop column lengths for </span><span class="si">%s</span><span class="s1">: should be </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="n">loop_len</span><span class="p">))</span>
        <span class="c1"># remove from any other loops</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="k">if</span> <span class="n">lower_newname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
        <span class="c1"># and add to this loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span>
        <span class="c1"># remove from item_order if present</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">):</span>
        <span class="n">thisloop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itemname</span><span class="p">,</span><span class="n">itemvalue</span> <span class="ow">in</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">thisloop</span><span class="p">[</span><span class="n">itemname</span><span class="p">]</span> <span class="o">=</span> <span class="n">itemvalue</span>

    <span class="k">def</span> <span class="nf">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` followed by calls to `AddLoopName`.</span>

<span class="sd">        Add multiple columns to the loop containing `dataname`. `loopdata` is a</span>
<span class="sd">        collection of (key,value) pairs, where `key` is the new dataname and `value`</span>
<span class="sd">        is a list of values for that dataname&quot;&quot;&quot;</span>
        <span class="c1"># check lengths</span>
        <span class="n">thisloop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
        <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">dataname</span><span class="p">])</span>
        <span class="n">bad_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">!=</span><span class="n">loop_len</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_vals</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
           <span class="k">raise</span> <span class="n">StarLengthError</span><span class="p">(</span><span class="s2">&quot;Number of values for looped datanames </span><span class="si">%s</span><span class="s2"> not equal to </span><span class="si">%d</span><span class="s2">&quot;</span> \
               <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">bad_vals</span> <span class="p">),</span><span class="n">loop_len</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loopdata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">thisloop</span><span class="p">]</span><span class="o">+=</span><span class="n">loopdata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">RemoveKeyedPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the packet for which dataname `keyname` takes</span>
<span class="sd">        value `keyvalue`.  Only the first such occurrence is</span>
<span class="sd">        removed.&quot;&quot;&quot;</span>
        <span class="n">packet_coord</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">keyname</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">keyvalue</span><span class="p">)</span>
        <span class="n">loopnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoopNames</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dataname</span> <span class="ow">in</span> <span class="n">loopnames</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">packet_coord</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">packet_coord</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">GetKeyedPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">no_case</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the loop packet (a `StarPacket` object) where `keyname` has value</span>
<span class="sd">        `keyvalue`. Ignore case in `keyvalue` if `no_case` is True.  `ValueError`</span>
<span class="sd">        is raised if no packet is found or more than one packet is found.&quot;&quot;&quot;</span>
        <span class="n">my_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
        <span class="c1">#print(&quot;Looking for %s in %s&quot; % (keyvalue, my_loop.parent_block))</span>
        <span class="c1">#print(&#39;Packet check on:&#39; + keyname)</span>
        <span class="c1">#[print(repr(getattr(a,keyname))) for a in my_loop]</span>
        <span class="k">if</span> <span class="n">no_case</span><span class="p">:</span>
           <span class="n">one_pack</span><span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="n">keyvalue</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">one_pack</span><span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span><span class="o">==</span><span class="n">keyvalue</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">one_pack</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad packet key </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">: returned </span><span class="si">%d</span><span class="s2"> packets&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">keyname</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">one_pack</span><span class="p">)))</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Keyed packet: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">one_pack</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">one_pack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">GetCompoundKeyedPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keydict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the loop packet (a `StarPacket` object) where the `{key:(value,caseless)}` pairs</span>
<span class="sd">        in `keydict` take the appropriate values. Ignore case for a given `key` if `caseless` is</span>
<span class="sd">        True.  `ValueError` is raised if no packet is found or more than one packet is found.&quot;&quot;&quot;</span>
        <span class="c1">#print &quot;Looking for %s in %s&quot; % (keyvalue, self.parent_block[keyname])</span>
        <span class="n">keynames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keydict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">my_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">keynames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="n">keynames</span><span class="p">:</span>
            <span class="n">keyval</span><span class="p">,</span><span class="n">no_case</span> <span class="o">=</span> <span class="n">keydict</span><span class="p">[</span><span class="n">one_key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">no_case</span><span class="p">:</span>
               <span class="n">my_loop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">one_key</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="nb">str</span><span class="p">(</span><span class="n">keyval</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">my_loop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">one_key</span><span class="p">)</span><span class="o">==</span><span class="n">keyval</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_loop</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad packet keys </span><span class="si">%s</span><span class="s2">: returned </span><span class="si">%d</span><span class="s2"> packets&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">keydict</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">my_loop</span><span class="p">)))</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Compound keyed packet: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">my_loop</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">my_loop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">GetKeyedSemanticPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">cat_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a complete packet for category `cat_id` where the</span>
<span class="sd">        category key for the category equals `keyvalue`.  This routine</span>
<span class="sd">        will understand any joined loops, so if separate loops in the</span>
<span class="sd">        datafile belong to the</span>
<span class="sd">        same category hierarchy (e.g. `_atom_site` and `_atom_site_aniso`),</span>
<span class="sd">        the returned `StarPacket` object will contain datanames from</span>
<span class="sd">        both categories.&quot;&quot;&quot;</span>
        <span class="n">target_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">[</span><span class="n">cat_id</span><span class="p">]</span>
        <span class="n">target_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">]</span> <span class="c1">#one only in each list</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">()</span>
        <span class="c1"># set case-sensitivity flag</span>
        <span class="n">lcase</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;_type.contents&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Code&#39;</span><span class="p">,</span><span class="s1">&#39;Tag&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">]:</span>
            <span class="n">lcase</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">cat_key</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">extra_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetKeyedPacket</span><span class="p">(</span><span class="n">cat_key</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">no_case</span><span class="o">=</span><span class="n">lcase</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>        <span class="c1">#missing key</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">test_key</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">cat_key</span><span class="p">]</span>  <span class="c1">#generate key if possible</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Test key is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">test_key</span> <span class="p">))</span>
                    <span class="k">if</span> <span class="n">test_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>\
                    <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">test_key</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">None</span> <span class="ow">in</span> <span class="n">test_key</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_key</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)):</span>
                        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Getting packet for key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">keyvalue</span> <span class="p">))</span>
                        <span class="n">extra_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetKeyedPacket</span><span class="p">(</span><span class="n">cat_key</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">no_case</span><span class="o">=</span><span class="n">lcase</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>             <span class="c1">#cannot be generated</span>
                    <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>      <span class="c1">#none/more than one, assume none</span>
                <span class="k">continue</span>
                <span class="c1">#extra_packet = self.dictionary.generate_default_packet(cat_id,cat_key,keyvalue)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">merge_packet</span><span class="p">(</span><span class="n">extra_packet</span><span class="p">)</span>
        <span class="c1"># the following attributes used to calculate missing values</span>
        <span class="k">for</span> <span class="n">keyname</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="n">keyname</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No key found for </span><span class="si">%s</span><span class="s2">, packet is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cat_id</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
        <span class="n">p</span><span class="o">.</span><span class="n">cif_dictionary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span>
        <span class="n">p</span><span class="o">.</span><span class="n">fulldata</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">GetMultiKeyedSemanticPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keydict</span><span class="p">,</span><span class="n">cat_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a complete packet for category `cat_id` where the keyvalues are</span>
<span class="sd">        provided as a dictionary of key:(value,caseless) pairs</span>
<span class="sd">        This routine</span>
<span class="sd">        will understand any joined loops, so if separate loops in the</span>
<span class="sd">        datafile belong to the</span>
<span class="sd">        same category hierarchy (e.g. `_atom_site` and `_atom_site_aniso`),</span>
<span class="sd">        the returned `StarPacket` object will contain datanames from</span>
<span class="sd">        the requested category and any children.&quot;&quot;&quot;</span>
        <span class="c1">#if len(keyvalues)==1:   #simplification</span>
        <span class="c1">#    return self.GetKeyedSemanticPacket(keydict[1][0],cat_id)</span>
        <span class="n">target_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">[</span><span class="n">cat_id</span><span class="p">]</span>
        <span class="c1"># update the dictionary passed to us with all equivalents, for</span>
        <span class="c1"># simplicity.</span>
        <span class="n">parallel_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">target_keys</span><span class="p">))</span>  <span class="c1">#transpose</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Parallel keys:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">parallel_keys</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Keydict:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">keydict</span><span class="p">))</span>
        <span class="n">start_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keydict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">one_name</span> <span class="ow">in</span> <span class="n">start_keys</span><span class="p">:</span>
            <span class="n">key_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">parallel_keys</span> <span class="k">if</span> <span class="n">one_name</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="n">key_set</span><span class="p">:</span>
                <span class="n">keydict</span><span class="p">[</span><span class="n">one_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">keydict</span><span class="p">[</span><span class="n">one_name</span><span class="p">]</span>
        <span class="c1"># target_keys is a list of lists, each of which is a compound key</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">()</span>
        <span class="c1"># a little function to return the dataname for a key</span>
        <span class="k">def</span> <span class="nf">find_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">key_equivs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,[])</span><span class="o">+</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">one_key</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">one_key</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">one_set</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">:</span> <span class="c1">#loop down the categories</span>
            <span class="n">true_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">find_key</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">one_set</span><span class="p">]</span>
            <span class="n">true_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">true_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_keys</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">one_set</span><span class="p">):</span>
                <span class="n">truekeydict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">t</span><span class="p">,</span><span class="n">keydict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">true_keys</span><span class="p">,</span><span class="n">one_set</span><span class="p">)])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">extra_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetCompoundKeyedPacket</span><span class="p">(</span><span class="n">truekeydict</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>     <span class="c1">#one or more are missing</span>
                    <span class="k">continue</span>         <span class="c1">#should try harder?</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Merging packet for keys &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">one_set</span><span class="p">))</span>
            <span class="n">p</span><span class="o">.</span><span class="n">merge_packet</span><span class="p">(</span><span class="n">extra_packet</span><span class="p">)</span>
        <span class="c1"># the following attributes used to calculate missing values</span>
        <span class="n">p</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">true_keys</span>
        <span class="n">p</span><span class="o">.</span><span class="n">cif_dictionary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span>
        <span class="n">p</span><span class="o">.</span><span class="n">fulldata</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">p</span>


    <span class="k">def</span> <span class="nf">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">new_grammar</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">string_delimiters</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">;&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">new_grammar</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;STAR2&#39;</span><span class="p">,</span><span class="s1">&#39;2.0&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">string_delimiters</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">,</span><span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">new_grammar</span> <span class="o">==</span> <span class="s1">&#39;2.0&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_delimiter</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">elif</span> <span class="n">new_grammar</span> <span class="o">==</span> <span class="s1">&#39;STAR2&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_delimiter</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span>
        <span class="k">elif</span> <span class="n">new_grammar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span><span class="s1">&#39;1.1&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Request to set unknown grammar </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">new_grammar</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">SetOutputLength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wraplength</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">maxoutlength</span><span class="o">=</span><span class="mi">2048</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the maximum output line length (`maxoutlength`) and the line length to</span>
<span class="sd">        wrap at (`wraplength`).  The wrap length is a target only and may not always be</span>
<span class="sd">        possible.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">wraplength</span> <span class="o">&gt;</span> <span class="n">maxoutlength</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;Wrap length (requested </span><span class="si">%d</span><span class="s2">) must be &lt;= Maximum line length (requested </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wraplength</span><span class="p">,</span><span class="n">maxoutlength</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wraplength</span> <span class="o">=</span> <span class="n">wraplength</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span> <span class="o">=</span> <span class="n">maxoutlength</span>

    <span class="k">def</span> <span class="nf">printsection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">instring</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">blockstart</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">blockend</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">finish_at</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">start_from</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># first make an ordering</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_ordering</span><span class="p">(</span><span class="n">finish_at</span><span class="p">,</span><span class="n">start_from</span><span class="p">)</span>  <span class="c1">#create self.output_order</span>
        <span class="c1"># now do it...</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">instring</span><span class="p">:</span>
            <span class="n">outstring</span> <span class="o">=</span> <span class="n">CIFStringIO</span><span class="p">(</span><span class="n">target_width</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>       <span class="c1"># the returned string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outstring</span> <span class="o">=</span> <span class="n">instring</span>
        <span class="c1"># print block delimiter</span>
        <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">blockstart</span><span class="p">,</span><span class="n">canbreak</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
           <span class="c1">#print &quot;Remaining to output &quot; + `self.output_order`</span>
           <span class="n">itemname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
           <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemname</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>  <span class="c1">#no loop</span>
                   <span class="n">item_spec</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;dataname&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item_spec</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                       <span class="n">item_spec</span> <span class="o">=</span> <span class="n">item_spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                       <span class="n">col_pos</span> <span class="o">=</span> <span class="n">item_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column&#39;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                       <span class="n">name_pos</span> <span class="o">=</span> <span class="n">item_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name_pos&#39;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                   <span class="k">else</span><span class="p">:</span>
                       <span class="n">col_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                       <span class="n">item_spec</span> <span class="o">=</span> <span class="p">{}</span>
                       <span class="n">name_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                   <span class="k">if</span> <span class="n">col_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">col_pos</span> <span class="o">=</span> <span class="mi">40</span>
                   <span class="n">outstring</span><span class="o">.</span><span class="n">set_tab</span><span class="p">(</span><span class="n">col_pos</span><span class="p">)</span>
                   <span class="n">itemvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">itemname</span><span class="p">]</span>
                   <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">itemname</span><span class="p">],</span><span class="n">mustbreak</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">do_tab</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">startcol</span><span class="o">=</span><span class="n">name_pos</span><span class="p">)</span>
                   <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">canbreak</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">do_tab</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>    <span class="c1">#space after itemname</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">format_value</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="n">hints</span><span class="o">=</span><span class="n">item_spec</span><span class="p">)</span>
           <span class="k">else</span><span class="p">:</span><span class="c1"># we are asked to print a loop block</span>
                    <span class="n">outstring</span><span class="o">.</span><span class="n">set_tab</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>       <span class="c1">#guess this is OK?</span>
                    <span class="n">loop_spec</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;name_pos&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;dataname&quot;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;loop&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">loop_spec</span><span class="p">:</span>
                        <span class="n">loop_indent</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">loop_spec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">loop_indent</span> <span class="o">=</span> <span class="n">indent</span>
                    <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;loop_</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">mustbreak</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">do_tab</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">startcol</span><span class="o">=</span><span class="n">loop_indent</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">format_names</span><span class="p">(</span><span class="n">outstring</span><span class="p">,</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">loop_no</span><span class="o">=</span><span class="n">itemname</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">format_packets</span><span class="p">(</span><span class="n">outstring</span><span class="p">,</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">loop_no</span><span class="o">=</span><span class="n">itemname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">returnstring</span> <span class="o">=</span> <span class="n">outstring</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">outstring</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">returnstring</span>

    <span class="k">def</span> <span class="nf">format_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">loop_no</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print datanames from `loop_no` one per line&quot;&quot;&quot;</span>
        <span class="n">temp_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">][:]</span>   <span class="c1">#copy</span>
        <span class="n">format_hints</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;dataname&#39;</span><span class="p">],</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;dataname&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">temp_order</span><span class="p">])</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_order</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">itemname</span> <span class="o">=</span> <span class="n">temp_order</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">req_indent</span> <span class="o">=</span> <span class="n">format_hints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">itemname</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name_pos&#39;</span><span class="p">,</span><span class="n">indent</span><span class="p">)</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">req_indent</span><span class="p">,</span><span class="n">do_tab</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">itemname</span><span class="p">],</span><span class="n">do_tab</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">do_tab</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">format_packets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">loop_no</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
       <span class="n">alldata</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]]</span>
       <span class="n">loopnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
       <span class="c1">#print &#39;Alldata: %s&#39; % `alldata`</span>
       <span class="n">packet_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">alldata</span><span class="p">))</span>
       <span class="c1">#print &#39;Packet data: %s&#39; % `packet_data`</span>
       <span class="c1">#create a dictionary for quick lookup of formatting requirements</span>
       <span class="n">format_hints</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;dataname&#39;</span><span class="p">],</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;dataname&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">loopnames</span><span class="p">])</span>
       <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">packet_data</span><span class="p">)):</span>
           <span class="k">if</span> <span class="n">position</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
               <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>    <span class="c1">#new line each packet except first</span>
           <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">packet_data</span><span class="p">[</span><span class="n">position</span><span class="p">])):</span>
               <span class="n">datapoint</span> <span class="o">=</span> <span class="n">packet_data</span><span class="p">[</span><span class="n">position</span><span class="p">][</span><span class="n">point</span><span class="p">]</span>
               <span class="n">format_hint</span> <span class="o">=</span> <span class="n">format_hints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">loopnames</span><span class="p">[</span><span class="n">point</span><span class="p">],{})</span>
               <span class="n">packstring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_packet_item</span><span class="p">(</span><span class="n">datapoint</span><span class="p">,</span><span class="n">indent</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="n">format_hint</span><span class="p">)</span>
               <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">canbreak</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">do_tab</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">format_packet_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pack_item</span><span class="p">,</span><span class="n">indent</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="n">format_hint</span><span class="p">):</span>
           <span class="c1"># print &#39;Formatting %s&#39; % `pack_item`</span>
           <span class="c1"># temporary check for any non-unicode items</span>
           <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pack_item</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pack_item</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
               <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;Item {0!r} is not unicode&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pack_item</span><span class="p">))</span>
           <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pack_item</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
               <span class="n">delimiter</span> <span class="o">=</span> <span class="n">format_hint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;delimiter&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
               <span class="n">startcol</span> <span class="o">=</span> <span class="n">format_hint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column&#39;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
               <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatstring</span><span class="p">(</span><span class="n">pack_item</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">),</span><span class="n">startcol</span><span class="o">=</span><span class="n">startcol</span><span class="p">)</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">format_value</span><span class="p">(</span><span class="n">pack_item</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="n">hints</span> <span class="o">=</span> <span class="n">format_hint</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_formatstring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">instring</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">standard</span><span class="o">=</span><span class="s1">&#39;CIF1&#39;</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">hints</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">if</span> <span class="n">hints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reformat&quot;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">instring</span><span class="p">:</span>
            <span class="n">instring</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">do_wrapping</span><span class="p">(</span><span class="n">instring</span><span class="p">,</span><span class="n">hints</span><span class="p">[</span><span class="s2">&quot;reformat_indent&quot;</span><span class="p">])</span>
        <span class="n">allowed_delimiters</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">string_delimiters</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instring</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">allowed_delimiters</span><span class="o">.</span><span class="n">difference_update</span><span class="p">([</span><span class="bp">None</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">instring</span><span class="p">:</span>
                <span class="n">allowed_delimiters</span><span class="o">.</span><span class="n">intersection_update</span><span class="p">([</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">;&quot;</span><span class="p">,</span><span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">instring</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">instring</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="se">\v</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">instring</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instring</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">instring</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;_$#;([{&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">instring</span><span class="p">:</span>
                <span class="n">allowed_delimiters</span><span class="o">.</span><span class="n">difference_update</span><span class="p">([</span><span class="bp">None</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instring</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">3</span> <span class="ow">and</span> <span class="p">(</span><span class="n">instring</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;data&#39;</span> <span class="ow">or</span> <span class="n">instring</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;save&#39;</span><span class="p">):</span>
                <span class="n">allowed_delimiters</span><span class="o">.</span><span class="n">difference_update</span><span class="p">([</span><span class="bp">None</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instring</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">5</span> <span class="ow">and</span> <span class="n">instring</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;global&#39;</span><span class="p">:</span>
                <span class="n">allowed_delimiters</span><span class="o">.</span><span class="n">difference_update</span><span class="p">([</span><span class="bp">None</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">instring</span><span class="p">:</span> <span class="n">allowed_delimiters</span><span class="o">.</span><span class="n">difference_update</span><span class="p">([</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">in</span> <span class="n">instring</span><span class="p">:</span> <span class="n">allowed_delimiters</span><span class="o">.</span><span class="n">difference_update</span><span class="p">([</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">])</span>
        <span class="n">out_delimiter</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">;&quot;</span>  <span class="c1">#default (most conservative)</span>
        <span class="k">if</span> <span class="n">delimiter</span> <span class="ow">in</span> <span class="n">allowed_delimiters</span><span class="p">:</span>
            <span class="n">out_delimiter</span> <span class="o">=</span> <span class="n">delimiter</span>
        <span class="k">elif</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">in</span> <span class="n">allowed_delimiters</span><span class="p">:</span> <span class="n">out_delimiter</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span>
        <span class="k">elif</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">allowed_delimiters</span><span class="p">:</span> <span class="n">out_delimiter</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span>
        <span class="k">if</span> <span class="n">out_delimiter</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&quot;&quot;&#39;</span><span class="p">,</span><span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">]:</span> <span class="k">return</span> <span class="n">out_delimiter</span> <span class="o">+</span> <span class="n">instring</span> <span class="o">+</span> <span class="n">out_delimiter</span>
        <span class="k">elif</span> <span class="n">out_delimiter</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">instring</span>
        <span class="c1"># we are left with semicolon strings</span>
        <span class="c1"># use our protocols:</span>
        <span class="n">maxlinelength</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">instring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">maxlinelength</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span><span class="p">:</span>
            <span class="n">protocol_string</span> <span class="o">=</span> <span class="n">apply_line_folding</span><span class="p">(</span><span class="n">instring</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">protocol_string</span> <span class="o">=</span> <span class="n">instring</span>
        <span class="c1"># now check for embedded delimiters</span>
        <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">;&quot;</span> <span class="ow">in</span> <span class="n">protocol_string</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;CIF:&quot;</span>
            <span class="k">while</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">protocol_string</span><span class="p">:</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span>
            <span class="n">protocol_string</span> <span class="o">=</span> <span class="n">apply_line_prefix</span><span class="p">(</span><span class="n">protocol_string</span><span class="p">,</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;&gt; &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">;&quot;</span> <span class="o">+</span> <span class="n">protocol_string</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">;&quot;</span>

    <span class="k">def</span> <span class="nf">format_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemvalue</span><span class="p">,</span><span class="n">stringsink</span><span class="p">,</span><span class="n">compound</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">hints</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Format a Star data value&quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">have_numpy</span>
        <span class="n">delimiter</span> <span class="o">=</span> <span class="n">hints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;delimiter&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">startcol</span> <span class="o">=</span> <span class="n">hints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column&#39;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span> <span class="c1">#not allowed</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;Non-unicode value {0} found in block&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>  <span class="c1">#need to sanitize</span>
            <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_formatstring</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span><span class="n">hints</span><span class="o">=</span><span class="n">hints</span><span class="p">),</span><span class="n">canbreak</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span><span class="n">startcol</span><span class="o">=</span><span class="n">startcol</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,(</span><span class="nb">list</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,</span><span class="s1">&#39;dtype&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,</span><span class="s1">&#39;__iter__&#39;</span><span class="p">)):</span> <span class="c1">#numpy</span>
           <span class="n">stringsink</span><span class="o">.</span><span class="n">set_tab</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
           <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span><span class="n">canbreak</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">newindent</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">mustbreak</span><span class="o">=</span><span class="n">compound</span><span class="p">,</span><span class="n">startcol</span><span class="o">=</span><span class="n">startcol</span><span class="p">)</span>
           <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">format_value</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">stringsink</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">listval</span> <span class="ow">in</span> <span class="n">itemvalue</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                  <span class="c1"># print &#39;Formatting %s&#39; % `listval`</span>
                  <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_delimiter</span><span class="p">,</span><span class="n">do_tab</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">format_value</span><span class="p">(</span><span class="n">listval</span><span class="p">,</span><span class="n">stringsink</span><span class="p">,</span><span class="n">compound</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
           <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span><span class="n">unindent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
           <span class="n">stringsink</span><span class="o">.</span><span class="n">set_tab</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
           <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="n">newindent</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">mustbreak</span><span class="o">=</span><span class="n">compound</span><span class="p">,</span><span class="n">startcol</span><span class="o">=</span><span class="n">startcol</span><span class="p">)</span>  <span class="c1">#start a new line inside</span>
           <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itemvalue</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
           <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
               <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="o">+</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">canbreak</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">format_value</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">stringsink</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                   <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_delimiter</span><span class="p">)</span>
                   <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="o">+</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="p">,</span><span class="n">canbreak</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">format_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">stringsink</span><span class="p">)</span>   <span class="c1">#never break between key and value</span>
           <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span><span class="n">unindent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,(</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">))</span> <span class="ow">or</span> \
             <span class="p">(</span><span class="n">have_numpy</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">,(</span><span class="n">numpy</span><span class="o">.</span><span class="n">number</span><span class="p">))):</span>  <span class="c1">#TODO - handle uncertainties</span>
           <span class="n">stringsink</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">itemvalue</span><span class="p">),</span><span class="n">canbreak</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">startcol</span><span class="o">=</span><span class="n">startcol</span><span class="p">)</span>   <span class="c1">#numbers</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Value in unexpected format for output: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">itemvalue</span> <span class="p">))</span>

    <span class="k">def</span> <span class="nf">create_ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">finish_at</span><span class="p">,</span><span class="n">start_from</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a canonical ordering that includes loops using our formatting hints dictionary&quot;&quot;&quot;</span>
        <span class="n">requested_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;dataname&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;dataname&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;loop&#39;</span><span class="p">])</span>
        <span class="n">new_order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">requested_order</span><span class="p">:</span>
           <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="nb">unicode</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">:</span>
               <span class="n">new_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
           <span class="k">elif</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>    <span class="c1">#in a loop somewhere</span>
               <span class="n">target_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
               <span class="k">if</span> <span class="n">target_loop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_order</span><span class="p">:</span>
                   <span class="n">new_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_loop</span><span class="p">)</span>
                   <span class="c1"># adjust loop name order</span>
                   <span class="n">loopnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">target_loop</span><span class="p">]</span>
                   <span class="n">loop_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">requested_order</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">loopnames</span><span class="p">]</span>
                   <span class="n">unordered</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">loopnames</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loop_order</span><span class="p">]</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">target_loop</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop_order</span> <span class="o">+</span> <span class="n">unordered</span>
        <span class="n">extras</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_order</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span> <span class="o">=</span> <span class="n">new_order</span> <span class="o">+</span> <span class="n">extras</span>
        <span class="c1"># now handle partial output</span>
        <span class="k">if</span> <span class="n">start_from</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">start_from</span> <span class="ow">in</span> <span class="n">requested_order</span><span class="p">:</span>
                <span class="n">sfi</span> <span class="o">=</span> <span class="n">requested_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">start_from</span><span class="p">)</span>
                <span class="n">loop_order</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">requested_order</span><span class="p">[</span><span class="n">sfi</span><span class="p">:]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">requested_order</span><span class="p">[</span><span class="n">sfi</span><span class="p">:]])</span>
                <span class="n">cand_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_order</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">cand_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loop_order</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">cand_pos</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cand_pos</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">loop_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">cand_pos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Output starts from </span><span class="si">%s</span><span class="s1">, requested </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="p">[</span><span class="n">cand_pos</span><span class="p">],</span><span class="n">start_from</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="p">[</span><span class="n">cand_pos</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Start is beyond end of output list&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">start_from</span> <span class="ow">in</span> <span class="n">extras</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">start_from</span><span class="p">):]</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">finish_at</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">finish_at</span> <span class="ow">in</span> <span class="n">requested_order</span><span class="p">:</span>
                <span class="n">fai</span> <span class="o">=</span> <span class="n">requested_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">finish_at</span><span class="p">)</span>
                <span class="n">loop_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">requested_order</span><span class="p">[</span><span class="n">fai</span><span class="p">:]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">requested_order</span><span class="p">[</span><span class="n">fai</span><span class="p">:]])</span>
                <span class="n">cand_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_order</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">cand_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loop_order</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">cand_pos</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cand_pos</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">loop_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">cand_pos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Output finishes before </span><span class="si">%s</span><span class="s1">, requested before </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="p">[</span><span class="n">cand_pos</span><span class="p">],</span><span class="n">finish_at</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="p">[:</span><span class="n">cand_pos</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;All of block output&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">finish_at</span> <span class="ow">in</span> <span class="n">extras</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">output_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">finish_at</span><span class="p">)]</span>
        <span class="c1">#print(&#39;Final order: &#39; + repr(self.output_order))</span>

    <span class="k">def</span> <span class="nf">convert_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert values held in dataname value fork to string version&quot;&quot;&quot;</span>
        <span class="n">v</span><span class="p">,</span><span class="n">is_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetFullItemValue</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
        <span class="k">if</span> <span class="n">check_stringiness</span><span class="p">(</span><span class="n">v</span><span class="p">):</span> <span class="k">return</span> <span class="n">v</span>   <span class="c1">#already strings</span>
        <span class="c1"># TODO...something else</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">do_wrapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">instring</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrap the provided string&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;   &quot;</span> <span class="ow">in</span> <span class="n">instring</span><span class="p">:</span>   <span class="c1">#already formatted</span>
            <span class="k">return</span> <span class="n">instring</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span><span class="o">.</span><span class="n">initial_indent</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">*</span><span class="n">indent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span><span class="o">.</span><span class="n">subsequent_indent</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">*</span><span class="n">indent</span>
        <span class="c1"># remove leading and trailing space</span>
        <span class="n">instring</span> <span class="o">=</span> <span class="n">instring</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># split into paragraphs</span>
        <span class="n">paras</span> <span class="o">=</span> <span class="n">instring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">wrapped_paras</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paras</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wrapped_paras</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">new_block</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;strict&quot;</span><span class="p">,</span><span class="n">match_att</span><span class="o">=</span><span class="p">[],</span><span class="n">match_function</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">rel_keys</span> <span class="o">=</span> <span class="p">[]):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;strict&#39;</span><span class="p">:</span>
           <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_block</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
               <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">match_att</span><span class="p">:</span>
                  <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s2">&quot;Identical keys </span><span class="si">%s</span><span class="s2"> in strict merge mode&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
               <span class="k">elif</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">match_att</span><span class="p">:</span>           <span class="c1">#a new dataname</span>
                   <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_block</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
           <span class="c1"># we get here if there are no keys in common, so we can now copy</span>
           <span class="c1"># the loops and not worry about overlaps</span>
           <span class="k">for</span> <span class="n">one_loop</span> <span class="ow">in</span> <span class="n">new_block</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">(</span><span class="n">one_loop</span><span class="p">)</span>
           <span class="c1"># we have lost case information</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_block</span><span class="o">.</span><span class="n">true_case</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span>
           <span class="n">newkeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_block</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
           <span class="k">for</span> <span class="n">ma</span> <span class="ow">in</span> <span class="n">match_att</span><span class="p">:</span>
              <span class="k">try</span><span class="p">:</span>
                   <span class="n">newkeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ma</span><span class="p">)</span>        <span class="c1">#don&#39;t touch the special ones</span>
              <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                   <span class="k">pass</span>
           <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_block</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
                      <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_block</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
           <span class="c1"># creating the loop will remove items from other loops</span>
           <span class="k">for</span> <span class="n">one_loop</span> <span class="ow">in</span> <span class="n">new_block</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">(</span><span class="n">one_loop</span><span class="p">)</span>
           <span class="c1"># we have lost case information</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_block</span><span class="o">.</span><span class="n">true_case</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;overlay&#39;</span><span class="p">:</span>
           <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Overlay mode, current overwrite is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">)</span>
           <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Overlay block merge mode not implemented&#39;</span><span class="p">)</span>
           <span class="n">save_overwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="bp">True</span>
           <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">new_block</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
               <span class="k">if</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">match_att</span><span class="p">:</span> <span class="k">continue</span>      <span class="c1">#ignore this one</span>
               <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_block</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span>
               <span class="c1">#non-looped items</span>
               <span class="k">if</span> <span class="n">new_block</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>     <span class="c1">#not looped</span>
                  <span class="bp">self</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
           <span class="n">my_loops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
           <span class="n">perfect_overlaps</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">new_block</span><span class="o">.</span><span class="n">loops</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loops</span><span class="p">]</span>
           <span class="k">for</span> <span class="n">po</span> <span class="ow">in</span> <span class="n">perfect_overlaps</span><span class="p">:</span>
              <span class="n">loop_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">po</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rel_keys</span><span class="p">]</span>  <span class="c1">#do we have a key?</span>
              <span class="k">try</span><span class="p">:</span>
                  <span class="n">newkeypos</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">newkeys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="n">loop_keys</span><span class="p">)</span>
                  <span class="n">newkeypos</span> <span class="o">=</span> <span class="n">newkeypos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>      <span class="c1">#one key per loop for now</span>
                  <span class="n">loop_keys</span> <span class="o">=</span> <span class="n">loop_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
              <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span><span class="ne">IndexError</span><span class="p">):</span>
                  <span class="n">newkeypos</span> <span class="o">=</span> <span class="p">[]</span>
                  <span class="n">overlap_data</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]),</span><span class="n">overlaps</span><span class="p">)</span> <span class="c1">#old packet data</span>
                  <span class="n">new_data</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">new_block</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">overlaps</span><span class="p">)</span> <span class="c1">#new packet data</span>
                  <span class="n">packet_data</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">overlap_data</span><span class="p">)</span>
                  <span class="n">new_p_data</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
                  <span class="c1"># remove any packets for which the keys match between old and new; we</span>
                  <span class="c1"># make the arbitrary choice that the old data stays</span>
                  <span class="k">if</span> <span class="n">newkeypos</span><span class="p">:</span>
                      <span class="c1"># get matching values in new list</span>
                      <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Old, new data:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">overlap_data</span><span class="p">[</span><span class="n">newkeypos</span><span class="p">]),</span><span class="nb">repr</span><span class="p">(</span><span class="n">new_data</span><span class="p">[</span><span class="n">newkeypos</span><span class="p">])))</span>
                      <span class="n">key_matches</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">a</span> <span class="ow">in</span> <span class="n">overlap_data</span><span class="p">[</span><span class="n">newkeypos</span><span class="p">],</span><span class="n">new_data</span><span class="p">[</span><span class="n">newkeypos</span><span class="p">])</span>
                      <span class="c1"># filter out any new data with these key values</span>
                      <span class="n">new_p_data</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">a</span><span class="p">[</span><span class="n">newkeypos</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key_matches</span><span class="p">,</span><span class="n">new_p_data</span><span class="p">)</span>
                      <span class="k">if</span> <span class="n">new_p_data</span><span class="p">:</span>
                          <span class="n">new_data</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="n">new_p_data</span><span class="p">)</span>
                      <span class="k">else</span><span class="p">:</span> <span class="n">new_data</span> <span class="o">=</span> <span class="p">[]</span>
                  <span class="c1"># wipe out the old data and enter the new stuff</span>
                  <span class="n">byebyeloop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">overlaps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                  <span class="c1"># print(&quot;Removing &#39;%r&#39; with overlaps &#39;%r&#39;&quot; % (byebyeloop, overlaps))</span>
                  <span class="c1"># Note that if, in the original dictionary, overlaps are not</span>
                  <span class="c1"># looped, GetLoop will return the block itself.  So we check</span>
                  <span class="c1"># for this case...</span>
                  <span class="k">if</span> <span class="n">byebyeloop</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">:</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">remove_loop</span><span class="p">(</span><span class="n">byebyeloop</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">((</span><span class="n">overlaps</span><span class="p">,</span><span class="n">overlap_data</span><span class="p">))</span>  <span class="c1">#adding old packets</span>
                  <span class="k">for</span> <span class="n">pd</span> <span class="ow">in</span> <span class="n">new_p_data</span><span class="p">:</span>                             <span class="c1">#adding new packets</span>
                     <span class="k">if</span> <span class="n">pd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">packet_data</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">overlaps</span><span class="p">)):</span>
                            <span class="c1">#don&#39;t do this at home; we are appending</span>
                            <span class="c1">#to something in place</span>
                            <span class="bp">self</span><span class="p">[</span><span class="n">overlaps</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="n">save_overwrite</span>

    <span class="k">def</span> <span class="nf">assign_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dic</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dic</span><span class="o">.</span><span class="n">diclang</span><span class="o">==</span><span class="s2">&quot;DDLm&quot;</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Warning: ignoring dictionary </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dic</span><span class="o">.</span><span class="n">my_uri</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="n">dic</span>

    <span class="k">def</span> <span class="nf">unassign_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove dictionary-dependent behaviour&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.StarFile.StarBlock">StarBlock</a></li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.AddItem">
    <p>def <span class="ident">AddItem</span>(</p><p>self, key, value, precheck=False)</p>
    </div>
    

    
  
    <div class="desc"><p>Add dataname <code>key</code> to block with value <code>value</code>.  <code>value</code> may be
a single value, a list or a tuple. If <code>precheck</code> is False (the default),
all values will be checked and converted to unicode strings as necessary. If
<code>precheck</code> is True, this checking is bypassed.  No checking is necessary
when values are read from a CIF file as they are already in correct form.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.AddItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.AddItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">precheck</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add dataname `key` to block with value `value`.  `value` may be</span>
<span class="sd">    a single value, a list or a tuple. If `precheck` is False (the default),</span>
<span class="sd">    all values will be checked and converted to unicode strings as necessary. If</span>
<span class="sd">    `precheck` is True, this checking is bypassed.  No checking is necessary</span>
<span class="sd">    when values are read from a CIF file as they are already in correct form.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
         <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Star datanames are strings only (got </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">key</span> <span class="p">))</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>    <span class="c1">#everything is unicode internally</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">precheck</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">check_data_name</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxnamelength</span><span class="p">)</span>    <span class="c1"># make sure no nasty characters</span>
    <span class="c1"># check for overwriting</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
             <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Attempt to insert duplicate item name </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">precheck</span><span class="p">:</span>   <span class="c1">#need to sanitise</span>
        <span class="n">regval</span><span class="p">,</span><span class="n">empty_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularise_data</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">pure_string</span> <span class="o">=</span> <span class="n">check_stringiness</span><span class="p">(</span><span class="n">regval</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_item_value</span><span class="p">(</span><span class="n">regval</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">regval</span><span class="p">,</span><span class="n">empty_val</span> <span class="o">=</span> <span class="n">value</span><span class="p">,</span><span class="bp">None</span>
        <span class="n">pure_string</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c1"># update ancillary information first</span>
    <span class="n">lower_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lower_key</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">lower_key</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>      <span class="c1">#need to add to order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lower_key</span><span class="p">)</span>
    <span class="c1"># always remove from our case table in case the case is different</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">lower_key</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">lower_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
    <span class="k">if</span> <span class="n">pure_string</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">lower_key</span><span class="p">:[</span><span class="n">regval</span><span class="p">,</span><span class="n">empty_val</span><span class="p">]})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">lower_key</span><span class="p">:[</span><span class="n">empty_val</span><span class="p">,</span><span class="n">regval</span><span class="p">]})</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.AddLoopItem">
    <p>def <span class="ident">AddLoopItem</span>(</p><p>self, incomingdata, precheck=False, maxlength=-1)</p>
    </div>
    

    
  
    <div class="desc"><p><em>Deprecated</em>. Use <code>AddItem</code> followed by <code>CreateLoop</code> if
necessary.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.AddLoopItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.AddLoopItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddLoopItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">incomingdata</span><span class="p">,</span><span class="n">precheck</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">maxlength</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` followed by `CreateLoop` if</span>
<span class="sd">    necessary.&quot;&quot;&quot;</span>
    <span class="c1"># print &quot;Received data %s&quot; % `incomingdata`</span>
    <span class="c1"># we accept tuples, strings, lists and dicts!!</span>
    <span class="c1"># Direct insertion: we have a string-valued key, with an array</span>
    <span class="c1"># of values -&gt; single-item into our loop</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
       <span class="c1"># a whole loop</span>
       <span class="n">keyvallist</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
       <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">keyvallist</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
         <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Star datanames are strings only (got </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.AddLoopName">
    <p>def <span class="ident">AddLoopName</span>(</p><p>self, oldname, newname)</p>
    </div>
    

    
  
    <div class="desc"><p>Add <code>newname</code> to the loop containing <code>oldname</code>. If it is already in the new loop, no
error is raised.  If <code>newname</code> is in a different loop, it is removed from that loop.
The number of values associated with <code>newname</code> must match the number of values associated
with all other columns of the new loop or a <code>ValueError</code> will be raised.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.AddLoopName', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.AddLoopName" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddLoopName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldname</span><span class="p">,</span> <span class="n">newname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add `newname` to the loop containing `oldname`. If it is already in the new loop, no</span>
<span class="sd">    error is raised.  If `newname` is in a different loop, it is removed from that loop.</span>
<span class="sd">    The number of values associated with `newname` must match the number of values associated</span>
<span class="sd">    with all other columns of the new loop or a `ValueError` will be raised.&quot;&quot;&quot;</span>
    <span class="n">lower_newname</span> <span class="o">=</span> <span class="n">newname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">oldname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not in loop&#39;</span> <span class="o">%</span> <span class="n">oldname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lower_newname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]:</span>
        <span class="k">return</span>
    <span class="c1"># check length</span>
    <span class="n">old_provides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">oldname</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="n">old_provides</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">newname</span><span class="p">])</span> <span class="o">!=</span> <span class="n">loop_len</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Mismatch of loop column lengths for </span><span class="si">%s</span><span class="s1">: should be </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="n">loop_len</span><span class="p">))</span>
    <span class="c1"># remove from any other loops</span>
    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="k">if</span> <span class="n">lower_newname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
    <span class="c1"># and add to this loop</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span>
    <span class="c1"># remove from item_order if present</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.AddToLoop">
    <p>def <span class="ident">AddToLoop</span>(</p><p>self, dataname, loopdata)</p>
    </div>
    

    
  
    <div class="desc"><p><em>Deprecated</em>. Use <code>AddItem</code> followed by calls to <code>AddLoopName</code>.</p>
<p>Add multiple columns to the loop containing <code>dataname</code>. <code>loopdata</code> is a
collection of (key,value) pairs, where <code>key</code> is the new dataname and <code>value</code>
is a list of values for that dataname</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.AddToLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.AddToLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` followed by calls to `AddLoopName`.</span>
<span class="sd">    Add multiple columns to the loop containing `dataname`. `loopdata` is a</span>
<span class="sd">    collection of (key,value) pairs, where `key` is the new dataname and `value`</span>
<span class="sd">    is a list of values for that dataname&quot;&quot;&quot;</span>
    <span class="c1"># check lengths</span>
    <span class="n">thisloop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
    <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">dataname</span><span class="p">])</span>
    <span class="n">bad_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">!=</span><span class="n">loop_len</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_vals</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
       <span class="k">raise</span> <span class="n">StarLengthError</span><span class="p">(</span><span class="s2">&quot;Number of values for looped datanames </span><span class="si">%s</span><span class="s2"> not equal to </span><span class="si">%d</span><span class="s2">&quot;</span> \
           <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">bad_vals</span> <span class="p">),</span><span class="n">loop_len</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loopdata</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">thisloop</span><span class="p">]</span><span class="o">+=</span><span class="n">loopdata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.ChangeItemOrder">
    <p>def <span class="ident">ChangeItemOrder</span>(</p><p>self, itemname, newpos)</p>
    </div>
    

    
  
    <div class="desc"><p>Move the printout order of <code>itemname</code> to <code>newpos</code>. If <code>itemname</code> is
in a loop, <code>newpos</code> refers to the order within the loop.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.ChangeItemOrder', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.ChangeItemOrder" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">ChangeItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">,</span><span class="n">newpos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Move the printout order of `itemname` to `newpos`. If `itemname` is</span>
<span class="sd">    in a loop, `newpos` refers to the order within the loop.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemname</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
        <span class="n">true_name</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">true_name</span> <span class="o">=</span> <span class="n">itemname</span>
    <span class="n">loopno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">true_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loopno</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1">#top level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">true_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">newpos</span><span class="p">,</span><span class="n">true_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loopno</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">true_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loopno</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">newpos</span><span class="p">,</span><span class="n">true_name</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.CreateLoop">
    <p>def <span class="ident">CreateLoop</span>(</p><p>self, datanames, order=-1, length_check=True)</p>
    </div>
    

    
  
    <div class="desc"><p>Create a loop in the datablock. <code>datanames</code> is a list of datanames that
together form a loop.  If length_check is True, they should have been initialised in the block
to have the same number of elements (possibly 0). If <code>order</code> is given,
the loop will appear at this position in the block when printing
out. A loop counts as a single position.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.CreateLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.CreateLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">CreateLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">datanames</span><span class="p">,</span><span class="n">order</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">length_check</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;Create a loop in the datablock. `datanames` is a list of datanames that</span>
<span class="sd">       together form a loop.  If length_check is True, they should have been initialised in the block</span>
<span class="sd">       to have the same number of elements (possibly 0). If `order` is given,</span>
<span class="sd">       the loop will appear at this position in the block when printing</span>
<span class="sd">       out. A loop counts as a single position.&quot;&quot;&quot;</span>
       <span class="k">if</span> <span class="n">length_check</span><span class="p">:</span>
           <span class="c1"># check lengths: these datanames should exist</span>
           <span class="n">listed_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">datanames</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">StarList</span><span class="p">)]</span>
           <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listed_values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">datanames</span><span class="p">):</span>
               <span class="n">len_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">datanames</span><span class="p">])</span>
               <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">len_set</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                   <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Request to loop datanames </span><span class="si">%s</span><span class="s1"> with different lengths: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">datanames</span> <span class="p">),</span><span class="nb">repr</span><span class="p">(</span> <span class="n">len_set</span> <span class="p">)))</span>
           <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">listed_values</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
               <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Request to loop datanames where some are single values and some are not&#39;</span><span class="p">)</span>
       <span class="c1"># store as lower case</span>
       <span class="n">lc_datanames</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datanames</span><span class="p">]</span>
       <span class="c1"># remove these datanames from all other loops</span>
       <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">lc_datanames</span> <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
       <span class="c1"># remove empty loops</span>
       <span class="n">empty_loops</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
       <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">empty_loops</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
           <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
       <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
           <span class="n">loopno</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="n">loopno</span> <span class="o">=</span> <span class="mi">1</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loopno</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lc_datanames</span><span class="p">)</span>
       <span class="k">if</span> <span class="n">order</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="n">loopno</span><span class="p">)</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loopno</span><span class="p">)</span>
       <span class="c1"># remove these datanames from item ordering</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lc_datanames</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.FindLoop">
    <p>def <span class="ident">FindLoop</span>(</p><p>self, keyname)</p>
    </div>
    

    
  
    <div class="desc"><p>Find the loop that contains <code>keyname</code> and return its numerical index or
-1 if not present. The numerical index can be used to refer to the loop in
other routines.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.FindLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.FindLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">FindLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the loop that contains `keyname` and return its numerical index or</span>
<span class="sd">    -1 if not present. The numerical index can be used to refer to the loop in</span>
<span class="sd">    other routines.&quot;&quot;&quot;</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">keyname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loop_no</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">loop_no</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.GetCompoundKeyedPacket">
    <p>def <span class="ident">GetCompoundKeyedPacket</span>(</p><p>self, keydict)</p>
    </div>
    

    
  
    <div class="desc"><p>Return the loop packet (a <code>StarPacket</code> object) where the <code>{key:(value,caseless)}</code> pairs
in <code>keydict</code> take the appropriate values. Ignore case for a given <code>key</code> if <code>caseless</code> is
True.  <code>ValueError</code> is raised if no packet is found or more than one packet is found.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.GetCompoundKeyedPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.GetCompoundKeyedPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetCompoundKeyedPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keydict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the loop packet (a `StarPacket` object) where the `{key:(value,caseless)}` pairs</span>
<span class="sd">    in `keydict` take the appropriate values. Ignore case for a given `key` if `caseless` is</span>
<span class="sd">    True.  `ValueError` is raised if no packet is found or more than one packet is found.&quot;&quot;&quot;</span>
    <span class="c1">#print &quot;Looking for %s in %s&quot; % (keyvalue, self.parent_block[keyname])</span>
    <span class="n">keynames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keydict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">my_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">keynames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="n">keynames</span><span class="p">:</span>
        <span class="n">keyval</span><span class="p">,</span><span class="n">no_case</span> <span class="o">=</span> <span class="n">keydict</span><span class="p">[</span><span class="n">one_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">no_case</span><span class="p">:</span>
           <span class="n">my_loop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">one_key</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="nb">str</span><span class="p">(</span><span class="n">keyval</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">my_loop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">one_key</span><span class="p">)</span><span class="o">==</span><span class="n">keyval</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_loop</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad packet keys </span><span class="si">%s</span><span class="s2">: returned </span><span class="si">%d</span><span class="s2"> packets&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">keydict</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">my_loop</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Compound keyed packet: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">my_loop</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">my_loop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.GetFullItemValue">
    <p>def <span class="ident">GetFullItemValue</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p>Return the value associated with <code>itemname</code>, and a boolean flagging whether
(True) or not (False) it is in a form suitable for calculation.  False is
always returned for strings and <code>StarList</code> objects.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.GetFullItemValue', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.GetFullItemValue" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetFullItemValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the value associated with `itemname`, and a boolean flagging whether</span>
<span class="sd">    (True) or not (False) it is in a form suitable for calculation.  False is</span>
<span class="sd">    always returned for strings and `StarList` objects.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Itemname </span><span class="si">%s</span><span class="s1"> not in datablock&#39;</span> <span class="o">%</span> <span class="n">itemname</span><span class="p">)</span>
    <span class="c1"># prefer string value unless all are None</span>
    <span class="c1"># are we a looped value?</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">StarList</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">not_none</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">,</span><span class="bp">False</span>    <span class="c1">#a string value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">StarList</span><span class="p">)</span>  <span class="c1">#a StarList is not calculation-ready</span>
    <span class="k">elif</span> <span class="n">not_none</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">,</span><span class="bp">False</span>         <span class="c1">#a list of string values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">StarList</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="bp">True</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.GetItemOrder">
    <p>def <span class="ident">GetItemOrder</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a list of datanames in the order in which they will be printed.  Loops are
referred to by numerical index</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.GetItemOrder', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.GetItemOrder" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a list of datanames in the order in which they will be printed.  Loops are</span>
<span class="sd">    referred to by numerical index&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">[:]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.GetItemPosition">
    <p>def <span class="ident">GetItemPosition</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p>A utility function to get the numerical order in the printout
of <code>itemname</code>.  An item has coordinate <code>(loop_no,pos)</code> with
the top level having a <code>loop_no</code> of -1.  If an integer is passed to
the routine then it will return the position of the loop
referenced by that number.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.GetItemPosition', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.GetItemPosition" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetItemPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A utility function to get the numerical order in the printout</span>
<span class="sd">    of `itemname`.  An item has coordinate `(loop_no,pos)` with</span>
<span class="sd">    the top level having a `loop_no` of -1.  If an integer is passed to</span>
<span class="sd">    the routine then it will return the position of the loop</span>
<span class="sd">    referenced by that number.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemname</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
        <span class="c1"># return loop position</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">itemname</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">itemname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No such dataname </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">itemname</span><span class="p">)</span>
    <span class="n">testname</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">testname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">))</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
    <span class="n">loop_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loop_no</span><span class="p">,</span><span class="n">loop_pos</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.GetItemValue">
    <p>def <span class="ident">GetItemValue</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p>Return value of <code>itemname</code>.  If <code>itemname</code> is looped, a list
of all values will be returned.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.GetItemValue', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.GetItemValue" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetItemValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return value of `itemname`.  If `itemname` is looped, a list</span>
<span class="sd">    of all values will be returned.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetFullItemValue</span><span class="p">(</span><span class="n">itemname</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.GetKeyedPacket">
    <p>def <span class="ident">GetKeyedPacket</span>(</p><p>self, keyname, keyvalue, no_case=False)</p>
    </div>
    

    
  
    <div class="desc"><p>Return the loop packet (a <code>StarPacket</code> object) where <code>keyname</code> has value
<code>keyvalue</code>. Ignore case in <code>keyvalue</code> if <code>no_case</code> is True.  <code>ValueError</code>
is raised if no packet is found or more than one packet is found.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.GetKeyedPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.GetKeyedPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetKeyedPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">no_case</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the loop packet (a `StarPacket` object) where `keyname` has value</span>
<span class="sd">    `keyvalue`. Ignore case in `keyvalue` if `no_case` is True.  `ValueError`</span>
<span class="sd">    is raised if no packet is found or more than one packet is found.&quot;&quot;&quot;</span>
    <span class="n">my_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
    <span class="c1">#print(&quot;Looking for %s in %s&quot; % (keyvalue, my_loop.parent_block))</span>
    <span class="c1">#print(&#39;Packet check on:&#39; + keyname)</span>
    <span class="c1">#[print(repr(getattr(a,keyname))) for a in my_loop]</span>
    <span class="k">if</span> <span class="n">no_case</span><span class="p">:</span>
       <span class="n">one_pack</span><span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="n">keyvalue</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
       <span class="n">one_pack</span><span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span><span class="o">==</span><span class="n">keyvalue</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">one_pack</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad packet key </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">: returned </span><span class="si">%d</span><span class="s2"> packets&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">keyname</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">one_pack</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Keyed packet: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">one_pack</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">one_pack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.GetKeyedSemanticPacket">
    <p>def <span class="ident">GetKeyedSemanticPacket</span>(</p><p>self, keyvalue, cat_id)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a complete packet for category <code>cat_id</code> where the
category key for the category equals <code>keyvalue</code>.  This routine
will understand any joined loops, so if separate loops in the
datafile belong to the
same category hierarchy (e.g. <code>_atom_site</code> and <code>_atom_site_aniso</code>),
the returned <code>StarPacket</code> object will contain datanames from
both categories.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.GetKeyedSemanticPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.GetKeyedSemanticPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetKeyedSemanticPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">cat_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a complete packet for category `cat_id` where the</span>
<span class="sd">    category key for the category equals `keyvalue`.  This routine</span>
<span class="sd">    will understand any joined loops, so if separate loops in the</span>
<span class="sd">    datafile belong to the</span>
<span class="sd">    same category hierarchy (e.g. `_atom_site` and `_atom_site_aniso`),</span>
<span class="sd">    the returned `StarPacket` object will contain datanames from</span>
<span class="sd">    both categories.&quot;&quot;&quot;</span>
    <span class="n">target_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">[</span><span class="n">cat_id</span><span class="p">]</span>
    <span class="n">target_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">]</span> <span class="c1">#one only in each list</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">()</span>
    <span class="c1"># set case-sensitivity flag</span>
    <span class="n">lcase</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;_type.contents&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Code&#39;</span><span class="p">,</span><span class="s1">&#39;Tag&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">]:</span>
        <span class="n">lcase</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">cat_key</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">extra_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetKeyedPacket</span><span class="p">(</span><span class="n">cat_key</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">no_case</span><span class="o">=</span><span class="n">lcase</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>        <span class="c1">#missing key</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">test_key</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">cat_key</span><span class="p">]</span>  <span class="c1">#generate key if possible</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Test key is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">test_key</span> <span class="p">))</span>
                <span class="k">if</span> <span class="n">test_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>\
                <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">test_key</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">None</span> <span class="ow">in</span> <span class="n">test_key</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_key</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Getting packet for key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">keyvalue</span> <span class="p">))</span>
                    <span class="n">extra_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetKeyedPacket</span><span class="p">(</span><span class="n">cat_key</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">no_case</span><span class="o">=</span><span class="n">lcase</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>             <span class="c1">#cannot be generated</span>
                <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>      <span class="c1">#none/more than one, assume none</span>
            <span class="k">continue</span>
            <span class="c1">#extra_packet = self.dictionary.generate_default_packet(cat_id,cat_key,keyvalue)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">merge_packet</span><span class="p">(</span><span class="n">extra_packet</span><span class="p">)</span>
    <span class="c1"># the following attributes used to calculate missing values</span>
    <span class="k">for</span> <span class="n">keyname</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="n">keyname</span><span class="p">]</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No key found for </span><span class="si">%s</span><span class="s2">, packet is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cat_id</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">cif_dictionary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span>
    <span class="n">p</span><span class="o">.</span><span class="n">fulldata</span> <span class="o">=</span> <span class="bp">self</span>
    <span class="k">return</span> <span class="n">p</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.GetLoop">
    <p>def <span class="ident">GetLoop</span>(</p><p>self, keyname)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a <code>StarFile.LoopBlock</code> object constructed from the loop containing <code>keyname</code>.
<code>keyname</code> is only significant as a way to specify the loop.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.GetLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.GetLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a `StarFile.LoopBlock` object constructed from the loop containing `keyname`.</span>
<span class="sd">    `keyname` is only significant as a way to specify the loop.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">LoopBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.GetLoopNames">
    <p>def <span class="ident">GetLoopNames</span>(</p><p>self, keyname)</p>
    </div>
    

    
  
    <div class="desc"><p>Return all datanames appearing together with <code>keyname</code></p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.GetLoopNames', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.GetLoopNames" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetLoopNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return all datanames appearing together with `keyname`&quot;&quot;&quot;</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not in any loop&#39;</span> <span class="o">%</span> <span class="n">keyname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.GetMultiKeyedSemanticPacket">
    <p>def <span class="ident">GetMultiKeyedSemanticPacket</span>(</p><p>self, keydict, cat_id)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a complete packet for category <code>cat_id</code> where the keyvalues are
provided as a dictionary of key:(value,caseless) pairs
This routine
will understand any joined loops, so if separate loops in the
datafile belong to the
same category hierarchy (e.g. <code>_atom_site</code> and <code>_atom_site_aniso</code>),
the returned <code>StarPacket</code> object will contain datanames from
the requested category and any children.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.GetMultiKeyedSemanticPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.GetMultiKeyedSemanticPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetMultiKeyedSemanticPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keydict</span><span class="p">,</span><span class="n">cat_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a complete packet for category `cat_id` where the keyvalues are</span>
<span class="sd">    provided as a dictionary of key:(value,caseless) pairs</span>
<span class="sd">    This routine</span>
<span class="sd">    will understand any joined loops, so if separate loops in the</span>
<span class="sd">    datafile belong to the</span>
<span class="sd">    same category hierarchy (e.g. `_atom_site` and `_atom_site_aniso`),</span>
<span class="sd">    the returned `StarPacket` object will contain datanames from</span>
<span class="sd">    the requested category and any children.&quot;&quot;&quot;</span>
    <span class="c1">#if len(keyvalues)==1:   #simplification</span>
    <span class="c1">#    return self.GetKeyedSemanticPacket(keydict[1][0],cat_id)</span>
    <span class="n">target_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">[</span><span class="n">cat_id</span><span class="p">]</span>
    <span class="c1"># update the dictionary passed to us with all equivalents, for</span>
    <span class="c1"># simplicity.</span>
    <span class="n">parallel_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">target_keys</span><span class="p">))</span>  <span class="c1">#transpose</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Parallel keys:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">parallel_keys</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Keydict:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">keydict</span><span class="p">))</span>
    <span class="n">start_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keydict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">one_name</span> <span class="ow">in</span> <span class="n">start_keys</span><span class="p">:</span>
        <span class="n">key_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">parallel_keys</span> <span class="k">if</span> <span class="n">one_name</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="n">key_set</span><span class="p">:</span>
            <span class="n">keydict</span><span class="p">[</span><span class="n">one_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">keydict</span><span class="p">[</span><span class="n">one_name</span><span class="p">]</span>
    <span class="c1"># target_keys is a list of lists, each of which is a compound key</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">()</span>
    <span class="c1"># a little function to return the dataname for a key</span>
    <span class="k">def</span> <span class="nf">find_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">key_equivs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,[])</span><span class="o">+</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">one_key</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">one_key</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">one_set</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">:</span> <span class="c1">#loop down the categories</span>
        <span class="n">true_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">find_key</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">one_set</span><span class="p">]</span>
        <span class="n">true_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">true_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_keys</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">one_set</span><span class="p">):</span>
            <span class="n">truekeydict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">t</span><span class="p">,</span><span class="n">keydict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">true_keys</span><span class="p">,</span><span class="n">one_set</span><span class="p">)])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">extra_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetCompoundKeyedPacket</span><span class="p">(</span><span class="n">truekeydict</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>     <span class="c1">#one or more are missing</span>
                <span class="k">continue</span>         <span class="c1">#should try harder?</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Merging packet for keys &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">one_set</span><span class="p">))</span>
        <span class="n">p</span><span class="o">.</span><span class="n">merge_packet</span><span class="p">(</span><span class="n">extra_packet</span><span class="p">)</span>
    <span class="c1"># the following attributes used to calculate missing values</span>
    <span class="n">p</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">true_keys</span>
    <span class="n">p</span><span class="o">.</span><span class="n">cif_dictionary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span>
    <span class="n">p</span><span class="o">.</span><span class="n">fulldata</span> <span class="o">=</span> <span class="bp">self</span>
    <span class="k">return</span> <span class="n">p</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.RemoveItem">
    <p>def <span class="ident">RemoveItem</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p>Remove <code>itemname</code> from the block.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.RemoveItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.RemoveItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">RemoveItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove `itemname` from the block.&quot;&quot;&quot;</span>
    <span class="c1"># first check any loops</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>
    <span class="n">testkey</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">testkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
        <span class="c1"># now remove from loop</span>
        <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">loop_no</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1">#will appear in order list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.RemoveKeyedPacket">
    <p>def <span class="ident">RemoveKeyedPacket</span>(</p><p>self, keyname, keyvalue)</p>
    </div>
    

    
  
    <div class="desc"><p>Remove the packet for which dataname <code>keyname</code> takes
value <code>keyvalue</code>.  Only the first such occurrence is
removed.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.RemoveKeyedPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.RemoveKeyedPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">RemoveKeyedPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove the packet for which dataname `keyname` takes</span>
<span class="sd">    value `keyvalue`.  Only the first such occurrence is</span>
<span class="sd">    removed.&quot;&quot;&quot;</span>
    <span class="n">packet_coord</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">keyname</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">keyvalue</span><span class="p">)</span>
    <span class="n">loopnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoopNames</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dataname</span> <span class="ow">in</span> <span class="n">loopnames</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">packet_coord</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">packet_coord</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.RemoveLoopItem">
    <p>def <span class="ident">RemoveLoopItem</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p><em>Deprecated</em>. Use <code>RemoveItem</code> instead</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.RemoveLoopItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.RemoveLoopItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">RemoveLoopItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `RemoveItem` instead&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">RemoveItem</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarBlock.SetOutputLength">
    <p>def <span class="ident">SetOutputLength</span>(</p><p>self, wraplength=80, maxoutlength=2048)</p>
    </div>
    

    
  
    <div class="desc"><p>Set the maximum output line length (<code>maxoutlength</code>) and the line length to
wrap at (<code>wraplength</code>).  The wrap length is a target only and may not always be
possible.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarBlock.SetOutputLength', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarBlock.SetOutputLength" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">SetOutputLength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wraplength</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">maxoutlength</span><span class="o">=</span><span class="mi">2048</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the maximum output line length (`maxoutlength`) and the line length to</span>
<span class="sd">    wrap at (`wraplength`).  The wrap length is a target only and may not always be</span>
<span class="sd">    possible.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">wraplength</span> <span class="o">&gt;</span> <span class="n">maxoutlength</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;Wrap length (requested </span><span class="si">%d</span><span class="s2">) must be &lt;= Maximum line length (requested </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wraplength</span><span class="p">,</span><span class="n">maxoutlength</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wraplength</span> <span class="o">=</span> <span class="n">wraplength</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span> <span class="o">=</span> <span class="n">maxoutlength</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.StarFile.StarDerivationError" class="name">class <span class="ident">StarDerivationError</span></p>
      
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarDerivationError', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarDerivationError" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">StarDerivationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fail_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_name</span> <span class="o">=</span> <span class="n">fail_name</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Derivation of </span><span class="si">%s</span><span class="s2"> failed, None returned&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_name</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.StarFile.StarDerivationError">StarDerivationError</a></li>
          <li>exceptions.Exception</li>
          <li>exceptions.BaseException</li>
          <li>__builtin__.object</li>
          </ul>
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.StarFile.StarDerivationFailure" class="name">class <span class="ident">StarDerivationFailure</span></p>
      
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarDerivationFailure', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarDerivationFailure" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">StarDerivationFailure</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fail_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_name</span> <span class="o">=</span> <span class="n">fail_name</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Derivation of </span><span class="si">%s</span><span class="s2"> failed&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_name</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.StarFile.StarDerivationFailure">StarDerivationFailure</a></li>
          <li>exceptions.AttributeError</li>
          <li>exceptions.StandardError</li>
          <li>exceptions.Exception</li>
          <li>exceptions.BaseException</li>
          <li>__builtin__.object</li>
          </ul>
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.StarFile.StarDict" class="name">class <span class="ident">StarDict</span></p>
      
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarDict', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarDict" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">StarDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.StarFile.StarDict">StarDict</a></li>
          <li>__builtin__.dict</li>
          <li>__builtin__.object</li>
          </ul>
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.StarFile.StarError" class="name">class <span class="ident">StarError</span></p>
      
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarError', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarError" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">StarError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Star Format error: &#39;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.StarFile.StarError">StarError</a></li>
          <li>exceptions.Exception</li>
          <li>exceptions.BaseException</li>
          <li>__builtin__.object</li>
          </ul>
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.StarFile.StarFile" class="name">class <span class="ident">StarFile</span></p>
      
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarFile', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarFile" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">StarFile</span><span class="p">(</span><span class="n">BlockCollection</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">datasource</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">maxinlength</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">maxoutlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">scoping</span><span class="o">=</span><span class="s1">&#39;instance&#39;</span><span class="p">,</span><span class="n">grammar</span><span class="o">=</span><span class="s1">&#39;1.1&#39;</span><span class="p">,</span><span class="n">scantype</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span>
                 <span class="n">permissive</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StarFile</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">datasource</span><span class="o">=</span><span class="n">datasource</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_uri</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span><span class="s1">&#39;my_uri&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maxoutlength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span> <span class="o">=</span> <span class="mi">2048</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span> <span class="o">=</span> <span class="n">maxoutlength</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="n">scoping</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datasource</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span><span class="s2">&quot;read&quot;</span><span class="p">):</span>
            <span class="n">ReadStar</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span><span class="n">prepared</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">grammar</span><span class="o">=</span><span class="n">grammar</span><span class="p">,</span><span class="n">scantype</span><span class="o">=</span><span class="n">scantype</span><span class="p">,</span>
                     <span class="n">maxlength</span> <span class="o">=</span> <span class="n">maxinlength</span><span class="p">,</span><span class="n">permissive</span><span class="o">=</span><span class="n">permissive</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_comment</span> <span class="o">=</span> \
<span class="sd">&quot;&quot;&quot;#\\#STAR</span>
<span class="sd">##########################################################################</span>
<span class="sd">#               STAR Format file</span>
<span class="sd">#               Produced by PySTARRW module</span>
<span class="sd">#</span>
<span class="sd">#  This is a STAR file.  STAR is a superset of the CIF file type.  For</span>
<span class="sd">#  more information, please refer to International Tables for Crystallography,</span>
<span class="sd">#  Volume G, Chapter 2.1</span>
<span class="sd">#</span>
<span class="sd">##########################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">set_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">my_uri</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_uri</span> <span class="o">=</span> <span class="n">my_uri</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.StarFile.StarFile">StarFile</a></li>
          <li><a href="#CifFile.StarFile.BlockCollection">BlockCollection</a></li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Instance variables</h3>
            <div class="item">
            <p id="CifFile.StarFile.StarFile.PC" class="name">var <span class="ident">PC</span></p>
            
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.StarFile.BlockCollection">BlockCollection</a></code>.<code><a href="#CifFile.StarFile.BlockCollection.PC">PC</a></code>
    </p>

            
  
  <div class="source_cont">
</div>

            </div>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarFile.NewBlock">
    <p>def <span class="ident">NewBlock</span>(</p><p>self, blockname, blockcontents=None, fix=True, parent=None)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.StarFile.BlockCollection">BlockCollection</a></code>.<code><a href="#CifFile.StarFile.BlockCollection.NewBlock">NewBlock</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Add a new block named <code>blockname</code> with contents <code>blockcontents</code>. If <code>fix</code>
is True, <code>blockname</code> will have spaces and tabs replaced by underscores. <code>parent</code>
allows a parent block to be set so that block hierarchies can be created.  Depending on
the output standard, these blocks will be printed out as nested save frames or
ignored.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarFile.NewBlock', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarFile.NewBlock" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">NewBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blockname</span><span class="p">,</span><span class="n">blockcontents</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">fix</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add a new block named `blockname` with contents `blockcontents`. If `fix`</span>
<span class="sd">    is True, `blockname` will have spaces and tabs replaced by underscores. `parent`</span>
<span class="sd">    allows a parent block to be set so that block hierarchies can be created.  Depending on</span>
<span class="sd">    the output standard, these blocks will be printed out as nested save frames or</span>
<span class="sd">    ignored.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">blockcontents</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">blockcontents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocktype</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">==</span> <span class="s2">&quot;CIF&quot;</span><span class="p">:</span>
        <span class="n">blockcontents</span><span class="o">.</span><span class="n">setmaxnamelength</span><span class="p">(</span><span class="mi">75</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blockname</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">75</span><span class="p">:</span>
             <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Blockname </span><span class="si">%s</span><span class="s1"> is longer than 75 characters&#39;</span> <span class="o">%</span> <span class="n">blockname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fix</span><span class="p">:</span>
        <span class="n">newblockname</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[  </span><span class="se">\t</span><span class="s1">]&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">blockname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">newblockname</span> <span class="o">=</span> <span class="n">blockname</span>
    <span class="n">new_lowerbn</span> <span class="o">=</span> <span class="n">newblockname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">new_lowerbn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>   <span class="c1">#already there</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
           <span class="n">toplevelnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">==</span><span class="bp">None</span><span class="p">]</span>
           <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">new_lowerbn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">toplevelnames</span><span class="p">:</span>  <span class="c1">#can give a new key to this one</span>
              <span class="k">while</span> <span class="n">new_lowerbn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span> <span class="n">new_lowerbn</span> <span class="o">=</span> <span class="n">new_lowerbn</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span>
           <span class="k">elif</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">new_lowerbn</span> <span class="ow">in</span> <span class="n">toplevelnames</span><span class="p">:</span> <span class="c1">#can fix a different one</span>
              <span class="n">replace_name</span> <span class="o">=</span> <span class="n">new_lowerbn</span>
              <span class="k">while</span> <span class="n">replace_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span> <span class="n">replace_name</span> <span class="o">=</span> <span class="n">replace_name</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">_rekey</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">,</span><span class="n">replace_name</span><span class="p">)</span>
              <span class="c1"># now continue on to add in the new block</span>
              <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">new_lowerbn</span><span class="p">:</span>        <span class="c1">#the new block&#39;s requested parent just got renamed!!</span>
                  <span class="n">parent</span> <span class="o">=</span> <span class="n">replace_name</span>
           <span class="k">else</span><span class="p">:</span>
              <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s2">&quot;Attempt to replace existing block &quot;</span> <span class="o">+</span> <span class="n">blockname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">new_lowerbn</span><span class="p">:</span><span class="n">blockcontents</span><span class="p">})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">newblockname</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
       <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">==</span> <span class="s1">&#39;instance&#39;</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">newblockname</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
          <span class="k">else</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">newblockname</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Warning:Parent block </span><span class="si">%s</span><span class="s1"> does not exist for child </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">newblockname</span><span class="p">))</span>
    <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">.</span><span class="n">set_characterset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">characterset</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span>
    <span class="k">return</span> <span class="n">new_lowerbn</span>  <span class="c1">#in case calling routine wants to know</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarFile.SetTemplate">
    <p>def <span class="ident">SetTemplate</span>(</p><p>self, template_file)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.StarFile.BlockCollection">BlockCollection</a></code>.<code><a href="#CifFile.StarFile.BlockCollection.SetTemplate">SetTemplate</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Use <code>template_file</code> as a template for all block output</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarFile.SetTemplate', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarFile.SetTemplate" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">SetTemplate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">template_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use `template_file` as a template for all block output&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span> <span class="o">=</span> <span class="n">process_template</span><span class="p">(</span><span class="n">template_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">b</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.StarFile.StarFile.WriteOut">
    <p>def <span class="ident">WriteOut</span>(</p><p>self, comment=u&#39;&#39;, wraplength=80, maxoutlength=0, blockorder=None, saves_after=None)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.StarFile.BlockCollection">BlockCollection</a></code>.<code><a href="#CifFile.StarFile.BlockCollection.WriteOut">WriteOut</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Return the contents of this file as a string, wrapping if possible at <code>wraplength</code>
characters and restricting maximum line length to <code>maxoutlength</code>.  Delimiters and
save frame nesting are controlled by <code>self.grammar</code>. If <code>blockorder</code> is
provided, blocks are output in this order unless nested save frames have been
requested (STAR2). The default block order is the order in which blocks were input.
<code>saves_after</code> inserts all save frames after the given dataname,
which allows less important items to appear later.  Useful in conjunction with a
template for dictionary files.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarFile.WriteOut', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarFile.WriteOut" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">WriteOut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">comment</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">wraplength</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">maxoutlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">blockorder</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">saves_after</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the contents of this file as a string, wrapping if possible at `wraplength`</span>
<span class="sd">    characters and restricting maximum line length to `maxoutlength`.  Delimiters and</span>
<span class="sd">    save frame nesting are controlled by `self.grammar`. If `blockorder` is</span>
<span class="sd">    provided, blocks are output in this order unless nested save frames have been</span>
<span class="sd">    requested (STAR2). The default block order is the order in which blocks were input.</span>
<span class="sd">    `saves_after` inserts all save frames after the given dataname,</span>
<span class="sd">    which allows less important items to appear later.  Useful in conjunction with a</span>
<span class="sd">    template for dictionary files.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">maxoutlength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetOutputLength</span><span class="p">(</span><span class="n">maxoutlength</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">comment</span><span class="p">:</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_comment</span>
    <span class="n">outstring</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">==</span> <span class="s2">&quot;2.0&quot;</span> <span class="ow">and</span> <span class="n">comment</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">!=</span> <span class="sa">r</span><span class="s2">&quot;#\#CIF_2.0&quot;</span><span class="p">:</span>
        <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;#\#CIF_2.0&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
    <span class="c1"># prepare all blocks</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span>
        <span class="n">b</span><span class="o">.</span><span class="n">SetOutputLength</span><span class="p">(</span><span class="n">wraplength</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span><span class="p">)</span>
    <span class="c1"># loop over top-level</span>
    <span class="c1"># monitor output</span>
    <span class="n">all_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>   <span class="c1">#i.e. lower case</span>
    <span class="k">if</span> <span class="n">blockorder</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">blockorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span>
    <span class="n">top_block_names</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">blockorder</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">blockref</span><span class="p">,</span><span class="n">blockname</span> <span class="ow">in</span> <span class="n">top_block_names</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">%s</span><span class="s1">, &#39;</span> <span class="o">%</span> <span class="n">blockname</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]))</span>
        <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;data_&#39;</span> <span class="o">+</span><span class="n">blockname</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">all_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">blockref</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">==</span> <span class="s1">&#39;Dic&#39;</span><span class="p">:</span>              <span class="c1">#put contents before save frames</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]</span><span class="o">.</span><span class="n">printsection</span><span class="p">(</span><span class="n">finish_at</span><span class="o">=</span><span class="s1">&#39;_dictionary_valid.application&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">==</span> <span class="s1">&#39;STAR2&#39;</span><span class="p">:</span>  <span class="c1">#nested save frames</span>
            <span class="n">child_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_immediate_children</span><span class="p">(</span><span class="n">blockref</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">child_ref</span><span class="p">,</span><span class="n">child_info</span> <span class="ow">in</span> <span class="n">child_refs</span><span class="p">:</span>
                <span class="n">child_name</span> <span class="o">=</span> <span class="n">child_info</span><span class="o">.</span><span class="n">block_id</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="n">child_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">block_to_string_nested</span><span class="p">(</span><span class="n">child_ref</span><span class="p">,</span><span class="n">child_name</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span><span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span><span class="s1">&#39;1.1&#39;</span><span class="p">,</span><span class="s1">&#39;2.0&#39;</span><span class="p">):</span>                   <span class="c1">#non-nested save frames</span>
            <span class="n">child_refs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">blockorder</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_child_of_parent</span><span class="p">(</span><span class="n">blockref</span><span class="p">,</span><span class="n">a</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">child_ref</span> <span class="ow">in</span> <span class="n">child_refs</span><span class="p">:</span>
                <span class="n">child_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">child_ref</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="n">child_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">child_ref</span><span class="p">]))</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">all_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">child_ref</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Grammar </span><span class="si">%s</span><span class="s1"> is not recognised for output&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">!=</span> <span class="s1">&#39;Dic&#39;</span><span class="p">:</span>              <span class="c1">#put contents after save frames</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]</span><span class="o">.</span><span class="n">printsection</span><span class="p">(</span><span class="n">start_from</span><span class="o">=</span><span class="s1">&#39;_dictionary_valid.application&#39;</span><span class="p">))</span>
    <span class="n">returnstring</span> <span class="o">=</span>  <span class="n">outstring</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="n">outstring</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;WARNING: following blocks not output: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">all_names</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;All blocks output.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">returnstring</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.StarFile.StarLengthError" class="name">class <span class="ident">StarLengthError</span></p>
      
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarLengthError', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarLengthError" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">StarLengthError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Star length error: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.StarFile.StarLengthError">StarLengthError</a></li>
          <li>exceptions.Exception</li>
          <li>exceptions.BaseException</li>
          <li>__builtin__.object</li>
          </ul>
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.StarFile.StarList" class="name">class <span class="ident">StarList</span></p>
      
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarList', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarList" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">StarList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">slice</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">StarList</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>   <span class="c1">#extended comma notation</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">StarList</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">StarList</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;SL(&quot;</span><span class="o">+</span><span class="nb">super</span><span class="p">(</span><span class="n">StarList</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.StarFile.StarList">StarList</a></li>
          <li>__builtin__.list</li>
          <li>__builtin__.object</li>
          </ul>
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.StarFile.StarPacket" class="name">class <span class="ident">StarPacket</span></p>
      
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.StarFile.StarPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.StarFile.StarPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">StarPacket</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">merge_packet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">incoming</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merge contents of incoming packet with this packet&quot;&quot;&quot;</span>
        <span class="n">new_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">incoming</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span> <span class="ow">and</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;_&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">incoming</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="n">new_attrs</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">na</span><span class="p">,</span><span class="nb">getattr</span><span class="p">(</span><span class="n">incoming</span><span class="p">,</span><span class="n">na</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">att_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Derive a missing attribute&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">att_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">att_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">att_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;cif_dictionary&#39;</span><span class="p">,</span><span class="s1">&#39;fulldata&#39;</span><span class="p">,</span><span class="s1">&#39;key&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Programming error: can only assign value of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">att_name</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cif_dictionary</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulldata</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">derive_item</span><span class="p">(</span><span class="n">att_name</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># now pick out the new value</span>
        <span class="c1"># self.key is a list of the key values</span>
        <span class="n">keydict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">v</span><span class="p">,(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="p">),</span><span class="bp">True</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">k</span><span class="p">])</span>
        <span class="n">full_pack</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">GetCompoundKeyedPacket</span><span class="p">(</span><span class="n">keydict</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">full_pack</span><span class="p">,</span><span class="n">att_name</span><span class="p">)</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.StarFile.StarPacket">StarPacket</a></li>
          <li>__builtin__.list</li>
          <li>__builtin__.object</li>
          </ul>
      </div>
      </div>

  </section>

    </article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Documentation generated by
      <a href="https://github.com/BurntSushi/pdoc">pdoc 0.3.2</a>
    </p>

    <p>pdoc is in the public domain with the
      <a href="http://unlicense.org">UNLICENSE</a></p>

    <p>Design by <a href="http://nadh.in">Kailash Nadh</a></p>
  </footer>
</div>
</body>
</html>
