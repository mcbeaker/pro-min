<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

    <title>CifFile.CifFile_module API documentation</title>
    <meta name="description" content="" />

  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
  
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}

  </style>

  <style type="text/css">
  
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  } 

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; } 

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;
      
      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/

  </style>

  <style type="text/css">
  .codehilite .hll { background-color: #ffffcc }
.codehilite  { background: #f8f8f8; }
.codehilite .c { color: #408080; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #BC7A00 } /* Comment.Preproc */
.codehilite .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #408080; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #408080; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #FF0000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #00A000 } /* Generic.Inserted */
.codehilite .go { color: #888888 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #7D9029 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #999999; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #A0A000 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mb { color: #666666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #BB6688 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #0000FF } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */
  </style>

  <style type="text/css">
  
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}

  </style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>

<div id="container">
    
  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">

    <li class="set"><h3><a href="#header-functions">Functions</a></h3>
      
  <ul>
    <li class="mono"><a href="#CifFile.CifFile_module.ReadCif">ReadCif</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.Validate">Validate</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-classes">Classes</a></h3>
      <ul>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></span>
        
          
  <ul>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.AddCifItem">AddCifItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.AddItem">AddItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.AddLoopItem">AddLoopItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.AddLoopName">AddLoopName</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.AddSingleCifItem">AddSingleCifItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.AddToLoop">AddToLoop</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.ChangeItemOrder">ChangeItemOrder</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.CreateLoop">CreateLoop</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.FindLoop">FindLoop</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.GetCompoundKeyedPacket">GetCompoundKeyedPacket</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.GetFullItemValue">GetFullItemValue</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.GetItemOrder">GetItemOrder</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.GetItemPosition">GetItemPosition</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.GetItemValue">GetItemValue</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.GetKeyedPacket">GetKeyedPacket</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.GetKeyedSemanticPacket">GetKeyedSemanticPacket</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.GetLoop">GetLoop</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.GetLoopNames">GetLoopNames</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.GetMultiKeyedSemanticPacket">GetMultiKeyedSemanticPacket</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.RemoveCifItem">RemoveCifItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.RemoveItem">RemoveItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.RemoveKeyedPacket">RemoveKeyedPacket</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.RemoveLoopItem">RemoveLoopItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifBlock.SetOutputLength">SetOutputLength</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.CifFile_module.CifDic">CifDic</a></span>
        
          
  <ul>
    <li class="mono"><a href="#CifFile.CifFile_module.CifDic.DDL1_normalise">DDL1_normalise</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifDic.DDL2_normalise">DDL2_normalise</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifDic.NewBlock">NewBlock</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifDic.SetTemplate">SetTemplate</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifDic.WriteOut">WriteOut</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.CifFile_module.CifError">CifError</a></span>
        
        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.CifFile_module.CifFile">CifFile</a></span>
        
          
  <ul>
    <li class="mono"><a href="#CifFile.CifFile_module.CifFile.NewBlock">NewBlock</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifFile.SetTemplate">SetTemplate</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifFile.WriteOut">WriteOut</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.CifFile_module.CifLoopBlock">CifLoopBlock</a></span>
        
          
  <ul>
    <li class="mono"><a href="#CifFile.CifFile_module.CifLoopBlock.AddPacket">AddPacket</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifLoopBlock.AddToLoop">AddToLoop</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifLoopBlock.ChangeItemOrder">ChangeItemOrder</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifLoopBlock.GetItemOrder">GetItemOrder</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifLoopBlock.GetItemPosition">GetItemPosition</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifLoopBlock.GetLoop">GetLoop</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifLoopBlock.GetLoopNames">GetLoopNames</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifLoopBlock.GetPacket">GetPacket</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifLoopBlock.RemoveItem">RemoveItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.CifLoopBlock.RemoveLoopItem">RemoveLoopItem</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.CifFile_module.CifRecursionError">CifRecursionError</a></span>
        
        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.CifFile_module.DicBlock">DicBlock</a></span>
        
          
  <ul>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.AddItem">AddItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.AddLoopItem">AddLoopItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.AddLoopName">AddLoopName</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.AddToLoop">AddToLoop</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.ChangeItemOrder">ChangeItemOrder</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.CreateLoop">CreateLoop</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.FindLoop">FindLoop</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.GetCompoundKeyedPacket">GetCompoundKeyedPacket</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.GetFullItemValue">GetFullItemValue</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.GetItemOrder">GetItemOrder</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.GetItemPosition">GetItemPosition</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.GetItemValue">GetItemValue</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.GetKeyedPacket">GetKeyedPacket</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.GetKeyedSemanticPacket">GetKeyedSemanticPacket</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.GetLoop">GetLoop</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.GetLoopNames">GetLoopNames</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.GetMultiKeyedSemanticPacket">GetMultiKeyedSemanticPacket</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.RemoveItem">RemoveItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.RemoveKeyedPacket">RemoveKeyedPacket</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.RemoveLoopItem">RemoveLoopItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.DicBlock.SetOutputLength">SetOutputLength</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.CifFile_module.ValidCifBlock">ValidCifBlock</a></span>
        
          
  <ul>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.AddCifItem">AddCifItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.AddItem">AddItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.AddLoopItem">AddLoopItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.AddLoopName">AddLoopName</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.AddSingleCifItem">AddSingleCifItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.AddToLoop">AddToLoop</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.ChangeItemOrder">ChangeItemOrder</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.CreateLoop">CreateLoop</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.FindLoop">FindLoop</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.GetCompoundKeyedPacket">GetCompoundKeyedPacket</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.GetFullItemValue">GetFullItemValue</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.GetItemOrder">GetItemOrder</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.GetItemPosition">GetItemPosition</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.GetItemValue">GetItemValue</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.GetKeyedPacket">GetKeyedPacket</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.GetKeyedSemanticPacket">GetKeyedSemanticPacket</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.GetLoop">GetLoop</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.GetLoopNames">GetLoopNames</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.GetMultiKeyedSemanticPacket">GetMultiKeyedSemanticPacket</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.RemoveCifItem">RemoveCifItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.RemoveItem">RemoveItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.RemoveKeyedPacket">RemoveKeyedPacket</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.RemoveLoopItem">RemoveLoopItem</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifBlock.SetOutputLength">SetOutputLength</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.CifFile_module.ValidCifError">ValidCifError</a></span>
        
        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.CifFile_module.ValidCifFile">ValidCifFile</a></span>
        
          
  <ul>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifFile.NewBlock">NewBlock</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifFile.SetTemplate">SetTemplate</a></li>
    <li class="mono"><a href="#CifFile.CifFile_module.ValidCifFile.WriteOut">WriteOut</a></li>
  </ul>

        </li>
        <li class="mono">
        <span class="class_name"><a href="#CifFile.CifFile_module.ValidationResult">ValidationResult</a></span>
        
        </li>
      </ul>
    </li>

    </ul>
  </div>

    <article id="content">
      
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">CifFile.CifFile_module</span> module</h1>
  
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module" class="source">
    <div class="codehilite"><pre><span></span><span class="c1"># To maximize python3/python2 compatibility</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="c1"># Python 2,3 compatibility</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">urlopen</span>         <span class="c1"># for arbitrary opening</span>
    <span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">urljoin</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
    <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">urljoin</span>

<span class="c1"># The unicode type does not exist in Python3 as the str type</span>
<span class="c1"># encompasses unicode.  PyCIFRW tests for &#39;unicode&#39; would fail</span>
<span class="c1"># Suggestions for a better approach welcome.</span>

<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;abc&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>   <span class="c1">#Python3</span>
    <span class="nb">unicode</span> <span class="o">=</span> <span class="nb">str</span>

<span class="n">__copyright</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">PYCIFRW License Agreement (Python License, Version 2)</span>
<span class="s2">-----------------------------------------------------</span>

<span class="s2">1. This LICENSE AGREEMENT is between the Australian Nuclear Science</span>
<span class="s2">and Technology Organisation (&quot;ANSTO&quot;), and the Individual or</span>
<span class="s2">Organization (&quot;Licensee&quot;) accessing and otherwise using this software</span>
<span class="s2">(&quot;PyCIFRW&quot;) in source or binary form and its associated documentation.</span>

<span class="s2">2. Subject to the terms and conditions of this License Agreement,</span>
<span class="s2">ANSTO hereby grants Licensee a nonexclusive, royalty-free, world-wide</span>
<span class="s2">license to reproduce, analyze, test, perform and/or display publicly,</span>
<span class="s2">prepare derivative works, distribute, and otherwise use PyCIFRW alone</span>
<span class="s2">or in any derivative version, provided, however, that this License</span>
<span class="s2">Agreement and ANSTO&#39;s notice of copyright, i.e., &quot;Copyright (c)</span>
<span class="s2">2001-2014 ANSTO; All Rights Reserved&quot; are retained in PyCIFRW alone or</span>
<span class="s2">in any derivative version prepared by Licensee.</span>

<span class="s2">3. In the event Licensee prepares a derivative work that is based on</span>
<span class="s2">or incorporates PyCIFRW or any part thereof, and wants to make the</span>
<span class="s2">derivative work available to others as provided herein, then Licensee</span>
<span class="s2">hereby agrees to include in any such work a brief summary of the</span>
<span class="s2">changes made to PyCIFRW.</span>

<span class="s2">4. ANSTO is making PyCIFRW available to Licensee on an &quot;AS IS&quot;</span>
<span class="s2">basis. ANSTO MAKES NO REPRESENTATIONS OR WARRANTIES, EXPRESS OR</span>
<span class="s2">IMPLIED. BY WAY OF EXAMPLE, BUT NOT LIMITATION, ANSTO MAKES NO AND</span>
<span class="s2">DISCLAIMS ANY REPRESENTATION OR WARRANTY OF MERCHANTABILITY OR FITNESS</span>
<span class="s2">FOR ANY PARTICULAR PURPOSE OR THAT THE USE OF PYCIFRW WILL NOT</span>
<span class="s2">INFRINGE ANY THIRD PARTY RIGHTS.</span>

<span class="s2">5. ANSTO SHALL NOT BE LIABLE TO LICENSEE OR ANY OTHER USERS OF PYCIFRW</span>
<span class="s2">FOR ANY INCIDENTAL, SPECIAL, OR CONSEQUENTIAL DAMAGES OR LOSS AS A</span>
<span class="s2">RESULT OF MODIFYING, DISTRIBUTING, OR OTHERWISE USING PYCIFRW, OR ANY</span>
<span class="s2">DERIVATIVE THEREOF, EVEN IF ADVISED OF THE POSSIBILITY THEREOF.</span>

<span class="s2">6. This License Agreement will automatically terminate upon a material</span>
<span class="s2">breach of its terms and conditions.</span>

<span class="s2">7. Nothing in this License Agreement shall be deemed to create any</span>
<span class="s2">relationship of agency, partnership, or joint venture between ANSTO</span>
<span class="s2">and Licensee. This License Agreement does not grant permission to use</span>
<span class="s2">ANSTO trademarks or trade name in a trademark sense to endorse or</span>
<span class="s2">promote products or services of Licensee, or any third party.</span>

<span class="s2">8. By copying, installing or otherwise using PyCIFRW, Licensee agrees</span>
<span class="s2">to be bound by the terms and conditions of this License Agreement.</span>

<span class="s2">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">re</span><span class="o">,</span><span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">StarFile</span>
<span class="kn">from</span> <span class="nn">.StarFile</span> <span class="kn">import</span> <span class="n">StarList</span>  <span class="c1">#put in global scope for exec statement</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">numpy</span>                   <span class="c1">#put in global scope for exec statement</span>
    <span class="kn">from</span> <span class="nn">.drel</span> <span class="kn">import</span> <span class="n">drel_runtime</span>  <span class="c1">#put in global scope for exec statement</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>                       <span class="c1">#will fail when using dictionaries for calcs</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>          <span class="c1">#must be in global scope for exec statement</span>

<span class="k">def</span> <span class="nf">track_recursion</span><span class="p">(</span><span class="n">in_this_func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Keep an eye on a function call to make sure that the key argument hasn&#39;t been</span>
<span class="sd">    seen before&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">key_arg</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">key_arg</span> <span class="ow">in</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">called_list</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Recursion watch: </span><span class="si">%s</span><span class="s1"> already called </span><span class="si">%d</span><span class="s1"> times&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key_arg</span><span class="p">,</span><span class="n">wrapper</span><span class="o">.</span><span class="n">called_list</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">key_arg</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="n">CifRecursionError</span><span class="p">(</span> <span class="n">key_arg</span><span class="p">,</span><span class="n">wrapper</span><span class="o">.</span><span class="n">called_list</span><span class="p">[:])</span>    <span class="c1">#failure</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wrapper</span><span class="o">.</span><span class="n">called_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>   <span class="c1">#first time</span>
            <span class="n">wrapper</span><span class="o">.</span><span class="n">stored_use_defaults</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allow_defaults&quot;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;All recursive calls will set allow_defaults to &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">wrapper</span><span class="o">.</span><span class="n">stored_use_defaults</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;allow_defaults&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">stored_use_defaults</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="n">called_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key_arg</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Recursion watch: call stack: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">wrapper</span><span class="o">.</span><span class="n">called_list</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">in_this_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">StarDerivationError</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wrapper</span><span class="o">.</span><span class="n">called_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#no more</span>
                <span class="k">raise</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">StarDerivationFailure</span><span class="p">(</span><span class="n">wrapper</span><span class="o">.</span><span class="n">called_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">wrapper</span><span class="o">.</span><span class="n">called_list</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wrapper</span><span class="o">.</span><span class="n">called_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">wrapper</span><span class="o">.</span><span class="n">stored_used_defaults</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="n">called_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">wrapper</span>

<span class="k">class</span> <span class="nc">CifBlock</span><span class="p">(</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarBlock</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to hold a single block of a CIF file.  A `CifBlock` object can be treated as</span>
<span class="sd">    a Python dictionary, in particular, individual items can be accessed using square</span>
<span class="sd">    brackets e.g. `b[&#39;_a_dataname&#39;]`.  All other Python dictionary methods are also</span>
<span class="sd">    available (e.g. `keys()`, `values()`).  Looped datanames will return a list of values.</span>

<span class="sd">    ## Initialisation</span>

<span class="sd">    When provided, `data` should be another `CifBlock` whose contents will be copied to</span>
<span class="sd">    this block.</span>

<span class="sd">    * if `strict` is set, maximum name lengths will be enforced</span>

<span class="sd">    * `maxoutlength` is the maximum length for output lines</span>

<span class="sd">    * `wraplength` is the ideal length to make output lines</span>

<span class="sd">    * When set, `overwrite` allows the values of datanames to be changed (otherwise an error</span>
<span class="sd">    is raised).</span>

<span class="sd">    * `compat_mode` will allow deprecated behaviour of creating single-dataname loops using</span>
<span class="sd">    the syntax `a[_dataname] = [1,2,3,4]`.  This should now be done by calling `CreateLoop`</span>
<span class="sd">    after setting the dataitem value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span> <span class="o">=</span> <span class="p">(),</span> <span class="n">strict</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">compat_mode</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;When provided, `data` should be another CifBlock whose contents will be copied to</span>
<span class="sd">        this block.</span>

<span class="sd">        * if `strict` is set, maximum name lengths will be enforced</span>

<span class="sd">        * `maxoutlength` is the maximum length for output lines</span>

<span class="sd">        * `wraplength` is the ideal length to make output lines</span>

<span class="sd">        * When set, `overwrite` allows the values of datanames to be changed (otherwise an error</span>
<span class="sd">        is raised).</span>

<span class="sd">        * `compat_mode` will allow deprecated behaviour of creating single-dataname loops using</span>
<span class="sd">        the syntax `a[_dataname] = [1,2,3,4]`.  This should now be done by calling `CreateLoop`</span>
<span class="sd">        after setting the dataitem value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">strict</span><span class="p">:</span> <span class="n">maxnamelength</span><span class="o">=</span><span class="mi">75</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">maxnamelength</span><span class="o">=-</span><span class="mi">1</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CifBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="n">maxnamelength</span><span class="o">=</span><span class="n">maxnamelength</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="bp">None</span>   <span class="c1">#DDL dictionary referring to this block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compat_mode</span> <span class="o">=</span> <span class="n">compat_mode</span>   <span class="c1">#old-style behaviour of setitem</span>

    <span class="k">def</span> <span class="nf">RemoveCifItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove `itemname` from the CifBlock&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RemoveItem</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
        <span class="c1"># for backwards compatibility make a single-element loop</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compat_mode</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarList</span><span class="p">):</span>
                 <span class="c1"># single element loop</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">([</span><span class="n">key</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">newblock</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="o">.</span><span class="n">im_class</span><span class="p">(</span><span class="n">newblock</span><span class="p">)</span>   <span class="c1">#catch inheritance</span>

    <span class="k">def</span> <span class="nf">AddCifItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; *DEPRECATED*. Use `AddItem` instead.&quot;&quot;&quot;</span>
        <span class="c1"># we accept only tuples, strings and lists!!</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">,</span><span class="nb">str</span><span class="p">))):</span>
                  <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Cif datanames are either a string, tuple or list&#39;</span><span class="p">)</span>
        <span class="c1"># we catch single item loops as well...</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AddSingleCifItem</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarList</span><span class="p">):</span>  <span class="c1"># a single element loop</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">return</span>
        <span class="c1"># otherwise, we loop over the datanames</span>
        <span class="n">keyvals</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],[</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">AddSingleCifItem</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">keyvals</span><span class="p">]</span>
        <span class="c1"># and create the loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">AddSingleCifItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` instead&quot;&quot;&quot;</span>
        <span class="sd">&quot;&quot;&quot;Add a single data item. If it is part of a loop, a separate call should be made&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">loopnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">CifFile</span><span class="p">(</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarFile</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">datasource</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">strict</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">standard</span><span class="o">=</span><span class="s1">&#39;CIF&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CifFile</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">datasource</span><span class="o">=</span><span class="n">datasource</span><span class="p">,</span><span class="n">standard</span><span class="o">=</span><span class="n">standard</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strict</span> <span class="o">=</span> <span class="n">strict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_comment</span> <span class="o">=</span> \
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">##########################################################################</span>
<span class="sd">#               Crystallographic Information Format file</span>
<span class="sd">#               Produced by PyCifRW module</span>
<span class="sd">#</span>
<span class="sd">#  This is a CIF file.  CIF has been adopted by the International</span>
<span class="sd">#  Union of Crystallography as the standard for data archiving and</span>
<span class="sd">#  transmission.</span>
<span class="sd">#</span>
<span class="sd">#  For information on this file format, follow the CIF links at</span>
<span class="sd">#  http://www.iucr.org</span>
<span class="sd">##########################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">CifError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Cif Format error: &#39;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

<span class="k">class</span> <span class="nc">ValidCifError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Cif Validity error: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

<span class="k">class</span> <span class="nc">CifRecursionError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key_value</span><span class="p">,</span><span class="n">call_stack</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_value</span> <span class="o">=</span> <span class="n">key_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span> <span class="o">=</span> <span class="n">call_stack</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Derivation has recursed, </span><span class="si">%s</span><span class="s2"> seen twice (call stack </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_value</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">DicBlock</span><span class="p">(</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarBlock</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A definition block within a dictionary, which allows imports</span>
<span class="sd">    to be transparently followed&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DicBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_import_cache</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">super</span><span class="p">(</span><span class="n">DicBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;_import.get&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_import_cache</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">follow_import</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">DicBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="s2">&quot;_import.get&quot;</span><span class="p">),</span><span class="n">dataname</span><span class="p">)</span> 
        <span class="k">try</span><span class="p">:</span>
            <span class="n">final_value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">DicBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>    <span class="c1">#not there</span>
            <span class="n">final_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">final_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not found&quot;</span> <span class="o">%</span> <span class="n">dataname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_value</span>

    <span class="k">def</span> <span class="nf">has_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">add_dict_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">cached</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a loaded dictionary to this block&#39;s cache&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_import_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="n">cached</span>
        
    <span class="k">def</span> <span class="nf">follow_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">import_info</span><span class="p">,</span><span class="n">dataname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the dataname values from the imported dictionary. `import_info`</span>
<span class="sd">        is a list of import locations&quot;&quot;&quot;</span>
        <span class="n">latest_value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">import_ref</span> <span class="ow">in</span> <span class="n">import_info</span><span class="p">:</span>
            <span class="n">file_loc</span> <span class="o">=</span> <span class="n">import_ref</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">file_loc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_import_cache</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dictionary for import </span><span class="si">%s</span><span class="s2"> not found&quot;</span> <span class="o">%</span> <span class="n">file_loc</span><span class="p">)</span>
            <span class="n">import_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_import_cache</span><span class="p">[</span><span class="n">file_loc</span><span class="p">]</span>
            <span class="n">miss</span> <span class="o">=</span> <span class="n">import_ref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;miss&#39;</span><span class="p">,</span><span class="s1">&#39;Exit&#39;</span><span class="p">)</span>
            <span class="n">target_key</span> <span class="o">=</span> <span class="n">import_ref</span><span class="p">[</span><span class="s2">&quot;save&quot;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">import_target</span> <span class="o">=</span> <span class="n">import_from</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">miss</span> <span class="o">==</span> <span class="s1">&#39;Exit&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s1">&#39;Import frame </span><span class="si">%s</span><span class="s1"> not found in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target_key</span><span class="p">,</span><span class="n">file_loc</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">continue</span>
            <span class="c1"># now import appropriately</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">import_ref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span><span class="s1">&#39;Contents&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;contents&quot;</span><span class="p">:</span>   <span class="c1">#only this is used at this level</span>
                <span class="n">latest_value</span> <span class="o">=</span> <span class="n">import_target</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dataname</span><span class="p">,</span><span class="n">latest_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">latest_value</span>
    
<span class="k">class</span> <span class="nc">CifDic</span><span class="p">(</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a Cif Dictionary object from the provided source, which can</span>
<span class="sd">    be a filename/URL or a CifFile.  Optional arguments (relevant to DDLm</span>
<span class="sd">    only):</span>

<span class="sd">    * do_minimum (Boolean):</span>
<span class="sd">         Do not set up the dREL system for auto-calculation or perform</span>
<span class="sd">         imports.  This implies do_imports=False and do_dREL=False</span>

<span class="sd">    * do_imports = No/Full/Contents/All:</span>
<span class="sd">         If not &#39;No&#39;, intepret _import.get statements for</span>
<span class="sd">         Full mode/Contents mode/Both respectively. See also option &#39;heavy&#39;</span>

<span class="sd">    * do_dREL = True/False:</span>
<span class="sd">         Parse and convert all dREL methods to Python. Implies do_imports=All</span>

<span class="sd">    * heavy = True/False:</span>
<span class="sd">         (Experimental). If True, importation overwrites definitions. If False,</span>
<span class="sd">         attributes are resolved dynamically.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dic</span><span class="p">,</span><span class="n">do_minimum</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">do_imports</span><span class="o">=</span><span class="s1">&#39;All&#39;</span><span class="p">,</span> <span class="n">do_dREL</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">grammar</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span><span class="n">heavy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_minimum</span> <span class="o">=</span> <span class="n">do_minimum</span>
        <span class="k">if</span> <span class="n">do_minimum</span><span class="p">:</span>
            <span class="n">do_imports</span> <span class="o">=</span> <span class="s1">&#39;No&#39;</span>
            <span class="n">do_dREL</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">do_dREL</span><span class="p">:</span> <span class="n">do_imports</span> <span class="o">=</span> <span class="s1">&#39;All&#39;</span>
        <span class="k">if</span> <span class="n">heavy</span> <span class="o">==</span> <span class="s1">&#39;Light&#39;</span> <span class="ow">and</span> <span class="n">do_imports</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;contents&#39;</span><span class="p">,</span><span class="s1">&#39;No&#39;</span><span class="p">):</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span><span class="s2">&quot;Light imports only available for mode &#39;contents&#39;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_cache</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1">#for DDLm imports</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_functions</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1">#for DDLm functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">switch_numpy</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>    <span class="c1">#no Numpy arrays returned</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">datasource</span><span class="o">=</span><span class="n">dic</span><span class="p">,</span><span class="n">grammar</span><span class="o">=</span><span class="n">grammar</span><span class="p">,</span><span class="n">blocktype</span><span class="o">=</span><span class="n">DicBlock</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">=</span> <span class="s1">&#39;Dic&#39;</span>    <span class="c1">#for correct output order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="s1">&#39;dictionary&#39;</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dicname</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">diclang</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_determine</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is a </span><span class="si">%s</span><span class="s1"> dictionary&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dicname</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">diclang</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scopes_mandatory</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scopes_naughty</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># rename and expand out definitions using &quot;_name&quot; in DDL dictionaries</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diclang</span> <span class="o">==</span> <span class="s2">&quot;DDL1&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DDL1_normalise</span><span class="p">()</span>   <span class="c1">#this removes any non-definition entries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_def_block_table</span><span class="p">()</span> <span class="c1">#From now on, [] uses definition_id</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diclang</span> <span class="o">==</span> <span class="s2">&quot;DDL1&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ddl1_cat_load</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">diclang</span> <span class="o">==</span> <span class="s2">&quot;DDL2&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DDL2_normalise</span><span class="p">()</span>   <span class="c1">#iron out some DDL2 tricky bits</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">diclang</span> <span class="o">==</span> <span class="s2">&quot;DDLm&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="s1">&#39;dictionary&#39;</span>   <span class="c1">#expose all save frames</span>
            <span class="k">if</span> <span class="n">do_imports</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obtain_imports</span><span class="p">(</span><span class="n">import_mode</span><span class="o">=</span><span class="n">do_imports</span><span class="p">,</span><span class="n">heavy</span><span class="o">=</span><span class="n">heavy</span><span class="p">)</span><span class="c1">#recursively calls this routine</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_alias_table</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_cat_obj_table</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_cat_key_table</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">do_dREL</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Doing full dictionary initialisation&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialise_drel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_category_info</span><span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="n">do_dREL</span><span class="p">)</span>
        <span class="c1"># initialise type information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">typedic</span><span class="o">=</span><span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primdic</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1">#typecode&lt;-&gt;primitive type translation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_type_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install_validation_functions</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">dic_determine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;on_this_dictionary&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="s2">&quot;on_this_dictionary&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">def_id_spec</span> <span class="o">=</span> <span class="s2">&quot;_name&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cat_id_spec</span> <span class="o">=</span> <span class="s2">&quot;_category.id&quot;</span>   <span class="c1">#we add this ourselves</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type_spec</span> <span class="o">=</span> <span class="s2">&quot;_type&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enum_spec</span> <span class="o">=</span> <span class="s2">&quot;_enumeration&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cat_spec</span> <span class="o">=</span> <span class="s2">&quot;_category&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">esd_spec</span> <span class="o">=</span> <span class="s2">&quot;_type_conditions&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">must_loop_spec</span> <span class="o">=</span> <span class="s2">&quot;_list&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">must_exist_spec</span> <span class="o">=</span> <span class="s2">&quot;_list_mandatory&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_ref_spec</span> <span class="o">=</span> <span class="s2">&quot;_list_reference&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key_spec</span> <span class="o">=</span> <span class="s2">&quot;_list_mandatory&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unique_spec</span> <span class="o">=</span> <span class="s2">&quot;_list_uniqueness&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">child_spec</span> <span class="o">=</span> <span class="s2">&quot;_list_link_child&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent_spec</span> <span class="o">=</span> <span class="s2">&quot;_list_link_parent&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">related_func</span> <span class="o">=</span> <span class="s2">&quot;_related_function&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">related_item</span> <span class="o">=</span> <span class="s2">&quot;_related_item&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primitive_type</span> <span class="o">=</span> <span class="s2">&quot;_type&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dep_spec</span> <span class="o">=</span> <span class="s2">&quot;xxx&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cat_list</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1">#to save searching all the time</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="s2">&quot;on_this_dictionary&quot;</span><span class="p">)[</span><span class="s2">&quot;_dictionary_name&quot;</span><span class="p">]</span>
            <span class="n">version</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="s2">&quot;on_this_dictionary&quot;</span><span class="p">)[</span><span class="s2">&quot;_dictionary_version&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="n">version</span><span class="p">,</span><span class="s2">&quot;DDL1&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_roots</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>              <span class="c1"># DDL2/DDLm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># now change to dictionary scoping</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="s1">&#39;dictionary&#39;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="p">[</span><span class="s2">&quot;_dictionary.title&quot;</span><span class="p">]</span>
            <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="p">[</span><span class="s2">&quot;_dictionary.version&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;_dictionary.class&quot;</span><span class="p">):</span>   <span class="c1">#DDLm</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enum_spec</span> <span class="o">=</span> <span class="s1">&#39;_enumeration_set.state&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">key_spec</span> <span class="o">=</span> <span class="s1">&#39;_category.key_id&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">must_exist_spec</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cat_spec</span> <span class="o">=</span> <span class="s1">&#39;_name.category_id&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">primitive_type</span> <span class="o">=</span> <span class="s1">&#39;_type.contents&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cat_id_spec</span> <span class="o">=</span> <span class="s2">&quot;_definition.id&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">def_id_spec</span> <span class="o">=</span> <span class="s2">&quot;_definition.id&quot;</span>
                <span class="k">return</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="n">version</span><span class="p">,</span><span class="s2">&quot;DDLm&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>   <span class="c1">#DDL2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cat_id_spec</span> <span class="o">=</span> <span class="s2">&quot;_category.id&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">def_id_spec</span> <span class="o">=</span> <span class="s2">&quot;_item.name&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">key_spec</span> <span class="o">=</span> <span class="s2">&quot;_category_mandatory.name&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type_spec</span> <span class="o">=</span> <span class="s2">&quot;_item_type.code&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enum_spec</span> <span class="o">=</span> <span class="s2">&quot;_item_enumeration.value&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">esd_spec</span> <span class="o">=</span> <span class="s2">&quot;_item_type_conditions.code&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cat_spec</span> <span class="o">=</span> <span class="s2">&quot;_item.category_id&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loop_spec</span> <span class="o">=</span> <span class="s2">&quot;there_is_no_loop_spec!&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">must_loop_spec</span> <span class="o">=</span> <span class="s2">&quot;xxx&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">must_exist_spec</span> <span class="o">=</span> <span class="s2">&quot;_item.mandatory_code&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">child_spec</span> <span class="o">=</span> <span class="s2">&quot;_item_linked.child_name&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent_spec</span> <span class="o">=</span> <span class="s2">&quot;_item_linked.parent_name&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">related_func</span> <span class="o">=</span> <span class="s2">&quot;_item_related.function_code&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">related_item</span> <span class="o">=</span> <span class="s2">&quot;_item_related.related_name&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unique_spec</span> <span class="o">=</span> <span class="s2">&quot;_category_key.name&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_ref_spec</span> <span class="o">=</span> <span class="s2">&quot;xxx&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">primitive_type</span> <span class="o">=</span> <span class="s2">&quot;_type&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dep_spec</span> <span class="o">=</span> <span class="s2">&quot;_item_dependent.dependent_name&quot;</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="n">version</span><span class="p">,</span><span class="s2">&quot;DDL2&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s2">&quot;Unable to determine dictionary DDL version&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">DDL1_normalise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># switch off block name collision checks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># add default type information in DDL2 style</span>
        <span class="c1"># initial types and constructs</span>
        <span class="n">base_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;char&quot;</span><span class="p">,</span><span class="s2">&quot;numb&quot;</span><span class="p">,</span><span class="s2">&quot;null&quot;</span><span class="p">]</span>
        <span class="n">prim_types</span> <span class="o">=</span> <span class="n">base_types</span><span class="p">[:]</span>
        <span class="n">base_constructs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.*&quot;</span><span class="p">,</span>
            <span class="s1">&#39;(-?(([0-9]*[.][0-9]+)|([0-9]+)[.]?)([(][0-9]+[)])?([eEdD][+-]?[0-9]+)?)|\?|\.&#39;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="se">\&quot;\&quot;</span><span class="s2"> &quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
           <span class="n">newnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c1">#keep by default</span>
           <span class="k">if</span> <span class="s2">&quot;_name&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
               <span class="n">real_name</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_name&quot;</span><span class="p">]</span>
               <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">real_name</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>        <span class="c1">#looped values</span>
                   <span class="k">for</span> <span class="n">looped_name</span> <span class="ow">in</span> <span class="n">real_name</span><span class="p">:</span>
                      <span class="n">new_value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                      <span class="n">new_value</span><span class="p">[</span><span class="s2">&quot;_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">looped_name</span>  <span class="c1">#only looped name</span>
                      <span class="bp">self</span><span class="p">[</span><span class="n">looped_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
                   <span class="n">newnames</span> <span class="o">=</span> <span class="n">real_name</span>
               <span class="k">else</span><span class="p">:</span>
                      <span class="bp">self</span><span class="p">[</span><span class="n">real_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                      <span class="n">newnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">real_name</span><span class="p">]</span>
           <span class="c1"># delete the old one</span>
           <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">newnames</span><span class="p">:</span>
              <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="c1"># loop again to normalise the contents of each definition</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
           <span class="c1">#unlock the block</span>
           <span class="n">save_overwrite</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">overwrite</span>
           <span class="n">value</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="bp">True</span>
           <span class="c1"># deal with a missing _list, _type_conditions</span>
           <span class="k">if</span> <span class="s2">&quot;_list&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
           <span class="k">if</span> <span class="s2">&quot;_type_conditions&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_type_conditions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
           <span class="c1"># deal with enumeration ranges</span>
           <span class="k">if</span> <span class="s2">&quot;_enumeration_range&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
               <span class="nb">max</span><span class="p">,</span><span class="nb">min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmaxmin</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;_enumeration_range&quot;</span><span class="p">])</span>
               <span class="k">if</span> <span class="nb">min</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                   <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">(((</span><span class="s2">&quot;_item_range.maximum&quot;</span><span class="p">,</span><span class="s2">&quot;_item_range.minimum&quot;</span><span class="p">),((</span><span class="nb">max</span><span class="p">,</span><span class="nb">max</span><span class="p">),(</span><span class="nb">max</span><span class="p">,</span><span class="nb">min</span><span class="p">))))</span>
               <span class="k">elif</span> <span class="nb">max</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                   <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">(((</span><span class="s2">&quot;_item_range.maximum&quot;</span><span class="p">,</span><span class="s2">&quot;_item_range.minimum&quot;</span><span class="p">),((</span><span class="nb">max</span><span class="p">,</span><span class="nb">min</span><span class="p">),(</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">))))</span>
               <span class="k">else</span><span class="p">:</span>
                   <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">(((</span><span class="s2">&quot;_item_range.maximum&quot;</span><span class="p">,</span><span class="s2">&quot;_item_range.minimum&quot;</span><span class="p">),((</span><span class="nb">max</span><span class="p">,</span><span class="nb">max</span><span class="p">,</span><span class="nb">min</span><span class="p">),(</span><span class="nb">max</span><span class="p">,</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">))))</span>
           <span class="c1">#add any type construct information</span>
           <span class="k">if</span> <span class="s2">&quot;_type_construct&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
               <span class="n">base_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;_name&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_type&quot;</span><span class="p">)</span>   <span class="c1">#ie dataname_type</span>
               <span class="n">base_constructs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;_type_construct&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;$&quot;</span><span class="p">)</span>
               <span class="n">prim_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;_type&quot;</span><span class="p">])</span>     <span class="c1">#keep a record</span>
               <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_types</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>   <span class="c1">#the new type name</span>

        <span class="c1">#make categories conform with ddl2</span>
        <span class="c1">#note that we must remove everything from the last underscore</span>
           <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_category&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;category_overview&quot;</span><span class="p">:</span>
                <span class="n">last_under</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                <span class="n">catid</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_name&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="n">last_under</span><span class="p">]</span>
                <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_category.id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catid</span>  <span class="c1">#remove square bracks</span>
                <span class="k">if</span> <span class="n">catid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_list</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">catid</span><span class="p">)</span>
           <span class="n">value</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="n">save_overwrite</span>
        <span class="c1"># we now add any missing categories before filling in the rest of the</span>
        <span class="c1"># information</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1">#print(&#39;processing ddl1 definition %s&#39; % key)</span>
            <span class="k">if</span> <span class="s2">&quot;_category&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;_category&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_list</span><span class="p">:</span>
                    <span class="c1"># rogue category, add it in</span>
                    <span class="n">newcat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;_category&quot;</span><span class="p">]</span>
                    <span class="n">fake_name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">newcat</span> <span class="o">+</span> <span class="s2">&quot;_[]&quot;</span>
                    <span class="n">newcatdata</span> <span class="o">=</span> <span class="n">CifBlock</span><span class="p">()</span>
                    <span class="n">newcatdata</span><span class="p">[</span><span class="s2">&quot;_category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;category_overview&quot;</span>
                    <span class="n">newcatdata</span><span class="p">[</span><span class="s2">&quot;_category.id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newcat</span>
                    <span class="n">newcatdata</span><span class="p">[</span><span class="s2">&quot;_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">fake_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">newcatdata</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cat_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newcat</span><span class="p">)</span>
        <span class="c1"># write out the type information in DDL2 style</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">((</span>
            <span class="p">(</span><span class="s2">&quot;_item_type_list.code&quot;</span><span class="p">,</span><span class="s2">&quot;_item_type_list.construct&quot;</span><span class="p">,</span>
              <span class="s2">&quot;_item_type_list.primitive_code&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">base_types</span><span class="p">,</span><span class="n">base_constructs</span><span class="p">,</span><span class="n">prim_types</span><span class="p">)</span>
            <span class="p">))</span>

    <span class="k">def</span> <span class="nf">ddl1_cat_load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">deflist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>       <span class="c1">#slight optimization</span>
        <span class="n">cat_mand_dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cat_unique_dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># a function to extract any necessary information from each definition</span>
        <span class="k">def</span> <span class="nf">get_cat_info</span><span class="p">(</span><span class="n">single_def</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">single_def</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">must_exist_spec</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;yes&#39;</span><span class="p">:</span>
                <span class="n">thiscat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">single_def</span><span class="p">][</span><span class="s2">&quot;_category&quot;</span><span class="p">]</span>
                <span class="n">curval</span> <span class="o">=</span> <span class="n">cat_mand_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">thiscat</span><span class="p">,[])</span>
                <span class="n">curval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_def</span><span class="p">)</span>
                <span class="n">cat_mand_dic</span><span class="p">[</span><span class="n">thiscat</span><span class="p">]</span> <span class="o">=</span> <span class="n">curval</span>
            <span class="c1"># now the unique items...</span>
            <span class="c1"># cif_core.dic throws us a curly one: the value of list_uniqueness is</span>
            <span class="c1"># not the same as the defined item for publ_body_label, so we have</span>
            <span class="c1"># to collect both together.  We assume a non-listed entry, which</span>
            <span class="c1"># is true for all current (May 2005) ddl1 dictionaries.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">single_def</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_spec</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
                <span class="n">thiscat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">single_def</span><span class="p">][</span><span class="s2">&quot;_category&quot;</span><span class="p">]</span>
                <span class="n">new_unique</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">single_def</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_spec</span><span class="p">]</span>
                <span class="n">uis</span> <span class="o">=</span> <span class="n">cat_unique_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">thiscat</span><span class="p">,[])</span>
                <span class="k">if</span> <span class="n">single_def</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uis</span><span class="p">:</span> <span class="n">uis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_def</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_unique</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uis</span><span class="p">:</span> <span class="n">uis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_unique</span><span class="p">)</span>
                <span class="n">cat_unique_dic</span><span class="p">[</span><span class="n">thiscat</span><span class="p">]</span> <span class="o">=</span> <span class="n">uis</span>

        <span class="p">[</span><span class="n">get_cat_info</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">deflist</span><span class="p">]</span> <span class="c1"># apply the above function</span>
        <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">cat_mand_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;_category_mandatory.name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat_mand_dic</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">cat_unique_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;_category_key.name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat_unique_dic</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">create_pcloop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">definition</span><span class="p">):</span>
        <span class="n">old_children</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">definition</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,[])</span>
        <span class="n">old_parents</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">definition</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">,[])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">old_children</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
             <span class="n">old_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">old_children</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">old_parents</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
             <span class="n">old_parents</span> <span class="o">=</span> <span class="p">[</span><span class="n">old_parents</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">old_children</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_parents</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> \
           <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">old_children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_parents</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
             <span class="k">return</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_children</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
             <span class="n">old_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">definition</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">old_parents</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_parents</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
             <span class="n">old_parents</span> <span class="o">=</span> <span class="p">[</span><span class="n">definition</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">old_children</span><span class="p">)</span>
        <span class="n">newloop</span> <span class="o">=</span> <span class="n">CifLoopBlock</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">newloop</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">((</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">,</span><span class="n">old_parents</span><span class="p">))</span>
        <span class="n">newloop</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">((</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,</span><span class="n">old_children</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">definition</span><span class="p">][</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">definition</span><span class="p">][</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">definition</span><span class="p">]</span><span class="o">.</span><span class="n">insert_loop</span><span class="p">(</span><span class="n">newloop</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">DDL2_normalise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="n">listed_defs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_item.name&#39;</span><span class="p">),</span><span class="nb">list</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
       <span class="c1"># now filter out all the single element lists!</span>
       <span class="n">dodgy_defs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_item.name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">listed_defs</span><span class="p">)</span>
       <span class="k">for</span> <span class="n">item_def</span> <span class="ow">in</span> <span class="n">dodgy_defs</span><span class="p">:</span>
                <span class="c1"># print(&quot;DDL2 norm: processing %s&quot; % item_def)</span>
                <span class="n">thisdef</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_def</span><span class="p">]</span>
                <span class="n">packet_no</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item_def</span><span class="p">)</span>
                <span class="n">realcat</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.category_id&#39;</span><span class="p">][</span><span class="n">packet_no</span><span class="p">]</span>
                <span class="n">realmand</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.mandatory_code&#39;</span><span class="p">][</span><span class="n">packet_no</span><span class="p">]</span>
                <span class="c1"># first add in all the missing categories</span>
                <span class="c1"># we don&#39;t replace the entry in the list corresponding to the</span>
                <span class="c1"># current item, as that would wipe out the information we want</span>
                <span class="k">for</span> <span class="n">child_no</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.name&#39;</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="n">child_no</span> <span class="o">==</span> <span class="n">packet_no</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">child_name</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.name&#39;</span><span class="p">][</span><span class="n">child_no</span><span class="p">]</span>
                    <span class="n">child_cat</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.category_id&#39;</span><span class="p">][</span><span class="n">child_no</span><span class="p">]</span>
                    <span class="n">child_mand</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.mandatory_code&#39;</span><span class="p">][</span><span class="n">child_no</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">child_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">child_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">CifBlock</span><span class="p">()</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">child_name</span><span class="p">][</span><span class="s1">&#39;_item.name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">child_name</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">child_name</span><span class="p">][</span><span class="s1">&#39;_item.category_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">child_cat</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">child_name</span><span class="p">][</span><span class="s1">&#39;_item.mandatory_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">child_mand</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">item_def</span><span class="p">][</span><span class="s1">&#39;_item.name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_def</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">item_def</span><span class="p">][</span><span class="s1">&#39;_item.category_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">realcat</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">item_def</span><span class="p">][</span><span class="s1">&#39;_item.mandatory_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">realmand</span>

       <span class="n">target_defs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;_item_linked.child_name&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">or</span> \
                                     <span class="s1">&#39;_item_linked.parent_name&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
       <span class="c1"># now dodgy_defs contains all definition blocks with more than one child/parent link</span>
       <span class="k">for</span> <span class="n">item_def</span> <span class="ow">in</span> <span class="n">dodgy_defs</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_pcloop</span><span class="p">(</span><span class="n">item_def</span><span class="p">)</span>           <span class="c1">#regularise appearance</span>
       <span class="k">for</span> <span class="n">item_def</span> <span class="ow">in</span> <span class="n">dodgy_defs</span><span class="p">:</span>
             <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Processing </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">item_def</span><span class="p">)</span>
             <span class="n">thisdef</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_def</span><span class="p">]</span>
             <span class="n">child_list</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">]</span>
             <span class="n">parents</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">]</span>
             <span class="c1"># for each parent, find the list of children.</span>
             <span class="n">family</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">parents</span><span class="p">,</span><span class="n">child_list</span><span class="p">))</span>
             <span class="n">notmychildren</span> <span class="o">=</span> <span class="n">family</span>         <span class="c1">#We aim to remove non-children</span>
             <span class="c1"># Loop over the parents, relocating as necessary</span>
             <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">notmychildren</span><span class="p">):</span>
                <span class="c1"># get all children of first entry</span>
                <span class="n">mychildren</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">family</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">notmychildren</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Parent </span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2"> children&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">notmychildren</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">mychildren</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">parent</span><span class="p">,</span><span class="n">child</span> <span class="ow">in</span> <span class="n">mychildren</span><span class="p">:</span>   <span class="c1">#parent is the same for all</span>
                         <span class="c1"># Make sure that we simply add in the new entry for the child, not replace it,</span>
                         <span class="c1"># otherwise we might spoil the child entry loop structure</span>
                         <span class="k">try</span><span class="p">:</span>
                             <span class="n">childloop</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">child</span><span class="p">]</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">)</span>
                         <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                             <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Creating new parent entry </span><span class="si">%s</span><span class="s1"> for definition </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">child</span><span class="p">))</span>
                             <span class="bp">self</span><span class="p">[</span><span class="n">child</span><span class="p">][</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">parent</span><span class="p">]</span>
                             <span class="n">childloop</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">child</span><span class="p">]</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">)</span>
                             <span class="n">childloop</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">((</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,[</span><span class="n">child</span><span class="p">]))</span>
                             <span class="k">continue</span>
                         <span class="k">else</span><span class="p">:</span>
                             <span class="c1"># A parent loop already exists and so will a child loop due to the</span>
                             <span class="c1"># call to create_pcloop above</span>
                             <span class="n">pars</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">childloop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">==</span><span class="n">child</span><span class="p">]</span>
                             <span class="n">goodpars</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">pars</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">==</span><span class="n">parent</span><span class="p">]</span>
                             <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">goodpars</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>   <span class="c1">#no need to add it</span>
                                 <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Skipping duplicated parent - child entry in </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">child</span><span class="p">))</span>
                                 <span class="k">continue</span>
                             <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Adding </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> entry&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">child</span><span class="p">))</span>
                             <span class="n">newpacket</span> <span class="o">=</span> <span class="n">childloop</span><span class="o">.</span><span class="n">GetPacket</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>   <span class="c1">#essentially a copy, I hope</span>
                             <span class="nb">setattr</span><span class="p">(</span><span class="n">newpacket</span><span class="p">,</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,</span><span class="n">child</span><span class="p">)</span>
                             <span class="nb">setattr</span><span class="p">(</span><span class="n">newpacket</span><span class="p">,</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">,</span><span class="n">parent</span><span class="p">)</span>
                             <span class="n">childloop</span><span class="o">.</span><span class="n">AddPacket</span><span class="p">(</span><span class="n">newpacket</span><span class="p">)</span>
                <span class="c1">#</span>
                <span class="c1"># Make sure the parent also points to the children.  We get</span>
                <span class="c1"># the current entry, then add our</span>
                <span class="c1"># new values if they are not there already</span>
                <span class="c1">#</span>
                <span class="n">parent_name</span> <span class="o">=</span> <span class="n">mychildren</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">old_children</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,[])</span>
                <span class="n">old_parents</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">,[])</span>
                <span class="n">oldfamily</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">old_parents</span><span class="p">,</span><span class="n">old_children</span><span class="p">)</span>
                <span class="n">newfamily</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Old parents -&gt; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">old_parents</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">childname</span> <span class="ow">in</span> <span class="n">mychildren</span><span class="p">:</span>
                    <span class="n">alreadythere</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">oldfamily</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">parent_name</span> <span class="ow">and</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span><span class="n">childname</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alreadythere</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="s1">&#39;Adding new child </span><span class="si">%s</span><span class="s1"> to parent definition at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">childname</span><span class="p">,</span><span class="n">parent_name</span><span class="p">)</span>
                    <span class="n">old_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">childname</span><span class="p">)</span>
                    <span class="n">old_parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_name</span><span class="p">)</span>
                <span class="c1"># Now output the loop, blowing away previous definitions.  If there is something</span>
                <span class="c1"># else in this category, we are destroying it.</span>
                <span class="n">newloop</span> <span class="o">=</span> <span class="n">CifLoopBlock</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">newloop</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">((</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">,</span><span class="n">old_parents</span><span class="p">))</span>
                <span class="n">newloop</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">((</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,</span><span class="n">old_children</span><span class="p">))</span>
                <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_name</span><span class="p">][</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">]</span>
                <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_name</span><span class="p">][</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">insert_loop</span><span class="p">(</span><span class="n">newloop</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;New parents -&gt; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">parent_name</span><span class="p">][</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">]))</span>
                <span class="c1"># now make a new,smaller list</span>
                <span class="n">notmychildren</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">notmychildren</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="n">mychildren</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

       <span class="c1"># now flatten any single element lists</span>
       <span class="n">single_defs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_item.name&#39;</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="n">listed_defs</span><span class="p">)</span>
       <span class="k">for</span> <span class="n">flat_def</span> <span class="ow">in</span> <span class="n">single_defs</span><span class="p">:</span>
           <span class="n">flat_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">flat_def</span><span class="p">]</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="s1">&#39;_item.name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
           <span class="k">for</span> <span class="n">flat_key</span> <span class="ow">in</span> <span class="n">flat_keys</span><span class="p">:</span> <span class="bp">self</span><span class="p">[</span><span class="n">flat_def</span><span class="p">][</span><span class="n">flat_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">flat_def</span><span class="p">][</span><span class="n">flat_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
       <span class="c1"># now deal with the multiple lists</span>
       <span class="c1"># next we do aliases</span>
       <span class="n">all_aliases</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;_item_aliases.alias_name&#39;</span><span class="p">)]</span>
       <span class="k">for</span> <span class="n">aliased</span> <span class="ow">in</span> <span class="n">all_aliases</span><span class="p">:</span>
          <span class="n">my_aliases</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">aliased</span><span class="p">][</span><span class="s1">&#39;_item_aliases.alias_name&#39;</span><span class="p">])</span>
          <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">my_aliases</span><span class="p">:</span>
              <span class="bp">self</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">aliased</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>   <span class="c1">#we are going to delete stuff...</span>
              <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">alias</span><span class="p">][</span><span class="s2">&quot;_item_aliases.alias_name&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">ddlm_parse_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;_dictionary_valid.application&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">scope_pack</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="s2">&quot;_dictionary_valid.application&quot;</span><span class="p">):</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">scope_pack</span><span class="p">,</span><span class="s2">&quot;_dictionary_valid.application&quot;</span><span class="p">)</span>
            <span class="n">valid_info</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">scope_pack</span><span class="p">,</span><span class="s2">&quot;_dictionary_valid.attributes&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scope</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Mandatory&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scopes_mandatory</span><span class="p">[</span><span class="n">scope</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_category_opt</span><span class="p">(</span><span class="n">valid_info</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">scope</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Prohibited&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scopes_naughty</span><span class="p">[</span><span class="n">scope</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_category_opt</span><span class="p">(</span><span class="n">valid_info</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">obtain_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">import_mode</span><span class="p">,</span><span class="n">heavy</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Collate import information&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_import_dics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">import_frames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([(</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_import.get&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;_import.get&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]])</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Import mode </span><span class="si">%s</span><span class="s1"> applied to following frames&#39;</span> <span class="o">%</span> <span class="n">import_mode</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">import_frames</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">import_mode</span> <span class="o">!=</span> <span class="s1">&#39;All&#39;</span><span class="p">:</span>
           <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">import_frames</span><span class="p">)):</span>
                <span class="n">import_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">import_frames</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">import_frames</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span><span class="s1">&#39;Contents&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">import_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
           <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Importing following frames in mode </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">import_mode</span><span class="p">)</span>
           <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_frames</span><span class="p">))</span>
        <span class="c1">#resolve all references</span>
        <span class="k">for</span> <span class="n">parent_block</span><span class="p">,</span><span class="n">import_list</span> <span class="ow">in</span> <span class="n">import_frames</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">import_ref</span> <span class="ow">in</span> <span class="n">import_list</span><span class="p">:</span>
            <span class="n">file_loc</span> <span class="o">=</span> <span class="n">import_ref</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span>
            <span class="n">full_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_path</span><span class="p">(</span><span class="n">file_loc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">full_uri</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_cache</span><span class="p">:</span>
                <span class="n">dic_as_cif</span> <span class="o">=</span> <span class="n">CifFile</span><span class="p">(</span><span class="n">full_uri</span><span class="p">,</span><span class="n">grammar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">template_cache</span><span class="p">[</span><span class="n">full_uri</span><span class="p">]</span> <span class="o">=</span> <span class="n">CifDic</span><span class="p">(</span><span class="n">dic_as_cif</span><span class="p">,</span><span class="n">do_imports</span><span class="o">=</span><span class="n">import_mode</span><span class="p">,</span><span class="n">heavy</span><span class="o">=</span><span class="n">heavy</span><span class="p">,</span><span class="n">do_dREL</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>  <span class="c1">#this will recurse internal imports</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Added </span><span class="si">%s</span><span class="s1"> to cached dictionaries&#39;</span> <span class="o">%</span> <span class="n">full_uri</span><span class="p">)</span>
            <span class="n">import_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_cache</span><span class="p">[</span><span class="n">full_uri</span><span class="p">]</span>
            <span class="n">dupl</span> <span class="o">=</span> <span class="n">import_ref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dupl&#39;</span><span class="p">,</span><span class="s1">&#39;Exit&#39;</span><span class="p">)</span>
            <span class="n">miss</span> <span class="o">=</span> <span class="n">import_ref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;miss&#39;</span><span class="p">,</span><span class="s1">&#39;Exit&#39;</span><span class="p">)</span>
            <span class="n">target_key</span> <span class="o">=</span> <span class="n">import_ref</span><span class="p">[</span><span class="s2">&quot;save&quot;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">import_target</span> <span class="o">=</span> <span class="n">import_from</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">miss</span> <span class="o">==</span> <span class="s1">&#39;Exit&#39;</span><span class="p">:</span>
                   <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s1">&#39;Import frame </span><span class="si">%s</span><span class="s1"> not found in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target_key</span><span class="p">,</span><span class="n">full_uri</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">continue</span>
            <span class="c1"># now import appropriately</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">import_ref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span><span class="s1">&#39;Contents&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">target_key</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;full&#39;</span><span class="p">:</span>  <span class="c1">#so blockname will be duplicated</span>
                <span class="k">if</span> <span class="n">dupl</span> <span class="o">==</span> <span class="s1">&#39;Exit&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s1">&#39;Import frame </span><span class="si">%s</span><span class="s1"> already in dictionary&#39;</span> <span class="o">%</span> <span class="n">target_key</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dupl</span> <span class="o">==</span> <span class="s1">&#39;Ignore&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">heavy</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_import</span><span class="p">(</span><span class="n">parent_block</span><span class="p">,</span><span class="n">import_from</span><span class="p">,</span><span class="n">import_target</span><span class="p">,</span><span class="n">target_key</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_import_light</span><span class="p">(</span><span class="n">parent_block</span><span class="p">,</span><span class="n">import_from</span><span class="p">,</span><span class="n">import_target</span><span class="p">,</span><span class="n">target_key</span><span class="p">,</span><span class="n">file_loc</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">ddlm_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent_block</span><span class="p">,</span><span class="n">import_from</span><span class="p">,</span><span class="n">import_target</span><span class="p">,</span><span class="n">target_key</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;All&#39;</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Import other dictionaries in place&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;contents&#39;</span><span class="p">:</span>   <span class="c1">#merge attributes only</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">parent_block</span><span class="p">]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">import_target</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span><span class="s2">&quot;full&quot;</span><span class="p">:</span>
                <span class="c1"># Do the syntactic merge</span>
                <span class="n">syntactic_head</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_parent</span><span class="p">(</span><span class="n">parent_block</span><span class="p">)]</span> <span class="c1">#root frame if no nesting</span>
                <span class="n">from_cat_head</span> <span class="o">=</span> <span class="n">import_target</span><span class="p">[</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span>
                <span class="n">child_frames</span> <span class="o">=</span> <span class="n">import_from</span><span class="o">.</span><span class="n">ddlm_all_children</span><span class="p">(</span><span class="n">from_cat_head</span><span class="p">)</span>
                 <span class="c1"># Check for Head merging Head</span>
                <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_block</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;Datum&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Head&#39;</span> <span class="ow">and</span> \
                   <span class="n">import_target</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;Datum&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Head&#39;</span><span class="p">:</span>
                      <span class="n">head_to_head</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                      <span class="n">head_to_head</span> <span class="o">=</span> <span class="bp">False</span>
                      <span class="n">child_frames</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">from_cat_head</span><span class="p">)</span>
                <span class="c1"># As we are in syntax land, we call the CifFile methods</span>
                <span class="n">child_blocks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">import_from</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">child_frames</span><span class="p">])</span>
                <span class="n">child_blocks</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="n">import_from</span><span class="p">)</span><span class="o">.</span><span class="n">makebc</span><span class="p">(</span><span class="n">child_blocks</span><span class="p">)</span>
                <span class="c1"># Prune out any datablocks that have identical definitions</span>
                <span class="n">from_defs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">a</span><span class="p">,</span><span class="n">child_blocks</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">child_blocks</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
                <span class="n">double_defs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">from_defs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Definitions for </span><span class="si">%s</span><span class="s1"> superseded&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">double_defs</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">double_defs</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">child_blocks</span><span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">merge_fast</span><span class="p">(</span><span class="n">child_blocks</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="n">syntactic_head</span><span class="p">)</span>      <span class="c1">#</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Syntactic merge of </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%d</span><span class="s1"> defs) in </span><span class="si">%s</span><span class="s1"> mode, now have </span><span class="si">%d</span><span class="s1"> defs&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target_key</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">child_frames</span><span class="p">),</span>
                   <span class="n">mode</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
                <span class="c1"># Now the semantic merge</span>
                <span class="c1"># First expand our definition &lt;-&gt; blockname tree</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_def_block_table</span><span class="p">()</span>
                <span class="n">merging_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_block</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span>      <span class="c1">#new parent</span>
                <span class="k">if</span> <span class="n">head_to_head</span><span class="p">:</span>
                    <span class="n">child_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_immediate_children</span><span class="p">(</span><span class="n">from_cat_head</span><span class="p">)</span>    <span class="c1">#old children</span>
                    <span class="c1">#the new parent is the importing category for all old children</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">child_frames</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merging_cat</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="c1"># remove the old head</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">from_cat_head</span><span class="p">]</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Semantic merge: </span><span class="si">%d</span><span class="s1"> defs reparented from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">child_frames</span><span class="p">),</span><span class="n">from_cat_head</span><span class="p">,</span><span class="n">merging_cat</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1">#imported category is only child</span>
                    <span class="n">from_frame</span> <span class="o">=</span> <span class="n">import_from</span><span class="p">[</span><span class="n">target_key</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]</span> <span class="c1">#so we can find it</span>
                    <span class="n">child_frame</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">from_frame</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">child_frame</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merging_cat</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Semantic merge: category for </span><span class="si">%s</span><span class="s1"> : now </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">from_frame</span><span class="p">,</span><span class="n">merging_cat</span><span class="p">))</span>
            <span class="c1"># it will never happen again...</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_block</span><span class="p">][</span><span class="s2">&quot;_import.get&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">resolve_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">file_loc</span><span class="p">):</span>
        <span class="n">url_comps</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">file_loc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">url_comps</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="k">return</span> <span class="n">file_loc</span>    <span class="c1">#already full URI</span>
        <span class="n">new_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_uri</span><span class="p">,</span><span class="n">file_loc</span><span class="p">)</span>
        <span class="c1">#print(&quot;Transformed %s to %s for import &quot; % (file_loc,new_url))</span>
        <span class="k">return</span> <span class="n">new_url</span>

    <span class="k">def</span> <span class="nf">ddlm_import_light</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent_block</span><span class="p">,</span><span class="n">import_from</span><span class="p">,</span><span class="n">import_target</span><span class="p">,</span><span class="n">target_key</span><span class="p">,</span><span class="n">file_loc</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;All&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register the imported dictionaries but do not alter any definitions. `parent_block`</span>
<span class="sd">        contains the id of the block that is importing. `import_target` is the block that</span>
<span class="sd">        should be imported. `import_from` is the CifFile that contains the definitions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;contents&#39;</span><span class="p">:</span>   <span class="c1">#merge attributes only</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">parent_block</span><span class="p">]</span><span class="o">.</span><span class="n">add_dict_cache</span><span class="p">(</span><span class="n">file_loc</span><span class="p">,</span><span class="n">import_from</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span><span class="s2">&quot;full&quot;</span><span class="p">:</span>
             <span class="c1"># Check for Head merging Head</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_block</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;Datum&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Head&#39;</span> <span class="ow">and</span> \
               <span class="n">import_target</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;Datum&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Head&#39;</span><span class="p">:</span>
                   <span class="n">head_to_head</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                   <span class="n">head_to_head</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c1"># Figure out the actual definition ID</span>
            <span class="n">head_id</span> <span class="o">=</span> <span class="n">import_target</span><span class="p">[</span><span class="s2">&quot;_definition.id&quot;</span><span class="p">]</span>
            <span class="c1"># Adjust parent information</span>
            <span class="n">merging_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_block</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span>
            <span class="n">from_cat_head</span> <span class="o">=</span> <span class="n">import_target</span><span class="p">[</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">head_to_head</span><span class="p">:</span>   <span class="c1"># imported category is only child</span>
                <span class="n">import_target</span><span class="p">[</span><span class="s2">&quot;_name.category_id&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">merging_cat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_import_dics</span> <span class="o">=</span> <span class="p">[(</span><span class="n">import_from</span><span class="p">,</span><span class="n">head_id</span><span class="p">)]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_import_dics</span> <span class="c1">#prepend</span>

    <span class="k">def</span> <span class="nf">lookup_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check the list of imported dictionaries for this definition&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">one_dic</span><span class="p">,</span><span class="n">head_def</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_import_dics</span><span class="p">:</span>
            <span class="n">from_cat_head</span> <span class="o">=</span> <span class="n">one_dic</span><span class="p">[</span><span class="n">head_def</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span>
            <span class="n">possible_keys</span> <span class="o">=</span> <span class="n">one_dic</span><span class="o">.</span><span class="n">ddlm_all_children</span><span class="p">(</span><span class="n">from_cat_head</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">possible_keys</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">one_dic</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not found in import dictionaries&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        


    <span class="k">def</span> <span class="nf">create_def_block_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create an internal table matching definition to block id &quot;&quot;&quot;</span>
        <span class="n">proto_table</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="c1"># now get the actual ids instead of blocks</span>
        <span class="n">proto_table</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_id_spec</span><span class="p">,</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">def_id_spec</span><span class="p">,</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">proto_table</span><span class="p">])</span>
        <span class="c1"># remove non-definitions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diclang</span> <span class="o">!=</span> <span class="s2">&quot;DDL1&quot;</span><span class="p">:</span>
            <span class="n">top_blocks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">top_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;on_this_dictionary&quot;</span><span class="p">]</span>
        <span class="c1"># catch dodgy duplicates</span>
        <span class="n">uniques</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">proto_table</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniques</span><span class="p">)</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">proto_table</span><span class="p">):</span>
            <span class="n">def_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">proto_table</span><span class="p">])</span>
            <span class="n">dodgy</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">def_names</span> <span class="k">if</span> <span class="n">def_names</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s1">&#39;Duplicate definitions in dictionary:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">dodgy</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">proto_table</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">top_blocks</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Access a datablock by definition id, after the lookup has been created&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>   <span class="c1">#block_id_table not present yet</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c1"># key is missing</span>
            <span class="k">try</span><span class="p">:</span> <span class="c1"># print(Definition for %s not found, reverting to CifFile&#39; % key)</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c1"># try imports</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_imports</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a new definition block&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]]</span><span class="o">=</span><span class="n">key</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>   <span class="c1">#does not exist yet</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">NewBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">newname</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">NewBlock</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">newname</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]]</span><span class="o">=</span><span class="n">newname</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> <span class="c1">#no block_id table</span>
            <span class="k">pass</span>
                
    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a definition&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span><span class="ne">KeyError</span><span class="p">):</span>   <span class="c1">#block_id_table not present yet</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># fix other datastructures</span>
        <span class="c1"># cat_obj table</span>

    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all definitions&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">has_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return (key,value) pairs&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">([(</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>

    <span class="k">def</span> <span class="nf">unlock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow overwriting of all definitions in this collection&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">overwrite</span><span class="o">=</span><span class="bp">True</span>

    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Disallow changes in definitions&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span>

    <span class="k">def</span> <span class="nf">rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldname</span><span class="p">,</span><span class="n">newname</span><span class="p">,</span><span class="n">blockname_as_well</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change a _definition.id from oldname to newname, and if `blockname_as_well` is True,</span>
<span class="sd">        change the underlying blockname too.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">blockname_as_well</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">oldname</span><span class="o">.</span><span class="n">lower</span><span class="p">()],</span><span class="n">newname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">newname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">=</span><span class="n">newname</span>
            <span class="k">if</span> <span class="n">oldname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">:</span> <span class="c1">#not removed</span>
               <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">oldname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">newname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">oldname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">oldname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="k">return</span>

    <span class="k">def</span> <span class="nf">get_root_category</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the single &#39;Head&#39; category of this dictionary&quot;&quot;&quot;</span>
        <span class="n">root_cats</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;Datum&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Head&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">root_cats</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">root_cats</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s2">&quot;Cannot determine a unique Head category, got&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">root_cats</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">root_cats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">ddlm_immediate_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">catname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of datanames for the immediate children of catname.  These are</span>
<span class="sd">        semantic children (i.e. based on _name.category_id), not structural children as</span>
<span class="sd">        in the case of StarFile.get_immediate_children&quot;&quot;&quot;</span>

        <span class="n">straight_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">catname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">straight_children</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ddlm_all_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">catname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of all children, including the `catname`&quot;&quot;&quot;</span>
        <span class="n">all_children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_immediate_children</span><span class="p">(</span><span class="n">catname</span><span class="p">)</span>
        <span class="n">cat_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">all_children</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Category&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cat_children</span><span class="p">:</span>
            <span class="n">all_children</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">all_children</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_all_children</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">all_children</span> <span class="o">+</span> <span class="p">[</span><span class="n">catname</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">is_semantic_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">maybe_child</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return true if `maybe_child` is a child of `parent`&quot;&quot;&quot;</span>
        <span class="n">all_children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_all_children</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">maybe_child</span> <span class="ow">in</span> <span class="n">all_children</span>

    <span class="k">def</span> <span class="nf">ddlm_danglers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of definitions that do not have a category defined</span>
<span class="sd">        for them, or are children of an unattached category&quot;&quot;&quot;</span>
        <span class="n">top_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_root_category</span><span class="p">()</span>
        <span class="n">connected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ddlm_all_children</span><span class="p">(</span><span class="n">top_block</span><span class="p">))</span>
        <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">unconnected</span> <span class="o">=</span> <span class="n">all_keys</span> <span class="o">-</span> <span class="n">connected</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">unconnected</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_ddlm_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the parent category of itemname&quot;&quot;&quot;</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">itemname</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  <span class="c1"># use the top block by default</span>
            <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has no parent&quot;</span> <span class="o">%</span> <span class="n">itemname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parent</span>

    <span class="k">def</span> <span class="nf">expand_category_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of all non-category items in a category or return the name</span>
<span class="sd">           if the name is not a category&quot;&quot;&quot;</span>
        <span class="n">new_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_list</span><span class="p">:</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Category&#39;</span><span class="p">:</span>
            <span class="n">new_list</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_category_opt</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> \
                     <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">new_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_list</span>

    <span class="k">def</span> <span class="nf">get_categories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of category names&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_definition.scope&quot;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Category&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">names_in_cat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cat</span><span class="p">,</span><span class="n">names_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="n">cat</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">names_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Item&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s2">&quot;_name.object_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">names</span><span class="p">])</span>



    <span class="k">def</span> <span class="nf">create_alias_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate an alias table that we can look up when searching for a dataname&quot;&quot;&quot;</span>
        <span class="n">all_aliases</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;_alias.definition_id&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_table</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([[</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_alias.definition_id&#39;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">all_aliases</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">create_cat_obj_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate a table indexed by (cat,obj) and returning the correct dataname&quot;&quot;&quot;</span>
        <span class="n">base_table</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([((</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()),[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)])</span> \
                           <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Item&#39;</span><span class="p">])</span>
        <span class="n">loopable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loopable_cats</span><span class="p">()</span>
        <span class="n">loopers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ddlm_immediate_children</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopable</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Loopable cats:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">loopable</span><span class="p">))</span>
        <span class="n">loop_children</span> <span class="o">=</span> <span class="p">[[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">loopable</span> <span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopers</span><span class="p">]</span>
        <span class="n">expand_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">loopable</span><span class="p">,</span><span class="n">loop_children</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Expansion list:&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">expand_list</span><span class="p">))</span>
        <span class="n">extra_table</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1">#for debugging we keep it separate from base_table until the end</span>
        <span class="k">def</span> <span class="nf">expand_base_table</span><span class="p">(</span><span class="n">parent_cat</span><span class="p">,</span><span class="n">child_cats</span><span class="p">):</span>
            <span class="n">extra_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># first deal with all the child categories</span>
            <span class="k">for</span> <span class="n">child_cat</span> <span class="ow">in</span> <span class="n">child_cats</span><span class="p">:</span>
              <span class="n">nn</span> <span class="o">=</span> <span class="p">[]</span>
              <span class="k">if</span> <span class="n">child_cat</span> <span class="ow">in</span> <span class="n">expand_list</span><span class="p">:</span>  <span class="c1"># a nested category: grab its names</span>
                <span class="n">nn</span> <span class="o">=</span> <span class="n">expand_base_table</span><span class="p">(</span><span class="n">child_cat</span><span class="p">,</span><span class="n">expand_list</span><span class="p">[</span><span class="n">child_cat</span><span class="p">])</span>
                <span class="c1"># store child names</span>
                <span class="n">extra_names</span> <span class="o">+=</span> <span class="n">nn</span>
              <span class="c1"># add all child names to the table</span>
              <span class="n">child_names</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="bp">self</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">])</span> \
                             <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names_in_cat</span><span class="p">(</span><span class="n">child_cat</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_type.purpose&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;Key&#39;</span><span class="p">]</span>
              <span class="n">child_names</span> <span class="o">+=</span> <span class="n">extra_names</span>
              <span class="n">extra_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">([((</span><span class="n">parent_cat</span><span class="p">,</span><span class="n">obj</span><span class="p">),[</span><span class="n">name</span><span class="p">])</span> <span class="k">for</span> <span class="n">obj</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="n">child_names</span> <span class="k">if</span> <span class="p">(</span><span class="n">parent_cat</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extra_table</span><span class="p">]))</span>
            <span class="c1"># and the repeated ones get appended instead</span>
            <span class="n">repeats</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">child_names</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">extra_table</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">obj</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="n">repeats</span><span class="p">:</span>
                <span class="n">extra_table</span><span class="p">[(</span><span class="n">parent_cat</span><span class="p">,</span><span class="n">obj</span><span class="p">)]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="c1"># and finally, add our own names to the return list</span>
            <span class="n">child_names</span> <span class="o">+=</span> <span class="p">[(</span><span class="bp">self</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="bp">self</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">])</span> \
                            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names_in_cat</span><span class="p">(</span><span class="n">parent_cat</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_type.purpose&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">!=</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">child_names</span>
        <span class="p">[</span><span class="n">expand_base_table</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">child</span><span class="p">)</span> <span class="k">for</span> <span class="n">parent</span><span class="p">,</span><span class="n">child</span> <span class="ow">in</span> <span class="n">expand_list</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Expansion cat/obj values: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">extra_table</span><span class="p">))</span>
        <span class="c1"># append repeated ones</span>
        <span class="n">non_repeats</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">extra_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_table</span><span class="p">])</span>
        <span class="n">repeats</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">extra_table</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">base_table</span><span class="p">]</span>
        <span class="n">base_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">non_repeats</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">repeats</span><span class="p">:</span>
            <span class="n">base_table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">extra_table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_obj_lookup_table</span> <span class="o">=</span> <span class="n">base_table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop_expand_list</span> <span class="o">=</span> <span class="n">expand_list</span>

    <span class="k">def</span> <span class="nf">get_loopable_cats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A short utility function which returns a list of looped categories. This</span>
<span class="sd">        is preferred to a fixed attribute as that fixed attribute would need to be</span>
<span class="sd">        updated after any edits&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Loop&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">create_cat_key_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a utility table with a list of keys applicable to each category. A key is</span>
<span class="sd">        a compound key, that is, it is a list&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_key_table</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">c</span><span class="p">,[</span><span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_category_key.name&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_category.key_id&quot;</span><span class="p">)]))])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loopable_cats</span><span class="p">()])</span>
        <span class="k">def</span> <span class="nf">collect_keys</span><span class="p">(</span><span class="n">parent_cat</span><span class="p">,</span><span class="n">child_cats</span><span class="p">):</span>
                <span class="n">kk</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">child_cat</span> <span class="ow">in</span> <span class="n">child_cats</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">child_cat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_expand_list</span><span class="p">:</span>
                        <span class="n">kk</span> <span class="o">+=</span> <span class="n">collect_keys</span><span class="p">(</span><span class="n">child_cat</span><span class="p">)</span>
                    <span class="c1"># add these keys to our list</span>
                    <span class="n">kk</span> <span class="o">+=</span> <span class="p">[</span><span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">child_cat</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_category_key.name&#39;</span><span class="p">,[</span><span class="bp">self</span><span class="p">[</span><span class="n">child_cat</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_category.key_id&#39;</span><span class="p">)]))]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">[</span><span class="n">parent_cat</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">[</span><span class="n">parent_cat</span><span class="p">]</span> <span class="o">+</span> <span class="n">kk</span>
                <span class="k">return</span> <span class="n">kk</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_expand_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">collect_keys</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Keys for categories&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">add_type_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;_item_type_list.construct&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="p">:</span>
            <span class="n">types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="p">[</span><span class="s2">&quot;_item_type_list.code&quot;</span><span class="p">]</span>
            <span class="n">prim_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="p">[</span><span class="s2">&quot;_item_type_list.primitive_code&quot;</span><span class="p">]</span>
            <span class="n">constructs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="p">[</span><span class="s2">&quot;_item_type_list.construct&quot;</span><span class="p">]])</span>
            <span class="c1"># add in \r wherever we see \n, and change \{ to \\{</span>
            <span class="k">def</span> <span class="nf">regex_fiddle</span><span class="p">(</span><span class="n">mm_regex</span><span class="p">):</span>
                <span class="n">brack_match</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;((.*\[.+)(</span><span class="se">\\</span><span class="s2">{)(.*\].*))&quot;</span>
                <span class="n">ret_match</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;((.*\[.+)(</span><span class="se">\\</span><span class="s2">n)(.*\].*))&quot;</span>
                <span class="n">fixed_regexp</span> <span class="o">=</span> <span class="n">mm_regex</span><span class="p">[:]</span>  <span class="c1">#copy</span>
                <span class="c1"># fix the brackets</span>
                <span class="n">bm</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">brack_match</span><span class="p">,</span><span class="n">mm_regex</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bm</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">fixed_regexp</span> <span class="o">=</span> <span class="n">bm</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\2</span><span class="se">\\\\</span><span class="s2">{\4&quot;</span><span class="p">)</span>
                <span class="c1"># fix missing \r</span>
                <span class="n">rm</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ret_match</span><span class="p">,</span><span class="n">fixed_regexp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rm</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">fixed_regexp</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\2\3</span><span class="se">\\</span><span class="s2">r\4&quot;</span><span class="p">)</span>
                <span class="c1">#print(&quot;Regexp %s becomes %s&quot; % (mm_regex,fixed_regexp))</span>
                <span class="k">return</span> <span class="n">fixed_regexp</span>
            <span class="n">constructs</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">regex_fiddle</span><span class="p">,</span><span class="n">constructs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">typecode</span><span class="p">,</span><span class="n">construct</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">types</span><span class="p">,</span><span class="n">constructs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">typedic</span><span class="p">[</span><span class="n">typecode</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">construct</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="o">|</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
            <span class="c1"># now make a primitive &lt;-&gt; type construct mapping</span>
            <span class="k">for</span> <span class="n">typecode</span><span class="p">,</span><span class="n">primtype</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">types</span><span class="p">,</span><span class="n">prim_types</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">primdic</span><span class="p">[</span><span class="n">typecode</span><span class="p">]</span> <span class="o">=</span> <span class="n">primtype</span>

    <span class="k">def</span> <span class="nf">add_category_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diclang</span> <span class="o">==</span> <span class="s2">&quot;DDLm&quot;</span><span class="p">:</span>
            <span class="n">catblocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Category&#39;</span><span class="p">]</span>
            <span class="n">looped_cats</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">catblocks</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;Set&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Loop&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent_lookup</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">one_cat</span> <span class="ow">in</span> <span class="n">looped_cats</span><span class="p">:</span>
                <span class="n">parent_cat</span> <span class="o">=</span> <span class="n">one_cat</span>
                <span class="n">parent_def</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_cat</span><span class="p">]</span>
                <span class="n">next_up</span> <span class="o">=</span> <span class="n">parent_def</span><span class="p">[</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">while</span> <span class="n">next_up</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span><span class="n">next_up</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;Set&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Loop&#39;</span><span class="p">:</span>
                    <span class="n">parent_def</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">next_up</span><span class="p">]</span>
                    <span class="n">parent_cat</span> <span class="o">=</span> <span class="n">next_up</span>
                    <span class="n">next_up</span> <span class="o">=</span> <span class="n">parent_def</span><span class="p">[</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent_lookup</span><span class="p">[</span><span class="n">one_cat</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_cat</span>

            <span class="k">if</span> <span class="n">full</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">key_equivs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">one_cat</span> <span class="ow">in</span> <span class="n">looped_cats</span><span class="p">:</span>   <span class="c1">#follow them up</span>
                    <span class="n">lower_keys</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">one_cat</span><span class="p">][</span><span class="s1">&#39;_category_key.name&#39;</span><span class="p">])</span>
                    <span class="n">start_keys</span> <span class="o">=</span> <span class="n">lower_keys</span><span class="p">[:]</span>
                    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">lower_keys</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">this_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">lower_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span>
                        <span class="n">parent</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">looped_cats</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">this_cat</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="n">a</span><span class="p">]</span>
                        <span class="c1">#print(Processing %s, keys %s, parent %s&quot; % (this_cat,repr(lower_keys),repr(parent)))</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s2">&quot;Category </span><span class="si">%s</span><span class="s2"> has more than one parent: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">one_cat</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">parent</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">break</span>
                        <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">parent_keys</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">parent</span><span class="p">][</span><span class="s1">&#39;_category_key.name&#39;</span><span class="p">])</span>
                        <span class="n">linked_keys</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="s2">&quot;_name.linked_item_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lower_keys</span><span class="p">]</span>
                        <span class="c1"># sanity check</span>
                        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">parent_keys</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">linked_keys</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s2">&quot;Parent keys and linked keys are different! </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent_keys</span><span class="p">,</span><span class="n">linked_keys</span><span class="p">))</span>
                            <span class="c1"># now add in our information</span>
                        <span class="k">for</span> <span class="n">parent</span><span class="p">,</span><span class="n">child</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">linked_keys</span><span class="p">,</span><span class="n">start_keys</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">key_equivs</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_equivs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">child</span><span class="p">,[])</span><span class="o">+</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
                        <span class="n">lower_keys</span> <span class="o">=</span> <span class="n">linked_keys</span>  <span class="c1">#preserves order of start keys</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent_lookup</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key_equivs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">change_category_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldname</span><span class="p">,</span><span class="n">newname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;Change the category name from [[oldname]] to [[newname]]&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">oldname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Cannot rename non-existent category </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">oldname</span><span class="p">,</span><span class="n">newname</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">newname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Cannot rename </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> as </span><span class="si">%s</span><span class="s1"> already exists&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">oldname</span><span class="p">,</span><span class="n">newname</span><span class="p">,</span><span class="n">oldname</span><span class="p">))</span>
        <span class="n">child_defs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_immediate_children</span><span class="p">(</span><span class="n">oldname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">oldname</span><span class="p">,</span><span class="n">newname</span><span class="p">)</span>   <span class="c1">#NB no name integrity checks</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">newname</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newname</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">newname</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newname</span>
        <span class="k">for</span> <span class="n">child_def</span> <span class="ow">in</span> <span class="n">child_defs</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">child_def</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newname</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">child_def</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Item&#39;</span><span class="p">:</span>
                <span class="n">newid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_catobj_name</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="n">child_def</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">child_def</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newid</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">child_def</span><span class="p">,</span><span class="n">newid</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>  <span class="c1">#no underscore at the beginning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_catobj_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cat</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Combine category and object in approved fashion to create id&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">cat</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">change_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">,</span><span class="n">catname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Move itemname into catname, return new handle&quot;&quot;&quot;</span>
        <span class="n">defid</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">itemname</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">defid</span><span class="p">[</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="n">catname</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Already in category, no change&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">itemname</span>
        <span class="k">if</span> <span class="n">catname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>    <span class="c1">#don&#39;t have it</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;No such category </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">catname</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">itemname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
        <span class="n">objid</span> <span class="o">=</span> <span class="n">defid</span><span class="p">[</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span>
        <span class="n">defid</span><span class="p">[</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catname</span>
        <span class="n">newid</span> <span class="o">=</span> <span class="n">itemname</span> <span class="c1"># stays the same for categories</span>
        <span class="k">if</span> <span class="n">defid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Item&#39;</span><span class="p">:</span>
            <span class="n">newid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_catobj_name</span><span class="p">(</span><span class="n">catname</span><span class="p">,</span><span class="n">objid</span><span class="p">)</span>
            <span class="n">defid</span><span class="p">[</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">newid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">itemname</span><span class="p">,</span><span class="n">newid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_parent</span><span class="p">(</span><span class="n">catname</span><span class="p">,</span><span class="n">newid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">newid</span>

    <span class="k">def</span> <span class="nf">change_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">one_def</span><span class="p">,</span><span class="n">newobj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change the object_id of one_def to newobj. This is not used for</span>
<span class="sd">        categories, but can be used for dictionaries&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;_dictionary.title&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">one_def</span><span class="p">]:</span>  <span class="c1">#a dictionary block</span>
            <span class="n">newid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_catobj_name</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">one_def</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">],</span><span class="n">newobj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">one_def</span><span class="p">,</span><span class="n">newid</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">newid</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newid</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">newid</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newobj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
            <span class="n">newid</span> <span class="o">=</span> <span class="n">newobj</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">one_def</span><span class="p">,</span><span class="n">newobj</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">newid</span><span class="p">][</span><span class="s1">&#39;_dictionary.title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">newid</span>

    <span class="c1"># Note that our semantic parent is given by catparent, but our syntactic parent is</span>
    <span class="c1"># always just the root block</span>
    <span class="k">def</span> <span class="nf">add_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">catname</span><span class="p">,</span><span class="n">catparent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">is_loop</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">allow_dangler</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a new category to the dictionary with name [[catname]].</span>
<span class="sd">           If [[catparent]] is None, the category will be a child of</span>
<span class="sd">           the topmost &#39;Head&#39; category or else the top data block. If</span>
<span class="sd">           [[is_loop]] is false, a Set category is created. If [[allow_dangler]]</span>
<span class="sd">           is true, the parent category does not have to exist.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">catname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s1">&#39;Attempt to add existing category </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">catname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
        <span class="n">syntactic_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">catparent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">semantic_root</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Head&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">semantic_root</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">semantic_root</span> <span class="o">=</span> <span class="n">semantic_root</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">semantic_root</span> <span class="o">=</span> <span class="n">syntactic_root</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">semantic_root</span> <span class="o">=</span> <span class="n">catparent</span>
        <span class="n">realname</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">NewBlock</span><span class="p">(</span><span class="n">catname</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="n">syntactic_root</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">catname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">=</span><span class="n">realname</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">catname</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catname</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_dangler</span> <span class="ow">or</span> <span class="n">catparent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">catname</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">semantic_root</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">catname</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catparent</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">catname</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catname</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">catname</span><span class="p">][</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Category&#39;</span>
        <span class="k">if</span> <span class="n">is_loop</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">catname</span><span class="p">][</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Loop&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">catname</span><span class="p">][</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Set&#39;</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">catname</span><span class="p">][</span><span class="s1">&#39;_description.text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;No definition provided&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">catname</span>

    <span class="k">def</span> <span class="nf">add_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">,</span><span class="n">catparent</span><span class="p">,</span><span class="n">def_text</span><span class="o">=</span><span class="s1">&#39;PLEASE DEFINE ME&#39;</span><span class="p">,</span><span class="n">allow_dangler</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add itemname to category [[catparent]]. If itemname contains periods,</span>
<span class="sd">        all text before the final period is ignored. If [[allow_dangler]] is True,</span>
<span class="sd">        no check for a parent category is made.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">itemname</span><span class="p">:</span>
            <span class="n">objname</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">objname</span> <span class="o">=</span> <span class="n">itemname</span>
        <span class="n">objname</span> <span class="o">=</span> <span class="n">objname</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_dangler</span> <span class="ow">and</span> <span class="p">(</span><span class="n">catparent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">[</span><span class="n">catparent</span><span class="p">][</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;Category&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s1">&#39;No category </span><span class="si">%s</span><span class="s1"> in dictionary&#39;</span> <span class="o">%</span> <span class="n">catparent</span><span class="p">)</span>
        <span class="n">fullname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">catparent</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">objname</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;New name: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fullname</span><span class="p">)</span>
        <span class="n">syntactic_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">realname</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">NewBlock</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="n">fix</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">syntactic_root</span><span class="p">)</span> <span class="c1">#low-level change</span>
        <span class="c1"># update our dictionary structures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span><span class="o">=</span><span class="n">realname</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">fullname</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">fullname</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">fullname</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">objname</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">fullname</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">catparent</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">fullname</span><span class="p">][</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Datum&#39;</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">fullname</span><span class="p">][</span><span class="s1">&#39;_description.text&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">def_text</span>

    <span class="k">def</span> <span class="nf">remove_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">defname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a definition from the dictionary.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">defname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">defname</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Category&#39;</span><span class="p">:</span>
            <span class="n">children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_immediate_children</span><span class="p">(</span><span class="n">defname</span><span class="p">)</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_definition</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">children</span><span class="p">]</span>
            <span class="n">cat_id</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">defname</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">defname</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_cat_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return (cat,obj) tuple. [[name]] must contain only a single period&quot;&quot;&quot;</span>
        <span class="n">cat</span><span class="p">,</span><span class="n">obj</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_name_by_cat_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">category</span><span class="p">,</span><span class="nb">object</span><span class="p">,</span><span class="n">give_default</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the dataname corresponding to the given category and object&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">category</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>    <span class="c1">#accidentally left in</span>
           <span class="n">true_cat</span> <span class="o">=</span> <span class="n">category</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">true_cat</span> <span class="o">=</span> <span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_obj_lookup_table</span><span class="p">[(</span><span class="n">true_cat</span><span class="p">,</span><span class="nb">object</span><span class="o">.</span><span class="n">lower</span><span class="p">())][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">give_default</span><span class="p">:</span>
               <span class="k">return</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">true_cat</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">object</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No such category,object in the dictionary: </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">true_cat</span><span class="p">,</span><span class="nb">object</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">WriteOut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">myblockorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_child_list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">=</span> <span class="s1">&#39;Dic&#39;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">WriteOut</span><span class="p">(</span><span class="n">blockorder</span> <span class="o">=</span> <span class="n">myblockorder</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_full_child_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of definition blocks in order parent-child-child-child-parent-child...&quot;&quot;&quot;</span>
        <span class="n">top_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">root_cat</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;Datum&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Head&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">root_cat</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">all_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">top_block</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurse_child_list</span><span class="p">(</span><span class="n">root_cat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">unrooted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_danglers</span><span class="p">()</span>
            <span class="n">double_names</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="n">unrooted</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_names</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">double_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s1">&#39;Names are children of internal and external categories:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">double_names</span><span class="p">))</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="n">unrooted</span><span class="p">[:]</span>
            <span class="k">for</span> <span class="n">no_root</span> <span class="ow">in</span> <span class="n">unrooted</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">no_root</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Category&#39;</span><span class="p">:</span>
                    <span class="n">all_names</span> <span class="o">+=</span> <span class="p">[</span><span class="n">no_root</span><span class="p">]</span>
                    <span class="n">remaining</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">no_root</span><span class="p">)</span>
                    <span class="n">these_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">unrooted</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="n">no_root</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                    <span class="n">all_names</span> <span class="o">+=</span> <span class="n">these_children</span>
                    <span class="p">[</span><span class="n">remaining</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">these_children</span><span class="p">]</span>
            <span class="c1"># now sort by category</span>
            <span class="n">ext_cats</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_from_name</span><span class="p">(</span><span class="n">r</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">remaining</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ext_cats</span><span class="p">:</span>
                <span class="n">cat_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">remaining</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_from_name</span><span class="p">(</span><span class="n">r</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">e</span><span class="p">]</span>
                <span class="p">[</span><span class="n">remaining</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cat_items</span><span class="p">]</span>
                <span class="n">all_names</span> <span class="o">+=</span> <span class="n">cat_items</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;WARNING: following items do not seem to belong to a category??&#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">remaining</span><span class="p">))</span>
                <span class="n">all_names</span> <span class="o">+=</span> <span class="n">remaining</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Final block order: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">all_names</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">all_names</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Dictionary contains no/multiple Head categories, please print as plain CIF instead&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cat_from_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">one_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Guess the category from the name. This should be used only when this is not important semantic information,</span>
<span class="sd">        for example, when printing out&quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">cat</span><span class="p">,</span><span class="n">obj</span><span class="p">)</span> <span class="o">=</span> <span class="n">one_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span><span class="p">:</span> <span class="n">cat</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">cat</span>

    <span class="k">def</span> <span class="nf">recurse_child_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parentname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recursively expand the logical child list of [[parentname]]&quot;&quot;&quot;</span>
        <span class="n">final_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">parentname</span><span class="p">]</span>
        <span class="n">child_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">parentname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="n">child_blocks</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>    <span class="c1">#we love alphabetical order</span>
        <span class="n">child_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">child_blocks</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Item&#39;</span><span class="p">]</span>
        <span class="n">final_list</span> <span class="o">+=</span> <span class="n">child_items</span>
        <span class="n">child_cats</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">child_blocks</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Category&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">child_cat</span> <span class="ow">in</span> <span class="n">child_cats</span><span class="p">:</span>
            <span class="n">final_list</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurse_child_list</span><span class="p">(</span><span class="n">child_cat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_list</span>



    <span class="k">def</span> <span class="nf">get_key_pack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">category</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="n">keyname</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_spec</span><span class="p">]</span>
        <span class="n">onepack</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">GetPackKey</span><span class="p">(</span><span class="n">keyname</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">onepack</span>

    <span class="k">def</span> <span class="nf">get_number_with_esd</span><span class="p">(</span><span class="n">numstring</span><span class="p">):</span>
        <span class="n">numb_re</span> <span class="o">=</span> <span class="s1">&#39;((-?(([0-9]*[.]([0-9]+))|([0-9]+)[.]?))([(][0-9]+[)])?([eEdD][+-]?[0-9]+)?)|(\?)|(\.)&#39;</span>
        <span class="n">our_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">numb_re</span><span class="p">,</span><span class="n">numstring</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">our_match</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span><span class="n">base_num</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">dad</span><span class="p">,</span><span class="n">dbd</span><span class="p">,</span><span class="n">esd</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">dot</span> <span class="o">=</span> <span class="n">our_match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="c1"># print(&quot;Debug: {} -&gt; {!r}&quot;.format(numstring, our_match.groups()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>
        <span class="k">if</span> <span class="n">dot</span> <span class="ow">or</span> <span class="n">q</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>     <span class="c1">#a dot or question mark</span>
        <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>          <span class="c1">#has exponent</span>
           <span class="n">exp</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span><span class="s2">&quot;e&quot;</span><span class="p">)</span>     <span class="c1"># mop up old fashioned numbers</span>
           <span class="n">exp</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">,</span><span class="s2">&quot;e&quot;</span><span class="p">)</span>
           <span class="n">base_num</span> <span class="o">=</span> <span class="n">base_num</span> <span class="o">+</span> <span class="n">exp</span>
        <span class="c1"># print(&quot;Debug: have %s for base_num from %s&quot; % (base_num,numstring))</span>
        <span class="n">base_num</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">base_num</span><span class="p">)</span>
        <span class="c1"># work out esd, if present.</span>
        <span class="k">if</span> <span class="n">esd</span><span class="p">:</span>
            <span class="n">esd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">esd</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>    <span class="c1"># no brackets</span>
            <span class="k">if</span> <span class="n">dad</span><span class="p">:</span>                   <span class="c1"># decimal point + digits</span>
                <span class="n">esd</span> <span class="o">=</span> <span class="n">esd</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dad</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>
                <span class="n">esd</span> <span class="o">=</span> <span class="n">esd</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))</span>
        <span class="k">return</span> <span class="n">base_num</span><span class="p">,</span><span class="n">esd</span>

    <span class="k">def</span> <span class="nf">getmaxmin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rangeexp</span><span class="p">):</span>
        <span class="n">regexp</span> <span class="o">=</span> <span class="s1">&#39;(-?(([0-9]*[.]([0-9]+))|([0-9]+)[.]?)([eEdD][+-]?[0-9]+)?)*&#39;</span>
        <span class="n">regexp</span> <span class="o">=</span> <span class="n">regexp</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">regexp</span>
        <span class="n">regexp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regexp</span><span class="p">,</span><span class="n">rangeexp</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">minimum</span> <span class="o">=</span> <span class="n">regexp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">maximum</span> <span class="o">=</span> <span class="n">regexp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Can&#39;t match </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rangeexp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">minimum</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">minimum</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">minimum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">minimum</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maximum</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">maximum</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">maximum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">maximum</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">maximum</span><span class="p">,</span><span class="n">minimum</span>

    <span class="k">def</span> <span class="nf">initialise_drel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse drel functions and prepare data structures in dictionary&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_parse_valid</span><span class="p">()</span> <span class="c1">#extract validity information from data block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform_drel</span><span class="p">()</span>   <span class="c1">#parse the drel functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_drel_funcs</span><span class="p">()</span>   <span class="c1">#put the drel functions into the namespace</span>

    <span class="k">def</span> <span class="nf">transform_drel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.drel</span> <span class="kn">import</span> <span class="n">drel_ast_yacc</span>
        <span class="kn">from</span> <span class="nn">.drel</span> <span class="kn">import</span> <span class="n">py_from_ast</span>
        <span class="kn">import</span> <span class="nn">traceback</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">drel_ast_yacc</span><span class="o">.</span><span class="n">parser</span>
        <span class="n">lexer</span> <span class="o">=</span> <span class="n">drel_ast_yacc</span><span class="o">.</span><span class="n">lexer</span>
        <span class="n">my_namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">my_namespace</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">my_namespace</span><span class="p">,</span><span class="n">my_namespace</span><span class="p">))</span>
        <span class="c1"># we provide a table of loopable categories {cat_name:((key1,key2..),[item_name,...]),...})</span>
        <span class="n">loopable_cats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loopable_cats</span><span class="p">()</span>
        <span class="n">loop_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s2">&quot;_category_key.name&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopable_cats</span><span class="p">]</span>
        <span class="n">loop_keys</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">loop_keys</span><span class="p">]</span>
        <span class="n">cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">names_in_cat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">names_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopable_cats</span><span class="p">]</span>
        <span class="n">loop_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">loopable_cats</span><span class="p">,</span><span class="nb">zip</span><span class="p">(</span><span class="n">loop_keys</span><span class="p">,</span><span class="n">cat_names</span><span class="p">)))</span>
        <span class="c1"># parser.listable_items = [a for a in self.keys() if &quot;*&quot; in self[a].get(&quot;_type.dimension&quot;,&quot;&quot;)]</span>
        <span class="n">derivable_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;_method.expression&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> \
                              <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_name.category_id&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">!=</span> <span class="s2">&quot;function&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">derivable</span> <span class="ow">in</span> <span class="n">derivable_list</span><span class="p">:</span>
            <span class="n">target_id</span> <span class="o">=</span> <span class="n">derivable</span>
            <span class="c1"># reset the list of visible names for parser</span>
            <span class="n">special_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()))]</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Target id: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">derivable</span><span class="p">)</span>
            <span class="n">drel_exprs</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">derivable</span><span class="p">][</span><span class="s2">&quot;_method.expression&quot;</span><span class="p">]</span>
            <span class="n">drel_purposes</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">derivable</span><span class="p">][</span><span class="s2">&quot;_method.purpose&quot;</span><span class="p">]</span>
            <span class="n">all_methods</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">drel_exprs</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">drel_exprs</span> <span class="o">=</span> <span class="p">[</span><span class="n">drel_exprs</span><span class="p">]</span>
                <span class="n">drel_purposes</span> <span class="o">=</span> <span class="p">[</span><span class="n">drel_purposes</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">drel_purpose</span><span class="p">,</span><span class="n">drel_expr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">drel_purposes</span><span class="p">,</span><span class="n">drel_exprs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">drel_purpose</span> <span class="o">!=</span> <span class="s1">&#39;Evaluation&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">drel_expr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">drel_expr</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
                <span class="c1"># print(&quot;Transforming %s&quot; % drel_expr)</span>
                <span class="c1"># List categories are treated differently...</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">meth_ast</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">drel_expr</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">lexer</span><span class="o">=</span><span class="n">lexer</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Syntax error in method for </span><span class="si">%s</span><span class="s1">; leaving as is&#39;</span> <span class="o">%</span> <span class="n">derivable</span><span class="p">)</span>
                    <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">print</span><span class="p">((</span><span class="nb">repr</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">print_tb</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="bp">None</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">))</span>
                    <span class="c1"># reset the lexer</span>
                    <span class="n">lexer</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="s1">&#39;INITIAL&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># Construct the python method</span>
                <span class="n">cat_meth</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">derivable</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Category&#39;</span><span class="p">:</span>
                    <span class="n">cat_meth</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">pyth_meth</span> <span class="o">=</span> <span class="n">py_from_ast</span><span class="o">.</span><span class="n">make_python_function</span><span class="p">(</span><span class="n">meth_ast</span><span class="p">,</span><span class="s2">&quot;pyfunc&quot;</span><span class="p">,</span><span class="n">target_id</span><span class="p">,</span>
                                                                           <span class="n">loopable</span><span class="o">=</span><span class="n">loop_info</span><span class="p">,</span>
                                                             <span class="n">cif_dic</span> <span class="o">=</span> <span class="bp">self</span><span class="p">,</span><span class="n">cat_meth</span><span class="o">=</span><span class="n">cat_meth</span><span class="p">)</span>
                <span class="n">all_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyth_meth</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_methods</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">save_overwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">derivable</span><span class="p">]</span><span class="o">.</span><span class="n">overwrite</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">derivable</span><span class="p">]</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">derivable</span><span class="p">][</span><span class="s2">&quot;_method.py_expression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_methods</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">derivable</span><span class="p">]</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="n">save_overwrite</span>
            <span class="c1">#print(&quot;Final result:\n &quot; + repr(self[derivable][&quot;_method.py_expression&quot;]))</span>

    <span class="k">def</span> <span class="nf">add_drel_funcs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.drel</span> <span class="kn">import</span> <span class="n">drel_ast_yacc</span>
        <span class="kn">from</span> <span class="nn">.drel</span> <span class="kn">import</span> <span class="n">py_from_ast</span>
        <span class="n">funclist</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_name.category_id&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;function&#39;</span><span class="p">]</span>
        <span class="n">funcnames</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s2">&quot;_name.object_id&quot;</span><span class="p">],</span>
                      <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">GetKeyedPacket</span><span class="p">(</span><span class="s2">&quot;_method.purpose&quot;</span><span class="p">,</span><span class="s2">&quot;Evaluation&quot;</span><span class="p">),</span><span class="s2">&quot;_method.expression&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">funclist</span><span class="p">]</span>
        <span class="c1"># create executable python code...</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">drel_ast_yacc</span><span class="o">.</span><span class="n">parser</span>
        <span class="c1"># we provide a table of loopable categories {cat_name:(key,[item_name,...]),...})</span>
        <span class="n">loopable_cats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loopable_cats</span><span class="p">()</span>
        <span class="n">loop_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s2">&quot;_category_key.name&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopable_cats</span><span class="p">]</span>
        <span class="n">loop_keys</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">loop_keys</span><span class="p">]</span>
        <span class="n">cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">names_in_cat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">names_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopable_cats</span><span class="p">]</span>
        <span class="n">loop_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">loopable_cats</span><span class="p">,</span><span class="nb">zip</span><span class="p">(</span><span class="n">loop_keys</span><span class="p">,</span><span class="n">cat_names</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">funcname</span><span class="p">,</span><span class="n">funcbody</span> <span class="ow">in</span> <span class="n">funcnames</span><span class="p">:</span>
            <span class="n">newline_body</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">funcbody</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">target_id</span> <span class="o">=</span> <span class="n">funcname</span>
            <span class="n">res_ast</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">newline_body</span><span class="p">)</span>
            <span class="n">py_function</span> <span class="o">=</span> <span class="n">py_from_ast</span><span class="o">.</span><span class="n">make_python_function</span><span class="p">(</span><span class="n">res_ast</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="n">targetname</span><span class="o">=</span><span class="n">funcname</span><span class="p">,</span><span class="n">func_def</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">loopable</span><span class="o">=</span><span class="n">loop_info</span><span class="p">,</span><span class="n">cif_dic</span> <span class="o">=</span> <span class="bp">self</span><span class="p">)</span>
            <span class="c1">#print(&#39;dREL library function -&gt;\n&#39; + py_function)</span>
            <span class="n">global_table</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span>
            <span class="k">exec</span><span class="p">(</span><span class="n">py_function</span><span class="p">,</span> <span class="n">global_table</span><span class="p">)</span>    <span class="c1">#add to namespace</span>
        <span class="c1">#print(&#39;Globals after dREL functions added:&#39; + repr(globals()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_functions</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span>  <span class="c1">#for outside access</span>

    <span class="nd">@track_recursion</span>
    <span class="k">def</span> <span class="nf">derive_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">start_key</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">store_value</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span><span class="n">allow_defaults</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">start_key</span>   <span class="c1">#starting value</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>     <span class="c1">#success is a non-None value</span>
        <span class="n">default_result</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1">#we have not used a default value</span>
        <span class="c1"># check for aliases</span>
        <span class="c1"># check for an older form of a new value</span>
        <span class="n">found_it</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,[])</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cifdata</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_it</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">corrected_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">cifdata</span><span class="p">[</span><span class="n">found_it</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">return</span> <span class="n">corrected_type</span>
        <span class="c1"># now do the reverse check - any alternative form</span>
        <span class="n">alias_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Aliases for </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">alias_name</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alias_name</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">alias_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>   <span class="c1">#actual definition name</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cifdata</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">cifdata</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">found_it</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">alias_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cifdata</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_it</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">cifdata</span><span class="p">[</span><span class="n">found_it</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">alias_name</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s1">&#39;Dictionary error: dataname alias appears in different definitions: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">alias_name</span><span class="p">))</span>

        <span class="n">the_category</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;_name.category_id&quot;</span><span class="p">]</span>
        <span class="n">cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_name.category_id&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span><span class="o">==</span><span class="n">the_category</span><span class="p">]</span>
        <span class="n">has_cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cat_names</span> <span class="k">if</span> <span class="n">cifdata</span><span class="o">.</span><span class="n">has_key_or_alias</span><span class="p">(</span><span class="n">a</span><span class="p">)]</span>
        <span class="c1"># store any default value in case we have a problem</span>
        <span class="n">def_val</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_enumeration.default&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">def_index_val</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_enumeration.def_index_id&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">has_cat_names</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># try category method</span>
            <span class="n">cat_result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">pulled_from_cats</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;_category_construct_local.components&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
            <span class="n">pulled_from_cats</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,[</span>
                                  <span class="bp">self</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;_category_construct_local.components&#39;</span><span class="p">]]</span>
                               <span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pulled_from_cats</span><span class="p">]</span>
            <span class="n">pulled_to_cats</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pulled_from_cats</span> <span class="k">if</span> <span class="n">the_category</span> <span class="ow">in</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">if</span> <span class="s1">&#39;_category_construct_local.type&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">the_category</span><span class="p">]:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;**Now constructing category </span><span class="si">%s</span><span class="s2"> using DDLm attributes**&quot;</span> <span class="o">%</span> <span class="n">the_category</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cat_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_category</span><span class="p">(</span><span class="n">the_category</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">CifRecursionError</span><span class="p">,</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarDerivationError</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;** Failed to construct category </span><span class="si">%s</span><span class="s1"> (error)&#39;</span> <span class="o">%</span> <span class="n">the_category</span><span class="p">)</span>
            <span class="c1"># Trying a pull-back when the category is partially populated</span>
            <span class="c1"># will not work, hence we test that cat_result has no keys</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pulled_to_cats</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat_result</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;**Now populating category </span><span class="si">%s</span><span class="s2"> from pulled-back category </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">the_category</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">pulled_to_cats</span><span class="p">)))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cat_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">push_from_pullback</span><span class="p">(</span><span class="n">the_category</span><span class="p">,</span><span class="n">pulled_to_cats</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">CifRecursionError</span><span class="p">,</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarDerivationError</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;** Failed to construct category </span><span class="si">%s</span><span class="s1"> from pullback information (error)&#39;</span> <span class="o">%</span> <span class="n">the_category</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;_method.py_expression&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">the_category</span><span class="p">]</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cat_result</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;**Now applying category method for </span><span class="si">%s</span><span class="s2"> in search of </span><span class="si">%s</span><span class="s2">**&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">the_category</span><span class="p">,</span><span class="n">key</span><span class="p">))</span>
                <span class="n">cat_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derive_item</span><span class="p">(</span><span class="n">the_category</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;**Tried pullbacks, obtained for </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">the_category</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">cat_result</span><span class="p">))</span>
            <span class="c1"># do we now have our value?</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cat_result</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cat_result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># Recalculate in case it actually worked</span>
        <span class="n">has_cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cat_names</span> <span class="k">if</span> <span class="n">cifdata</span><span class="o">.</span><span class="n">has_key_or_alias</span><span class="p">(</span><span class="n">a</span><span class="p">)]</span>
        <span class="n">the_funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_method.py_expression&#39;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">the_funcs</span><span class="p">:</span>   <span class="c1">#attempt to calculate it</span>
            <span class="c1">#global_table = globals()</span>
            <span class="c1">#global_table.update(self.ddlm_functions)</span>
            <span class="k">for</span> <span class="n">one_func</span> <span class="ow">in</span> <span class="n">the_funcs</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Executing function for </span><span class="si">%s</span><span class="s1">:&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
                <span class="c1">#print(one_func)</span>
                <span class="k">exec</span><span class="p">(</span><span class="n">one_func</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>  <span class="c1">#will access dREL functions, puts &quot;pyfunc&quot; in scope</span>
                <span class="c1"># print(&#39;in following global environment: &#39; + repr(global_table))</span>
                <span class="n">stored_setting</span> <span class="o">=</span> <span class="n">cifdata</span><span class="o">.</span><span class="n">provide_value</span>
                <span class="n">cifdata</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">pyfunc</span><span class="p">(</span><span class="n">cifdata</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">CifRecursionError</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">except</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">StarDerivationError</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">cifdata</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="n">stored_setting</span>
                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="c1">#print(&quot;Function returned {!r}&quot;.format(result))</span>

        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">allow_defaults</span><span class="p">:</span>   <span class="c1"># try defaults</span>
            <span class="k">if</span> <span class="n">def_val</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">def_val</span><span class="p">)</span>
                <span class="n">default_result</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">def_index_val</span><span class="p">:</span>            <span class="c1">#derive a default value</span>
                <span class="n">index_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;_enumeration_default.index&quot;</span><span class="p">]</span>
                <span class="n">val_to_index</span> <span class="o">=</span> <span class="n">cifdata</span><span class="p">[</span><span class="n">def_index_val</span><span class="p">]</span>     <span class="c1">#what we are keying on</span>
                <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">def_index_val</span><span class="p">][</span><span class="s1">&#39;_type.contents&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Code&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span><span class="s1">&#39;Tag&#39;</span><span class="p">]:</span>
                    <span class="n">lcase_comp</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">index_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">index_vals</span><span class="p">]</span>
                <span class="c1"># Handle loops</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val_to_index</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">lcase_comp</span><span class="p">:</span>
                        <span class="n">val_to_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">val_to_index</span><span class="p">]</span>
                    <span class="n">keypos</span> <span class="o">=</span> <span class="p">[</span><span class="n">index_vals</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">val_to_index</span><span class="p">]</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;_enumeration_default.value&quot;</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">keypos</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">lcase_comp</span><span class="p">:</span>
                        <span class="n">val_to_index</span> <span class="o">=</span> <span class="n">val_to_index</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">keypos</span> <span class="o">=</span> <span class="n">index_vals</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">val_to_index</span><span class="p">)</span>   <span class="c1">#value error if no such value available</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;_enumeration_default.value&quot;</span><span class="p">][</span><span class="n">keypos</span><span class="p">]</span>
                    <span class="n">default_result</span> <span class="o">=</span> <span class="bp">True</span>   <span class="c1">#flag that it must be extended</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Indexed on </span><span class="si">%s</span><span class="s2"> to get </span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">def_index_val</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">val_to_index</span><span class="p">)))</span>

        <span class="c1"># read it in</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>   <span class="c1">#can&#39;t do anything else</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Warning: no way of deriving item </span><span class="si">%s</span><span class="s1">, allow_defaults is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">allow_defaults</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">StarDerivationError</span><span class="p">(</span><span class="n">start_key</span><span class="p">)</span>
        <span class="n">is_looped</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">the_category</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;Set&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Loop&#39;</span><span class="p">:</span>
            <span class="n">is_looped</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">has_cat_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>   <span class="c1">#this category already exists</span>
                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">default_result</span><span class="p">:</span> <span class="c1">#need to create a list of values</span>
                    <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cifdata</span><span class="p">[</span><span class="n">has_cat_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="n">out_result</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">]</span><span class="o">*</span><span class="n">loop_len</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">out_result</span>
            <span class="k">else</span><span class="p">:</span>   <span class="c1">#nothing exists in this category, we can&#39;t store this at all</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Resetting result </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> to null list as category is empty&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">result</span><span class="p">))</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># now try to insert the new information into the right place</span>
        <span class="c1"># find if items of this category already appear...</span>
        <span class="c1"># Never cache empty values</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span>\
          <span class="n">store_value</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_definition.scope&quot;</span><span class="p">,</span><span class="s2">&quot;Item&quot;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Item&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_looped</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_new_looped_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">default_result</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_new_unlooped_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store_new_cat_values</span><span class="p">(</span><span class="n">cifdata</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">the_category</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">store_new_looped_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">default_result</span><span class="p">):</span>
          <span class="sd">&quot;&quot;&quot;Store a looped value from the dREL system into a CifFile&quot;&quot;&quot;</span>
          <span class="c1"># try to change any matrices etc. to lists</span>
          <span class="n">the_category</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;_name.category_id&quot;</span><span class="p">]</span>
          <span class="n">out_result</span> <span class="o">=</span> <span class="n">result</span>
          <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">default_result</span><span class="p">:</span>
                  <span class="c1"># find any numpy arrays</span>
                  <span class="k">def</span> <span class="nf">conv_from_numpy</span><span class="p">(</span><span class="n">one_elem</span><span class="p">):</span>
                      <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">one_elem</span><span class="p">,</span><span class="s1">&#39;dtype&#39;</span><span class="p">):</span>
                         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">one_elem</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span>
                            <span class="k">return</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">StarList</span><span class="p">([</span><span class="n">conv_from_numpy</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">one_elem</span><span class="p">])</span>
                         <span class="k">return</span> <span class="n">one_elem</span>
                      <span class="k">if</span> <span class="n">one_elem</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>   <span class="c1">#so is not a float</span>
                         <span class="k">return</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">StarList</span><span class="p">([</span><span class="n">conv_from_numpy</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">one_elem</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span>
                      <span class="k">else</span><span class="p">:</span>
                          <span class="k">try</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">one_elem</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                          <span class="k">except</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">one_elem</span>
                  <span class="n">out_result</span> <span class="o">=</span> <span class="p">[</span><span class="n">conv_from_numpy</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
          <span class="c1"># so out_result now contains a value suitable for storage</span>
          <span class="n">cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_name.category_id&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span><span class="o">==</span><span class="n">the_category</span><span class="p">]</span>
          <span class="n">has_cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cat_names</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cifdata</span><span class="p">]</span>
          <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Adding {}, found pre-existing names: &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">has_cat_names</span><span class="p">))</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">has_cat_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>   <span class="c1">#this category already exists</span>
              <span class="n">cifdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_result</span>      <span class="c1">#lengths must match or else!!</span>
              <span class="n">cifdata</span><span class="o">.</span><span class="n">AddLoopName</span><span class="p">(</span><span class="n">has_cat_names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">key</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
              <span class="n">cifdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_result</span>
              <span class="n">cifdata</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">([</span><span class="n">key</span><span class="p">])</span>
          <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Loop info:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">cifdata</span><span class="o">.</span><span class="n">loops</span><span class="p">))</span>
          <span class="k">return</span> <span class="n">out_result</span>

    <span class="k">def</span> <span class="nf">store_new_unlooped_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">result</span><span class="p">):</span>
          <span class="sd">&quot;&quot;&quot;Store a single value from the dREL system&quot;&quot;&quot;</span>
          <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="s1">&#39;dtype&#39;</span><span class="p">):</span>
              <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                  <span class="n">out_result</span> <span class="o">=</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">StarList</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                  <span class="n">cifdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_result</span>
              <span class="k">else</span><span class="p">:</span>
                  <span class="n">cifdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
              <span class="n">cifdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
          <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">construct_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">category</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a category using DDLm attributes&quot;&quot;&quot;</span>
        <span class="n">con_type</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_category_construct_local.type&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">con_type</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">con_type</span> <span class="o">==</span> <span class="s1">&#39;Pullback&#39;</span> <span class="ow">or</span> <span class="n">con_type</span> <span class="o">==</span> <span class="s1">&#39;Filter&#39;</span><span class="p">:</span>
            <span class="n">morphisms</span>  <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="s1">&#39;_category_construct_local.components&#39;</span><span class="p">]</span>
            <span class="n">morph_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">cifdata</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">morphisms</span><span class="p">]</span> <span class="c1"># the mapped values for each cat</span>
            <span class="n">cats</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">morphisms</span><span class="p">]</span>
            <span class="n">cat_keys</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_category.key_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cats</span><span class="p">]</span>
            <span class="n">cat_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cifdata</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cat_keys</span><span class="p">]</span> <span class="c1">#the category key values for each cat</span>
            <span class="k">if</span> <span class="n">con_type</span> <span class="o">==</span> <span class="s1">&#39;Filter&#39;</span><span class="p">:</span>
                <span class="n">int_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_category_construct_local.integer_filter&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
                <span class="n">text_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_category_construct_local.text_filter&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">int_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">morph_values</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">int_filter</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">text_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">morph_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text_filter</span><span class="p">)</span>
                <span class="n">cat_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">morph_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
            <span class="c1"># create the mathematical product filtered by equality of dataname values</span>
            <span class="n">pullback_ids</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cat_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">cat_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> \
                            <span class="k">if</span> <span class="n">morph_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cat_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span><span class="o">==</span><span class="n">morph_values</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">cat_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">y</span><span class="p">)]]</span>
            <span class="c1"># now prepare for return</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pullback_ids</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{}</span>
            <span class="n">newids</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="s1">&#39;_category_construct_local.new_ids&#39;</span><span class="p">]</span>
            <span class="n">fullnewids</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_obj_lookup_table</span><span class="p">[(</span><span class="n">category</span><span class="p">,</span><span class="n">n</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">newids</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">con_type</span> <span class="o">==</span> <span class="s1">&#39;Pullback&#39;</span><span class="p">:</span>
                <span class="n">final_results</span> <span class="o">=</span> <span class="p">{</span><span class="n">fullnewids</span><span class="p">[</span><span class="mi">0</span><span class="p">]:[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pullback_ids</span><span class="p">],</span><span class="n">fullnewids</span><span class="p">[</span><span class="mi">1</span><span class="p">]:[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pullback_ids</span><span class="p">]}</span>
                <span class="n">final_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicate_datanames</span><span class="p">(</span><span class="n">cifdata</span><span class="p">,</span><span class="n">cats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">category</span><span class="p">,</span><span class="n">key_vals</span> <span class="o">=</span> <span class="n">final_results</span><span class="p">[</span><span class="n">fullnewids</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">skip_names</span><span class="o">=</span><span class="n">newids</span><span class="p">))</span>
                <span class="n">final_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicate_datanames</span><span class="p">(</span><span class="n">cifdata</span><span class="p">,</span><span class="n">cats</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">category</span><span class="p">,</span><span class="n">key_vals</span> <span class="o">=</span> <span class="n">final_results</span><span class="p">[</span><span class="n">fullnewids</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">skip_names</span><span class="o">=</span><span class="n">newids</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">con_type</span> <span class="o">==</span> <span class="s1">&#39;Filter&#39;</span><span class="p">:</span>   <span class="c1">#simple filter</span>
                <span class="n">final_results</span> <span class="o">=</span> <span class="p">{</span><span class="n">fullnewids</span><span class="p">[</span><span class="mi">0</span><span class="p">]:[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pullback_ids</span><span class="p">]}</span>
                <span class="n">final_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicate_datanames</span><span class="p">(</span><span class="n">cifdata</span><span class="p">,</span><span class="n">cats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">category</span><span class="p">,</span><span class="n">key_vals</span> <span class="o">=</span> <span class="n">final_results</span><span class="p">[</span><span class="n">fullnewids</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">skip_names</span><span class="o">=</span><span class="n">newids</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">store_value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store_new_cat_values</span><span class="p">(</span><span class="n">cifdata</span><span class="p">,</span><span class="n">final_results</span><span class="p">,</span><span class="n">category</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">final_results</span>

    <span class="k">def</span> <span class="nf">push_from_pullback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">target_category</span><span class="p">,</span><span class="n">source_categories</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Each of the categories in source_categories are pullbacks that include</span>
<span class="sd">        the target_category&quot;&quot;&quot;</span>
        <span class="n">target_key</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">target_category</span><span class="p">][</span><span class="s1">&#39;_category.key_id&#39;</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">target_key</span><span class="p">:[]}</span>
        <span class="n">first_time</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># for each source category, determine which element goes to the target</span>
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">source_categories</span><span class="p">:</span>
            <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">sc</span><span class="p">][</span><span class="s1">&#39;_category_construct_local.components&#39;</span><span class="p">]</span>
            <span class="n">comp_cats</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">components</span><span class="p">]</span>
            <span class="n">new_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">sc</span><span class="p">][</span><span class="s1">&#39;_category_construct_local.new_ids&#39;</span><span class="p">]</span>
            <span class="n">source_ids</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_obj_lookup_table</span><span class="p">[(</span><span class="n">sc</span><span class="p">,</span><span class="n">n</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">new_ids</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># not a filter</span>
                <span class="n">element_pos</span> <span class="o">=</span> <span class="n">comp_cats</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target_category</span><span class="p">)</span>
                <span class="n">old_id</span> <span class="o">=</span> <span class="n">source_ids</span><span class="p">[</span><span class="n">element_pos</span><span class="p">]</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Using </span><span class="si">%s</span><span class="s1"> to populate </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">old_id</span><span class="p">,</span><span class="n">target_key</span><span class="p">))</span>
                <span class="n">result</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cifdata</span><span class="p">[</span><span class="n">old_id</span><span class="p">])</span>
                <span class="c1"># project through all identical names</span>
                <span class="n">extra_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_datanames</span><span class="p">(</span><span class="n">cifdata</span><span class="p">,</span><span class="n">sc</span><span class="p">,</span><span class="n">target_category</span><span class="p">,</span><span class="n">skip_names</span><span class="o">=</span><span class="n">new_ids</span><span class="o">+</span><span class="p">[</span><span class="n">target_key</span><span class="p">])</span>
                <span class="c1"># we only include keys that are common to all categories</span>
                <span class="k">if</span> <span class="n">first_time</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_result</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">extra_result</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Updating </span><span class="si">%s</span><span class="s1">: was </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">])))</span>
                            <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_result</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extra_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_datanames</span><span class="p">(</span><span class="n">cifdata</span><span class="p">,</span><span class="n">sc</span><span class="p">,</span><span class="n">target_category</span><span class="p">,</span><span class="n">skip_names</span><span class="o">=</span><span class="n">new_ids</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra_result</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">source_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cifdata</span><span class="p">:</span>  <span class="c1">#something is present</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cifdata</span><span class="p">[</span><span class="n">source_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">extra_result</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Reverse filter: Updating </span><span class="si">%s</span><span class="s1">: was </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">])))</span>
                            <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_result</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">extra_result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="c1"># Bonus derivation if there is a singleton filter</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">sc</span><span class="p">][</span><span class="s1">&#39;_category_construct_local.type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Filter&#39;</span><span class="p">:</span>
                        <span class="n">int_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">sc</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_category_construct_local.integer_filter&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
                        <span class="n">text_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">sc</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_category_construct_local.text_filter&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">int_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">filter_values</span> <span class="o">=</span> <span class="n">int_filter</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">filter_values</span> <span class="o">=</span> <span class="n">text_filter</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filter_values</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>    <span class="c1">#a singleton</span>
                            <span class="n">extra_dataname</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">sc</span><span class="p">][</span><span class="s1">&#39;_category_construct_local.components&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">int_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">new_value</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">filter_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cifdata</span><span class="p">[</span><span class="n">source_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">new_value</span> <span class="o">=</span> <span class="n">filter_values</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cifdata</span><span class="p">[</span><span class="n">source_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                            <span class="k">if</span> <span class="n">extra_dataname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                                <span class="n">result</span><span class="p">[</span><span class="n">extra_dataname</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">result</span><span class="p">[</span><span class="n">extra_dataname</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unexpected category construct type&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="n">sc</span><span class="p">][</span><span class="s1">&#39;_category_construct_local.type&#39;</span><span class="p">])</span>
            <span class="n">first_time</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># check for sanity - all dataname lengths must be identical</span>
        <span class="n">datalen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>
        <span class="k">if</span> <span class="n">datalen</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;Failed to construct equal-length category items,&#39;</span><span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">store_value</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Now storing &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store_new_cat_values</span><span class="p">(</span><span class="n">cifdata</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">target_category</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">duplicate_datanames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">from_category</span><span class="p">,</span><span class="n">to_category</span><span class="p">,</span><span class="n">key_vals</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">skip_names</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Copy across datanames for which the from_category key equals [[key_vals]]&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">s_names_in_cat</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names_in_cat</span><span class="p">(</span><span class="n">from_category</span><span class="p">,</span><span class="n">names_only</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">t_names_in_cat</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names_in_cat</span><span class="p">(</span><span class="n">to_category</span><span class="p">,</span><span class="n">names_only</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">can_project</span> <span class="o">=</span> <span class="n">s_names_in_cat</span> <span class="o">&amp;</span> <span class="n">t_names_in_cat</span>
        <span class="n">can_project</span> <span class="o">-=</span> <span class="nb">set</span><span class="p">(</span><span class="n">skip_names</span><span class="p">)</span>  <span class="c1">#already dealt with</span>
        <span class="n">source_key</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">from_category</span><span class="p">][</span><span class="s1">&#39;_category.key_id&#39;</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Source dataname set: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s_names_in_cat</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Target dataname set: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">t_names_in_cat</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Projecting through following datanames from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">from_category</span><span class="p">,</span><span class="n">to_category</span><span class="p">)</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">can_project</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">project_name</span> <span class="ow">in</span> <span class="n">can_project</span><span class="p">:</span>
            <span class="n">full_from_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_obj_lookup_table</span><span class="p">[(</span><span class="n">from_category</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="n">project_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">full_to_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_obj_lookup_table</span><span class="p">[(</span><span class="n">to_category</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="n">project_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key_vals</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">full_to_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cifdata</span><span class="p">[</span><span class="n">full_from_name</span><span class="p">]</span>
                <span class="k">except</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">StarDerivationError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_key_vals</span> <span class="o">=</span> <span class="n">cifdata</span><span class="p">[</span><span class="n">source_key</span><span class="p">]</span>
                <span class="n">filter_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_key_vals</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">key_vals</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">all_data_vals</span> <span class="o">=</span> <span class="n">cifdata</span><span class="p">[</span><span class="n">full_from_name</span><span class="p">]</span>
                <span class="k">except</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">StarDerivationError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">result</span><span class="p">[</span><span class="n">full_to_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_data_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filter_pos</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">store_new_cat_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">the_category</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store the values in [[result]] into [[cifdata]]&quot;&quot;&quot;</span>
        <span class="n">the_key</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_type.purpose&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span>
        <span class="n">double_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cifdata</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">double_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">already_present</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names_in_cat</span><span class="p">(</span><span class="n">the_category</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cifdata</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">already_present</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Category </span><span class="si">%s</span><span class="s2"> not updated, mismatched datanames: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">the_category</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">already_present</span><span class="p">)</span><span class="o">^</span><span class="nb">set</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
                <span class="k">return</span>
            <span class="c1">#check key values</span>
            <span class="n">old_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cifdata</span><span class="p">[</span><span class="n">the_key</span><span class="p">])</span>
            <span class="n">common_keys</span> <span class="o">=</span> <span class="n">old_keys</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">the_key</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">common_keys</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Category </span><span class="si">%s</span><span class="s2"> not updated, key values in common:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">common_keys</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="c1">#extend result values with old values</span>
            <span class="k">for</span> <span class="n">one_name</span><span class="p">,</span><span class="n">one_value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">result</span><span class="p">[</span><span class="n">one_name</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cifdata</span><span class="p">[</span><span class="n">one_name</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">one_name</span><span class="p">,</span> <span class="n">one_value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store_new_looped_value</span><span class="p">(</span><span class="n">one_name</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">one_value</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">StarError</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: Not replacing </span><span class="si">%s</span><span class="s1"> with calculated </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">one_name</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">cifdata</span><span class="p">[</span><span class="n">one_name</span><span class="p">]),</span><span class="nb">repr</span><span class="p">(</span><span class="n">one_value</span><span class="p">)))</span>
        <span class="c1">#put the key as the first item</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Fixing item order for {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">the_key</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="n">the_key</span><span class="p">:</span>  <span class="c1">#should only be one</span>
            <span class="n">cifdata</span><span class="o">.</span><span class="n">ChangeItemOrder</span><span class="p">(</span><span class="n">one_key</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">generate_default_packet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">catname</span><span class="p">,</span><span class="n">catkey</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a StarPacket with items from ``catname`` and a key value</span>
<span class="sd">        of ``keyvalue``&quot;&quot;&quot;</span>
        <span class="n">newpack</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names_in_cat</span><span class="p">(</span><span class="n">catname</span><span class="p">):</span>
            <span class="n">def_val</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">na</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_enumeration.default&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">def_val</span><span class="p">:</span>
                <span class="n">final_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_type</span><span class="p">(</span><span class="n">na</span><span class="p">,</span><span class="n">def_val</span><span class="p">)</span>
                <span class="n">newpack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">final_val</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">newpack</span><span class="p">,</span><span class="n">na</span><span class="p">,</span><span class="n">final_val</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newpack</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">newpack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">keyvalue</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">newpack</span><span class="p">,</span><span class="n">catkey</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newpack</span>


    <span class="k">def</span> <span class="nf">switch_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">to_val</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">change_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">,</span><span class="n">inval</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inval</span> <span class="o">==</span> <span class="s2">&quot;?&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="n">inval</span>
        <span class="n">change_function</span> <span class="o">=</span> <span class="n">convert_type</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">itemname</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inval</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inval</span><span class="p">,</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarList</span><span class="p">):</span>   <span class="c1">#from a loop</span>
            <span class="n">newval</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">change_function</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">inval</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newval</span> <span class="o">=</span> <span class="n">change_function</span><span class="p">(</span><span class="n">inval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newval</span>

    <span class="k">def</span> <span class="nf">install_validation_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Install the DDL-appropriate validation checks&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diclang</span> <span class="o">!=</span> <span class="s1">&#39;DDLm&#39;</span><span class="p">:</span>
            <span class="c1"># functions which check conformance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_validation_funs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_item_type</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_item_esd</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_item_enum</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_enum_range</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_looping</span>
            <span class="p">]</span>
            <span class="c1"># functions checking loop values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop_validation_funs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_loop_membership</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_loop_key</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_loop_references</span>
            <span class="p">]</span>
            <span class="c1"># where we need to look at other values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_validation_funs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_exclusion</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_parent</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_child</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_dependents</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_uniqueness</span>
            <span class="p">]</span>
            <span class="c1"># where only a full block will do</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_validation_funs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_mandatory_category</span>
            <span class="p">]</span>
            <span class="c1"># removal is quicker with special checks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_remove_validation_funs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_remove_parent_child</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">diclang</span> <span class="o">==</span> <span class="s1">&#39;DDLm&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_validation_funs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_item_enum</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_item_esd_ddlm</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop_validation_funs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_looping_ddlm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_loop_key_ddlm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_loop_membership</span>
                <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_validation_funs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_validation_funs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_mandatory_items</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_prohibited_items</span>
                <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_remove_validation_funs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span> <span class="o">=</span> <span class="bp">False</span>        <span class="c1"># default value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_parents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_keys</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">validate_item_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">mymatch</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="n">target_type</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type_spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_type</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>          <span class="c1"># e.g. a category definition</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>                  <span class="c1"># not restricted in any way</span>
        <span class="n">matchexpr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typedic</span><span class="p">[</span><span class="n">target_type</span><span class="p">]</span>
        <span class="n">item_values</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">item_value</span><span class="p">)</span>
        <span class="c1">#for item in item_values:</span>
            <span class="c1">#print(&quot;Type match &quot; + item_name + &quot; &quot; + item + &quot;:&quot;,)</span>
        <span class="c1">#skip dots and question marks</span>
        <span class="n">check_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item_values</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span><span class="s2">&quot;.&quot;</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">!=</span> <span class="s2">&quot;?&quot;</span><span class="p">]</span>
        <span class="n">check_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">check_all</span> <span class="k">if</span> <span class="n">mymatch</span><span class="p">(</span><span class="n">matchexpr</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="n">a</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_all</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_values&quot;</span><span class="p">:</span><span class="n">check_all</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">decide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">result_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct the return list&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_list</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
               <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
               <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_values&quot;</span><span class="p">:</span><span class="n">result_list</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_item_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
        <span class="n">container_type</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">][</span><span class="s1">&#39;_type.container&#39;</span><span class="p">]</span>
        <span class="n">item_values</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">item_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">container_type</span> <span class="o">==</span> <span class="s1">&#39;Single&#39;</span><span class="p">:</span>
           <span class="n">okcheck</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item_values</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">long</span><span class="p">,</span><span class="nb">unicode</span><span class="p">))]</span>
           <span class="k">return</span> <span class="n">decide</span><span class="p">(</span><span class="n">okcheck</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">container_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Multiple&#39;</span><span class="p">,</span><span class="s1">&#39;List&#39;</span><span class="p">):</span>
           <span class="n">okcheck</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item_values</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">StarList</span><span class="p">)]</span>
           <span class="k">return</span> <span class="n">decide</span><span class="p">(</span><span class="n">okcheck</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">container_type</span> <span class="o">==</span> <span class="s1">&#39;Array&#39;</span><span class="p">:</span>    <span class="c1">#A list with numerical values</span>
           <span class="n">okcheck</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item_values</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">StarList</span><span class="p">)]</span>
           <span class="n">first_check</span> <span class="o">=</span> <span class="n">decide</span><span class="p">(</span><span class="n">okcheck</span><span class="p">)</span>
           <span class="k">if</span> <span class="ow">not</span> <span class="n">first_check</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]:</span> <span class="k">return</span> <span class="n">first_check</span>
           <span class="c1">#num_check = [a for a in item_values if len([b for b in a if not isinstance</span>

    <span class="k">def</span> <span class="nf">validate_item_esd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primitive_type</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;numb&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="n">can_esd</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">esd_spec</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;esd&quot;</span>
        <span class="k">if</span> <span class="n">can_esd</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>         <span class="c1">#must be OK!</span>
        <span class="n">item_values</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">item_value</span><span class="p">)</span>
        <span class="n">check_all</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item_values</span> <span class="k">if</span> <span class="n">get_number_with_esd</span><span class="p">(</span><span class="n">a</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_all</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_values&quot;</span><span class="p">:</span><span class="n">check_all</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_item_esd_ddlm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;self.primitive_type&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> \
        <span class="p">[</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span><span class="s1">&#39;Index&#39;</span><span class="p">,</span><span class="s1">&#39;Integer&#39;</span><span class="p">,</span><span class="s1">&#39;Real&#39;</span><span class="p">,</span><span class="s1">&#39;Imag&#39;</span><span class="p">,</span><span class="s1">&#39;Complex&#39;</span><span class="p">,</span><span class="s1">&#39;Binary&#39;</span><span class="p">,</span><span class="s1">&#39;Hexadecimal&#39;</span><span class="p">,</span><span class="s1">&#39;Octal&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="n">can_esd</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_type.purpose&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;Measurand&#39;</span><span class="p">:</span>
            <span class="n">can_esd</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">item_values</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">item_value</span><span class="p">)</span>
        <span class="n">check_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_number_with_esd</span><span class="p">(</span><span class="n">a</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item_values</span><span class="p">]</span>
        <span class="n">check_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">check_all</span> <span class="k">if</span> <span class="p">(</span><span class="n">can_esd</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> \
                 <span class="p">(</span><span class="ow">not</span> <span class="n">can_esd</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_all</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_values&quot;</span><span class="p">:</span><span class="n">check_all</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_enum_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;_item_range.minimum&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="s2">&quot;_item_range.maximum&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="n">minvals</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_item_range.minimum&quot;</span><span class="p">,</span><span class="n">default</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">])</span>
        <span class="n">maxvals</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_item_range.maximum&quot;</span><span class="p">,</span><span class="n">default</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">makefloat</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="n">a</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">maxvals</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">makefloat</span><span class="p">,</span> <span class="n">maxvals</span><span class="p">)</span>
        <span class="n">minvals</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">makefloat</span><span class="p">,</span> <span class="n">minvals</span><span class="p">)</span>
        <span class="n">rangelist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">minvals</span><span class="p">,</span><span class="n">maxvals</span><span class="p">))</span>
        <span class="n">item_values</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">item_value</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">map_check</span><span class="p">(</span><span class="n">rangelist</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item_value</span> <span class="o">==</span> <span class="s2">&quot;?&quot;</span> <span class="ow">or</span> <span class="n">item_value</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">True</span>
            <span class="n">iv</span><span class="p">,</span><span class="n">esd</span> <span class="o">=</span> <span class="n">get_number_with_esd</span><span class="p">(</span><span class="n">item_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iv</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>  <span class="c1">#shouldn&#39;t happen as is numb type</span>
            <span class="k">for</span> <span class="n">lower</span><span class="p">,</span><span class="n">upper</span> <span class="ow">in</span> <span class="n">rangelist</span><span class="p">:</span>
                <span class="c1">#check the minima</span>
                <span class="k">if</span> <span class="n">lower</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span> <span class="n">lower</span> <span class="o">=</span> <span class="n">iv</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">upper</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">iv</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">iv</span> <span class="o">&gt;</span> <span class="n">lower</span> <span class="ow">and</span> <span class="n">iv</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="p">:</span> <span class="k">return</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">upper</span> <span class="o">==</span> <span class="n">lower</span> <span class="ow">and</span> <span class="n">iv</span> <span class="o">==</span> <span class="n">upper</span><span class="p">:</span> <span class="k">return</span> <span class="bp">True</span>
            <span class="c1"># debug</span>
            <span class="c1"># print(&quot;Value %s fails range check %d &lt; x &lt; %d&quot; % (item_value,lower,upper))</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">check_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item_values</span> <span class="k">if</span> <span class="n">map_check</span><span class="p">(</span><span class="n">rangelist</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">True</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_all</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_values&quot;</span><span class="p">:</span><span class="n">check_all</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_item_enum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">enum_list</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">enum_spec</span><span class="p">][:]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="n">enum_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>   <span class="c1">#default value</span>
        <span class="n">enum_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">)</span>   <span class="c1">#unknown</span>
        <span class="n">item_values</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">item_value</span><span class="p">)</span>
        <span class="c1">#print(&quot;Enum check: {!r} in {!r}&quot;.format(item_values, enum_list))</span>
        <span class="n">check_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item_values</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enum_list</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_all</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_values&quot;</span><span class="p">:</span><span class="n">check_all</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_looping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">must_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">must_loop_spec</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">must_loop</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_value</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span> <span class="c1"># not looped</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">}</span>      <span class="c1">#this could be triggered</span>
        <span class="k">if</span> <span class="n">must_loop</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_value</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_looping_ddlm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loop_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that all names are loopable&quot;&quot;&quot;</span>
        <span class="n">truly_loopy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_final_cats</span><span class="p">(</span><span class="n">loop_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">truly_loopy</span><span class="p">)</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">loop_names</span><span class="p">):</span>  <span class="c1">#some are bad</span>
            <span class="n">categories</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_spec</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loop_names</span><span class="p">]</span>
            <span class="n">not_looped</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">categories</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_lookup</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">not_looped</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>


    <span class="k">def</span> <span class="nf">validate_loop_membership</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loop_names</span><span class="p">):</span>
        <span class="n">final_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_final_cats</span><span class="p">(</span><span class="n">loop_names</span><span class="p">)</span>
        <span class="n">bad_items</span> <span class="o">=</span>  <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">final_cat</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">final_cat</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_items</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">bad_items</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_final_cats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loop_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of the uppermost parent categories for the loop_names. Names</span>
<span class="sd">        that are not from loopable categories are ignored.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_spec</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loop_names</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>       <span class="c1">#category_id is mandatory</span>
            <span class="k">raise</span> <span class="n">ValidCifError</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> missing from dictionary </span><span class="si">%s</span><span class="s2"> for item in loop containing </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_spec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dicname</span><span class="p">,</span><span class="n">loop_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">truly_looped</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">categories</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_lookup</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_lookup</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">truly_looped</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">validate_loop_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loop_names</span><span class="p">):</span>
        <span class="n">category</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">loop_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_spec</span><span class="p">]</span>
        <span class="c1"># find any unique values which must be present</span>
        <span class="n">key_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_spec</span><span class="p">,[])</span>
        <span class="k">for</span> <span class="n">names_to_check</span> <span class="ow">in</span> <span class="n">key_spec</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names_to_check</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>   <span class="c1">#only one</span>
                <span class="n">names_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">names_to_check</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">loop_key</span> <span class="ow">in</span> <span class="n">names_to_check</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">loop_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loop_names</span><span class="p">:</span>
                    <span class="c1">#is this one of those dang implicit items?</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">loop_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">must_exist_spec</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>          <span class="c1">#it is virtually there...</span>
                    <span class="n">alternates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alternates</span><span class="p">(</span><span class="n">loop_key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">alternates</span> <span class="o">==</span> <span class="p">[]:</span>
                        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">loop_key</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">alt_names</span> <span class="ow">in</span> <span class="n">alternates</span><span class="p">:</span>
                        <span class="n">alt</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alt_names</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loop_names</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">loop_key</span><span class="p">}</span>  <span class="c1"># no alternates</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_loop_key_ddlm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loop_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make sure at least one of the necessary keys are available&quot;&quot;&quot;</span>
        <span class="n">final_cats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_final_cats</span><span class="p">(</span><span class="n">loop_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_cats</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">poss_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">[</span><span class="n">final_cats</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># </span>
            <span class="n">found_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">poss_keys</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loop_names</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_keys</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">poss_keys</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_loop_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loop_names</span><span class="p">):</span>
        <span class="n">must_haves</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_ref_spec</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loop_names</span><span class="p">]</span>
        <span class="n">must_haves</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">must_haves</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">]</span>
        <span class="c1"># build a flat list.  For efficiency we don&#39;t remove duplicates,as</span>
        <span class="c1"># we expect no more than the order of 10 or 20 looped names.</span>
        <span class="k">def</span> <span class="nf">flat_func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
               <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>       <span class="c1">#single name</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">a</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>       <span class="c1">#list of names</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="n">flat_mh</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="p">[</span><span class="n">flat_func</span><span class="p">(</span><span class="n">flat_mh</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">must_haves</span><span class="p">]</span>
        <span class="n">group_mh</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="n">flat_mh</span><span class="p">)</span>
        <span class="n">single_mh</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="n">flat_mh</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">single_mh</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loop_names</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">check_gr</span><span class="p">(</span><span class="n">s_item</span><span class="p">,</span> <span class="n">name_list</span><span class="p">):</span>
            <span class="n">nl</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">a</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">s_item</span><span class="p">)],</span><span class="n">name_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s_item</span> <span class="ow">in</span> <span class="n">nl</span><span class="p">:</span> <span class="k">return</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">res_g</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">group_mh</span> <span class="k">if</span> <span class="n">check_gr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">loop_names</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">res_g</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
        <span class="c1"># construct alternate list</span>
        <span class="n">alternates</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">get_alternates</span><span class="p">(</span><span class="n">a</span><span class="p">)),</span><span class="n">res</span><span class="p">)</span>
        <span class="n">alternates</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alternates</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]]</span>
        <span class="c1"># next line purely for error reporting</span>
        <span class="n">missing_alts</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alternates</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternates</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
           <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">missing_alts</span><span class="p">}</span>   <span class="c1">#short cut; at least one</span>
                                                       <span class="c1">#doesn&#39;t have an altern</span>
        <span class="c1">#loop over alternates</span>
        <span class="k">for</span> <span class="n">orig_name</span><span class="p">,</span><span class="n">alt_names</span> <span class="ow">in</span> <span class="n">alternates</span><span class="p">:</span>
             <span class="n">alt</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alt_names</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loop_names</span><span class="p">]</span>
             <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">orig_name</span><span class="p">}</span><span class="c1"># no alternates</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>        <span class="c1">#found alternates</span>

    <span class="k">def</span> <span class="nf">get_alternates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">main_name</span><span class="p">,</span><span class="n">exclusive_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">alternates</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">main_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">related_func</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">alt_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">alternates</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">alt_names</span> <span class="o">=</span>  <span class="bp">self</span><span class="p">[</span><span class="n">main_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">related_item</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alt_names</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
                <span class="n">alt_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">alt_names</span><span class="p">]</span>
                <span class="n">alternates</span> <span class="o">=</span> <span class="p">[</span><span class="n">alternates</span><span class="p">]</span>
            <span class="n">together</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">alt_names</span><span class="p">,</span><span class="n">alternates</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exclusive_only</span><span class="p">:</span>
                <span class="n">alt_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">together</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;alternate_exclusive&quot;</span> \
                                             <span class="ow">or</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;replace&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alt_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">together</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;alternate&quot;</span> <span class="ow">or</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;replace&quot;</span><span class="p">]</span>
            <span class="n">alt_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alt_names</span><span class="p">])</span>
        <span class="c1"># now do the alias thing</span>
        <span class="n">alias_names</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">main_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_item_aliases.alias_name&quot;</span><span class="p">,[]))</span>
        <span class="n">alt_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">alias_names</span><span class="p">)</span>
        <span class="c1"># print(&quot;Alternates for {}: {!r}&quot;.format(main_name, alt_names))</span>
        <span class="k">return</span> <span class="n">alt_names</span>


    <span class="k">def</span> <span class="nf">validate_exclusion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">,</span><span class="n">whole_block</span><span class="p">,</span><span class="n">provisional_items</span><span class="o">=</span><span class="p">{},</span><span class="nb">globals</span><span class="o">=</span><span class="p">{}):</span>
       <span class="n">alternates</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alternates</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span><span class="n">exclusive_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)]</span>
       <span class="n">item_name_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">whole_block</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
       <span class="n">item_name_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">provisional_items</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
       <span class="n">bad</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alternates</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item_name_list</span><span class="p">]</span>
       <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
           <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Bad: </span><span class="si">%s</span><span class="s2">, alternates </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">bad</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">alternates</span><span class="p">)))</span>
           <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">bad</span><span class="p">}</span>
       <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="c1"># validate that parent exists and contains matching values</span>
    <span class="k">def</span> <span class="nf">validate_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">,</span><span class="n">whole_block</span><span class="p">,</span><span class="n">provisional_items</span><span class="o">=</span><span class="p">{},</span><span class="nb">globals</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">parent_item</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_item</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>   <span class="c1">#no parent specified</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_item</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">parent_item</span> <span class="o">=</span> <span class="n">parent_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent_item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_parents</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done_parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_item</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Done parents </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">done_parents</span><span class="p">))</span>
        <span class="c1"># initialise parent/child values</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_value</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
            <span class="n">child_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">item_value</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">child_values</span> <span class="o">=</span> <span class="n">item_value</span><span class="p">[:]</span>    <span class="c1">#copy for safety</span>
        <span class="c1"># track down the parent</span>
        <span class="c1"># print(&quot;Looking for {} parent item {} in {!r}&quot;.format(item_name, parent_item, whole_block))</span>
        <span class="c1"># if globals contains the parent values, we are doing a DDL2 dictionary, and so</span>
        <span class="c1"># we have collected all parent values into the global block - so no need to search</span>
        <span class="c1"># for them elsewhere.</span>
        <span class="c1"># print(&quot;Looking for {!r}&quot;.format(parent_item))</span>
        <span class="n">parent_values</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_item</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_values</span><span class="p">:</span>
            <span class="n">parent_values</span> <span class="o">=</span> <span class="n">provisional_items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_item</span><span class="p">,</span><span class="n">whole_block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_item</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_values</span><span class="p">:</span>
            <span class="c1"># go for alternates</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">whole_block</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">namespace</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">provisional_items</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">namespace</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">globals</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">alt_names</span> <span class="o">=</span> <span class="n">filter_present</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_alternates</span><span class="p">(</span><span class="n">parent_item</span><span class="p">),</span><span class="n">namespace</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">child_values</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">!=</span> <span class="s2">&quot;?&quot;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;parent&quot;</span><span class="p">:</span><span class="n">parent_item</span><span class="p">}</span><span class="c1">#no parent available -&gt; error</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>       <span class="c1">#maybe True is more appropriate??</span>
            <span class="n">parent_item</span> <span class="o">=</span> <span class="n">alt_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>           <span class="c1">#should never be more than one??</span>
            <span class="n">parent_values</span> <span class="o">=</span> <span class="n">provisional_items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_item</span><span class="p">,</span><span class="n">whole_block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_item</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_values</span><span class="p">:</span>   <span class="c1"># check global block</span>
                <span class="n">parent_values</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_item</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_values</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
            <span class="n">parent_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">parent_values</span><span class="p">]</span>
        <span class="c1">#print(&quot;Checking parent %s against %s, values %r/%r&quot; % (parent_item,</span>
        <span class="c1">#                                          item_name, parent_values, child_values))</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_parent_child</span><span class="p">(</span><span class="n">parent_values</span><span class="p">,</span><span class="n">child_values</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_values&quot;</span><span class="p">:</span><span class="n">missing</span><span class="p">,</span><span class="s2">&quot;parent&quot;</span><span class="p">:</span><span class="n">parent_item</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">,</span><span class="n">whole_block</span><span class="p">,</span><span class="n">provisional_items</span><span class="o">=</span><span class="p">{},</span><span class="nb">globals</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">child_items</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">child_spec</span><span class="p">][:]</span>  <span class="c1">#copy</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>    <span class="c1">#not relevant</span>
        <span class="c1"># special case for dictionaries  -&gt; we check parents of children only</span>
        <span class="k">if</span> <span class="n">item_name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">:</span>  <span class="c1">#dictionary so skip</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child_items</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span> <span class="c1"># only one child</span>
            <span class="n">child_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">child_items</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_value</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span> <span class="c1"># single value</span>
            <span class="n">parent_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">item_value</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">parent_values</span> <span class="o">=</span> <span class="n">item_value</span><span class="p">[:]</span>
        <span class="c1"># expand child list with list of alternates</span>
        <span class="k">for</span> <span class="n">child_item</span> <span class="ow">in</span> <span class="n">child_items</span><span class="p">[:]:</span>
            <span class="n">child_items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_alternates</span><span class="p">(</span><span class="n">child_item</span><span class="p">))</span>
        <span class="c1"># now loop over the children</span>
        <span class="k">for</span> <span class="n">child_item</span> <span class="ow">in</span> <span class="n">child_items</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child_item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_children</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">done_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child_item</span><span class="p">)</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Done children </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">done_children</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">child_item</span> <span class="ow">in</span> <span class="n">provisional_items</span><span class="p">:</span>
                <span class="n">child_values</span> <span class="o">=</span> <span class="n">provisional_items</span><span class="p">[</span><span class="n">child_item</span><span class="p">][:]</span>
            <span class="k">elif</span> <span class="n">child_item</span> <span class="ow">in</span> <span class="n">whole_block</span><span class="p">:</span>
                <span class="n">child_values</span> <span class="o">=</span> <span class="n">whole_block</span><span class="p">[</span><span class="n">child_item</span><span class="p">][:]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child_values</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
                <span class="n">child_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">child_values</span><span class="p">]</span>
                <span class="c1"># print(&quot;Checking child %s against %s, values %r/%r&quot; % (child_item,</span>
                <span class="c1">#       item_name, child_values, parent_values))</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_parent_child</span><span class="p">(</span><span class="n">parent_values</span><span class="p">,</span><span class="n">child_values</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_values&quot;</span><span class="p">:</span><span class="n">missing</span><span class="p">,</span><span class="s2">&quot;child&quot;</span><span class="p">:</span><span class="n">child_item</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>       <span class="c1">#could mean that no child items present</span>

    <span class="c1">#a generic checker: all child vals should appear in parent_vals</span>
    <span class="k">def</span> <span class="nf">check_parent_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent_vals</span><span class="p">,</span><span class="n">child_vals</span><span class="p">):</span>
        <span class="c1"># shield ourselves from dots and question marks</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="n">parent_vals</span><span class="p">[:]</span>
        <span class="n">pv</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;?&quot;</span><span class="p">])</span>
        <span class="n">res</span> <span class="o">=</span>  <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">child_vals</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pv</span><span class="p">]</span>
        <span class="c1">#print(&quot;Missing: %s&quot; % res)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">validate_remove_parent_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">whole_block</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">child_items</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">child_spec</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child_items</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span> <span class="c1"># only one child</span>
            <span class="n">child_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">child_items</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">child_item</span> <span class="ow">in</span> <span class="n">child_items</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child_item</span> <span class="ow">in</span> <span class="n">whole_block</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;child&quot;</span><span class="p">:</span><span class="n">child_item</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_dependents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">,</span><span class="n">whole_block</span><span class="p">,</span><span class="n">prov</span><span class="o">=</span><span class="p">{},</span><span class="nb">globals</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dep_items</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">dep_spec</span><span class="p">][:]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>    <span class="c1">#not relevant</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dep_items</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
            <span class="n">dep_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">dep_items</span><span class="p">]</span>
        <span class="n">actual_names</span> <span class="o">=</span> <span class="n">whole_block</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">actual_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">prov</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">actual_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">globals</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dep_items</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">actual_names</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">alternates</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_alternates</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="n">a</span><span class="p">],</span><span class="n">missing</span><span class="p">)</span>
            <span class="c1"># compact way to get a list of alternative items which are</span>
            <span class="c1"># present</span>
            <span class="n">have_check</span> <span class="o">=</span> <span class="p">[(</span><span class="n">filter_present</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">actual_names</span><span class="p">),</span>
                                       <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">alternates</span><span class="p">]</span>
            <span class="n">have_check</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">have_check</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">have_check</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">have_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">have_check</span><span class="p">]</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">have_check</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_uniqueness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">,</span><span class="n">whole_block</span><span class="p">,</span><span class="n">provisional_items</span><span class="o">=</span><span class="p">{},</span>
                                                                  <span class="nb">globals</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">category</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">category</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;No category found for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">item_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="c1"># print(&quot;Category {!r} for item {}&quot;.format(category, item_name))</span>
        <span class="c1"># we make a copy in the following as we will be removing stuff later!</span>
        <span class="n">unique_i</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_category_key.name&quot;</span><span class="p">,[])[:]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unique_i</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
            <span class="n">unique_i</span> <span class="o">=</span> <span class="p">[</span><span class="n">unique_i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">item_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_i</span><span class="p">:</span>       <span class="c1">#no need to verify</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_value</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>  <span class="c1">#not looped</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="c1"># print(&quot;Checking %s -&gt; %s -&gt; %s -&gt;Unique: %r&quot; % (item_name,category,catentry, unique_i))</span>
        <span class="c1"># check that we can&#39;t optimize by not doing this check</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">unique_i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_keys</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unique_i</span><span class="p">)</span>
        <span class="n">val_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># get the matching data from any other data items</span>
        <span class="n">unique_i</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item_name</span><span class="p">)</span>
        <span class="n">other_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>            <span class="c1"># i.e. do have others to think about</span>
           <span class="k">for</span> <span class="n">other_name</span> <span class="ow">in</span> <span class="n">unique_i</span><span class="p">:</span>
           <span class="c1"># we look for the value first in the provisional dict, then the main block</span>
           <span class="c1"># the logic being that anything in the provisional dict overrides the</span>
           <span class="c1"># main block</span>
               <span class="k">if</span> <span class="n">other_name</span> <span class="ow">in</span> <span class="n">provisional_items</span><span class="p">:</span>
                   <span class="n">other_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">provisional_items</span><span class="p">[</span><span class="n">other_name</span><span class="p">])</span>
               <span class="k">elif</span> <span class="n">other_name</span> <span class="ow">in</span> <span class="n">whole_block</span><span class="p">:</span>
                   <span class="n">other_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">whole_block</span><span class="p">[</span><span class="n">other_name</span><span class="p">])</span>
               <span class="k">elif</span> <span class="bp">self</span><span class="p">[</span><span class="n">other_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">must_exist_spec</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;implicit&quot;</span><span class="p">:</span>
                   <span class="n">other_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">item_name</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">item_value</span><span class="p">))</span>  <span class="c1">#placeholder</span>
               <span class="k">else</span><span class="p">:</span>
                   <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">other_name</span><span class="p">}</span><span class="c1">#missing data name</span>
        <span class="c1"># ok, so we go through all of our values</span>
        <span class="c1"># this works by comparing lists of strings to one other, and</span>
        <span class="c1"># so could be fooled if you think that &#39;1.&#39; and &#39;1&#39; are</span>
        <span class="c1"># identical</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item_value</span><span class="p">)):</span>
            <span class="c1">#print(&quot;Value no. %d&quot; % i, end=&quot; &quot;)</span>
            <span class="n">this_entry</span> <span class="o">=</span> <span class="n">item_value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">other_data</span><span class="p">)):</span>
                <span class="n">this_entry</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">this_entry</span><span class="p">,</span><span class="n">other_data</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span>
            <span class="c1">#print(&quot;Looking for {!r} in {!r}: &quot;.format(this_entry, val_list))</span>
            <span class="k">if</span> <span class="n">this_entry</span> <span class="ow">in</span> <span class="n">val_list</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_values&quot;</span><span class="p">:</span><span class="n">this_entry</span><span class="p">}</span>
            <span class="n">val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_entry</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>


    <span class="k">def</span> <span class="nf">validate_mandatory_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">whole_block</span><span class="p">):</span>
        <span class="n">mand_cats</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_category.id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_category.mandatory_code&quot;</span><span class="p">,</span><span class="s2">&quot;no&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;yes&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mand_cats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
        <span class="c1"># print(&quot;Mandatory categories - {!r}&quot;.format(mand_cats)</span>
        <span class="c1"># find which categories each of our datanames belongs to</span>
        <span class="n">all_cats</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_spec</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">whole_block</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mand_cats</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_cats</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="nb">repr</span><span class="p">(</span><span class="n">missing</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">check_mandatory_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">whole_block</span><span class="p">,</span><span class="n">default_scope</span><span class="o">=</span><span class="s1">&#39;Item&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an error if any mandatory items are missing&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scopes_mandatory</span><span class="p">)</span><span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">default_scope</span> <span class="o">==</span> <span class="s1">&#39;Datablock&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>     <span class="c1">#is a data file</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">whole_block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="n">default_scope</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;_dictionary.title&#39;</span> <span class="ow">in</span> <span class="n">whole_block</span><span class="p">:</span>
           <span class="n">scope</span> <span class="o">=</span> <span class="s1">&#39;Dictionary&#39;</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes_mandatory</span><span class="p">[</span><span class="n">scope</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">whole_block</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">missing</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">check_prohibited_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">whole_block</span><span class="p">,</span><span class="n">default_scope</span><span class="o">=</span><span class="s1">&#39;Item&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an error if any prohibited items are present&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scopes_naughty</span><span class="p">)</span><span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">default_scope</span> <span class="o">==</span> <span class="s1">&#39;Datablock&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>     <span class="c1">#is a data file</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">whole_block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="n">default_scope</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;_dictionary.title&#39;</span> <span class="ow">in</span> <span class="n">whole_block</span><span class="p">:</span>
           <span class="n">scope</span> <span class="o">=</span> <span class="s1">&#39;Dictionary&#39;</span>
        <span class="n">present</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes_naughty</span><span class="p">[</span><span class="n">scope</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">whole_block</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">present</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">present</span><span class="p">}</span>


    <span class="k">def</span> <span class="nf">run_item_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">item_name</span><span class="p">:</span><span class="nb">list</span><span class="p">([(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="n">f</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_validation_funs</span><span class="p">])}</span>

    <span class="k">def</span> <span class="nf">run_loop_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loop_names</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">loop_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="nb">list</span><span class="p">([(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="n">f</span><span class="p">(</span><span class="n">loop_names</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_validation_funs</span><span class="p">])}</span>

    <span class="k">def</span> <span class="nf">run_global_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">,</span><span class="n">data_block</span><span class="p">,</span><span class="n">provisional_items</span><span class="o">=</span><span class="p">{},</span><span class="nb">globals</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="n">f</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">,</span><span class="n">data_block</span><span class="p">,</span><span class="n">provisional_items</span><span class="p">,</span><span class="nb">globals</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_validation_funs</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">item_name</span><span class="p">:</span><span class="n">results</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">run_block_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">whole_block</span><span class="p">,</span><span class="n">block_scope</span><span class="o">=</span><span class="s1">&#39;Item&#39;</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="n">f</span><span class="p">(</span><span class="n">whole_block</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_validation_funs</span><span class="p">])</span>
        <span class="c1"># fix up the return values</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;whole_block&quot;</span><span class="p">:</span><span class="n">results</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">optimize_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_parents</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">optimize_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_parents</span> <span class="o">=</span> <span class="p">[]</span>



<span class="k">class</span> <span class="nc">ValidCifBlock</span><span class="p">(</span><span class="n">CifBlock</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A `CifBlock` that is valid with respect to a given CIF dictionary.  Methods</span>
<span class="sd">    of `CifBlock` are overridden where necessary to disallow addition of invalid items to the</span>
<span class="sd">    `CifBlock`.</span>

<span class="sd">    ## Initialisation</span>

<span class="sd">    * `dic` is a `CifDic` object to be used for validation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dic</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">diclist</span><span class="o">=</span><span class="p">[],</span> <span class="n">mergemode</span> <span class="o">=</span> <span class="s2">&quot;replace&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwords</span><span class="p">):</span>
        <span class="n">CifBlock</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwords</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dic</span> <span class="ow">and</span> <span class="n">diclist</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Warning: diclist argument ignored when initialising ValidCifBlock&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span><span class="n">CifDic</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span> <span class="o">=</span> <span class="n">dic</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span> <span class="s2">&quot;ValidCifBlock passed non-CifDic type in dic argument&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diclist</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dic</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidCifError</span><span class="p">(</span> <span class="s2">&quot;At least one dictionary must be specified&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">diclist</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span> <span class="o">=</span> <span class="n">merge_dic</span><span class="p">(</span><span class="n">diclist</span><span class="p">,</span><span class="n">mergemode</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_data_checks</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">ValidCifError</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">run_data_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">optimize_on</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dataname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">update_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">run_item_validation</span><span class="p">(</span><span class="n">dataname</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="n">dataname</span><span class="p">]))</span>
            <span class="n">update_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">run_global_validation</span><span class="p">(</span><span class="n">dataname</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="n">dataname</span><span class="p">],</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">loop_names</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">update_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">run_loop_validation</span><span class="p">(</span><span class="n">loop_names</span><span class="p">))</span>
        <span class="c1"># now run block-level checks</span>
        <span class="n">update_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">run_block_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="c1"># return false and list of baddies if anything didn&#39;t match</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">optimize_off</span><span class="p">()</span>
        <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="c1">#dictionary will change</span>
        <span class="k">for</span> <span class="n">test_key</span> <span class="ow">in</span> <span class="n">all_keys</span><span class="p">:</span>
            <span class="c1">#print(&quot;%s: %r&quot; % (test_key, self.v_result[test_key]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">[</span><span class="n">test_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">[</span><span class="n">test_key</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">==</span><span class="bp">False</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">[</span><span class="n">test_key</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">[</span><span class="n">test_key</span><span class="p">]</span>
        <span class="n">isvalid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span>
        <span class="c1">#if not isvalid:</span>
        <span class="c1">#    print(&quot;Baddies: {!r}&quot;.format(self.v_result))</span>
        <span class="k">return</span> <span class="n">isvalid</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">v_result</span>

    <span class="k">def</span> <span class="nf">single_item_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
        <span class="c1">#self.match_single_item(item_name)</span>
        <span class="k">if</span> <span class="n">item_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">item_name</span><span class="p">:[]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">run_item_validation</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">)</span>
        <span class="n">baddies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">==</span><span class="bp">False</span><span class="p">])</span>
        <span class="c1"># if even one false one is found, this should trigger</span>
        <span class="n">isvalid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">baddies</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># if not isvalid: print(&quot;Failures for {}: {!r}&quot;.format(item_name, baddies))</span>
        <span class="k">return</span> <span class="n">isvalid</span><span class="p">,</span><span class="n">baddies</span>

    <span class="k">def</span> <span class="nf">loop_item_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loop_names</span><span class="p">):</span>
        <span class="n">in_dic_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loop_names</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_dic_names</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">loop_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:[]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">run_loop_validation</span><span class="p">(</span><span class="n">in_dic_names</span><span class="p">)</span>
        <span class="n">baddies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">in_dic_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">==</span><span class="bp">False</span><span class="p">])</span>
        <span class="c1"># if even one false one is found, this should trigger</span>
        <span class="n">isvalid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">baddies</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># if not isvalid: print(&quot;Failures for {}: {!r}&quot;.format(loop_names, baddies))</span>
        <span class="k">return</span> <span class="n">isvalid</span><span class="p">,</span><span class="n">baddies</span>

    <span class="k">def</span> <span class="nf">global_item_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">,</span><span class="n">provisional_items</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">if</span> <span class="n">item_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">item_name</span><span class="p">:[]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">run_global_validation</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span>
               <span class="n">item_value</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">provisional_items</span> <span class="o">=</span> <span class="n">provisional_items</span><span class="p">)</span>
        <span class="n">baddies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">])</span>
        <span class="c1"># if even one false one is found, this should trigger</span>
        <span class="n">isvalid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">baddies</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># if not isvalid: print(&quot;Failures for {}: {!r}&quot;.format(item_name, baddies))</span>
        <span class="k">return</span> <span class="n">isvalid</span><span class="p">,</span><span class="n">baddies</span>

    <span class="k">def</span> <span class="nf">remove_global_item_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">item_name</span><span class="p">:[]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">run_remove_global_validation</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">baddies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">==</span><span class="bp">False</span><span class="p">])</span>
        <span class="c1"># if even one false one is found, this should trigger</span>
        <span class="n">isvalid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">baddies</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># if not isvalid: print(&quot;Failures for {}: {!r}&quot;.format(item_name, baddies))</span>
        <span class="k">return</span> <span class="n">isvalid</span><span class="p">,</span><span class="n">baddies</span>

    <span class="k">def</span> <span class="nf">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">):</span>
        <span class="c1"># single item checks</span>
        <span class="n">paired_data</span> <span class="o">=</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">paired_data</span><span class="p">:</span>
            <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_item_check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">)</span>
        <span class="c1"># loop item checks; merge with current loop</span>
        <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">aloop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="s2">&quot;loops&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">dataname</span> <span class="ow">in</span> <span class="n">aloop</span><span class="p">:</span>
                <span class="n">loopnames</span> <span class="o">=</span> <span class="n">aloop</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">new_name</span> <span class="ow">in</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">new_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loopnames</span><span class="p">:</span> <span class="n">loopnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>
                <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">looped_item_check</span><span class="p">(</span><span class="n">loopnames</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">)</span>
        <span class="n">prov_dict</span> <span class="o">=</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">paired_data</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">prov_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>   <span class="c1"># remove temporarily</span>
            <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_item_check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">prov_dict</span><span class="p">)</span>
            <span class="n">prov_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>  <span class="c1"># add back in</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">)</span>
        <span class="n">CifBlock</span><span class="o">.</span><span class="n">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">AddCifItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>   <span class="c1"># single item</span>
            <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_item_check</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_item_check</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">paired_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">paired_data</span><span class="p">:</span>
                <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_item_check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
            <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_item_check</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">prov_dict</span> <span class="o">=</span> <span class="p">{}</span>            <span class="c1"># for storing temporary items</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">paired_data</span><span class="p">:</span> <span class="n">prov_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="n">value</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">paired_data</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">prov_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>   <span class="c1"># remove temporarily</span>
                <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_item_check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">prov_dict</span><span class="p">)</span>
                <span class="n">prov_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>  <span class="c1"># add back in</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Programming error: AddCifItem passed non-tuple,non-string item&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ValidCifBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">AddCifItem</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">AddItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set value of dataname `key` to `value` after checking for conformance with CIF dictionary&quot;&quot;&quot;</span>
        <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_item_check</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
        <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_item_check</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ValidCifBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># utility function</span>
    <span class="k">def</span> <span class="nf">report_if_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">valid</span><span class="p">,</span><span class="n">bad_list</span><span class="p">,</span><span class="n">data_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
            <span class="n">bad_tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">bad_list</span><span class="p">]</span>
            <span class="n">error_string</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bad_tests</span><span class="p">)</span>
            <span class="n">error_string</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">data_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; fails following validity checks: &quot;</span>  <span class="o">+</span> <span class="n">error_string</span>
            <span class="k">raise</span> <span class="n">ValidCifError</span><span class="p">(</span> <span class="n">error_string</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="c1"># we don&#39;t need to run single item checks; we do need to run loop and</span>
        <span class="c1"># global checks.</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">loop_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">loop_items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">loop_items</span><span class="p">:</span>             <span class="c1">#need to check loop conformance</span>
                <span class="n">loop_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loop_items</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_item_check</span><span class="p">(</span><span class="n">loop_names</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">)</span>
            <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_global_item_check</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RemoveCifItem</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="n">outstr</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
       <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;Validation results</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
       <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
       <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> invalid items found</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">))</span>
       <span class="k">for</span> <span class="n">item_name</span><span class="p">,</span><span class="n">val_func_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
           <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> fails following tests:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">item_name</span><span class="p">)</span>
           <span class="k">for</span> <span class="n">val_func</span> <span class="ow">in</span> <span class="n">val_func_list</span><span class="p">:</span>
               <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
       <span class="k">return</span> <span class="n">outstr</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ValidCifFile</span><span class="p">(</span><span class="n">CifFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CIF file for which all datablocks are valid.  Argument `dic` to</span>
<span class="sd">    initialisation specifies a `CifDic` object to use for validation.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dic</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">diclist</span><span class="o">=</span><span class="p">[],</span><span class="n">mergemode</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">diclist</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dic</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;bigdic&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidCifError</span><span class="p">(</span> <span class="s2">&quot;At least one dictionary is required to create a ValidCifFile object&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dic</span> <span class="ow">and</span> <span class="n">diclist</span><span class="p">:</span>     <span class="c1">#merge here for speed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bigdic</span> <span class="o">=</span> <span class="n">merge_dic</span><span class="p">(</span><span class="n">diclist</span><span class="p">,</span><span class="n">mergemode</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dic</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">diclist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bigdic</span> <span class="o">=</span> <span class="n">dic</span>
        <span class="n">CifFile</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">blockname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">blockname</span><span class="p">]</span><span class="o">=</span><span class="n">ValidCifBlock</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">blockname</span><span class="p">],</span><span class="n">dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bigdic</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">NewBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blockname</span><span class="p">,</span><span class="n">blockcontents</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">CifFile</span><span class="o">.</span><span class="n">NewBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blockname</span><span class="p">,</span><span class="n">blockcontents</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># dictionary[blockname] is now a CifBlock object.  We</span>
        <span class="c1"># turn it into a ValidCifBlock object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">blockname</span><span class="p">]</span> <span class="o">=</span> <span class="n">ValidCifBlock</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bigdic</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">blockname</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">ValidationResult</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents validation result. It is initialised with &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;results is return value of validate function&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_matches</span> <span class="o">=</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">use_html</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string with human-readable description of validation result&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">validate_report</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_matches</span><span class="p">),</span><span class="n">use_html</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">block_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True for valid CIF file, otherwise False&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">block_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">block_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">block_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">block_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_result</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">block_name</span> <span class="ow">in</span> <span class="n">block_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_result</span><span class="p">[</span><span class="n">block_name</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="bp">True</span><span class="p">,{}):</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">valid</span>

    <span class="k">def</span> <span class="nf">has_no_match_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">block_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return true if some items are not found in dictionary&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">block_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">block_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">block_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">block_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_matches</span><span class="o">.</span><span class="n">iter_keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">block_name</span> <span class="ow">in</span> <span class="n">block_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_matches</span><span class="p">[</span><span class="n">block_name</span><span class="p">]:</span>
                <span class="n">has_no_match_items</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">has_no_match_items</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">has_no_match_items</span>



<span class="k">def</span> <span class="nf">Validate</span><span class="p">(</span><span class="n">ciffile</span><span class="p">,</span><span class="n">dic</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">diclist</span><span class="o">=</span><span class="p">[],</span><span class="n">mergemode</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">,</span><span class="n">isdic</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate the `ciffile` conforms to the definitions in `CifDic` object `dic`, or if `dic` is missing,</span>
<span class="sd">    to the results of merging the `CifDic` objects in `diclist` according to `mergemode`.  Flag</span>
<span class="sd">    `isdic` indicates that `ciffile` is a CIF dictionary meaning that save frames should be</span>
<span class="sd">    accessed for validation and that mandatory_category should be interpreted differently for DDL2.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ciffile</span><span class="p">,</span><span class="n">CifFile</span><span class="p">):</span>
        <span class="n">check_file</span> <span class="o">=</span> <span class="n">CifFile</span><span class="p">(</span><span class="n">ciffile</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">check_file</span> <span class="o">=</span> <span class="n">ciffile</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dic</span><span class="p">:</span>
        <span class="n">fulldic</span> <span class="o">=</span> <span class="n">merge_dic</span><span class="p">(</span><span class="n">diclist</span><span class="p">,</span><span class="n">mergemode</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fulldic</span> <span class="o">=</span> <span class="n">dic</span>
    <span class="n">no_matches</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">valid_result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">isdic</span><span class="p">:</span>          <span class="c1">#assume one block only</span>
        <span class="n">check_file</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="s1">&#39;instance&#39;</span> <span class="c1">#only data blocks visible</span>
        <span class="n">top_level</span> <span class="o">=</span> <span class="n">check_file</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">check_file</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="s1">&#39;dictionary&#39;</span>   <span class="c1">#all blocks visible</span>
        <span class="c1"># collect a list of parents for speed</span>
        <span class="k">if</span> <span class="n">fulldic</span><span class="o">.</span><span class="n">diclang</span> <span class="o">==</span> <span class="s1">&#39;DDL2&#39;</span><span class="p">:</span>
            <span class="n">poss_parents</span> <span class="o">=</span> <span class="n">fulldic</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="s2">&quot;_item_linked.parent_name&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">poss_parents</span><span class="p">:</span>
                <span class="n">curr_parent</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">check_file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent</span><span class="p">,[]))</span>
                <span class="n">new_vals</span> <span class="o">=</span> <span class="n">check_file</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
                <span class="n">new_vals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">curr_parent</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_vals</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">check_file</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_vals</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Added </span><span class="si">%s</span><span class="s2"> (len </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">check_file</span><span class="p">[</span><span class="n">parent</span><span class="p">])))</span>
    <span class="c1"># now run the validations</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">check_file</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">isdic</span> <span class="ow">and</span> <span class="n">block</span> <span class="o">==</span> <span class="n">top_level</span><span class="p">:</span>
           <span class="n">block_scope</span> <span class="o">=</span> <span class="s1">&#39;Dictionary&#39;</span>
        <span class="k">elif</span> <span class="n">isdic</span><span class="p">:</span>
           <span class="n">block_scope</span> <span class="o">=</span> <span class="s1">&#39;Item&#39;</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">block_scope</span> <span class="o">=</span> <span class="s1">&#39;Datablock&#39;</span>
        <span class="n">no_matches</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">check_file</span><span class="p">[</span><span class="n">block</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fulldic</span><span class="p">]</span>
        <span class="c1"># remove non-matching items</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Not matched: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">no_matches</span><span class="p">[</span><span class="n">block</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">nogood</span> <span class="ow">in</span> <span class="n">no_matches</span><span class="p">[</span><span class="n">block</span><span class="p">]:</span>
             <span class="k">del</span> <span class="n">check_file</span><span class="p">[</span><span class="n">block</span><span class="p">][</span><span class="n">nogood</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Validating block </span><span class="si">%s</span><span class="s2">, scope </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="n">block_scope</span><span class="p">))</span>
        <span class="n">valid_result</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_data_checks</span><span class="p">(</span><span class="n">check_file</span><span class="p">[</span><span class="n">block</span><span class="p">],</span><span class="n">fulldic</span><span class="p">,</span><span class="n">block_scope</span><span class="o">=</span><span class="n">block_scope</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">valid_result</span><span class="p">,</span><span class="n">no_matches</span>

<span class="k">def</span> <span class="nf">validate_report</span><span class="p">(</span><span class="n">val_result</span><span class="p">,</span><span class="n">use_html</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">valid_result</span><span class="p">,</span><span class="n">no_matches</span> <span class="o">=</span> <span class="n">val_result</span>
    <span class="n">outstr</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">use_html</span><span class="p">:</span>
        <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;h2&gt;Validation results&lt;/h2&gt;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;Validation results</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">suppress_valid</span> <span class="o">=</span> <span class="bp">True</span>         <span class="c1">#don&#39;t clutter with valid messages</span>
        <span class="k">if</span> <span class="n">use_html</span><span class="p">:</span>
           <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;For brevity, valid blocks are not reported in the output.&lt;/p&gt;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">suppress_valid</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">valid_result</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">block_result</span> <span class="o">=</span> <span class="n">valid_result</span><span class="p">[</span><span class="n">block</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">block_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">out_line</span> <span class="o">=</span> <span class="s2">&quot;Block &#39;</span><span class="si">%s</span><span class="s2">&#39; is VALID&quot;</span> <span class="o">%</span> <span class="n">block</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_line</span> <span class="o">=</span> <span class="s2">&quot;Block &#39;</span><span class="si">%s</span><span class="s2">&#39; is INVALID&quot;</span> <span class="o">%</span> <span class="n">block</span>
        <span class="k">if</span> <span class="n">use_html</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">block_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">suppress_valid</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">no_matches</span><span class="p">[</span><span class="n">block</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">block_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;&lt;h3&gt;</span><span class="si">%s</span><span class="s2">&lt;/h3&gt;&lt;p&gt;&quot;</span> <span class="o">%</span> <span class="n">out_line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
                <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">out_line</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">no_matches</span><span class="p">[</span><span class="n">block</span><span class="p">])</span><span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_html</span><span class="p">:</span>
                <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;&lt;p&gt;The following items were not found in the dictionary&quot;</span><span class="p">)</span>
                <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; (note that this does not invalidate the data block):&lt;/p&gt;&quot;</span><span class="p">)</span>
                <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;&lt;table&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">[</span><span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;tr&gt;&lt;td&gt;</span><span class="si">%s</span><span class="s2">&lt;/td&gt;&lt;/tr&gt;&quot;</span> <span class="o">%</span> <span class="n">it</span><span class="p">)</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">no_matches</span><span class="p">[</span><span class="n">block</span><span class="p">]]</span>
                <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;/table&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> The following items were not found in the dictionary:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Note that this does not invalidate the data block</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">[</span><span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">it</span><span class="p">)</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">no_matches</span><span class="p">[</span><span class="n">block</span><span class="p">]]</span>
        <span class="c1"># now organise our results by type of error, not data item...</span>
        <span class="n">error_type_dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">error_item</span><span class="p">,</span> <span class="n">error_list</span> <span class="ow">in</span> <span class="n">block_result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">func_name</span><span class="p">,</span><span class="n">bad_result</span> <span class="ow">in</span> <span class="n">error_list</span><span class="p">:</span>
                <span class="n">bad_result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;item_name&quot;</span><span class="p">:</span><span class="n">error_item</span><span class="p">})</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">error_type_dic</span><span class="p">[</span><span class="n">func_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bad_result</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">error_type_dic</span><span class="p">[</span><span class="n">func_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">bad_result</span><span class="p">]</span>
        <span class="c1"># make a table of test name, test message</span>
        <span class="n">info_table</span> <span class="o">=</span> <span class="p">{</span>\
        <span class="s1">&#39;validate_item_type&#39;</span><span class="p">:</span>\
            <span class="s2">&quot;The following data items had badly formed values&quot;</span><span class="p">,</span>
        <span class="s1">&#39;validate_item_esd&#39;</span><span class="p">:</span>\
            <span class="s2">&quot;The following data items should not have esds appended&quot;</span><span class="p">,</span>
        <span class="s1">&#39;validate_enum_range&#39;</span><span class="p">:</span>\
            <span class="s2">&quot;The following data items have values outside permitted range&quot;</span><span class="p">,</span>
        <span class="s1">&#39;validate_item_enum&#39;</span><span class="p">:</span>\
            <span class="s2">&quot;The following data items have values outside permitted set&quot;</span><span class="p">,</span>
        <span class="s1">&#39;validate_looping&#39;</span><span class="p">:</span>\
            <span class="s2">&quot;The following data items violate looping constraints&quot;</span><span class="p">,</span>
        <span class="s1">&#39;validate_loop_membership&#39;</span><span class="p">:</span>\
            <span class="s2">&quot;The following looped data names are of different categories to the first looped data name&quot;</span><span class="p">,</span>
        <span class="s1">&#39;validate_loop_key&#39;</span><span class="p">:</span>\
            <span class="s2">&quot;A required dataname for this category is missing from the loop</span><span class="se">\n</span><span class="s2"> containing the dataname&quot;</span><span class="p">,</span>
        <span class="s1">&#39;validate_loop_key_ddlm&#39;</span><span class="p">:</span>\
            <span class="s2">&quot;A loop key is missing for the category containing the dataname&quot;</span><span class="p">,</span>
        <span class="s1">&#39;validate_loop_references&#39;</span><span class="p">:</span>\
            <span class="s2">&quot;A dataname required by the item is missing from the loop&quot;</span><span class="p">,</span>
        <span class="s1">&#39;validate_parent&#39;</span><span class="p">:</span>\
            <span class="s2">&quot;A parent dataname is missing or contains different values&quot;</span><span class="p">,</span>
        <span class="s1">&#39;validate_child&#39;</span><span class="p">:</span>\
            <span class="s2">&quot;A child dataname contains different values to the parent&quot;</span><span class="p">,</span>
        <span class="s1">&#39;validate_uniqueness&#39;</span><span class="p">:</span>\
            <span class="s2">&quot;One or more data items do not take unique values&quot;</span><span class="p">,</span>
        <span class="s1">&#39;validate_dependents&#39;</span><span class="p">:</span>\
            <span class="s2">&quot;A dataname required by the item is missing from the data block&quot;</span><span class="p">,</span>
        <span class="s1">&#39;validate_exclusion&#39;</span><span class="p">:</span> \
            <span class="s2">&quot;Both dataname and exclusive alternates or aliases are present in data block&quot;</span><span class="p">,</span>
        <span class="s1">&#39;validate_mandatory_category&#39;</span><span class="p">:</span>\
            <span class="s2">&quot;A required category is missing from this block&quot;</span><span class="p">,</span>
        <span class="s1">&#39;check_mandatory_items&#39;</span><span class="p">:</span>\
            <span class="s2">&quot;A required data attribute is missing from this block&quot;</span><span class="p">,</span>
        <span class="s1">&#39;check_prohibited_items&#39;</span><span class="p">:</span>\
            <span class="s2">&quot;A prohibited data attribute is present in this block&quot;</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">test_name</span><span class="p">,</span><span class="n">test_results</span> <span class="ow">in</span> <span class="n">error_type_dic</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
           <span class="k">if</span> <span class="n">use_html</span><span class="p">:</span>
               <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html_error_report</span><span class="p">(</span><span class="n">test_name</span><span class="p">,</span><span class="n">info_table</span><span class="p">[</span><span class="n">test_name</span><span class="p">],</span><span class="n">test_results</span><span class="p">))</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_report</span><span class="p">(</span><span class="n">test_name</span><span class="p">,</span><span class="n">info_table</span><span class="p">[</span><span class="n">test_name</span><span class="p">],</span><span class="n">test_results</span><span class="p">))</span>
               <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outstr</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

<span class="c1"># A function to lay out a single error report.  We are passed</span>
<span class="c1"># the name of the error (one of our validation functions), the</span>
<span class="c1"># explanation to print out, and a dictionary with the error</span>
<span class="c1"># information.  We print no more than 50 characters of the item</span>

<span class="k">def</span> <span class="nf">error_report</span><span class="p">(</span><span class="n">error_name</span><span class="p">,</span><span class="n">error_explanation</span><span class="p">,</span><span class="n">error_dics</span><span class="p">):</span>
   <span class="n">retstring</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"> &quot;</span> <span class="o">+</span> <span class="n">error_explanation</span> <span class="o">+</span> <span class="s2">&quot;:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
   <span class="n">headstring</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%-32s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;Item name&quot;</span>
   <span class="n">bodystring</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
   <span class="k">if</span> <span class="s2">&quot;bad_values&quot;</span> <span class="ow">in</span> <span class="n">error_dics</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
      <span class="n">headstring</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%-20s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;Bad value(s)&quot;</span>
   <span class="k">if</span> <span class="s2">&quot;bad_items&quot;</span> <span class="ow">in</span> <span class="n">error_dics</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
      <span class="n">headstring</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%-20s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;Bad dataname(s)&quot;</span>
   <span class="k">if</span> <span class="s2">&quot;child&quot;</span> <span class="ow">in</span> <span class="n">error_dics</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
      <span class="n">headstring</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%-20s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;Child&quot;</span>
   <span class="k">if</span> <span class="s2">&quot;parent&quot;</span> <span class="ow">in</span> <span class="n">error_dics</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
      <span class="n">headstring</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%-20s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;Parent&quot;</span>
   <span class="n">headstring</span> <span class="o">+=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
   <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">error_dics</span><span class="p">:</span>
      <span class="n">bodystring</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%-32s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">error</span><span class="p">[</span><span class="s2">&quot;item_name&quot;</span><span class="p">]</span>
      <span class="k">if</span> <span class="s2">&quot;bad_values&quot;</span> <span class="ow">in</span> <span class="n">error</span><span class="p">:</span>
          <span class="n">out_vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">a</span><span class="p">)[:</span><span class="mi">50</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">error</span><span class="p">[</span><span class="s2">&quot;bad_values&quot;</span><span class="p">]]</span>
          <span class="n">bodystring</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%-20s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">out_vals</span>
      <span class="k">if</span> <span class="s2">&quot;bad_items&quot;</span> <span class="ow">in</span> <span class="n">error</span><span class="p">:</span>
          <span class="n">bodystring</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%-20s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">error</span><span class="p">[</span><span class="s2">&quot;bad_items&quot;</span><span class="p">])</span>
      <span class="k">if</span> <span class="s2">&quot;child&quot;</span> <span class="ow">in</span> <span class="n">error</span><span class="p">:</span>
          <span class="n">bodystring</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%-20s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">error</span><span class="p">[</span><span class="s2">&quot;child&quot;</span><span class="p">])</span>
      <span class="k">if</span> <span class="s2">&quot;parent&quot;</span> <span class="ow">in</span> <span class="n">error</span><span class="p">:</span>
          <span class="n">bodystring</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%-20s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">error</span><span class="p">[</span><span class="s2">&quot;parent&quot;</span><span class="p">])</span>
   <span class="k">return</span> <span class="n">retstring</span> <span class="o">+</span> <span class="n">headstring</span> <span class="o">+</span> <span class="n">bodystring</span>

<span class="c1">#  This lays out an HTML error report</span>

<span class="k">def</span> <span class="nf">html_error_report</span><span class="p">(</span><span class="n">error_name</span><span class="p">,</span><span class="n">error_explanation</span><span class="p">,</span><span class="n">error_dics</span><span class="p">,</span><span class="n">annotate</span><span class="o">=</span><span class="p">[]):</span>
   <span class="n">retstring</span> <span class="o">=</span> <span class="s2">&quot;&lt;h4&gt;&quot;</span> <span class="o">+</span> <span class="n">error_explanation</span> <span class="o">+</span> <span class="s2">&quot;:&lt;/h4&gt;&quot;</span>
   <span class="n">retstring</span> <span class="o">=</span> <span class="n">retstring</span> <span class="o">+</span> <span class="s2">&quot;&lt;table cellpadding=5&gt;&lt;tr&gt;&quot;</span>
   <span class="n">headstring</span> <span class="o">=</span> <span class="s2">&quot;&lt;th&gt;Item name&lt;/th&gt;&quot;</span>
   <span class="n">bodystring</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
   <span class="k">if</span> <span class="s2">&quot;bad_values&quot;</span> <span class="ow">in</span> <span class="n">error_dics</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
      <span class="n">headstring</span> <span class="o">+=</span> <span class="s2">&quot;&lt;th&gt;Bad value(s)&lt;/th&gt;&quot;</span>
   <span class="k">if</span> <span class="s2">&quot;bad_items&quot;</span> <span class="ow">in</span> <span class="n">error_dics</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
      <span class="n">headstring</span> <span class="o">+=</span> <span class="s2">&quot;&lt;th&gt;Bad dataname(s)&lt;/th&gt;&quot;</span>
   <span class="k">if</span> <span class="s2">&quot;child&quot;</span> <span class="ow">in</span> <span class="n">error_dics</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
      <span class="n">headstring</span> <span class="o">+=</span> <span class="s2">&quot;&lt;th&gt;Child&lt;/th&gt;&quot;</span>
   <span class="k">if</span> <span class="s2">&quot;parent&quot;</span> <span class="ow">in</span> <span class="n">error_dics</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
      <span class="n">headstring</span> <span class="o">+=</span> <span class="s2">&quot;&lt;th&gt;Parent&lt;/th&gt;&quot;</span>
   <span class="n">headstring</span> <span class="o">+=</span><span class="s2">&quot;&lt;/tr&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
   <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">error_dics</span><span class="p">:</span>
      <span class="n">bodystring</span> <span class="o">+=</span> <span class="s2">&quot;&lt;tr&gt;&lt;td&gt;&lt;tt&gt;</span><span class="si">%s</span><span class="s2">&lt;/tt&gt;&lt;/td&gt;&quot;</span> <span class="o">%</span> <span class="n">error</span><span class="p">[</span><span class="s2">&quot;item_name&quot;</span><span class="p">]</span>
      <span class="k">if</span> <span class="s2">&quot;bad_values&quot;</span> <span class="ow">in</span> <span class="n">error</span><span class="p">:</span>
          <span class="n">bodystring</span> <span class="o">+=</span> <span class="s2">&quot;&lt;td&gt;</span><span class="si">%s</span><span class="s2">&lt;/td&gt;&quot;</span> <span class="o">%</span> <span class="n">error</span><span class="p">[</span><span class="s2">&quot;bad_values&quot;</span><span class="p">]</span>
      <span class="k">if</span> <span class="s2">&quot;bad_items&quot;</span> <span class="ow">in</span> <span class="n">error</span><span class="p">:</span>
          <span class="n">bodystring</span> <span class="o">+=</span> <span class="s2">&quot;&lt;td&gt;&lt;tt&gt;</span><span class="si">%s</span><span class="s2">&lt;/tt&gt;&lt;/td&gt;&quot;</span> <span class="o">%</span> <span class="n">error</span><span class="p">[</span><span class="s2">&quot;bad_items&quot;</span><span class="p">]</span>
      <span class="k">if</span> <span class="s2">&quot;child&quot;</span> <span class="ow">in</span> <span class="n">error</span><span class="p">:</span>
          <span class="n">bodystring</span> <span class="o">+=</span> <span class="s2">&quot;&lt;td&gt;&lt;tt&gt;</span><span class="si">%s</span><span class="s2">&lt;/tt&gt;&lt;/td&gt;&quot;</span> <span class="o">%</span> <span class="n">error</span><span class="p">[</span><span class="s2">&quot;child&quot;</span><span class="p">]</span>
      <span class="k">if</span> <span class="s2">&quot;parent&quot;</span> <span class="ow">in</span> <span class="n">error</span><span class="p">:</span>
          <span class="n">bodystring</span> <span class="o">+=</span> <span class="s2">&quot;&lt;td&gt;&lt;tt&gt;</span><span class="si">%s</span><span class="s2">&lt;/tt&gt;&lt;/td&gt;&quot;</span> <span class="o">%</span> <span class="n">error</span><span class="p">[</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span>
      <span class="n">bodystring</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/tr&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
   <span class="k">return</span> <span class="n">retstring</span> <span class="o">+</span> <span class="n">headstring</span> <span class="o">+</span> <span class="n">bodystring</span> <span class="o">+</span> <span class="s2">&quot;&lt;/table&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="k">def</span> <span class="nf">run_data_checks</span><span class="p">(</span><span class="n">check_block</span><span class="p">,</span><span class="n">fulldic</span><span class="p">,</span><span class="n">block_scope</span><span class="o">=</span><span class="s1">&#39;Item&#39;</span><span class="p">):</span>
    <span class="n">v_result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">check_block</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">update_value</span><span class="p">(</span><span class="n">v_result</span><span class="p">,</span> <span class="n">fulldic</span><span class="o">.</span><span class="n">run_item_validation</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">check_block</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
        <span class="n">update_value</span><span class="p">(</span><span class="n">v_result</span><span class="p">,</span> <span class="n">fulldic</span><span class="o">.</span><span class="n">run_global_validation</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">check_block</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="n">check_block</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">loopnames</span> <span class="ow">in</span> <span class="n">check_block</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">update_value</span><span class="p">(</span><span class="n">v_result</span><span class="p">,</span> <span class="n">fulldic</span><span class="o">.</span><span class="n">run_loop_validation</span><span class="p">(</span><span class="n">loopnames</span><span class="p">))</span>
    <span class="n">update_value</span><span class="p">(</span><span class="n">v_result</span><span class="p">,</span><span class="n">fulldic</span><span class="o">.</span><span class="n">run_block_validation</span><span class="p">(</span><span class="n">check_block</span><span class="p">,</span><span class="n">block_scope</span><span class="o">=</span><span class="n">block_scope</span><span class="p">))</span>
    <span class="c1"># return false and list of baddies if anything didn&#39;t match</span>
    <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">v_result</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">test_key</span> <span class="ow">in</span> <span class="n">all_keys</span><span class="p">:</span>
        <span class="n">v_result</span><span class="p">[</span><span class="n">test_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">v_result</span><span class="p">[</span><span class="n">test_key</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">==</span><span class="bp">False</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_result</span><span class="p">[</span><span class="n">test_key</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">v_result</span><span class="p">[</span><span class="n">test_key</span><span class="p">]</span>
    <span class="c1"># if even one false one is found, this should trigger</span>
    <span class="c1"># print(&quot;Baddies: {!r}&quot;.format(v_result))</span>
    <span class="n">isvalid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_result</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span>
    <span class="k">return</span> <span class="n">isvalid</span><span class="p">,</span><span class="n">v_result</span>


<span class="k">def</span> <span class="nf">get_number_with_esd</span><span class="p">(</span><span class="n">numstring</span><span class="p">):</span>
    <span class="n">numb_re</span> <span class="o">=</span> <span class="s1">&#39;((-?(([0-9]*[.]([0-9]+))|([0-9]+)[.]?))([(][0-9]+[)])?([eEdD][+-]?[0-9]+)?)|(\?)|(\.)&#39;</span>
    <span class="n">our_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">numb_re</span><span class="p">,</span><span class="n">numstring</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">our_match</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span><span class="n">base_num</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">dad</span><span class="p">,</span><span class="n">dbd</span><span class="p">,</span><span class="n">esd</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">dot</span> <span class="o">=</span> <span class="n">our_match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
        <span class="c1"># print(&quot;Debug: {} -&gt; {!r}&quot;.format(numstring, our_match.groups()))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>
    <span class="k">if</span> <span class="n">dot</span> <span class="ow">or</span> <span class="n">q</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>     <span class="c1">#a dot or question mark</span>
    <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>          <span class="c1">#has exponent</span>
       <span class="n">exp</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span><span class="s2">&quot;e&quot;</span><span class="p">)</span>     <span class="c1"># mop up old fashioned numbers</span>
       <span class="n">exp</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">,</span><span class="s2">&quot;e&quot;</span><span class="p">)</span>
       <span class="n">base_num</span> <span class="o">=</span> <span class="n">base_num</span> <span class="o">+</span> <span class="n">exp</span>
    <span class="c1"># print(&quot;Debug: have %s for base_num from %s&quot; % (base_num,numstring))</span>
    <span class="n">base_num</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">base_num</span><span class="p">)</span>
    <span class="c1"># work out esd, if present.</span>
    <span class="k">if</span> <span class="n">esd</span><span class="p">:</span>
        <span class="n">esd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">esd</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>    <span class="c1"># no brackets</span>
        <span class="k">if</span> <span class="n">dad</span><span class="p">:</span>                   <span class="c1"># decimal point + digits</span>
            <span class="n">esd</span> <span class="o">=</span> <span class="n">esd</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dad</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>
            <span class="n">esd</span> <span class="o">=</span> <span class="n">esd</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))</span>
    <span class="k">return</span> <span class="n">base_num</span><span class="p">,</span><span class="n">esd</span>

<span class="k">def</span> <span class="nf">float_with_esd</span><span class="p">(</span><span class="n">inval</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inval</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">inval</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>  <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">inval</span><span class="p">[:</span><span class="n">j</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">inval</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">convert_type</span><span class="p">(</span><span class="n">definition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert value to have the type given by definition&quot;&quot;&quot;</span>
    <span class="c1">#extract the actual required type information</span>
    <span class="n">container</span> <span class="o">=</span> <span class="n">definition</span><span class="p">[</span><span class="s1">&#39;_type.container&#39;</span><span class="p">]</span>
    <span class="n">dimension</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_type.dimension&#39;</span><span class="p">,</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarList</span><span class="p">([]))</span>
    <span class="n">structure</span> <span class="o">=</span> <span class="n">interpret_structure</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="s1">&#39;_type.contents&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">container</span> <span class="o">==</span> <span class="s1">&#39;Single&#39;</span><span class="p">:</span>   <span class="c1">#a single value to convert</span>
        <span class="k">return</span> <span class="n">convert_single_value</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">container</span> <span class="o">==</span> <span class="s1">&#39;List&#39;</span><span class="p">:</span>   <span class="c1">#lots of the same value</span>
        <span class="k">return</span> <span class="n">convert_list_values</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span><span class="n">dimension</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">container</span> <span class="o">==</span> <span class="s1">&#39;Multiple&#39;</span><span class="p">:</span> <span class="c1">#no idea</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">elif</span> <span class="n">container</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Array&#39;</span><span class="p">,</span><span class="s1">&#39;Matrix&#39;</span><span class="p">):</span> <span class="c1">#numpy array</span>
        <span class="k">return</span> <span class="n">convert_matrix_values</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">a</span>    <span class="c1">#unable to convert</span>

<span class="k">def</span> <span class="nf">convert_single_value</span><span class="p">(</span><span class="n">type_spec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a single item according to type_spec&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">type_spec</span> <span class="o">==</span> <span class="s1">&#39;Real&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">float_with_esd</span>
    <span class="k">if</span> <span class="n">type_spec</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span><span class="s1">&#39;Integer&#39;</span><span class="p">,</span><span class="s1">&#39;Index&#39;</span><span class="p">,</span><span class="s1">&#39;Binary&#39;</span><span class="p">,</span><span class="s1">&#39;Hexadecimal&#39;</span><span class="p">,</span><span class="s1">&#39;Octal&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span>
    <span class="k">if</span> <span class="n">type_spec</span> <span class="o">==</span> <span class="s1">&#39;Complex&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">complex</span>
    <span class="k">if</span> <span class="n">type_spec</span> <span class="o">==</span> <span class="s1">&#39;Imag&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="nb">complex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">type_spec</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Code&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span><span class="s1">&#39;Tag&#39;</span><span class="p">):</span>  <span class="c1">#case-insensitive -&gt; lowercase</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">a</span>   <span class="c1">#can&#39;t do anything numeric</span>

<span class="k">class</span> <span class="nc">convert_simple_list</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">    Callable object that converts values in a simple list according</span>
<span class="sd">    to the specified element structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converters</span> <span class="o">=</span> <span class="p">[</span><span class="n">convert_single_value</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="n">structure</span><span class="p">]</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">converters</span><span class="p">):</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="s2">&quot;Expected iterable of </span><span class="si">%i</span><span class="s2"> values, got </span><span class="si">%i</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">converters</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">converters</span><span class="p">,</span> <span class="n">element</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">rv</span>

<span class="c1"># End of class convert_single_value</span>

<span class="k">def</span> <span class="nf">convert_list_values</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">dimension</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert the values according to the element</span>
<span class="sd">       structure given in [[structure]]&quot;&quot;&quot;</span>
    <span class="c1"># simple repetition</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="p">(</span><span class="nb">unicode</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
        <span class="n">fcnv</span> <span class="o">=</span> <span class="n">convert_single_value</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
    <span class="c1"># assume structure is a list of types</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fcnv</span> <span class="o">=</span> <span class="n">convert_simple_list</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">fcnv</span>
    <span class="c1"># setup nested conversion function when dimension differs from 1.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dimension</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">dimension</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">args</span> <span class="p">:</span> <span class="p">[</span><span class="n">fcnv</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">rv</span>

<span class="k">def</span> <span class="nf">convert_matrix_values</span><span class="p">(</span><span class="n">valtype</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a dREL String or Float valued List structure to a numpy matrix structure&quot;&quot;&quot;</span>
    <span class="c1"># first convert to numpy array, then let numpy do the work</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">numpy</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">a</span>   <span class="c1">#cannot do it</span>
    <span class="k">if</span> <span class="n">valtype</span> <span class="o">==</span> <span class="s1">&#39;Real&#39;</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span>
    <span class="k">elif</span> <span class="n">valtype</span> <span class="o">==</span> <span class="s1">&#39;Integer&#39;</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="k">elif</span> <span class="n">valtype</span> <span class="o">==</span> <span class="s1">&#39;Complex&#39;</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="nb">complex</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown matrix value type&#39;</span><span class="p">)</span>
    <span class="n">fcnv</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span> <span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fcnv</span>

<span class="k">def</span> <span class="nf">interpret_structure</span><span class="p">(</span><span class="n">struc_spec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Interpret a DDLm structure specification&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">TypeContentsParser</span> <span class="k">as</span> <span class="n">t</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">TypeParser</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">TypeParserScanner</span><span class="p">(</span><span class="n">struc_spec</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s2">&quot;input&quot;</span><span class="p">)()</span>


<span class="c1"># A utility function to append to item values rather than replace them</span>
<span class="k">def</span> <span class="nf">update_value</span><span class="p">(</span><span class="n">base_dict</span><span class="p">,</span><span class="n">new_items</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">new_key</span> <span class="ow">in</span> <span class="n">new_items</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">new_key</span> <span class="ow">in</span> <span class="n">base_dict</span><span class="p">:</span>
            <span class="n">base_dict</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_items</span><span class="p">[</span><span class="n">new_key</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_dict</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_items</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span>

<span class="c1">#Transpose the list of lists passed to us</span>
<span class="k">def</span> <span class="nf">transpose</span><span class="p">(</span><span class="n">base_list</span><span class="p">):</span>
    <span class="n">new_lofl</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">full_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_list</span><span class="p">)</span>
    <span class="n">opt_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">full_length</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">base_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
       <span class="n">new_packet</span> <span class="o">=</span> <span class="p">[]</span>
       <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">opt_range</span><span class="p">:</span>
          <span class="n">new_packet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
       <span class="n">new_lofl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_packet</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_lofl</span>

<span class="c1"># listify strings - used surprisingly often</span>
<span class="k">def</span> <span class="nf">listify</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span> <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">item</span>

<span class="c1"># given a list of search items, return a list of items</span>
<span class="c1"># actually contained in the given data block</span>
<span class="k">def</span> <span class="nf">filter_present</span><span class="p">(</span><span class="n">namelist</span><span class="p">,</span><span class="n">datablocknames</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">namelist</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">datablocknames</span><span class="p">]</span>

<span class="c1"># Make an item immutable, used if we want a list to be a key</span>
<span class="k">def</span> <span class="nf">make_immutable</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turn list of StarList values into a list of immutable items&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">StarList</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>

<span class="c1"># merge ddl dictionaries.  We should be passed filenames or CifFile</span>
<span class="c1"># objects</span>
<span class="k">def</span> <span class="nf">merge_dic</span><span class="p">(</span><span class="n">diclist</span><span class="p">,</span><span class="n">mergemode</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">,</span><span class="n">ddlspec</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">dic_as_cif_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dic</span> <span class="ow">in</span> <span class="n">diclist</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span><span class="n">CifFile</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dic</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
               <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Require list of CifFile names/objects for dictionary merging&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span><span class="n">CifFile</span><span class="p">):</span> <span class="n">dic_as_cif_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CifFile</span><span class="p">(</span><span class="n">dic</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">dic_as_cif_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dic</span><span class="p">)</span>
    <span class="c1"># we now merge left to right</span>
    <span class="n">basedic</span> <span class="o">=</span> <span class="n">dic_as_cif_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;on_this_dictionary&quot;</span> <span class="ow">in</span> <span class="n">basedic</span><span class="p">:</span>   <span class="c1">#DDL1 style only</span>
        <span class="k">for</span> <span class="n">dic</span> <span class="ow">in</span> <span class="n">dic_as_cif_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
           <span class="n">basedic</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">mergemode</span><span class="p">,</span><span class="n">match_att</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;_name&quot;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">basedic</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>                     <span class="c1">#One block: DDL2/m style</span>
        <span class="n">old_block</span> <span class="o">=</span> <span class="n">basedic</span><span class="p">[</span><span class="n">basedic</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">dic</span> <span class="ow">in</span> <span class="n">dic_as_cif_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
           <span class="n">new_block</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="n">dic</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span>
           <span class="n">basedic</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">mergemode</span><span class="p">,</span>
                         <span class="n">single_block</span><span class="o">=</span><span class="p">[</span><span class="n">basedic</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="n">dic</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]],</span>
                         <span class="n">match_att</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;_item.name&quot;</span><span class="p">],</span><span class="n">match_function</span><span class="o">=</span><span class="n">find_parent</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">CifDic</span><span class="p">(</span><span class="n">basedic</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">find_parent</span><span class="p">(</span><span class="n">ddl2_def</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;_item.name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ddl2_def</span><span class="p">:</span>
       <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ddl2_def</span><span class="p">[</span><span class="s2">&quot;_item.name&quot;</span><span class="p">],</span><span class="nb">unicode</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ddl2_def</span><span class="p">[</span><span class="s2">&quot;_item.name&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;_item_linked.child_name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ddl2_def</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s2">&quot;Asked to find parent in block with no child_names&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;_item_linked.parent_name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ddl2_def</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s2">&quot;Asked to find parent in block with no parent_names&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ddl2_def</span><span class="p">[</span><span class="s2">&quot;_item.name&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ddl2_def</span><span class="p">[</span><span class="s2">&quot;_item_linked.child_name&quot;</span><span class="p">]])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s2">&quot;Unable to find single unique parent data item&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">ReadCif</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">grammar</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span><span class="n">scantype</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span><span class="n">scoping</span><span class="o">=</span><span class="s1">&#39;instance&#39;</span><span class="p">,</span><span class="n">standard</span><span class="o">=</span><span class="s1">&#39;CIF&#39;</span><span class="p">,</span>
            <span class="n">permissive</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Read in a CIF file, returning a `CifFile` object.</span>

<span class="sd">    * `filename` may be a URL, a file</span>
<span class="sd">    path on the local system, or any object with a `read` method.</span>

<span class="sd">    * `grammar` chooses the CIF grammar variant. `1.0` is the original 1992 grammar and `1.1`</span>
<span class="sd">    is identical except for the exclusion of square brackets as the first characters in</span>
<span class="sd">    undelimited datanames. `2.0` will read files in the CIF2.0 standard, and `STAR2` will</span>
<span class="sd">    read files according to the STAR2 publication.  If grammar is `None`, autodetection</span>
<span class="sd">    will be attempted in the order `2.0`, `1.1` and `1.0`. This will always succeed for</span>
<span class="sd">    properly-formed CIF2.0 files.  Note that only Unicode characters in the basic multilingual</span>
<span class="sd">    plane are recognised (this will be fixed when PyCIFRW is ported to Python 3).</span>

<span class="sd">    * `scantype` can be `standard` or `flex`.  `standard` provides pure Python parsing at the</span>
<span class="sd">    cost of a factor of 10 or so in speed.  `flex` will tokenise the input CIF file using</span>
<span class="sd">    fast C routines, but is not available for CIF2/STAR2 files.  Note that running PyCIFRW in</span>
<span class="sd">    Jython uses native Java regular expressions</span>
<span class="sd">    to provide a speedup regardless of this argument (and does not yet support CIF2).</span>

<span class="sd">    * `scoping` is only relevant where nested save frames are expected (STAR2 only).</span>
<span class="sd">    `instance` scoping makes nested save frames</span>
<span class="sd">    invisible outside their hierarchy, allowing duplicate save frame names in separate</span>
<span class="sd">    hierarchies. `dictionary` scoping makes all save frames within a data block visible to each</span>
<span class="sd">    other, thereby restricting all save frames to have unique names.</span>
<span class="sd">    Currently the only recognised value for `standard` is `CIF`, which when set enforces a</span>
<span class="sd">    maximum length of 75 characters for datanames and has no other effect. &quot;&quot;&quot;</span>

    <span class="n">finalcif</span> <span class="o">=</span> <span class="n">CifFile</span><span class="p">(</span><span class="n">scoping</span><span class="o">=</span><span class="n">scoping</span><span class="p">,</span><span class="n">standard</span><span class="o">=</span><span class="n">standard</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">ReadStar</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">prepared</span><span class="o">=</span><span class="n">finalcif</span><span class="p">,</span><span class="n">grammar</span><span class="o">=</span><span class="n">grammar</span><span class="p">,</span><span class="n">scantype</span><span class="o">=</span><span class="n">scantype</span><span class="p">,</span>
                             <span class="n">permissive</span><span class="o">=</span><span class="n">permissive</span><span class="p">)</span>
    <span class="c1">#return StarFile.StarFile(filename,maxlength,scantype=scantype,grammar=grammar,**kwargs)</span>

<span class="k">class</span> <span class="nc">CifLoopBlock</span><span class="p">(</span><span class="n">StarFile</span><span class="o">.</span><span class="n">LoopBlock</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="p">(),</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CifLoopBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="c1">#No documentation flags</span>
</pre></div>

  </div>

  </header>

  <section id="section-items">

    <h2 class="section-title" id="header-functions">Functions</h2>
      
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ReadCif">
    <p>def <span class="ident">ReadCif</span>(</p><p>filename, grammar=u&#39;auto&#39;, scantype=u&#39;standard&#39;, scoping=u&#39;instance&#39;, standard=u&#39;CIF&#39;, permissive=False)</p>
    </div>
    

    
  
    <div class="desc"><p>Read in a CIF file, returning a <code>CifFile</code> object.</p>
<ul>
<li>
<p><code>filename</code> may be a URL, a file
path on the local system, or any object with a <code>read</code> method.</p>
</li>
<li>
<p><code>grammar</code> chooses the CIF grammar variant. <code>1.0</code> is the original 1992 grammar and <code>1.1</code>
is identical except for the exclusion of square brackets as the first characters in
undelimited datanames. <code>2.0</code> will read files in the CIF2.0 standard, and <code>STAR2</code> will
read files according to the STAR2 publication.  If grammar is <code>None</code>, autodetection
will be attempted in the order <code>2.0</code>, <code>1.1</code> and <code>1.0</code>. This will always succeed for
properly-formed CIF2.0 files.  Note that only Unicode characters in the basic multilingual
plane are recognised (this will be fixed when PyCIFRW is ported to Python 3).</p>
</li>
<li>
<p><code>scantype</code> can be <code>standard</code> or <code>flex</code>.  <code>standard</code> provides pure Python parsing at the
cost of a factor of 10 or so in speed.  <code>flex</code> will tokenise the input CIF file using
fast C routines, but is not available for CIF2/STAR2 files.  Note that running PyCIFRW in
Jython uses native Java regular expressions
to provide a speedup regardless of this argument (and does not yet support CIF2).</p>
</li>
<li>
<p><code>scoping</code> is only relevant where nested save frames are expected (STAR2 only).
<code>instance</code> scoping makes nested save frames
invisible outside their hierarchy, allowing duplicate save frame names in separate
hierarchies. <code>dictionary</code> scoping makes all save frames within a data block visible to each
other, thereby restricting all save frames to have unique names.
Currently the only recognised value for <code>standard</code> is <code>CIF</code>, which when set enforces a
maximum length of 75 characters for datanames and has no other effect.</p>
</li>
</ul></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ReadCif', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ReadCif" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">ReadCif</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">grammar</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span><span class="n">scantype</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span><span class="n">scoping</span><span class="o">=</span><span class="s1">&#39;instance&#39;</span><span class="p">,</span><span class="n">standard</span><span class="o">=</span><span class="s1">&#39;CIF&#39;</span><span class="p">,</span>
            <span class="n">permissive</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Read in a CIF file, returning a `CifFile` object.</span>

<span class="sd">    * `filename` may be a URL, a file</span>
<span class="sd">    path on the local system, or any object with a `read` method.</span>

<span class="sd">    * `grammar` chooses the CIF grammar variant. `1.0` is the original 1992 grammar and `1.1`</span>
<span class="sd">    is identical except for the exclusion of square brackets as the first characters in</span>
<span class="sd">    undelimited datanames. `2.0` will read files in the CIF2.0 standard, and `STAR2` will</span>
<span class="sd">    read files according to the STAR2 publication.  If grammar is `None`, autodetection</span>
<span class="sd">    will be attempted in the order `2.0`, `1.1` and `1.0`. This will always succeed for</span>
<span class="sd">    properly-formed CIF2.0 files.  Note that only Unicode characters in the basic multilingual</span>
<span class="sd">    plane are recognised (this will be fixed when PyCIFRW is ported to Python 3).</span>

<span class="sd">    * `scantype` can be `standard` or `flex`.  `standard` provides pure Python parsing at the</span>
<span class="sd">    cost of a factor of 10 or so in speed.  `flex` will tokenise the input CIF file using</span>
<span class="sd">    fast C routines, but is not available for CIF2/STAR2 files.  Note that running PyCIFRW in</span>
<span class="sd">    Jython uses native Java regular expressions</span>
<span class="sd">    to provide a speedup regardless of this argument (and does not yet support CIF2).</span>

<span class="sd">    * `scoping` is only relevant where nested save frames are expected (STAR2 only).</span>
<span class="sd">    `instance` scoping makes nested save frames</span>
<span class="sd">    invisible outside their hierarchy, allowing duplicate save frame names in separate</span>
<span class="sd">    hierarchies. `dictionary` scoping makes all save frames within a data block visible to each</span>
<span class="sd">    other, thereby restricting all save frames to have unique names.</span>
<span class="sd">    Currently the only recognised value for `standard` is `CIF`, which when set enforces a</span>
<span class="sd">    maximum length of 75 characters for datanames and has no other effect. &quot;&quot;&quot;</span>

    <span class="n">finalcif</span> <span class="o">=</span> <span class="n">CifFile</span><span class="p">(</span><span class="n">scoping</span><span class="o">=</span><span class="n">scoping</span><span class="p">,</span><span class="n">standard</span><span class="o">=</span><span class="n">standard</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">ReadStar</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">prepared</span><span class="o">=</span><span class="n">finalcif</span><span class="p">,</span><span class="n">grammar</span><span class="o">=</span><span class="n">grammar</span><span class="p">,</span><span class="n">scantype</span><span class="o">=</span><span class="n">scantype</span><span class="p">,</span>
                             <span class="n">permissive</span><span class="o">=</span><span class="n">permissive</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.Validate">
    <p>def <span class="ident">Validate</span>(</p><p>ciffile, dic=u&#39;&#39;, diclist=[], mergemode=u&#39;replace&#39;, isdic=False)</p>
    </div>
    

    
  
    <div class="desc"><p>Validate the <code>ciffile</code> conforms to the definitions in <code>CifDic</code> object <code>dic</code>, or if <code>dic</code> is missing,
to the results of merging the <code>CifDic</code> objects in <code>diclist</code> according to <code>mergemode</code>.  Flag
<code>isdic</code> indicates that <code>ciffile</code> is a CIF dictionary meaning that save frames should be
accessed for validation and that mandatory_category should be interpreted differently for DDL2.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.Validate', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.Validate" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">Validate</span><span class="p">(</span><span class="n">ciffile</span><span class="p">,</span><span class="n">dic</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">diclist</span><span class="o">=</span><span class="p">[],</span><span class="n">mergemode</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">,</span><span class="n">isdic</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate the `ciffile` conforms to the definitions in `CifDic` object `dic`, or if `dic` is missing,</span>
<span class="sd">    to the results of merging the `CifDic` objects in `diclist` according to `mergemode`.  Flag</span>
<span class="sd">    `isdic` indicates that `ciffile` is a CIF dictionary meaning that save frames should be</span>
<span class="sd">    accessed for validation and that mandatory_category should be interpreted differently for DDL2.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ciffile</span><span class="p">,</span><span class="n">CifFile</span><span class="p">):</span>
        <span class="n">check_file</span> <span class="o">=</span> <span class="n">CifFile</span><span class="p">(</span><span class="n">ciffile</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">check_file</span> <span class="o">=</span> <span class="n">ciffile</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dic</span><span class="p">:</span>
        <span class="n">fulldic</span> <span class="o">=</span> <span class="n">merge_dic</span><span class="p">(</span><span class="n">diclist</span><span class="p">,</span><span class="n">mergemode</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fulldic</span> <span class="o">=</span> <span class="n">dic</span>
    <span class="n">no_matches</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">valid_result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">isdic</span><span class="p">:</span>          <span class="c1">#assume one block only</span>
        <span class="n">check_file</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="s1">&#39;instance&#39;</span> <span class="c1">#only data blocks visible</span>
        <span class="n">top_level</span> <span class="o">=</span> <span class="n">check_file</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">check_file</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="s1">&#39;dictionary&#39;</span>   <span class="c1">#all blocks visible</span>
        <span class="c1"># collect a list of parents for speed</span>
        <span class="k">if</span> <span class="n">fulldic</span><span class="o">.</span><span class="n">diclang</span> <span class="o">==</span> <span class="s1">&#39;DDL2&#39;</span><span class="p">:</span>
            <span class="n">poss_parents</span> <span class="o">=</span> <span class="n">fulldic</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="s2">&quot;_item_linked.parent_name&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">poss_parents</span><span class="p">:</span>
                <span class="n">curr_parent</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">check_file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent</span><span class="p">,[]))</span>
                <span class="n">new_vals</span> <span class="o">=</span> <span class="n">check_file</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
                <span class="n">new_vals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">curr_parent</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_vals</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">check_file</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_vals</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Added </span><span class="si">%s</span><span class="s2"> (len </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">check_file</span><span class="p">[</span><span class="n">parent</span><span class="p">])))</span>
    <span class="c1"># now run the validations</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">check_file</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">isdic</span> <span class="ow">and</span> <span class="n">block</span> <span class="o">==</span> <span class="n">top_level</span><span class="p">:</span>
           <span class="n">block_scope</span> <span class="o">=</span> <span class="s1">&#39;Dictionary&#39;</span>
        <span class="k">elif</span> <span class="n">isdic</span><span class="p">:</span>
           <span class="n">block_scope</span> <span class="o">=</span> <span class="s1">&#39;Item&#39;</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">block_scope</span> <span class="o">=</span> <span class="s1">&#39;Datablock&#39;</span>
        <span class="n">no_matches</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">check_file</span><span class="p">[</span><span class="n">block</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fulldic</span><span class="p">]</span>
        <span class="c1"># remove non-matching items</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Not matched: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">no_matches</span><span class="p">[</span><span class="n">block</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">nogood</span> <span class="ow">in</span> <span class="n">no_matches</span><span class="p">[</span><span class="n">block</span><span class="p">]:</span>
             <span class="k">del</span> <span class="n">check_file</span><span class="p">[</span><span class="n">block</span><span class="p">][</span><span class="n">nogood</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Validating block </span><span class="si">%s</span><span class="s2">, scope </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">block</span><span class="p">,</span><span class="n">block_scope</span><span class="p">))</span>
        <span class="n">valid_result</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_data_checks</span><span class="p">(</span><span class="n">check_file</span><span class="p">[</span><span class="n">block</span><span class="p">],</span><span class="n">fulldic</span><span class="p">,</span><span class="n">block_scope</span><span class="o">=</span><span class="n">block_scope</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">valid_result</span><span class="p">,</span><span class="n">no_matches</span>
</pre></div>

  </div>
</div>

  </div>
  

    <h2 class="section-title" id="header-classes">Classes</h2>
      
      <div class="item">
      <p id="CifFile.CifFile_module.CifBlock" class="name">class <span class="ident">CifBlock</span></p>
      
  
    <div class="desc"><p>A class to hold a single block of a CIF file.  A <code>CifBlock</code> object can be treated as
a Python dictionary, in particular, individual items can be accessed using square
brackets e.g. <code>b['_a_dataname']</code>.  All other Python dictionary methods are also
available (e.g. <code>keys()</code>, <code>values()</code>).  Looped datanames will return a list of values.</p>
<h2>Initialisation</h2>
<p>When provided, <code>data</code> should be another <code>CifBlock</code> whose contents will be copied to
this block.</p>
<ul>
<li>
<p>if <code>strict</code> is set, maximum name lengths will be enforced</p>
</li>
<li>
<p><code>maxoutlength</code> is the maximum length for output lines</p>
</li>
<li>
<p><code>wraplength</code> is the ideal length to make output lines</p>
</li>
<li>
<p>When set, <code>overwrite</code> allows the values of datanames to be changed (otherwise an error
is raised).</p>
</li>
<li>
<p><code>compat_mode</code> will allow deprecated behaviour of creating single-dataname loops using
the syntax <code>a[_dataname] = [1,2,3,4]</code>.  This should now be done by calling <code>CreateLoop</code>
after setting the dataitem value.</p>
</li>
</ul></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CifBlock</span><span class="p">(</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarBlock</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to hold a single block of a CIF file.  A `CifBlock` object can be treated as</span>
<span class="sd">    a Python dictionary, in particular, individual items can be accessed using square</span>
<span class="sd">    brackets e.g. `b[&#39;_a_dataname&#39;]`.  All other Python dictionary methods are also</span>
<span class="sd">    available (e.g. `keys()`, `values()`).  Looped datanames will return a list of values.</span>

<span class="sd">    ## Initialisation</span>

<span class="sd">    When provided, `data` should be another `CifBlock` whose contents will be copied to</span>
<span class="sd">    this block.</span>

<span class="sd">    * if `strict` is set, maximum name lengths will be enforced</span>

<span class="sd">    * `maxoutlength` is the maximum length for output lines</span>

<span class="sd">    * `wraplength` is the ideal length to make output lines</span>

<span class="sd">    * When set, `overwrite` allows the values of datanames to be changed (otherwise an error</span>
<span class="sd">    is raised).</span>

<span class="sd">    * `compat_mode` will allow deprecated behaviour of creating single-dataname loops using</span>
<span class="sd">    the syntax `a[_dataname] = [1,2,3,4]`.  This should now be done by calling `CreateLoop`</span>
<span class="sd">    after setting the dataitem value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span> <span class="o">=</span> <span class="p">(),</span> <span class="n">strict</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">compat_mode</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;When provided, `data` should be another CifBlock whose contents will be copied to</span>
<span class="sd">        this block.</span>

<span class="sd">        * if `strict` is set, maximum name lengths will be enforced</span>

<span class="sd">        * `maxoutlength` is the maximum length for output lines</span>

<span class="sd">        * `wraplength` is the ideal length to make output lines</span>

<span class="sd">        * When set, `overwrite` allows the values of datanames to be changed (otherwise an error</span>
<span class="sd">        is raised).</span>

<span class="sd">        * `compat_mode` will allow deprecated behaviour of creating single-dataname loops using</span>
<span class="sd">        the syntax `a[_dataname] = [1,2,3,4]`.  This should now be done by calling `CreateLoop`</span>
<span class="sd">        after setting the dataitem value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">strict</span><span class="p">:</span> <span class="n">maxnamelength</span><span class="o">=</span><span class="mi">75</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">maxnamelength</span><span class="o">=-</span><span class="mi">1</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CifBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="n">maxnamelength</span><span class="o">=</span><span class="n">maxnamelength</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="bp">None</span>   <span class="c1">#DDL dictionary referring to this block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compat_mode</span> <span class="o">=</span> <span class="n">compat_mode</span>   <span class="c1">#old-style behaviour of setitem</span>

    <span class="k">def</span> <span class="nf">RemoveCifItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove `itemname` from the CifBlock&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RemoveItem</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
        <span class="c1"># for backwards compatibility make a single-element loop</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compat_mode</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarList</span><span class="p">):</span>
                 <span class="c1"># single element loop</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">([</span><span class="n">key</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">newblock</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="o">.</span><span class="n">im_class</span><span class="p">(</span><span class="n">newblock</span><span class="p">)</span>   <span class="c1">#catch inheritance</span>

    <span class="k">def</span> <span class="nf">AddCifItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; *DEPRECATED*. Use `AddItem` instead.&quot;&quot;&quot;</span>
        <span class="c1"># we accept only tuples, strings and lists!!</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">,</span><span class="nb">str</span><span class="p">))):</span>
                  <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Cif datanames are either a string, tuple or list&#39;</span><span class="p">)</span>
        <span class="c1"># we catch single item loops as well...</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AddSingleCifItem</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarList</span><span class="p">):</span>  <span class="c1"># a single element loop</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">return</span>
        <span class="c1"># otherwise, we loop over the datanames</span>
        <span class="n">keyvals</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],[</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">AddSingleCifItem</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">keyvals</span><span class="p">]</span>
        <span class="c1"># and create the loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">AddSingleCifItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` instead&quot;&quot;&quot;</span>
        <span class="sd">&quot;&quot;&quot;Add a single data item. If it is part of a loop, a separate call should be made&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">loopnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">]</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></li>
          <li>CifFile.StarFile.StarBlock</li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.AddCifItem">
    <p>def <span class="ident">AddCifItem</span>(</p><p>self, data)</p>
    </div>
    

    
  
    <div class="desc"><p><em>DEPRECATED</em>. Use <code>AddItem</code> instead.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.AddCifItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.AddCifItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddCifItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; *DEPRECATED*. Use `AddItem` instead.&quot;&quot;&quot;</span>
    <span class="c1"># we accept only tuples, strings and lists!!</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">,</span><span class="nb">str</span><span class="p">))):</span>
              <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Cif datanames are either a string, tuple or list&#39;</span><span class="p">)</span>
    <span class="c1"># we catch single item loops as well...</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AddSingleCifItem</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarList</span><span class="p">):</span>  <span class="c1"># a single element loop</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">return</span>
    <span class="c1"># otherwise, we loop over the datanames</span>
    <span class="n">keyvals</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],[</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">AddSingleCifItem</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">keyvals</span><span class="p">]</span>
    <span class="c1"># and create the loop</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.AddItem">
    <p>def <span class="ident">AddItem</span>(</p><p>self, key, value, precheck=False)</p>
    </div>
    

    
  
    <div class="desc"><p>Add dataname <code>key</code> to block with value <code>value</code>.  <code>value</code> may be
a single value, a list or a tuple. If <code>precheck</code> is False (the default),
all values will be checked and converted to unicode strings as necessary. If
<code>precheck</code> is True, this checking is bypassed.  No checking is necessary
when values are read from a CIF file as they are already in correct form.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.AddItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.AddItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">precheck</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add dataname `key` to block with value `value`.  `value` may be</span>
<span class="sd">    a single value, a list or a tuple. If `precheck` is False (the default),</span>
<span class="sd">    all values will be checked and converted to unicode strings as necessary. If</span>
<span class="sd">    `precheck` is True, this checking is bypassed.  No checking is necessary</span>
<span class="sd">    when values are read from a CIF file as they are already in correct form.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
         <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Star datanames are strings only (got </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">key</span> <span class="p">))</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>    <span class="c1">#everything is unicode internally</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">precheck</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">check_data_name</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxnamelength</span><span class="p">)</span>    <span class="c1"># make sure no nasty characters</span>
    <span class="c1"># check for overwriting</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
             <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Attempt to insert duplicate item name </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">precheck</span><span class="p">:</span>   <span class="c1">#need to sanitise</span>
        <span class="n">regval</span><span class="p">,</span><span class="n">empty_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularise_data</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">pure_string</span> <span class="o">=</span> <span class="n">check_stringiness</span><span class="p">(</span><span class="n">regval</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_item_value</span><span class="p">(</span><span class="n">regval</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">regval</span><span class="p">,</span><span class="n">empty_val</span> <span class="o">=</span> <span class="n">value</span><span class="p">,</span><span class="bp">None</span>
        <span class="n">pure_string</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c1"># update ancillary information first</span>
    <span class="n">lower_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lower_key</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">lower_key</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>      <span class="c1">#need to add to order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lower_key</span><span class="p">)</span>
    <span class="c1"># always remove from our case table in case the case is different</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">lower_key</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">lower_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
    <span class="k">if</span> <span class="n">pure_string</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">lower_key</span><span class="p">:[</span><span class="n">regval</span><span class="p">,</span><span class="n">empty_val</span><span class="p">]})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">lower_key</span><span class="p">:[</span><span class="n">empty_val</span><span class="p">,</span><span class="n">regval</span><span class="p">]})</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.AddLoopItem">
    <p>def <span class="ident">AddLoopItem</span>(</p><p>self, incomingdata, precheck=False, maxlength=-1)</p>
    </div>
    

    
  
    <div class="desc"><p><em>Deprecated</em>. Use <code>AddItem</code> followed by <code>CreateLoop</code> if
necessary.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.AddLoopItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.AddLoopItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddLoopItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">incomingdata</span><span class="p">,</span><span class="n">precheck</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">maxlength</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` followed by `CreateLoop` if</span>
<span class="sd">    necessary.&quot;&quot;&quot;</span>
    <span class="c1"># print &quot;Received data %s&quot; % `incomingdata`</span>
    <span class="c1"># we accept tuples, strings, lists and dicts!!</span>
    <span class="c1"># Direct insertion: we have a string-valued key, with an array</span>
    <span class="c1"># of values -&gt; single-item into our loop</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
       <span class="c1"># a whole loop</span>
       <span class="n">keyvallist</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
       <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">keyvallist</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
         <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Star datanames are strings only (got </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.AddLoopName">
    <p>def <span class="ident">AddLoopName</span>(</p><p>self, oldname, newname)</p>
    </div>
    

    
  
    <div class="desc"><p>Add <code>newname</code> to the loop containing <code>oldname</code>. If it is already in the new loop, no
error is raised.  If <code>newname</code> is in a different loop, it is removed from that loop.
The number of values associated with <code>newname</code> must match the number of values associated
with all other columns of the new loop or a <code>ValueError</code> will be raised.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.AddLoopName', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.AddLoopName" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddLoopName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldname</span><span class="p">,</span> <span class="n">newname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add `newname` to the loop containing `oldname`. If it is already in the new loop, no</span>
<span class="sd">    error is raised.  If `newname` is in a different loop, it is removed from that loop.</span>
<span class="sd">    The number of values associated with `newname` must match the number of values associated</span>
<span class="sd">    with all other columns of the new loop or a `ValueError` will be raised.&quot;&quot;&quot;</span>
    <span class="n">lower_newname</span> <span class="o">=</span> <span class="n">newname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">oldname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not in loop&#39;</span> <span class="o">%</span> <span class="n">oldname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lower_newname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]:</span>
        <span class="k">return</span>
    <span class="c1"># check length</span>
    <span class="n">old_provides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">oldname</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="n">old_provides</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">newname</span><span class="p">])</span> <span class="o">!=</span> <span class="n">loop_len</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Mismatch of loop column lengths for </span><span class="si">%s</span><span class="s1">: should be </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="n">loop_len</span><span class="p">))</span>
    <span class="c1"># remove from any other loops</span>
    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="k">if</span> <span class="n">lower_newname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
    <span class="c1"># and add to this loop</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span>
    <span class="c1"># remove from item_order if present</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.AddSingleCifItem">
    <p>def <span class="ident">AddSingleCifItem</span>(</p><p>self, key, value)</p>
    </div>
    

    
  
    <div class="desc"><p><em>Deprecated</em>. Use <code>AddItem</code> instead</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.AddSingleCifItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.AddSingleCifItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddSingleCifItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` instead&quot;&quot;&quot;</span>
    <span class="sd">&quot;&quot;&quot;Add a single data item. If it is part of a loop, a separate call should be made&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.AddToLoop">
    <p>def <span class="ident">AddToLoop</span>(</p><p>self, dataname, loopdata)</p>
    </div>
    

    
  
    <div class="desc"><p><em>Deprecated</em>. Use <code>AddItem</code> followed by calls to <code>AddLoopName</code>.</p>
<p>Add multiple columns to the loop containing <code>dataname</code>. <code>loopdata</code> is a
collection of (key,value) pairs, where <code>key</code> is the new dataname and <code>value</code>
is a list of values for that dataname</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.AddToLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.AddToLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` followed by calls to `AddLoopName`.</span>
<span class="sd">    Add multiple columns to the loop containing `dataname`. `loopdata` is a</span>
<span class="sd">    collection of (key,value) pairs, where `key` is the new dataname and `value`</span>
<span class="sd">    is a list of values for that dataname&quot;&quot;&quot;</span>
    <span class="c1"># check lengths</span>
    <span class="n">thisloop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
    <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">dataname</span><span class="p">])</span>
    <span class="n">bad_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">!=</span><span class="n">loop_len</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_vals</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
       <span class="k">raise</span> <span class="n">StarLengthError</span><span class="p">(</span><span class="s2">&quot;Number of values for looped datanames </span><span class="si">%s</span><span class="s2"> not equal to </span><span class="si">%d</span><span class="s2">&quot;</span> \
           <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">bad_vals</span> <span class="p">),</span><span class="n">loop_len</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loopdata</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">thisloop</span><span class="p">]</span><span class="o">+=</span><span class="n">loopdata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.ChangeItemOrder">
    <p>def <span class="ident">ChangeItemOrder</span>(</p><p>self, itemname, newpos)</p>
    </div>
    

    
  
    <div class="desc"><p>Move the printout order of <code>itemname</code> to <code>newpos</code>. If <code>itemname</code> is
in a loop, <code>newpos</code> refers to the order within the loop.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.ChangeItemOrder', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.ChangeItemOrder" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">ChangeItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">,</span><span class="n">newpos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Move the printout order of `itemname` to `newpos`. If `itemname` is</span>
<span class="sd">    in a loop, `newpos` refers to the order within the loop.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemname</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
        <span class="n">true_name</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">true_name</span> <span class="o">=</span> <span class="n">itemname</span>
    <span class="n">loopno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">true_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loopno</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1">#top level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">true_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">newpos</span><span class="p">,</span><span class="n">true_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loopno</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">true_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loopno</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">newpos</span><span class="p">,</span><span class="n">true_name</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.CreateLoop">
    <p>def <span class="ident">CreateLoop</span>(</p><p>self, datanames, order=-1, length_check=True)</p>
    </div>
    

    
  
    <div class="desc"><p>Create a loop in the datablock. <code>datanames</code> is a list of datanames that
together form a loop.  If length_check is True, they should have been initialised in the block
to have the same number of elements (possibly 0). If <code>order</code> is given,
the loop will appear at this position in the block when printing
out. A loop counts as a single position.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.CreateLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.CreateLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">CreateLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">datanames</span><span class="p">,</span><span class="n">order</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">length_check</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;Create a loop in the datablock. `datanames` is a list of datanames that</span>
<span class="sd">       together form a loop.  If length_check is True, they should have been initialised in the block</span>
<span class="sd">       to have the same number of elements (possibly 0). If `order` is given,</span>
<span class="sd">       the loop will appear at this position in the block when printing</span>
<span class="sd">       out. A loop counts as a single position.&quot;&quot;&quot;</span>
       <span class="k">if</span> <span class="n">length_check</span><span class="p">:</span>
           <span class="c1"># check lengths: these datanames should exist</span>
           <span class="n">listed_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">datanames</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">StarList</span><span class="p">)]</span>
           <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listed_values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">datanames</span><span class="p">):</span>
               <span class="n">len_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">datanames</span><span class="p">])</span>
               <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">len_set</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                   <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Request to loop datanames </span><span class="si">%s</span><span class="s1"> with different lengths: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">datanames</span> <span class="p">),</span><span class="nb">repr</span><span class="p">(</span> <span class="n">len_set</span> <span class="p">)))</span>
           <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">listed_values</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
               <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Request to loop datanames where some are single values and some are not&#39;</span><span class="p">)</span>
       <span class="c1"># store as lower case</span>
       <span class="n">lc_datanames</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datanames</span><span class="p">]</span>
       <span class="c1"># remove these datanames from all other loops</span>
       <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">lc_datanames</span> <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
       <span class="c1"># remove empty loops</span>
       <span class="n">empty_loops</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
       <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">empty_loops</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
           <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
       <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
           <span class="n">loopno</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="n">loopno</span> <span class="o">=</span> <span class="mi">1</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loopno</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lc_datanames</span><span class="p">)</span>
       <span class="k">if</span> <span class="n">order</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="n">loopno</span><span class="p">)</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loopno</span><span class="p">)</span>
       <span class="c1"># remove these datanames from item ordering</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lc_datanames</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.FindLoop">
    <p>def <span class="ident">FindLoop</span>(</p><p>self, keyname)</p>
    </div>
    

    
  
    <div class="desc"><p>Find the loop that contains <code>keyname</code> and return its numerical index or
-1 if not present. The numerical index can be used to refer to the loop in
other routines.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.FindLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.FindLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">FindLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the loop that contains `keyname` and return its numerical index or</span>
<span class="sd">    -1 if not present. The numerical index can be used to refer to the loop in</span>
<span class="sd">    other routines.&quot;&quot;&quot;</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">keyname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loop_no</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">loop_no</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.GetCompoundKeyedPacket">
    <p>def <span class="ident">GetCompoundKeyedPacket</span>(</p><p>self, keydict)</p>
    </div>
    

    
  
    <div class="desc"><p>Return the loop packet (a <code>StarPacket</code> object) where the <code>{key:(value,caseless)}</code> pairs
in <code>keydict</code> take the appropriate values. Ignore case for a given <code>key</code> if <code>caseless</code> is
True.  <code>ValueError</code> is raised if no packet is found or more than one packet is found.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.GetCompoundKeyedPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.GetCompoundKeyedPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetCompoundKeyedPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keydict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the loop packet (a `StarPacket` object) where the `{key:(value,caseless)}` pairs</span>
<span class="sd">    in `keydict` take the appropriate values. Ignore case for a given `key` if `caseless` is</span>
<span class="sd">    True.  `ValueError` is raised if no packet is found or more than one packet is found.&quot;&quot;&quot;</span>
    <span class="c1">#print &quot;Looking for %s in %s&quot; % (keyvalue, self.parent_block[keyname])</span>
    <span class="n">keynames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keydict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">my_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">keynames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="n">keynames</span><span class="p">:</span>
        <span class="n">keyval</span><span class="p">,</span><span class="n">no_case</span> <span class="o">=</span> <span class="n">keydict</span><span class="p">[</span><span class="n">one_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">no_case</span><span class="p">:</span>
           <span class="n">my_loop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">one_key</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="nb">str</span><span class="p">(</span><span class="n">keyval</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">my_loop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">one_key</span><span class="p">)</span><span class="o">==</span><span class="n">keyval</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_loop</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad packet keys </span><span class="si">%s</span><span class="s2">: returned </span><span class="si">%d</span><span class="s2"> packets&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">keydict</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">my_loop</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Compound keyed packet: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">my_loop</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">my_loop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.GetFullItemValue">
    <p>def <span class="ident">GetFullItemValue</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p>Return the value associated with <code>itemname</code>, and a boolean flagging whether
(True) or not (False) it is in a form suitable for calculation.  False is
always returned for strings and <code>StarList</code> objects.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.GetFullItemValue', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.GetFullItemValue" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetFullItemValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the value associated with `itemname`, and a boolean flagging whether</span>
<span class="sd">    (True) or not (False) it is in a form suitable for calculation.  False is</span>
<span class="sd">    always returned for strings and `StarList` objects.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Itemname </span><span class="si">%s</span><span class="s1"> not in datablock&#39;</span> <span class="o">%</span> <span class="n">itemname</span><span class="p">)</span>
    <span class="c1"># prefer string value unless all are None</span>
    <span class="c1"># are we a looped value?</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">StarList</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">not_none</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">,</span><span class="bp">False</span>    <span class="c1">#a string value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">StarList</span><span class="p">)</span>  <span class="c1">#a StarList is not calculation-ready</span>
    <span class="k">elif</span> <span class="n">not_none</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">,</span><span class="bp">False</span>         <span class="c1">#a list of string values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">StarList</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="bp">True</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.GetItemOrder">
    <p>def <span class="ident">GetItemOrder</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a list of datanames in the order in which they will be printed.  Loops are
referred to by numerical index</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.GetItemOrder', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.GetItemOrder" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a list of datanames in the order in which they will be printed.  Loops are</span>
<span class="sd">    referred to by numerical index&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">[:]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.GetItemPosition">
    <p>def <span class="ident">GetItemPosition</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p>A utility function to get the numerical order in the printout
of <code>itemname</code>.  An item has coordinate <code>(loop_no,pos)</code> with
the top level having a <code>loop_no</code> of -1.  If an integer is passed to
the routine then it will return the position of the loop
referenced by that number.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.GetItemPosition', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.GetItemPosition" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetItemPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A utility function to get the numerical order in the printout</span>
<span class="sd">    of `itemname`.  An item has coordinate `(loop_no,pos)` with</span>
<span class="sd">    the top level having a `loop_no` of -1.  If an integer is passed to</span>
<span class="sd">    the routine then it will return the position of the loop</span>
<span class="sd">    referenced by that number.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemname</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
        <span class="c1"># return loop position</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">itemname</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">itemname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No such dataname </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">itemname</span><span class="p">)</span>
    <span class="n">testname</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">testname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">))</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
    <span class="n">loop_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loop_no</span><span class="p">,</span><span class="n">loop_pos</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.GetItemValue">
    <p>def <span class="ident">GetItemValue</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p>Return value of <code>itemname</code>.  If <code>itemname</code> is looped, a list
of all values will be returned.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.GetItemValue', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.GetItemValue" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetItemValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return value of `itemname`.  If `itemname` is looped, a list</span>
<span class="sd">    of all values will be returned.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetFullItemValue</span><span class="p">(</span><span class="n">itemname</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.GetKeyedPacket">
    <p>def <span class="ident">GetKeyedPacket</span>(</p><p>self, keyname, keyvalue, no_case=False)</p>
    </div>
    

    
  
    <div class="desc"><p>Return the loop packet (a <code>StarPacket</code> object) where <code>keyname</code> has value
<code>keyvalue</code>. Ignore case in <code>keyvalue</code> if <code>no_case</code> is True.  <code>ValueError</code>
is raised if no packet is found or more than one packet is found.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.GetKeyedPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.GetKeyedPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetKeyedPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">no_case</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the loop packet (a `StarPacket` object) where `keyname` has value</span>
<span class="sd">    `keyvalue`. Ignore case in `keyvalue` if `no_case` is True.  `ValueError`</span>
<span class="sd">    is raised if no packet is found or more than one packet is found.&quot;&quot;&quot;</span>
    <span class="n">my_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
    <span class="c1">#print(&quot;Looking for %s in %s&quot; % (keyvalue, my_loop.parent_block))</span>
    <span class="c1">#print(&#39;Packet check on:&#39; + keyname)</span>
    <span class="c1">#[print(repr(getattr(a,keyname))) for a in my_loop]</span>
    <span class="k">if</span> <span class="n">no_case</span><span class="p">:</span>
       <span class="n">one_pack</span><span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="n">keyvalue</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
       <span class="n">one_pack</span><span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span><span class="o">==</span><span class="n">keyvalue</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">one_pack</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad packet key </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">: returned </span><span class="si">%d</span><span class="s2"> packets&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">keyname</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">one_pack</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Keyed packet: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">one_pack</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">one_pack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.GetKeyedSemanticPacket">
    <p>def <span class="ident">GetKeyedSemanticPacket</span>(</p><p>self, keyvalue, cat_id)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a complete packet for category <code>cat_id</code> where the
category key for the category equals <code>keyvalue</code>.  This routine
will understand any joined loops, so if separate loops in the
datafile belong to the
same category hierarchy (e.g. <code>_atom_site</code> and <code>_atom_site_aniso</code>),
the returned <code>StarPacket</code> object will contain datanames from
both categories.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.GetKeyedSemanticPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.GetKeyedSemanticPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetKeyedSemanticPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">cat_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a complete packet for category `cat_id` where the</span>
<span class="sd">    category key for the category equals `keyvalue`.  This routine</span>
<span class="sd">    will understand any joined loops, so if separate loops in the</span>
<span class="sd">    datafile belong to the</span>
<span class="sd">    same category hierarchy (e.g. `_atom_site` and `_atom_site_aniso`),</span>
<span class="sd">    the returned `StarPacket` object will contain datanames from</span>
<span class="sd">    both categories.&quot;&quot;&quot;</span>
    <span class="n">target_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">[</span><span class="n">cat_id</span><span class="p">]</span>
    <span class="n">target_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">]</span> <span class="c1">#one only in each list</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">()</span>
    <span class="c1"># set case-sensitivity flag</span>
    <span class="n">lcase</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;_type.contents&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Code&#39;</span><span class="p">,</span><span class="s1">&#39;Tag&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">]:</span>
        <span class="n">lcase</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">cat_key</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">extra_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetKeyedPacket</span><span class="p">(</span><span class="n">cat_key</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">no_case</span><span class="o">=</span><span class="n">lcase</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>        <span class="c1">#missing key</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">test_key</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">cat_key</span><span class="p">]</span>  <span class="c1">#generate key if possible</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Test key is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">test_key</span> <span class="p">))</span>
                <span class="k">if</span> <span class="n">test_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>\
                <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">test_key</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">None</span> <span class="ow">in</span> <span class="n">test_key</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_key</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Getting packet for key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">keyvalue</span> <span class="p">))</span>
                    <span class="n">extra_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetKeyedPacket</span><span class="p">(</span><span class="n">cat_key</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">no_case</span><span class="o">=</span><span class="n">lcase</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>             <span class="c1">#cannot be generated</span>
                <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>      <span class="c1">#none/more than one, assume none</span>
            <span class="k">continue</span>
            <span class="c1">#extra_packet = self.dictionary.generate_default_packet(cat_id,cat_key,keyvalue)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">merge_packet</span><span class="p">(</span><span class="n">extra_packet</span><span class="p">)</span>
    <span class="c1"># the following attributes used to calculate missing values</span>
    <span class="k">for</span> <span class="n">keyname</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="n">keyname</span><span class="p">]</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No key found for </span><span class="si">%s</span><span class="s2">, packet is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cat_id</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">cif_dictionary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span>
    <span class="n">p</span><span class="o">.</span><span class="n">fulldata</span> <span class="o">=</span> <span class="bp">self</span>
    <span class="k">return</span> <span class="n">p</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.GetLoop">
    <p>def <span class="ident">GetLoop</span>(</p><p>self, keyname)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a <code>StarFile.LoopBlock</code> object constructed from the loop containing <code>keyname</code>.
<code>keyname</code> is only significant as a way to specify the loop.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.GetLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.GetLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a `StarFile.LoopBlock` object constructed from the loop containing `keyname`.</span>
<span class="sd">    `keyname` is only significant as a way to specify the loop.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">LoopBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.GetLoopNames">
    <p>def <span class="ident">GetLoopNames</span>(</p><p>self, keyname)</p>
    </div>
    

    
  
    <div class="desc"><p>Return all datanames appearing together with <code>keyname</code></p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.GetLoopNames', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.GetLoopNames" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetLoopNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return all datanames appearing together with `keyname`&quot;&quot;&quot;</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not in any loop&#39;</span> <span class="o">%</span> <span class="n">keyname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.GetMultiKeyedSemanticPacket">
    <p>def <span class="ident">GetMultiKeyedSemanticPacket</span>(</p><p>self, keydict, cat_id)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a complete packet for category <code>cat_id</code> where the keyvalues are
provided as a dictionary of key:(value,caseless) pairs
This routine
will understand any joined loops, so if separate loops in the
datafile belong to the
same category hierarchy (e.g. <code>_atom_site</code> and <code>_atom_site_aniso</code>),
the returned <code>StarPacket</code> object will contain datanames from
the requested category and any children.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.GetMultiKeyedSemanticPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.GetMultiKeyedSemanticPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetMultiKeyedSemanticPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keydict</span><span class="p">,</span><span class="n">cat_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a complete packet for category `cat_id` where the keyvalues are</span>
<span class="sd">    provided as a dictionary of key:(value,caseless) pairs</span>
<span class="sd">    This routine</span>
<span class="sd">    will understand any joined loops, so if separate loops in the</span>
<span class="sd">    datafile belong to the</span>
<span class="sd">    same category hierarchy (e.g. `_atom_site` and `_atom_site_aniso`),</span>
<span class="sd">    the returned `StarPacket` object will contain datanames from</span>
<span class="sd">    the requested category and any children.&quot;&quot;&quot;</span>
    <span class="c1">#if len(keyvalues)==1:   #simplification</span>
    <span class="c1">#    return self.GetKeyedSemanticPacket(keydict[1][0],cat_id)</span>
    <span class="n">target_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">[</span><span class="n">cat_id</span><span class="p">]</span>
    <span class="c1"># update the dictionary passed to us with all equivalents, for</span>
    <span class="c1"># simplicity.</span>
    <span class="n">parallel_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">target_keys</span><span class="p">))</span>  <span class="c1">#transpose</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Parallel keys:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">parallel_keys</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Keydict:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">keydict</span><span class="p">))</span>
    <span class="n">start_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keydict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">one_name</span> <span class="ow">in</span> <span class="n">start_keys</span><span class="p">:</span>
        <span class="n">key_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">parallel_keys</span> <span class="k">if</span> <span class="n">one_name</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="n">key_set</span><span class="p">:</span>
            <span class="n">keydict</span><span class="p">[</span><span class="n">one_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">keydict</span><span class="p">[</span><span class="n">one_name</span><span class="p">]</span>
    <span class="c1"># target_keys is a list of lists, each of which is a compound key</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">()</span>
    <span class="c1"># a little function to return the dataname for a key</span>
    <span class="k">def</span> <span class="nf">find_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">key_equivs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,[])</span><span class="o">+</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">one_key</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">one_key</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">one_set</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">:</span> <span class="c1">#loop down the categories</span>
        <span class="n">true_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">find_key</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">one_set</span><span class="p">]</span>
        <span class="n">true_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">true_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_keys</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">one_set</span><span class="p">):</span>
            <span class="n">truekeydict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">t</span><span class="p">,</span><span class="n">keydict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">true_keys</span><span class="p">,</span><span class="n">one_set</span><span class="p">)])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">extra_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetCompoundKeyedPacket</span><span class="p">(</span><span class="n">truekeydict</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>     <span class="c1">#one or more are missing</span>
                <span class="k">continue</span>         <span class="c1">#should try harder?</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Merging packet for keys &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">one_set</span><span class="p">))</span>
        <span class="n">p</span><span class="o">.</span><span class="n">merge_packet</span><span class="p">(</span><span class="n">extra_packet</span><span class="p">)</span>
    <span class="c1"># the following attributes used to calculate missing values</span>
    <span class="n">p</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">true_keys</span>
    <span class="n">p</span><span class="o">.</span><span class="n">cif_dictionary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span>
    <span class="n">p</span><span class="o">.</span><span class="n">fulldata</span> <span class="o">=</span> <span class="bp">self</span>
    <span class="k">return</span> <span class="n">p</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.RemoveCifItem">
    <p>def <span class="ident">RemoveCifItem</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p>Remove <code>itemname</code> from the CifBlock</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.RemoveCifItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.RemoveCifItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">RemoveCifItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove `itemname` from the CifBlock&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">RemoveItem</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.RemoveItem">
    <p>def <span class="ident">RemoveItem</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p>Remove <code>itemname</code> from the block.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.RemoveItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.RemoveItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">RemoveItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove `itemname` from the block.&quot;&quot;&quot;</span>
    <span class="c1"># first check any loops</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>
    <span class="n">testkey</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">testkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
        <span class="c1"># now remove from loop</span>
        <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">loop_no</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1">#will appear in order list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.RemoveKeyedPacket">
    <p>def <span class="ident">RemoveKeyedPacket</span>(</p><p>self, keyname, keyvalue)</p>
    </div>
    

    
  
    <div class="desc"><p>Remove the packet for which dataname <code>keyname</code> takes
value <code>keyvalue</code>.  Only the first such occurrence is
removed.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.RemoveKeyedPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.RemoveKeyedPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">RemoveKeyedPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove the packet for which dataname `keyname` takes</span>
<span class="sd">    value `keyvalue`.  Only the first such occurrence is</span>
<span class="sd">    removed.&quot;&quot;&quot;</span>
    <span class="n">packet_coord</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">keyname</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">keyvalue</span><span class="p">)</span>
    <span class="n">loopnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoopNames</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dataname</span> <span class="ow">in</span> <span class="n">loopnames</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">packet_coord</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">packet_coord</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.RemoveLoopItem">
    <p>def <span class="ident">RemoveLoopItem</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p><em>Deprecated</em>. Use <code>RemoveItem</code> instead</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.RemoveLoopItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.RemoveLoopItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">RemoveLoopItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `RemoveItem` instead&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">RemoveItem</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifBlock.SetOutputLength">
    <p>def <span class="ident">SetOutputLength</span>(</p><p>self, wraplength=80, maxoutlength=2048)</p>
    </div>
    

    
  
    <div class="desc"><p>Set the maximum output line length (<code>maxoutlength</code>) and the line length to
wrap at (<code>wraplength</code>).  The wrap length is a target only and may not always be
possible.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifBlock.SetOutputLength', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifBlock.SetOutputLength" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">SetOutputLength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wraplength</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">maxoutlength</span><span class="o">=</span><span class="mi">2048</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the maximum output line length (`maxoutlength`) and the line length to</span>
<span class="sd">    wrap at (`wraplength`).  The wrap length is a target only and may not always be</span>
<span class="sd">    possible.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">wraplength</span> <span class="o">&gt;</span> <span class="n">maxoutlength</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;Wrap length (requested </span><span class="si">%d</span><span class="s2">) must be &lt;= Maximum line length (requested </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wraplength</span><span class="p">,</span><span class="n">maxoutlength</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wraplength</span> <span class="o">=</span> <span class="n">wraplength</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span> <span class="o">=</span> <span class="n">maxoutlength</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.CifFile_module.CifDic" class="name">class <span class="ident">CifDic</span></p>
      
  
    <div class="desc"><p>Create a Cif Dictionary object from the provided source, which can
be a filename/URL or a CifFile.  Optional arguments (relevant to DDLm
only):</p>
<ul>
<li>
<p>do_minimum (Boolean):
     Do not set up the dREL system for auto-calculation or perform
     imports.  This implies do_imports=False and do_dREL=False</p>
</li>
<li>
<p>do_imports = No/Full/Contents/All:
     If not 'No', intepret _import.get statements for
     Full mode/Contents mode/Both respectively. See also option 'heavy'</p>
</li>
<li>
<p>do_dREL = True/False:
     Parse and convert all dREL methods to Python. Implies do_imports=All</p>
</li>
<li>
<p>heavy = True/False:
     (Experimental). If True, importation overwrites definitions. If False,
     attributes are resolved dynamically.</p>
</li>
</ul></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifDic', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifDic" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CifDic</span><span class="p">(</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a Cif Dictionary object from the provided source, which can</span>
<span class="sd">    be a filename/URL or a CifFile.  Optional arguments (relevant to DDLm</span>
<span class="sd">    only):</span>

<span class="sd">    * do_minimum (Boolean):</span>
<span class="sd">         Do not set up the dREL system for auto-calculation or perform</span>
<span class="sd">         imports.  This implies do_imports=False and do_dREL=False</span>

<span class="sd">    * do_imports = No/Full/Contents/All:</span>
<span class="sd">         If not &#39;No&#39;, intepret _import.get statements for</span>
<span class="sd">         Full mode/Contents mode/Both respectively. See also option &#39;heavy&#39;</span>

<span class="sd">    * do_dREL = True/False:</span>
<span class="sd">         Parse and convert all dREL methods to Python. Implies do_imports=All</span>

<span class="sd">    * heavy = True/False:</span>
<span class="sd">         (Experimental). If True, importation overwrites definitions. If False,</span>
<span class="sd">         attributes are resolved dynamically.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dic</span><span class="p">,</span><span class="n">do_minimum</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">do_imports</span><span class="o">=</span><span class="s1">&#39;All&#39;</span><span class="p">,</span> <span class="n">do_dREL</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">grammar</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span><span class="n">heavy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_minimum</span> <span class="o">=</span> <span class="n">do_minimum</span>
        <span class="k">if</span> <span class="n">do_minimum</span><span class="p">:</span>
            <span class="n">do_imports</span> <span class="o">=</span> <span class="s1">&#39;No&#39;</span>
            <span class="n">do_dREL</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">do_dREL</span><span class="p">:</span> <span class="n">do_imports</span> <span class="o">=</span> <span class="s1">&#39;All&#39;</span>
        <span class="k">if</span> <span class="n">heavy</span> <span class="o">==</span> <span class="s1">&#39;Light&#39;</span> <span class="ow">and</span> <span class="n">do_imports</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;contents&#39;</span><span class="p">,</span><span class="s1">&#39;No&#39;</span><span class="p">):</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span><span class="s2">&quot;Light imports only available for mode &#39;contents&#39;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_cache</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1">#for DDLm imports</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_functions</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1">#for DDLm functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">switch_numpy</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>    <span class="c1">#no Numpy arrays returned</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">datasource</span><span class="o">=</span><span class="n">dic</span><span class="p">,</span><span class="n">grammar</span><span class="o">=</span><span class="n">grammar</span><span class="p">,</span><span class="n">blocktype</span><span class="o">=</span><span class="n">DicBlock</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">=</span> <span class="s1">&#39;Dic&#39;</span>    <span class="c1">#for correct output order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="s1">&#39;dictionary&#39;</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dicname</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">diclang</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_determine</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is a </span><span class="si">%s</span><span class="s1"> dictionary&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dicname</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">diclang</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scopes_mandatory</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scopes_naughty</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># rename and expand out definitions using &quot;_name&quot; in DDL dictionaries</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diclang</span> <span class="o">==</span> <span class="s2">&quot;DDL1&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DDL1_normalise</span><span class="p">()</span>   <span class="c1">#this removes any non-definition entries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_def_block_table</span><span class="p">()</span> <span class="c1">#From now on, [] uses definition_id</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diclang</span> <span class="o">==</span> <span class="s2">&quot;DDL1&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ddl1_cat_load</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">diclang</span> <span class="o">==</span> <span class="s2">&quot;DDL2&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DDL2_normalise</span><span class="p">()</span>   <span class="c1">#iron out some DDL2 tricky bits</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">diclang</span> <span class="o">==</span> <span class="s2">&quot;DDLm&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="s1">&#39;dictionary&#39;</span>   <span class="c1">#expose all save frames</span>
            <span class="k">if</span> <span class="n">do_imports</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obtain_imports</span><span class="p">(</span><span class="n">import_mode</span><span class="o">=</span><span class="n">do_imports</span><span class="p">,</span><span class="n">heavy</span><span class="o">=</span><span class="n">heavy</span><span class="p">)</span><span class="c1">#recursively calls this routine</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_alias_table</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_cat_obj_table</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_cat_key_table</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">do_dREL</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Doing full dictionary initialisation&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialise_drel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_category_info</span><span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="n">do_dREL</span><span class="p">)</span>
        <span class="c1"># initialise type information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">typedic</span><span class="o">=</span><span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primdic</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1">#typecode&lt;-&gt;primitive type translation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_type_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install_validation_functions</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">dic_determine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;on_this_dictionary&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="s2">&quot;on_this_dictionary&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">def_id_spec</span> <span class="o">=</span> <span class="s2">&quot;_name&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cat_id_spec</span> <span class="o">=</span> <span class="s2">&quot;_category.id&quot;</span>   <span class="c1">#we add this ourselves</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type_spec</span> <span class="o">=</span> <span class="s2">&quot;_type&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enum_spec</span> <span class="o">=</span> <span class="s2">&quot;_enumeration&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cat_spec</span> <span class="o">=</span> <span class="s2">&quot;_category&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">esd_spec</span> <span class="o">=</span> <span class="s2">&quot;_type_conditions&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">must_loop_spec</span> <span class="o">=</span> <span class="s2">&quot;_list&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">must_exist_spec</span> <span class="o">=</span> <span class="s2">&quot;_list_mandatory&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_ref_spec</span> <span class="o">=</span> <span class="s2">&quot;_list_reference&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key_spec</span> <span class="o">=</span> <span class="s2">&quot;_list_mandatory&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unique_spec</span> <span class="o">=</span> <span class="s2">&quot;_list_uniqueness&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">child_spec</span> <span class="o">=</span> <span class="s2">&quot;_list_link_child&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent_spec</span> <span class="o">=</span> <span class="s2">&quot;_list_link_parent&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">related_func</span> <span class="o">=</span> <span class="s2">&quot;_related_function&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">related_item</span> <span class="o">=</span> <span class="s2">&quot;_related_item&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">primitive_type</span> <span class="o">=</span> <span class="s2">&quot;_type&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dep_spec</span> <span class="o">=</span> <span class="s2">&quot;xxx&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cat_list</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1">#to save searching all the time</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="s2">&quot;on_this_dictionary&quot;</span><span class="p">)[</span><span class="s2">&quot;_dictionary_name&quot;</span><span class="p">]</span>
            <span class="n">version</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="s2">&quot;on_this_dictionary&quot;</span><span class="p">)[</span><span class="s2">&quot;_dictionary_version&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="n">version</span><span class="p">,</span><span class="s2">&quot;DDL1&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_roots</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>              <span class="c1"># DDL2/DDLm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># now change to dictionary scoping</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">=</span> <span class="s1">&#39;dictionary&#39;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="p">[</span><span class="s2">&quot;_dictionary.title&quot;</span><span class="p">]</span>
            <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="p">[</span><span class="s2">&quot;_dictionary.version&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;_dictionary.class&quot;</span><span class="p">):</span>   <span class="c1">#DDLm</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enum_spec</span> <span class="o">=</span> <span class="s1">&#39;_enumeration_set.state&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">key_spec</span> <span class="o">=</span> <span class="s1">&#39;_category.key_id&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">must_exist_spec</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cat_spec</span> <span class="o">=</span> <span class="s1">&#39;_name.category_id&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">primitive_type</span> <span class="o">=</span> <span class="s1">&#39;_type.contents&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cat_id_spec</span> <span class="o">=</span> <span class="s2">&quot;_definition.id&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">def_id_spec</span> <span class="o">=</span> <span class="s2">&quot;_definition.id&quot;</span>
                <span class="k">return</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="n">version</span><span class="p">,</span><span class="s2">&quot;DDLm&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>   <span class="c1">#DDL2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cat_id_spec</span> <span class="o">=</span> <span class="s2">&quot;_category.id&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">def_id_spec</span> <span class="o">=</span> <span class="s2">&quot;_item.name&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">key_spec</span> <span class="o">=</span> <span class="s2">&quot;_category_mandatory.name&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type_spec</span> <span class="o">=</span> <span class="s2">&quot;_item_type.code&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enum_spec</span> <span class="o">=</span> <span class="s2">&quot;_item_enumeration.value&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">esd_spec</span> <span class="o">=</span> <span class="s2">&quot;_item_type_conditions.code&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cat_spec</span> <span class="o">=</span> <span class="s2">&quot;_item.category_id&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loop_spec</span> <span class="o">=</span> <span class="s2">&quot;there_is_no_loop_spec!&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">must_loop_spec</span> <span class="o">=</span> <span class="s2">&quot;xxx&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">must_exist_spec</span> <span class="o">=</span> <span class="s2">&quot;_item.mandatory_code&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">child_spec</span> <span class="o">=</span> <span class="s2">&quot;_item_linked.child_name&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent_spec</span> <span class="o">=</span> <span class="s2">&quot;_item_linked.parent_name&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">related_func</span> <span class="o">=</span> <span class="s2">&quot;_item_related.function_code&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">related_item</span> <span class="o">=</span> <span class="s2">&quot;_item_related.related_name&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unique_spec</span> <span class="o">=</span> <span class="s2">&quot;_category_key.name&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_ref_spec</span> <span class="o">=</span> <span class="s2">&quot;xxx&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">primitive_type</span> <span class="o">=</span> <span class="s2">&quot;_type&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dep_spec</span> <span class="o">=</span> <span class="s2">&quot;_item_dependent.dependent_name&quot;</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="n">version</span><span class="p">,</span><span class="s2">&quot;DDL2&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s2">&quot;Unable to determine dictionary DDL version&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">DDL1_normalise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># switch off block name collision checks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># add default type information in DDL2 style</span>
        <span class="c1"># initial types and constructs</span>
        <span class="n">base_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;char&quot;</span><span class="p">,</span><span class="s2">&quot;numb&quot;</span><span class="p">,</span><span class="s2">&quot;null&quot;</span><span class="p">]</span>
        <span class="n">prim_types</span> <span class="o">=</span> <span class="n">base_types</span><span class="p">[:]</span>
        <span class="n">base_constructs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.*&quot;</span><span class="p">,</span>
            <span class="s1">&#39;(-?(([0-9]*[.][0-9]+)|([0-9]+)[.]?)([(][0-9]+[)])?([eEdD][+-]?[0-9]+)?)|\?|\.&#39;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="se">\&quot;\&quot;</span><span class="s2"> &quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
           <span class="n">newnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c1">#keep by default</span>
           <span class="k">if</span> <span class="s2">&quot;_name&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
               <span class="n">real_name</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_name&quot;</span><span class="p">]</span>
               <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">real_name</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>        <span class="c1">#looped values</span>
                   <span class="k">for</span> <span class="n">looped_name</span> <span class="ow">in</span> <span class="n">real_name</span><span class="p">:</span>
                      <span class="n">new_value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                      <span class="n">new_value</span><span class="p">[</span><span class="s2">&quot;_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">looped_name</span>  <span class="c1">#only looped name</span>
                      <span class="bp">self</span><span class="p">[</span><span class="n">looped_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
                   <span class="n">newnames</span> <span class="o">=</span> <span class="n">real_name</span>
               <span class="k">else</span><span class="p">:</span>
                      <span class="bp">self</span><span class="p">[</span><span class="n">real_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                      <span class="n">newnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">real_name</span><span class="p">]</span>
           <span class="c1"># delete the old one</span>
           <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">newnames</span><span class="p">:</span>
              <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="c1"># loop again to normalise the contents of each definition</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
           <span class="c1">#unlock the block</span>
           <span class="n">save_overwrite</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">overwrite</span>
           <span class="n">value</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="bp">True</span>
           <span class="c1"># deal with a missing _list, _type_conditions</span>
           <span class="k">if</span> <span class="s2">&quot;_list&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
           <span class="k">if</span> <span class="s2">&quot;_type_conditions&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_type_conditions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
           <span class="c1"># deal with enumeration ranges</span>
           <span class="k">if</span> <span class="s2">&quot;_enumeration_range&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
               <span class="nb">max</span><span class="p">,</span><span class="nb">min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmaxmin</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;_enumeration_range&quot;</span><span class="p">])</span>
               <span class="k">if</span> <span class="nb">min</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                   <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">(((</span><span class="s2">&quot;_item_range.maximum&quot;</span><span class="p">,</span><span class="s2">&quot;_item_range.minimum&quot;</span><span class="p">),((</span><span class="nb">max</span><span class="p">,</span><span class="nb">max</span><span class="p">),(</span><span class="nb">max</span><span class="p">,</span><span class="nb">min</span><span class="p">))))</span>
               <span class="k">elif</span> <span class="nb">max</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                   <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">(((</span><span class="s2">&quot;_item_range.maximum&quot;</span><span class="p">,</span><span class="s2">&quot;_item_range.minimum&quot;</span><span class="p">),((</span><span class="nb">max</span><span class="p">,</span><span class="nb">min</span><span class="p">),(</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">))))</span>
               <span class="k">else</span><span class="p">:</span>
                   <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">(((</span><span class="s2">&quot;_item_range.maximum&quot;</span><span class="p">,</span><span class="s2">&quot;_item_range.minimum&quot;</span><span class="p">),((</span><span class="nb">max</span><span class="p">,</span><span class="nb">max</span><span class="p">,</span><span class="nb">min</span><span class="p">),(</span><span class="nb">max</span><span class="p">,</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">))))</span>
           <span class="c1">#add any type construct information</span>
           <span class="k">if</span> <span class="s2">&quot;_type_construct&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
               <span class="n">base_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;_name&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_type&quot;</span><span class="p">)</span>   <span class="c1">#ie dataname_type</span>
               <span class="n">base_constructs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;_type_construct&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;$&quot;</span><span class="p">)</span>
               <span class="n">prim_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;_type&quot;</span><span class="p">])</span>     <span class="c1">#keep a record</span>
               <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_types</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>   <span class="c1">#the new type name</span>

        <span class="c1">#make categories conform with ddl2</span>
        <span class="c1">#note that we must remove everything from the last underscore</span>
           <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_category&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;category_overview&quot;</span><span class="p">:</span>
                <span class="n">last_under</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                <span class="n">catid</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_name&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="n">last_under</span><span class="p">]</span>
                <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_category.id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catid</span>  <span class="c1">#remove square bracks</span>
                <span class="k">if</span> <span class="n">catid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_list</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">catid</span><span class="p">)</span>
           <span class="n">value</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="n">save_overwrite</span>
        <span class="c1"># we now add any missing categories before filling in the rest of the</span>
        <span class="c1"># information</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1">#print(&#39;processing ddl1 definition %s&#39; % key)</span>
            <span class="k">if</span> <span class="s2">&quot;_category&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;_category&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_list</span><span class="p">:</span>
                    <span class="c1"># rogue category, add it in</span>
                    <span class="n">newcat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;_category&quot;</span><span class="p">]</span>
                    <span class="n">fake_name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">newcat</span> <span class="o">+</span> <span class="s2">&quot;_[]&quot;</span>
                    <span class="n">newcatdata</span> <span class="o">=</span> <span class="n">CifBlock</span><span class="p">()</span>
                    <span class="n">newcatdata</span><span class="p">[</span><span class="s2">&quot;_category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;category_overview&quot;</span>
                    <span class="n">newcatdata</span><span class="p">[</span><span class="s2">&quot;_category.id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newcat</span>
                    <span class="n">newcatdata</span><span class="p">[</span><span class="s2">&quot;_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">fake_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">newcatdata</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cat_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newcat</span><span class="p">)</span>
        <span class="c1"># write out the type information in DDL2 style</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">((</span>
            <span class="p">(</span><span class="s2">&quot;_item_type_list.code&quot;</span><span class="p">,</span><span class="s2">&quot;_item_type_list.construct&quot;</span><span class="p">,</span>
              <span class="s2">&quot;_item_type_list.primitive_code&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">base_types</span><span class="p">,</span><span class="n">base_constructs</span><span class="p">,</span><span class="n">prim_types</span><span class="p">)</span>
            <span class="p">))</span>

    <span class="k">def</span> <span class="nf">ddl1_cat_load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">deflist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>       <span class="c1">#slight optimization</span>
        <span class="n">cat_mand_dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cat_unique_dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># a function to extract any necessary information from each definition</span>
        <span class="k">def</span> <span class="nf">get_cat_info</span><span class="p">(</span><span class="n">single_def</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">single_def</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">must_exist_spec</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;yes&#39;</span><span class="p">:</span>
                <span class="n">thiscat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">single_def</span><span class="p">][</span><span class="s2">&quot;_category&quot;</span><span class="p">]</span>
                <span class="n">curval</span> <span class="o">=</span> <span class="n">cat_mand_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">thiscat</span><span class="p">,[])</span>
                <span class="n">curval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_def</span><span class="p">)</span>
                <span class="n">cat_mand_dic</span><span class="p">[</span><span class="n">thiscat</span><span class="p">]</span> <span class="o">=</span> <span class="n">curval</span>
            <span class="c1"># now the unique items...</span>
            <span class="c1"># cif_core.dic throws us a curly one: the value of list_uniqueness is</span>
            <span class="c1"># not the same as the defined item for publ_body_label, so we have</span>
            <span class="c1"># to collect both together.  We assume a non-listed entry, which</span>
            <span class="c1"># is true for all current (May 2005) ddl1 dictionaries.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">single_def</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_spec</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
                <span class="n">thiscat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">single_def</span><span class="p">][</span><span class="s2">&quot;_category&quot;</span><span class="p">]</span>
                <span class="n">new_unique</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">single_def</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_spec</span><span class="p">]</span>
                <span class="n">uis</span> <span class="o">=</span> <span class="n">cat_unique_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">thiscat</span><span class="p">,[])</span>
                <span class="k">if</span> <span class="n">single_def</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uis</span><span class="p">:</span> <span class="n">uis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_def</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_unique</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uis</span><span class="p">:</span> <span class="n">uis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_unique</span><span class="p">)</span>
                <span class="n">cat_unique_dic</span><span class="p">[</span><span class="n">thiscat</span><span class="p">]</span> <span class="o">=</span> <span class="n">uis</span>

        <span class="p">[</span><span class="n">get_cat_info</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">deflist</span><span class="p">]</span> <span class="c1"># apply the above function</span>
        <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">cat_mand_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;_category_mandatory.name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat_mand_dic</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">cat_unique_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;_category_key.name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat_unique_dic</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">create_pcloop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">definition</span><span class="p">):</span>
        <span class="n">old_children</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">definition</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,[])</span>
        <span class="n">old_parents</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">definition</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">,[])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">old_children</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
             <span class="n">old_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">old_children</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">old_parents</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
             <span class="n">old_parents</span> <span class="o">=</span> <span class="p">[</span><span class="n">old_parents</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">old_children</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_parents</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> \
           <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">old_children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_parents</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
             <span class="k">return</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_children</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
             <span class="n">old_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">definition</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">old_parents</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_parents</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
             <span class="n">old_parents</span> <span class="o">=</span> <span class="p">[</span><span class="n">definition</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">old_children</span><span class="p">)</span>
        <span class="n">newloop</span> <span class="o">=</span> <span class="n">CifLoopBlock</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">newloop</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">((</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">,</span><span class="n">old_parents</span><span class="p">))</span>
        <span class="n">newloop</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">((</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,</span><span class="n">old_children</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">definition</span><span class="p">][</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">definition</span><span class="p">][</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">definition</span><span class="p">]</span><span class="o">.</span><span class="n">insert_loop</span><span class="p">(</span><span class="n">newloop</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">DDL2_normalise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="n">listed_defs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_item.name&#39;</span><span class="p">),</span><span class="nb">list</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
       <span class="c1"># now filter out all the single element lists!</span>
       <span class="n">dodgy_defs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_item.name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">listed_defs</span><span class="p">)</span>
       <span class="k">for</span> <span class="n">item_def</span> <span class="ow">in</span> <span class="n">dodgy_defs</span><span class="p">:</span>
                <span class="c1"># print(&quot;DDL2 norm: processing %s&quot; % item_def)</span>
                <span class="n">thisdef</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_def</span><span class="p">]</span>
                <span class="n">packet_no</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item_def</span><span class="p">)</span>
                <span class="n">realcat</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.category_id&#39;</span><span class="p">][</span><span class="n">packet_no</span><span class="p">]</span>
                <span class="n">realmand</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.mandatory_code&#39;</span><span class="p">][</span><span class="n">packet_no</span><span class="p">]</span>
                <span class="c1"># first add in all the missing categories</span>
                <span class="c1"># we don&#39;t replace the entry in the list corresponding to the</span>
                <span class="c1"># current item, as that would wipe out the information we want</span>
                <span class="k">for</span> <span class="n">child_no</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.name&#39;</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="n">child_no</span> <span class="o">==</span> <span class="n">packet_no</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">child_name</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.name&#39;</span><span class="p">][</span><span class="n">child_no</span><span class="p">]</span>
                    <span class="n">child_cat</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.category_id&#39;</span><span class="p">][</span><span class="n">child_no</span><span class="p">]</span>
                    <span class="n">child_mand</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.mandatory_code&#39;</span><span class="p">][</span><span class="n">child_no</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">child_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">child_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">CifBlock</span><span class="p">()</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">child_name</span><span class="p">][</span><span class="s1">&#39;_item.name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">child_name</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">child_name</span><span class="p">][</span><span class="s1">&#39;_item.category_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">child_cat</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">child_name</span><span class="p">][</span><span class="s1">&#39;_item.mandatory_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">child_mand</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">item_def</span><span class="p">][</span><span class="s1">&#39;_item.name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_def</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">item_def</span><span class="p">][</span><span class="s1">&#39;_item.category_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">realcat</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">item_def</span><span class="p">][</span><span class="s1">&#39;_item.mandatory_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">realmand</span>

       <span class="n">target_defs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;_item_linked.child_name&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">or</span> \
                                     <span class="s1">&#39;_item_linked.parent_name&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
       <span class="c1"># now dodgy_defs contains all definition blocks with more than one child/parent link</span>
       <span class="k">for</span> <span class="n">item_def</span> <span class="ow">in</span> <span class="n">dodgy_defs</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_pcloop</span><span class="p">(</span><span class="n">item_def</span><span class="p">)</span>           <span class="c1">#regularise appearance</span>
       <span class="k">for</span> <span class="n">item_def</span> <span class="ow">in</span> <span class="n">dodgy_defs</span><span class="p">:</span>
             <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Processing </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">item_def</span><span class="p">)</span>
             <span class="n">thisdef</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_def</span><span class="p">]</span>
             <span class="n">child_list</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">]</span>
             <span class="n">parents</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">]</span>
             <span class="c1"># for each parent, find the list of children.</span>
             <span class="n">family</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">parents</span><span class="p">,</span><span class="n">child_list</span><span class="p">))</span>
             <span class="n">notmychildren</span> <span class="o">=</span> <span class="n">family</span>         <span class="c1">#We aim to remove non-children</span>
             <span class="c1"># Loop over the parents, relocating as necessary</span>
             <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">notmychildren</span><span class="p">):</span>
                <span class="c1"># get all children of first entry</span>
                <span class="n">mychildren</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">family</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">notmychildren</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Parent </span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2"> children&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">notmychildren</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">mychildren</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">parent</span><span class="p">,</span><span class="n">child</span> <span class="ow">in</span> <span class="n">mychildren</span><span class="p">:</span>   <span class="c1">#parent is the same for all</span>
                         <span class="c1"># Make sure that we simply add in the new entry for the child, not replace it,</span>
                         <span class="c1"># otherwise we might spoil the child entry loop structure</span>
                         <span class="k">try</span><span class="p">:</span>
                             <span class="n">childloop</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">child</span><span class="p">]</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">)</span>
                         <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                             <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Creating new parent entry </span><span class="si">%s</span><span class="s1"> for definition </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">child</span><span class="p">))</span>
                             <span class="bp">self</span><span class="p">[</span><span class="n">child</span><span class="p">][</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">parent</span><span class="p">]</span>
                             <span class="n">childloop</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">child</span><span class="p">]</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">)</span>
                             <span class="n">childloop</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">((</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,[</span><span class="n">child</span><span class="p">]))</span>
                             <span class="k">continue</span>
                         <span class="k">else</span><span class="p">:</span>
                             <span class="c1"># A parent loop already exists and so will a child loop due to the</span>
                             <span class="c1"># call to create_pcloop above</span>
                             <span class="n">pars</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">childloop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">==</span><span class="n">child</span><span class="p">]</span>
                             <span class="n">goodpars</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">pars</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">==</span><span class="n">parent</span><span class="p">]</span>
                             <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">goodpars</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>   <span class="c1">#no need to add it</span>
                                 <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Skipping duplicated parent - child entry in </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">child</span><span class="p">))</span>
                                 <span class="k">continue</span>
                             <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Adding </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> entry&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">child</span><span class="p">))</span>
                             <span class="n">newpacket</span> <span class="o">=</span> <span class="n">childloop</span><span class="o">.</span><span class="n">GetPacket</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>   <span class="c1">#essentially a copy, I hope</span>
                             <span class="nb">setattr</span><span class="p">(</span><span class="n">newpacket</span><span class="p">,</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,</span><span class="n">child</span><span class="p">)</span>
                             <span class="nb">setattr</span><span class="p">(</span><span class="n">newpacket</span><span class="p">,</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">,</span><span class="n">parent</span><span class="p">)</span>
                             <span class="n">childloop</span><span class="o">.</span><span class="n">AddPacket</span><span class="p">(</span><span class="n">newpacket</span><span class="p">)</span>
                <span class="c1">#</span>
                <span class="c1"># Make sure the parent also points to the children.  We get</span>
                <span class="c1"># the current entry, then add our</span>
                <span class="c1"># new values if they are not there already</span>
                <span class="c1">#</span>
                <span class="n">parent_name</span> <span class="o">=</span> <span class="n">mychildren</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">old_children</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,[])</span>
                <span class="n">old_parents</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">,[])</span>
                <span class="n">oldfamily</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">old_parents</span><span class="p">,</span><span class="n">old_children</span><span class="p">)</span>
                <span class="n">newfamily</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Old parents -&gt; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">old_parents</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">childname</span> <span class="ow">in</span> <span class="n">mychildren</span><span class="p">:</span>
                    <span class="n">alreadythere</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">oldfamily</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">parent_name</span> <span class="ow">and</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span><span class="n">childname</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alreadythere</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="s1">&#39;Adding new child </span><span class="si">%s</span><span class="s1"> to parent definition at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">childname</span><span class="p">,</span><span class="n">parent_name</span><span class="p">)</span>
                    <span class="n">old_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">childname</span><span class="p">)</span>
                    <span class="n">old_parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_name</span><span class="p">)</span>
                <span class="c1"># Now output the loop, blowing away previous definitions.  If there is something</span>
                <span class="c1"># else in this category, we are destroying it.</span>
                <span class="n">newloop</span> <span class="o">=</span> <span class="n">CifLoopBlock</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">newloop</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">((</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">,</span><span class="n">old_parents</span><span class="p">))</span>
                <span class="n">newloop</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">((</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,</span><span class="n">old_children</span><span class="p">))</span>
                <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_name</span><span class="p">][</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">]</span>
                <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_name</span><span class="p">][</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">insert_loop</span><span class="p">(</span><span class="n">newloop</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;New parents -&gt; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">parent_name</span><span class="p">][</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">]))</span>
                <span class="c1"># now make a new,smaller list</span>
                <span class="n">notmychildren</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">notmychildren</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="n">mychildren</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

       <span class="c1"># now flatten any single element lists</span>
       <span class="n">single_defs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_item.name&#39;</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="n">listed_defs</span><span class="p">)</span>
       <span class="k">for</span> <span class="n">flat_def</span> <span class="ow">in</span> <span class="n">single_defs</span><span class="p">:</span>
           <span class="n">flat_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">flat_def</span><span class="p">]</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="s1">&#39;_item.name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
           <span class="k">for</span> <span class="n">flat_key</span> <span class="ow">in</span> <span class="n">flat_keys</span><span class="p">:</span> <span class="bp">self</span><span class="p">[</span><span class="n">flat_def</span><span class="p">][</span><span class="n">flat_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">flat_def</span><span class="p">][</span><span class="n">flat_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
       <span class="c1"># now deal with the multiple lists</span>
       <span class="c1"># next we do aliases</span>
       <span class="n">all_aliases</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;_item_aliases.alias_name&#39;</span><span class="p">)]</span>
       <span class="k">for</span> <span class="n">aliased</span> <span class="ow">in</span> <span class="n">all_aliases</span><span class="p">:</span>
          <span class="n">my_aliases</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">aliased</span><span class="p">][</span><span class="s1">&#39;_item_aliases.alias_name&#39;</span><span class="p">])</span>
          <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">my_aliases</span><span class="p">:</span>
              <span class="bp">self</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">aliased</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>   <span class="c1">#we are going to delete stuff...</span>
              <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">alias</span><span class="p">][</span><span class="s2">&quot;_item_aliases.alias_name&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">ddlm_parse_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;_dictionary_valid.application&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">scope_pack</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="s2">&quot;_dictionary_valid.application&quot;</span><span class="p">):</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">scope_pack</span><span class="p">,</span><span class="s2">&quot;_dictionary_valid.application&quot;</span><span class="p">)</span>
            <span class="n">valid_info</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">scope_pack</span><span class="p">,</span><span class="s2">&quot;_dictionary_valid.attributes&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scope</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Mandatory&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scopes_mandatory</span><span class="p">[</span><span class="n">scope</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_category_opt</span><span class="p">(</span><span class="n">valid_info</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">scope</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Prohibited&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scopes_naughty</span><span class="p">[</span><span class="n">scope</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_category_opt</span><span class="p">(</span><span class="n">valid_info</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">obtain_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">import_mode</span><span class="p">,</span><span class="n">heavy</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Collate import information&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_import_dics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">import_frames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([(</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_import.get&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;_import.get&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]])</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Import mode </span><span class="si">%s</span><span class="s1"> applied to following frames&#39;</span> <span class="o">%</span> <span class="n">import_mode</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">import_frames</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">import_mode</span> <span class="o">!=</span> <span class="s1">&#39;All&#39;</span><span class="p">:</span>
           <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">import_frames</span><span class="p">)):</span>
                <span class="n">import_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">import_frames</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">import_frames</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span><span class="s1">&#39;Contents&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">import_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
           <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Importing following frames in mode </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">import_mode</span><span class="p">)</span>
           <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">import_frames</span><span class="p">))</span>
        <span class="c1">#resolve all references</span>
        <span class="k">for</span> <span class="n">parent_block</span><span class="p">,</span><span class="n">import_list</span> <span class="ow">in</span> <span class="n">import_frames</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">import_ref</span> <span class="ow">in</span> <span class="n">import_list</span><span class="p">:</span>
            <span class="n">file_loc</span> <span class="o">=</span> <span class="n">import_ref</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span>
            <span class="n">full_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_path</span><span class="p">(</span><span class="n">file_loc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">full_uri</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_cache</span><span class="p">:</span>
                <span class="n">dic_as_cif</span> <span class="o">=</span> <span class="n">CifFile</span><span class="p">(</span><span class="n">full_uri</span><span class="p">,</span><span class="n">grammar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">template_cache</span><span class="p">[</span><span class="n">full_uri</span><span class="p">]</span> <span class="o">=</span> <span class="n">CifDic</span><span class="p">(</span><span class="n">dic_as_cif</span><span class="p">,</span><span class="n">do_imports</span><span class="o">=</span><span class="n">import_mode</span><span class="p">,</span><span class="n">heavy</span><span class="o">=</span><span class="n">heavy</span><span class="p">,</span><span class="n">do_dREL</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>  <span class="c1">#this will recurse internal imports</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Added </span><span class="si">%s</span><span class="s1"> to cached dictionaries&#39;</span> <span class="o">%</span> <span class="n">full_uri</span><span class="p">)</span>
            <span class="n">import_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_cache</span><span class="p">[</span><span class="n">full_uri</span><span class="p">]</span>
            <span class="n">dupl</span> <span class="o">=</span> <span class="n">import_ref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dupl&#39;</span><span class="p">,</span><span class="s1">&#39;Exit&#39;</span><span class="p">)</span>
            <span class="n">miss</span> <span class="o">=</span> <span class="n">import_ref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;miss&#39;</span><span class="p">,</span><span class="s1">&#39;Exit&#39;</span><span class="p">)</span>
            <span class="n">target_key</span> <span class="o">=</span> <span class="n">import_ref</span><span class="p">[</span><span class="s2">&quot;save&quot;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">import_target</span> <span class="o">=</span> <span class="n">import_from</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">miss</span> <span class="o">==</span> <span class="s1">&#39;Exit&#39;</span><span class="p">:</span>
                   <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s1">&#39;Import frame </span><span class="si">%s</span><span class="s1"> not found in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target_key</span><span class="p">,</span><span class="n">full_uri</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">continue</span>
            <span class="c1"># now import appropriately</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">import_ref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span><span class="s1">&#39;Contents&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">target_key</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;full&#39;</span><span class="p">:</span>  <span class="c1">#so blockname will be duplicated</span>
                <span class="k">if</span> <span class="n">dupl</span> <span class="o">==</span> <span class="s1">&#39;Exit&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s1">&#39;Import frame </span><span class="si">%s</span><span class="s1"> already in dictionary&#39;</span> <span class="o">%</span> <span class="n">target_key</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dupl</span> <span class="o">==</span> <span class="s1">&#39;Ignore&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">heavy</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_import</span><span class="p">(</span><span class="n">parent_block</span><span class="p">,</span><span class="n">import_from</span><span class="p">,</span><span class="n">import_target</span><span class="p">,</span><span class="n">target_key</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_import_light</span><span class="p">(</span><span class="n">parent_block</span><span class="p">,</span><span class="n">import_from</span><span class="p">,</span><span class="n">import_target</span><span class="p">,</span><span class="n">target_key</span><span class="p">,</span><span class="n">file_loc</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">ddlm_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent_block</span><span class="p">,</span><span class="n">import_from</span><span class="p">,</span><span class="n">import_target</span><span class="p">,</span><span class="n">target_key</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;All&#39;</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Import other dictionaries in place&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;contents&#39;</span><span class="p">:</span>   <span class="c1">#merge attributes only</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">parent_block</span><span class="p">]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">import_target</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span><span class="s2">&quot;full&quot;</span><span class="p">:</span>
                <span class="c1"># Do the syntactic merge</span>
                <span class="n">syntactic_head</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_parent</span><span class="p">(</span><span class="n">parent_block</span><span class="p">)]</span> <span class="c1">#root frame if no nesting</span>
                <span class="n">from_cat_head</span> <span class="o">=</span> <span class="n">import_target</span><span class="p">[</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span>
                <span class="n">child_frames</span> <span class="o">=</span> <span class="n">import_from</span><span class="o">.</span><span class="n">ddlm_all_children</span><span class="p">(</span><span class="n">from_cat_head</span><span class="p">)</span>
                 <span class="c1"># Check for Head merging Head</span>
                <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_block</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;Datum&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Head&#39;</span> <span class="ow">and</span> \
                   <span class="n">import_target</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;Datum&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Head&#39;</span><span class="p">:</span>
                      <span class="n">head_to_head</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                      <span class="n">head_to_head</span> <span class="o">=</span> <span class="bp">False</span>
                      <span class="n">child_frames</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">from_cat_head</span><span class="p">)</span>
                <span class="c1"># As we are in syntax land, we call the CifFile methods</span>
                <span class="n">child_blocks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">import_from</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">child_frames</span><span class="p">])</span>
                <span class="n">child_blocks</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="n">import_from</span><span class="p">)</span><span class="o">.</span><span class="n">makebc</span><span class="p">(</span><span class="n">child_blocks</span><span class="p">)</span>
                <span class="c1"># Prune out any datablocks that have identical definitions</span>
                <span class="n">from_defs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">a</span><span class="p">,</span><span class="n">child_blocks</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">child_blocks</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
                <span class="n">double_defs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">from_defs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Definitions for </span><span class="si">%s</span><span class="s1"> superseded&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">double_defs</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">double_defs</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">child_blocks</span><span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">merge_fast</span><span class="p">(</span><span class="n">child_blocks</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="n">syntactic_head</span><span class="p">)</span>      <span class="c1">#</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Syntactic merge of </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%d</span><span class="s1"> defs) in </span><span class="si">%s</span><span class="s1"> mode, now have </span><span class="si">%d</span><span class="s1"> defs&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target_key</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">child_frames</span><span class="p">),</span>
                   <span class="n">mode</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
                <span class="c1"># Now the semantic merge</span>
                <span class="c1"># First expand our definition &lt;-&gt; blockname tree</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_def_block_table</span><span class="p">()</span>
                <span class="n">merging_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_block</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span>      <span class="c1">#new parent</span>
                <span class="k">if</span> <span class="n">head_to_head</span><span class="p">:</span>
                    <span class="n">child_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_immediate_children</span><span class="p">(</span><span class="n">from_cat_head</span><span class="p">)</span>    <span class="c1">#old children</span>
                    <span class="c1">#the new parent is the importing category for all old children</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">child_frames</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merging_cat</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="c1"># remove the old head</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">from_cat_head</span><span class="p">]</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Semantic merge: </span><span class="si">%d</span><span class="s1"> defs reparented from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">child_frames</span><span class="p">),</span><span class="n">from_cat_head</span><span class="p">,</span><span class="n">merging_cat</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1">#imported category is only child</span>
                    <span class="n">from_frame</span> <span class="o">=</span> <span class="n">import_from</span><span class="p">[</span><span class="n">target_key</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]</span> <span class="c1">#so we can find it</span>
                    <span class="n">child_frame</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">from_frame</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">child_frame</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merging_cat</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Semantic merge: category for </span><span class="si">%s</span><span class="s1"> : now </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">from_frame</span><span class="p">,</span><span class="n">merging_cat</span><span class="p">))</span>
            <span class="c1"># it will never happen again...</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_block</span><span class="p">][</span><span class="s2">&quot;_import.get&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">resolve_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">file_loc</span><span class="p">):</span>
        <span class="n">url_comps</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">file_loc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">url_comps</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="k">return</span> <span class="n">file_loc</span>    <span class="c1">#already full URI</span>
        <span class="n">new_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_uri</span><span class="p">,</span><span class="n">file_loc</span><span class="p">)</span>
        <span class="c1">#print(&quot;Transformed %s to %s for import &quot; % (file_loc,new_url))</span>
        <span class="k">return</span> <span class="n">new_url</span>

    <span class="k">def</span> <span class="nf">ddlm_import_light</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent_block</span><span class="p">,</span><span class="n">import_from</span><span class="p">,</span><span class="n">import_target</span><span class="p">,</span><span class="n">target_key</span><span class="p">,</span><span class="n">file_loc</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;All&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register the imported dictionaries but do not alter any definitions. `parent_block`</span>
<span class="sd">        contains the id of the block that is importing. `import_target` is the block that</span>
<span class="sd">        should be imported. `import_from` is the CifFile that contains the definitions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;contents&#39;</span><span class="p">:</span>   <span class="c1">#merge attributes only</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">parent_block</span><span class="p">]</span><span class="o">.</span><span class="n">add_dict_cache</span><span class="p">(</span><span class="n">file_loc</span><span class="p">,</span><span class="n">import_from</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span><span class="s2">&quot;full&quot;</span><span class="p">:</span>
             <span class="c1"># Check for Head merging Head</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_block</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;Datum&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Head&#39;</span> <span class="ow">and</span> \
               <span class="n">import_target</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;Datum&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Head&#39;</span><span class="p">:</span>
                   <span class="n">head_to_head</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                   <span class="n">head_to_head</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c1"># Figure out the actual definition ID</span>
            <span class="n">head_id</span> <span class="o">=</span> <span class="n">import_target</span><span class="p">[</span><span class="s2">&quot;_definition.id&quot;</span><span class="p">]</span>
            <span class="c1"># Adjust parent information</span>
            <span class="n">merging_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_block</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span>
            <span class="n">from_cat_head</span> <span class="o">=</span> <span class="n">import_target</span><span class="p">[</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">head_to_head</span><span class="p">:</span>   <span class="c1"># imported category is only child</span>
                <span class="n">import_target</span><span class="p">[</span><span class="s2">&quot;_name.category_id&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">merging_cat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_import_dics</span> <span class="o">=</span> <span class="p">[(</span><span class="n">import_from</span><span class="p">,</span><span class="n">head_id</span><span class="p">)]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_import_dics</span> <span class="c1">#prepend</span>

    <span class="k">def</span> <span class="nf">lookup_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check the list of imported dictionaries for this definition&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">one_dic</span><span class="p">,</span><span class="n">head_def</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_import_dics</span><span class="p">:</span>
            <span class="n">from_cat_head</span> <span class="o">=</span> <span class="n">one_dic</span><span class="p">[</span><span class="n">head_def</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span>
            <span class="n">possible_keys</span> <span class="o">=</span> <span class="n">one_dic</span><span class="o">.</span><span class="n">ddlm_all_children</span><span class="p">(</span><span class="n">from_cat_head</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">possible_keys</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">one_dic</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not found in import dictionaries&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        


    <span class="k">def</span> <span class="nf">create_def_block_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create an internal table matching definition to block id &quot;&quot;&quot;</span>
        <span class="n">proto_table</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="c1"># now get the actual ids instead of blocks</span>
        <span class="n">proto_table</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_id_spec</span><span class="p">,</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">def_id_spec</span><span class="p">,</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">proto_table</span><span class="p">])</span>
        <span class="c1"># remove non-definitions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diclang</span> <span class="o">!=</span> <span class="s2">&quot;DDL1&quot;</span><span class="p">:</span>
            <span class="n">top_blocks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">top_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;on_this_dictionary&quot;</span><span class="p">]</span>
        <span class="c1"># catch dodgy duplicates</span>
        <span class="n">uniques</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">proto_table</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniques</span><span class="p">)</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">proto_table</span><span class="p">):</span>
            <span class="n">def_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">proto_table</span><span class="p">])</span>
            <span class="n">dodgy</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">def_names</span> <span class="k">if</span> <span class="n">def_names</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s1">&#39;Duplicate definitions in dictionary:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">dodgy</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">proto_table</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">top_blocks</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Access a datablock by definition id, after the lookup has been created&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>   <span class="c1">#block_id_table not present yet</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c1"># key is missing</span>
            <span class="k">try</span><span class="p">:</span> <span class="c1"># print(Definition for %s not found, reverting to CifFile&#39; % key)</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c1"># try imports</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_imports</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a new definition block&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]]</span><span class="o">=</span><span class="n">key</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>   <span class="c1">#does not exist yet</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">NewBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">newname</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">NewBlock</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">newname</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]]</span><span class="o">=</span><span class="n">newname</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> <span class="c1">#no block_id table</span>
            <span class="k">pass</span>
                
    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a definition&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span><span class="ne">KeyError</span><span class="p">):</span>   <span class="c1">#block_id_table not present yet</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># fix other datastructures</span>
        <span class="c1"># cat_obj table</span>

    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all definitions&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">has_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return (key,value) pairs&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">([(</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>

    <span class="k">def</span> <span class="nf">unlock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow overwriting of all definitions in this collection&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">overwrite</span><span class="o">=</span><span class="bp">True</span>

    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Disallow changes in definitions&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span>

    <span class="k">def</span> <span class="nf">rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldname</span><span class="p">,</span><span class="n">newname</span><span class="p">,</span><span class="n">blockname_as_well</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change a _definition.id from oldname to newname, and if `blockname_as_well` is True,</span>
<span class="sd">        change the underlying blockname too.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">blockname_as_well</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">oldname</span><span class="o">.</span><span class="n">lower</span><span class="p">()],</span><span class="n">newname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">newname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">=</span><span class="n">newname</span>
            <span class="k">if</span> <span class="n">oldname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">:</span> <span class="c1">#not removed</span>
               <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">oldname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">newname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">oldname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">oldname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="k">return</span>

    <span class="k">def</span> <span class="nf">get_root_category</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the single &#39;Head&#39; category of this dictionary&quot;&quot;&quot;</span>
        <span class="n">root_cats</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;Datum&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Head&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">root_cats</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">root_cats</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s2">&quot;Cannot determine a unique Head category, got&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">root_cats</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">root_cats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">ddlm_immediate_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">catname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of datanames for the immediate children of catname.  These are</span>
<span class="sd">        semantic children (i.e. based on _name.category_id), not structural children as</span>
<span class="sd">        in the case of StarFile.get_immediate_children&quot;&quot;&quot;</span>

        <span class="n">straight_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">catname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">straight_children</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ddlm_all_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">catname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of all children, including the `catname`&quot;&quot;&quot;</span>
        <span class="n">all_children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_immediate_children</span><span class="p">(</span><span class="n">catname</span><span class="p">)</span>
        <span class="n">cat_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">all_children</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Category&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cat_children</span><span class="p">:</span>
            <span class="n">all_children</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">all_children</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_all_children</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">all_children</span> <span class="o">+</span> <span class="p">[</span><span class="n">catname</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">is_semantic_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">maybe_child</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return true if `maybe_child` is a child of `parent`&quot;&quot;&quot;</span>
        <span class="n">all_children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_all_children</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">maybe_child</span> <span class="ow">in</span> <span class="n">all_children</span>

    <span class="k">def</span> <span class="nf">ddlm_danglers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of definitions that do not have a category defined</span>
<span class="sd">        for them, or are children of an unattached category&quot;&quot;&quot;</span>
        <span class="n">top_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_root_category</span><span class="p">()</span>
        <span class="n">connected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ddlm_all_children</span><span class="p">(</span><span class="n">top_block</span><span class="p">))</span>
        <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">unconnected</span> <span class="o">=</span> <span class="n">all_keys</span> <span class="o">-</span> <span class="n">connected</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">unconnected</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_ddlm_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the parent category of itemname&quot;&quot;&quot;</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">itemname</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  <span class="c1"># use the top block by default</span>
            <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has no parent&quot;</span> <span class="o">%</span> <span class="n">itemname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parent</span>

    <span class="k">def</span> <span class="nf">expand_category_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of all non-category items in a category or return the name</span>
<span class="sd">           if the name is not a category&quot;&quot;&quot;</span>
        <span class="n">new_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_list</span><span class="p">:</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Category&#39;</span><span class="p">:</span>
            <span class="n">new_list</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_category_opt</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> \
                     <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">new_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_list</span>

    <span class="k">def</span> <span class="nf">get_categories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of category names&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_definition.scope&quot;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Category&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">names_in_cat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cat</span><span class="p">,</span><span class="n">names_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="n">cat</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">names_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Item&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s2">&quot;_name.object_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">names</span><span class="p">])</span>



    <span class="k">def</span> <span class="nf">create_alias_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate an alias table that we can look up when searching for a dataname&quot;&quot;&quot;</span>
        <span class="n">all_aliases</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;_alias.definition_id&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_table</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([[</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_alias.definition_id&#39;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">all_aliases</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">create_cat_obj_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate a table indexed by (cat,obj) and returning the correct dataname&quot;&quot;&quot;</span>
        <span class="n">base_table</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([((</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()),[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)])</span> \
                           <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Item&#39;</span><span class="p">])</span>
        <span class="n">loopable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loopable_cats</span><span class="p">()</span>
        <span class="n">loopers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ddlm_immediate_children</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopable</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Loopable cats:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">loopable</span><span class="p">))</span>
        <span class="n">loop_children</span> <span class="o">=</span> <span class="p">[[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">a</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">loopable</span> <span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopers</span><span class="p">]</span>
        <span class="n">expand_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">loopable</span><span class="p">,</span><span class="n">loop_children</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Expansion list:&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">expand_list</span><span class="p">))</span>
        <span class="n">extra_table</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1">#for debugging we keep it separate from base_table until the end</span>
        <span class="k">def</span> <span class="nf">expand_base_table</span><span class="p">(</span><span class="n">parent_cat</span><span class="p">,</span><span class="n">child_cats</span><span class="p">):</span>
            <span class="n">extra_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># first deal with all the child categories</span>
            <span class="k">for</span> <span class="n">child_cat</span> <span class="ow">in</span> <span class="n">child_cats</span><span class="p">:</span>
              <span class="n">nn</span> <span class="o">=</span> <span class="p">[]</span>
              <span class="k">if</span> <span class="n">child_cat</span> <span class="ow">in</span> <span class="n">expand_list</span><span class="p">:</span>  <span class="c1"># a nested category: grab its names</span>
                <span class="n">nn</span> <span class="o">=</span> <span class="n">expand_base_table</span><span class="p">(</span><span class="n">child_cat</span><span class="p">,</span><span class="n">expand_list</span><span class="p">[</span><span class="n">child_cat</span><span class="p">])</span>
                <span class="c1"># store child names</span>
                <span class="n">extra_names</span> <span class="o">+=</span> <span class="n">nn</span>
              <span class="c1"># add all child names to the table</span>
              <span class="n">child_names</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="bp">self</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">])</span> \
                             <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names_in_cat</span><span class="p">(</span><span class="n">child_cat</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_type.purpose&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;Key&#39;</span><span class="p">]</span>
              <span class="n">child_names</span> <span class="o">+=</span> <span class="n">extra_names</span>
              <span class="n">extra_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">([((</span><span class="n">parent_cat</span><span class="p">,</span><span class="n">obj</span><span class="p">),[</span><span class="n">name</span><span class="p">])</span> <span class="k">for</span> <span class="n">obj</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="n">child_names</span> <span class="k">if</span> <span class="p">(</span><span class="n">parent_cat</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extra_table</span><span class="p">]))</span>
            <span class="c1"># and the repeated ones get appended instead</span>
            <span class="n">repeats</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">child_names</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">extra_table</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">obj</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="n">repeats</span><span class="p">:</span>
                <span class="n">extra_table</span><span class="p">[(</span><span class="n">parent_cat</span><span class="p">,</span><span class="n">obj</span><span class="p">)]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="c1"># and finally, add our own names to the return list</span>
            <span class="n">child_names</span> <span class="o">+=</span> <span class="p">[(</span><span class="bp">self</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="bp">self</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">])</span> \
                            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names_in_cat</span><span class="p">(</span><span class="n">parent_cat</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_type.purpose&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">!=</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">child_names</span>
        <span class="p">[</span><span class="n">expand_base_table</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">child</span><span class="p">)</span> <span class="k">for</span> <span class="n">parent</span><span class="p">,</span><span class="n">child</span> <span class="ow">in</span> <span class="n">expand_list</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Expansion cat/obj values: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">extra_table</span><span class="p">))</span>
        <span class="c1"># append repeated ones</span>
        <span class="n">non_repeats</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">extra_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_table</span><span class="p">])</span>
        <span class="n">repeats</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">extra_table</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">base_table</span><span class="p">]</span>
        <span class="n">base_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">non_repeats</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">repeats</span><span class="p">:</span>
            <span class="n">base_table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">extra_table</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_obj_lookup_table</span> <span class="o">=</span> <span class="n">base_table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop_expand_list</span> <span class="o">=</span> <span class="n">expand_list</span>

    <span class="k">def</span> <span class="nf">get_loopable_cats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A short utility function which returns a list of looped categories. This</span>
<span class="sd">        is preferred to a fixed attribute as that fixed attribute would need to be</span>
<span class="sd">        updated after any edits&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Loop&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">create_cat_key_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a utility table with a list of keys applicable to each category. A key is</span>
<span class="sd">        a compound key, that is, it is a list&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_key_table</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">c</span><span class="p">,[</span><span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_category_key.name&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_category.key_id&quot;</span><span class="p">)]))])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loopable_cats</span><span class="p">()])</span>
        <span class="k">def</span> <span class="nf">collect_keys</span><span class="p">(</span><span class="n">parent_cat</span><span class="p">,</span><span class="n">child_cats</span><span class="p">):</span>
                <span class="n">kk</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">child_cat</span> <span class="ow">in</span> <span class="n">child_cats</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">child_cat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_expand_list</span><span class="p">:</span>
                        <span class="n">kk</span> <span class="o">+=</span> <span class="n">collect_keys</span><span class="p">(</span><span class="n">child_cat</span><span class="p">)</span>
                    <span class="c1"># add these keys to our list</span>
                    <span class="n">kk</span> <span class="o">+=</span> <span class="p">[</span><span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">child_cat</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_category_key.name&#39;</span><span class="p">,[</span><span class="bp">self</span><span class="p">[</span><span class="n">child_cat</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_category.key_id&#39;</span><span class="p">)]))]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">[</span><span class="n">parent_cat</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">[</span><span class="n">parent_cat</span><span class="p">]</span> <span class="o">+</span> <span class="n">kk</span>
                <span class="k">return</span> <span class="n">kk</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_expand_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">collect_keys</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Keys for categories&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">add_type_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;_item_type_list.construct&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="p">:</span>
            <span class="n">types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="p">[</span><span class="s2">&quot;_item_type_list.code&quot;</span><span class="p">]</span>
            <span class="n">prim_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="p">[</span><span class="s2">&quot;_item_type_list.primitive_code&quot;</span><span class="p">]</span>
            <span class="n">constructs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="p">[</span><span class="s2">&quot;_item_type_list.construct&quot;</span><span class="p">]])</span>
            <span class="c1"># add in \r wherever we see \n, and change \{ to \\{</span>
            <span class="k">def</span> <span class="nf">regex_fiddle</span><span class="p">(</span><span class="n">mm_regex</span><span class="p">):</span>
                <span class="n">brack_match</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;((.*\[.+)(</span><span class="se">\\</span><span class="s2">{)(.*\].*))&quot;</span>
                <span class="n">ret_match</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;((.*\[.+)(</span><span class="se">\\</span><span class="s2">n)(.*\].*))&quot;</span>
                <span class="n">fixed_regexp</span> <span class="o">=</span> <span class="n">mm_regex</span><span class="p">[:]</span>  <span class="c1">#copy</span>
                <span class="c1"># fix the brackets</span>
                <span class="n">bm</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">brack_match</span><span class="p">,</span><span class="n">mm_regex</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bm</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">fixed_regexp</span> <span class="o">=</span> <span class="n">bm</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\2</span><span class="se">\\\\</span><span class="s2">{\4&quot;</span><span class="p">)</span>
                <span class="c1"># fix missing \r</span>
                <span class="n">rm</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ret_match</span><span class="p">,</span><span class="n">fixed_regexp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rm</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">fixed_regexp</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\2\3</span><span class="se">\\</span><span class="s2">r\4&quot;</span><span class="p">)</span>
                <span class="c1">#print(&quot;Regexp %s becomes %s&quot; % (mm_regex,fixed_regexp))</span>
                <span class="k">return</span> <span class="n">fixed_regexp</span>
            <span class="n">constructs</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">regex_fiddle</span><span class="p">,</span><span class="n">constructs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">typecode</span><span class="p">,</span><span class="n">construct</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">types</span><span class="p">,</span><span class="n">constructs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">typedic</span><span class="p">[</span><span class="n">typecode</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">construct</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="o">|</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
            <span class="c1"># now make a primitive &lt;-&gt; type construct mapping</span>
            <span class="k">for</span> <span class="n">typecode</span><span class="p">,</span><span class="n">primtype</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">types</span><span class="p">,</span><span class="n">prim_types</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">primdic</span><span class="p">[</span><span class="n">typecode</span><span class="p">]</span> <span class="o">=</span> <span class="n">primtype</span>

    <span class="k">def</span> <span class="nf">add_category_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diclang</span> <span class="o">==</span> <span class="s2">&quot;DDLm&quot;</span><span class="p">:</span>
            <span class="n">catblocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Category&#39;</span><span class="p">]</span>
            <span class="n">looped_cats</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">catblocks</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;Set&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Loop&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent_lookup</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">one_cat</span> <span class="ow">in</span> <span class="n">looped_cats</span><span class="p">:</span>
                <span class="n">parent_cat</span> <span class="o">=</span> <span class="n">one_cat</span>
                <span class="n">parent_def</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_cat</span><span class="p">]</span>
                <span class="n">next_up</span> <span class="o">=</span> <span class="n">parent_def</span><span class="p">[</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">while</span> <span class="n">next_up</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span><span class="n">next_up</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;Set&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Loop&#39;</span><span class="p">:</span>
                    <span class="n">parent_def</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">next_up</span><span class="p">]</span>
                    <span class="n">parent_cat</span> <span class="o">=</span> <span class="n">next_up</span>
                    <span class="n">next_up</span> <span class="o">=</span> <span class="n">parent_def</span><span class="p">[</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent_lookup</span><span class="p">[</span><span class="n">one_cat</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_cat</span>

            <span class="k">if</span> <span class="n">full</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">key_equivs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">one_cat</span> <span class="ow">in</span> <span class="n">looped_cats</span><span class="p">:</span>   <span class="c1">#follow them up</span>
                    <span class="n">lower_keys</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">one_cat</span><span class="p">][</span><span class="s1">&#39;_category_key.name&#39;</span><span class="p">])</span>
                    <span class="n">start_keys</span> <span class="o">=</span> <span class="n">lower_keys</span><span class="p">[:]</span>
                    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">lower_keys</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">this_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">lower_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span>
                        <span class="n">parent</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">looped_cats</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">this_cat</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="n">a</span><span class="p">]</span>
                        <span class="c1">#print(Processing %s, keys %s, parent %s&quot; % (this_cat,repr(lower_keys),repr(parent)))</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s2">&quot;Category </span><span class="si">%s</span><span class="s2"> has more than one parent: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">one_cat</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">parent</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">break</span>
                        <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">parent_keys</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">parent</span><span class="p">][</span><span class="s1">&#39;_category_key.name&#39;</span><span class="p">])</span>
                        <span class="n">linked_keys</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="s2">&quot;_name.linked_item_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lower_keys</span><span class="p">]</span>
                        <span class="c1"># sanity check</span>
                        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">parent_keys</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">linked_keys</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s2">&quot;Parent keys and linked keys are different! </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent_keys</span><span class="p">,</span><span class="n">linked_keys</span><span class="p">))</span>
                            <span class="c1"># now add in our information</span>
                        <span class="k">for</span> <span class="n">parent</span><span class="p">,</span><span class="n">child</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">linked_keys</span><span class="p">,</span><span class="n">start_keys</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">key_equivs</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_equivs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">child</span><span class="p">,[])</span><span class="o">+</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
                        <span class="n">lower_keys</span> <span class="o">=</span> <span class="n">linked_keys</span>  <span class="c1">#preserves order of start keys</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent_lookup</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key_equivs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">change_category_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldname</span><span class="p">,</span><span class="n">newname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;Change the category name from [[oldname]] to [[newname]]&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">oldname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Cannot rename non-existent category </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">oldname</span><span class="p">,</span><span class="n">newname</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">newname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Cannot rename </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> as </span><span class="si">%s</span><span class="s1"> already exists&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">oldname</span><span class="p">,</span><span class="n">newname</span><span class="p">,</span><span class="n">oldname</span><span class="p">))</span>
        <span class="n">child_defs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_immediate_children</span><span class="p">(</span><span class="n">oldname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">oldname</span><span class="p">,</span><span class="n">newname</span><span class="p">)</span>   <span class="c1">#NB no name integrity checks</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">newname</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newname</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">newname</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newname</span>
        <span class="k">for</span> <span class="n">child_def</span> <span class="ow">in</span> <span class="n">child_defs</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">child_def</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newname</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">child_def</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Item&#39;</span><span class="p">:</span>
                <span class="n">newid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_catobj_name</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="n">child_def</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">child_def</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newid</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">child_def</span><span class="p">,</span><span class="n">newid</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>  <span class="c1">#no underscore at the beginning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_catobj_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cat</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Combine category and object in approved fashion to create id&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">cat</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">change_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">,</span><span class="n">catname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Move itemname into catname, return new handle&quot;&quot;&quot;</span>
        <span class="n">defid</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">itemname</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">defid</span><span class="p">[</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="n">catname</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Already in category, no change&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">itemname</span>
        <span class="k">if</span> <span class="n">catname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>    <span class="c1">#don&#39;t have it</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;No such category </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">catname</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">itemname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
        <span class="n">objid</span> <span class="o">=</span> <span class="n">defid</span><span class="p">[</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span>
        <span class="n">defid</span><span class="p">[</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catname</span>
        <span class="n">newid</span> <span class="o">=</span> <span class="n">itemname</span> <span class="c1"># stays the same for categories</span>
        <span class="k">if</span> <span class="n">defid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Item&#39;</span><span class="p">:</span>
            <span class="n">newid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_catobj_name</span><span class="p">(</span><span class="n">catname</span><span class="p">,</span><span class="n">objid</span><span class="p">)</span>
            <span class="n">defid</span><span class="p">[</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">newid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">itemname</span><span class="p">,</span><span class="n">newid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_parent</span><span class="p">(</span><span class="n">catname</span><span class="p">,</span><span class="n">newid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">newid</span>

    <span class="k">def</span> <span class="nf">change_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">one_def</span><span class="p">,</span><span class="n">newobj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change the object_id of one_def to newobj. This is not used for</span>
<span class="sd">        categories, but can be used for dictionaries&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;_dictionary.title&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">one_def</span><span class="p">]:</span>  <span class="c1">#a dictionary block</span>
            <span class="n">newid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_catobj_name</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">one_def</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">],</span><span class="n">newobj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">one_def</span><span class="p">,</span><span class="n">newid</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">newid</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newid</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">newid</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">newobj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
            <span class="n">newid</span> <span class="o">=</span> <span class="n">newobj</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">one_def</span><span class="p">,</span><span class="n">newobj</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">newid</span><span class="p">][</span><span class="s1">&#39;_dictionary.title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">newid</span>

    <span class="c1"># Note that our semantic parent is given by catparent, but our syntactic parent is</span>
    <span class="c1"># always just the root block</span>
    <span class="k">def</span> <span class="nf">add_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">catname</span><span class="p">,</span><span class="n">catparent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">is_loop</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">allow_dangler</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a new category to the dictionary with name [[catname]].</span>
<span class="sd">           If [[catparent]] is None, the category will be a child of</span>
<span class="sd">           the topmost &#39;Head&#39; category or else the top data block. If</span>
<span class="sd">           [[is_loop]] is false, a Set category is created. If [[allow_dangler]]</span>
<span class="sd">           is true, the parent category does not have to exist.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">catname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s1">&#39;Attempt to add existing category </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">catname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
        <span class="n">syntactic_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">catparent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">semantic_root</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Head&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">semantic_root</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">semantic_root</span> <span class="o">=</span> <span class="n">semantic_root</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">semantic_root</span> <span class="o">=</span> <span class="n">syntactic_root</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">semantic_root</span> <span class="o">=</span> <span class="n">catparent</span>
        <span class="n">realname</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">NewBlock</span><span class="p">(</span><span class="n">catname</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="n">syntactic_root</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">catname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">=</span><span class="n">realname</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">catname</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catname</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_dangler</span> <span class="ow">or</span> <span class="n">catparent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">catname</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">semantic_root</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">catname</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catparent</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">catname</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catname</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">catname</span><span class="p">][</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Category&#39;</span>
        <span class="k">if</span> <span class="n">is_loop</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">catname</span><span class="p">][</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Loop&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">catname</span><span class="p">][</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Set&#39;</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">catname</span><span class="p">][</span><span class="s1">&#39;_description.text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;No definition provided&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">catname</span>

    <span class="k">def</span> <span class="nf">add_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">,</span><span class="n">catparent</span><span class="p">,</span><span class="n">def_text</span><span class="o">=</span><span class="s1">&#39;PLEASE DEFINE ME&#39;</span><span class="p">,</span><span class="n">allow_dangler</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add itemname to category [[catparent]]. If itemname contains periods,</span>
<span class="sd">        all text before the final period is ignored. If [[allow_dangler]] is True,</span>
<span class="sd">        no check for a parent category is made.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">itemname</span><span class="p">:</span>
            <span class="n">objname</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">objname</span> <span class="o">=</span> <span class="n">itemname</span>
        <span class="n">objname</span> <span class="o">=</span> <span class="n">objname</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_dangler</span> <span class="ow">and</span> <span class="p">(</span><span class="n">catparent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">[</span><span class="n">catparent</span><span class="p">][</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;Category&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s1">&#39;No category </span><span class="si">%s</span><span class="s1"> in dictionary&#39;</span> <span class="o">%</span> <span class="n">catparent</span><span class="p">)</span>
        <span class="n">fullname</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">catparent</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">objname</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;New name: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fullname</span><span class="p">)</span>
        <span class="n">syntactic_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">realname</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">NewBlock</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="n">fix</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">syntactic_root</span><span class="p">)</span> <span class="c1">#low-level change</span>
        <span class="c1"># update our dictionary structures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span><span class="o">=</span><span class="n">realname</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">fullname</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">fullname</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">fullname</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">objname</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">fullname</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">catparent</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">fullname</span><span class="p">][</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Datum&#39;</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">fullname</span><span class="p">][</span><span class="s1">&#39;_description.text&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">def_text</span>

    <span class="k">def</span> <span class="nf">remove_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">defname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a definition from the dictionary.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">defname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">defname</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Category&#39;</span><span class="p">:</span>
            <span class="n">children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_immediate_children</span><span class="p">(</span><span class="n">defname</span><span class="p">)</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_definition</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">children</span><span class="p">]</span>
            <span class="n">cat_id</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">defname</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">defname</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_cat_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return (cat,obj) tuple. [[name]] must contain only a single period&quot;&quot;&quot;</span>
        <span class="n">cat</span><span class="p">,</span><span class="n">obj</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_name_by_cat_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">category</span><span class="p">,</span><span class="nb">object</span><span class="p">,</span><span class="n">give_default</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the dataname corresponding to the given category and object&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">category</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>    <span class="c1">#accidentally left in</span>
           <span class="n">true_cat</span> <span class="o">=</span> <span class="n">category</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">true_cat</span> <span class="o">=</span> <span class="n">category</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_obj_lookup_table</span><span class="p">[(</span><span class="n">true_cat</span><span class="p">,</span><span class="nb">object</span><span class="o">.</span><span class="n">lower</span><span class="p">())][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">give_default</span><span class="p">:</span>
               <span class="k">return</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">true_cat</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">object</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No such category,object in the dictionary: </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">true_cat</span><span class="p">,</span><span class="nb">object</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">WriteOut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">myblockorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_child_list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">=</span> <span class="s1">&#39;Dic&#39;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">WriteOut</span><span class="p">(</span><span class="n">blockorder</span> <span class="o">=</span> <span class="n">myblockorder</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_full_child_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of definition blocks in order parent-child-child-child-parent-child...&quot;&quot;&quot;</span>
        <span class="n">top_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">root_cat</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;Datum&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Head&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">root_cat</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">all_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">top_block</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurse_child_list</span><span class="p">(</span><span class="n">root_cat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">unrooted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_danglers</span><span class="p">()</span>
            <span class="n">double_names</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span><span class="n">unrooted</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_names</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">double_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s1">&#39;Names are children of internal and external categories:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">double_names</span><span class="p">))</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="n">unrooted</span><span class="p">[:]</span>
            <span class="k">for</span> <span class="n">no_root</span> <span class="ow">in</span> <span class="n">unrooted</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">no_root</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Category&#39;</span><span class="p">:</span>
                    <span class="n">all_names</span> <span class="o">+=</span> <span class="p">[</span><span class="n">no_root</span><span class="p">]</span>
                    <span class="n">remaining</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">no_root</span><span class="p">)</span>
                    <span class="n">these_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">unrooted</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="n">no_root</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                    <span class="n">all_names</span> <span class="o">+=</span> <span class="n">these_children</span>
                    <span class="p">[</span><span class="n">remaining</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">these_children</span><span class="p">]</span>
            <span class="c1"># now sort by category</span>
            <span class="n">ext_cats</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_from_name</span><span class="p">(</span><span class="n">r</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">remaining</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ext_cats</span><span class="p">:</span>
                <span class="n">cat_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">remaining</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_from_name</span><span class="p">(</span><span class="n">r</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">e</span><span class="p">]</span>
                <span class="p">[</span><span class="n">remaining</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cat_items</span><span class="p">]</span>
                <span class="n">all_names</span> <span class="o">+=</span> <span class="n">cat_items</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;WARNING: following items do not seem to belong to a category??&#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">remaining</span><span class="p">))</span>
                <span class="n">all_names</span> <span class="o">+=</span> <span class="n">remaining</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Final block order: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">all_names</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">all_names</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Dictionary contains no/multiple Head categories, please print as plain CIF instead&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cat_from_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">one_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Guess the category from the name. This should be used only when this is not important semantic information,</span>
<span class="sd">        for example, when printing out&quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">cat</span><span class="p">,</span><span class="n">obj</span><span class="p">)</span> <span class="o">=</span> <span class="n">one_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span><span class="p">:</span> <span class="n">cat</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">cat</span>

    <span class="k">def</span> <span class="nf">recurse_child_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parentname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recursively expand the logical child list of [[parentname]]&quot;&quot;&quot;</span>
        <span class="n">final_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">parentname</span><span class="p">]</span>
        <span class="n">child_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">parentname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="n">child_blocks</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>    <span class="c1">#we love alphabetical order</span>
        <span class="n">child_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">child_blocks</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Item&#39;</span><span class="p">]</span>
        <span class="n">final_list</span> <span class="o">+=</span> <span class="n">child_items</span>
        <span class="n">child_cats</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">child_blocks</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Category&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">child_cat</span> <span class="ow">in</span> <span class="n">child_cats</span><span class="p">:</span>
            <span class="n">final_list</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurse_child_list</span><span class="p">(</span><span class="n">child_cat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_list</span>



    <span class="k">def</span> <span class="nf">get_key_pack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">category</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="n">keyname</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_spec</span><span class="p">]</span>
        <span class="n">onepack</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">GetPackKey</span><span class="p">(</span><span class="n">keyname</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">onepack</span>

    <span class="k">def</span> <span class="nf">get_number_with_esd</span><span class="p">(</span><span class="n">numstring</span><span class="p">):</span>
        <span class="n">numb_re</span> <span class="o">=</span> <span class="s1">&#39;((-?(([0-9]*[.]([0-9]+))|([0-9]+)[.]?))([(][0-9]+[)])?([eEdD][+-]?[0-9]+)?)|(\?)|(\.)&#39;</span>
        <span class="n">our_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">numb_re</span><span class="p">,</span><span class="n">numstring</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">our_match</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span><span class="n">base_num</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">dad</span><span class="p">,</span><span class="n">dbd</span><span class="p">,</span><span class="n">esd</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">dot</span> <span class="o">=</span> <span class="n">our_match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="c1"># print(&quot;Debug: {} -&gt; {!r}&quot;.format(numstring, our_match.groups()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>
        <span class="k">if</span> <span class="n">dot</span> <span class="ow">or</span> <span class="n">q</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>     <span class="c1">#a dot or question mark</span>
        <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>          <span class="c1">#has exponent</span>
           <span class="n">exp</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span><span class="s2">&quot;e&quot;</span><span class="p">)</span>     <span class="c1"># mop up old fashioned numbers</span>
           <span class="n">exp</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">,</span><span class="s2">&quot;e&quot;</span><span class="p">)</span>
           <span class="n">base_num</span> <span class="o">=</span> <span class="n">base_num</span> <span class="o">+</span> <span class="n">exp</span>
        <span class="c1"># print(&quot;Debug: have %s for base_num from %s&quot; % (base_num,numstring))</span>
        <span class="n">base_num</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">base_num</span><span class="p">)</span>
        <span class="c1"># work out esd, if present.</span>
        <span class="k">if</span> <span class="n">esd</span><span class="p">:</span>
            <span class="n">esd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">esd</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>    <span class="c1"># no brackets</span>
            <span class="k">if</span> <span class="n">dad</span><span class="p">:</span>                   <span class="c1"># decimal point + digits</span>
                <span class="n">esd</span> <span class="o">=</span> <span class="n">esd</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dad</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>
                <span class="n">esd</span> <span class="o">=</span> <span class="n">esd</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))</span>
        <span class="k">return</span> <span class="n">base_num</span><span class="p">,</span><span class="n">esd</span>

    <span class="k">def</span> <span class="nf">getmaxmin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rangeexp</span><span class="p">):</span>
        <span class="n">regexp</span> <span class="o">=</span> <span class="s1">&#39;(-?(([0-9]*[.]([0-9]+))|([0-9]+)[.]?)([eEdD][+-]?[0-9]+)?)*&#39;</span>
        <span class="n">regexp</span> <span class="o">=</span> <span class="n">regexp</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">regexp</span>
        <span class="n">regexp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regexp</span><span class="p">,</span><span class="n">rangeexp</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">minimum</span> <span class="o">=</span> <span class="n">regexp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">maximum</span> <span class="o">=</span> <span class="n">regexp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Can&#39;t match </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rangeexp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">minimum</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">minimum</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">minimum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">minimum</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maximum</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">maximum</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">maximum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">maximum</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">maximum</span><span class="p">,</span><span class="n">minimum</span>

    <span class="k">def</span> <span class="nf">initialise_drel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse drel functions and prepare data structures in dictionary&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_parse_valid</span><span class="p">()</span> <span class="c1">#extract validity information from data block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform_drel</span><span class="p">()</span>   <span class="c1">#parse the drel functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_drel_funcs</span><span class="p">()</span>   <span class="c1">#put the drel functions into the namespace</span>

    <span class="k">def</span> <span class="nf">transform_drel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.drel</span> <span class="kn">import</span> <span class="n">drel_ast_yacc</span>
        <span class="kn">from</span> <span class="nn">.drel</span> <span class="kn">import</span> <span class="n">py_from_ast</span>
        <span class="kn">import</span> <span class="nn">traceback</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">drel_ast_yacc</span><span class="o">.</span><span class="n">parser</span>
        <span class="n">lexer</span> <span class="o">=</span> <span class="n">drel_ast_yacc</span><span class="o">.</span><span class="n">lexer</span>
        <span class="n">my_namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">my_namespace</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">my_namespace</span><span class="p">,</span><span class="n">my_namespace</span><span class="p">))</span>
        <span class="c1"># we provide a table of loopable categories {cat_name:((key1,key2..),[item_name,...]),...})</span>
        <span class="n">loopable_cats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loopable_cats</span><span class="p">()</span>
        <span class="n">loop_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s2">&quot;_category_key.name&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopable_cats</span><span class="p">]</span>
        <span class="n">loop_keys</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">loop_keys</span><span class="p">]</span>
        <span class="n">cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">names_in_cat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">names_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopable_cats</span><span class="p">]</span>
        <span class="n">loop_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">loopable_cats</span><span class="p">,</span><span class="nb">zip</span><span class="p">(</span><span class="n">loop_keys</span><span class="p">,</span><span class="n">cat_names</span><span class="p">)))</span>
        <span class="c1"># parser.listable_items = [a for a in self.keys() if &quot;*&quot; in self[a].get(&quot;_type.dimension&quot;,&quot;&quot;)]</span>
        <span class="n">derivable_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;_method.expression&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> \
                              <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_name.category_id&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">!=</span> <span class="s2">&quot;function&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">derivable</span> <span class="ow">in</span> <span class="n">derivable_list</span><span class="p">:</span>
            <span class="n">target_id</span> <span class="o">=</span> <span class="n">derivable</span>
            <span class="c1"># reset the list of visible names for parser</span>
            <span class="n">special_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()))]</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Target id: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">derivable</span><span class="p">)</span>
            <span class="n">drel_exprs</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">derivable</span><span class="p">][</span><span class="s2">&quot;_method.expression&quot;</span><span class="p">]</span>
            <span class="n">drel_purposes</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">derivable</span><span class="p">][</span><span class="s2">&quot;_method.purpose&quot;</span><span class="p">]</span>
            <span class="n">all_methods</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">drel_exprs</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">drel_exprs</span> <span class="o">=</span> <span class="p">[</span><span class="n">drel_exprs</span><span class="p">]</span>
                <span class="n">drel_purposes</span> <span class="o">=</span> <span class="p">[</span><span class="n">drel_purposes</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">drel_purpose</span><span class="p">,</span><span class="n">drel_expr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">drel_purposes</span><span class="p">,</span><span class="n">drel_exprs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">drel_purpose</span> <span class="o">!=</span> <span class="s1">&#39;Evaluation&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">drel_expr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">drel_expr</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
                <span class="c1"># print(&quot;Transforming %s&quot; % drel_expr)</span>
                <span class="c1"># List categories are treated differently...</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">meth_ast</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">drel_expr</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">lexer</span><span class="o">=</span><span class="n">lexer</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Syntax error in method for </span><span class="si">%s</span><span class="s1">; leaving as is&#39;</span> <span class="o">%</span> <span class="n">derivable</span><span class="p">)</span>
                    <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">print</span><span class="p">((</span><span class="nb">repr</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">print_tb</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="bp">None</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">))</span>
                    <span class="c1"># reset the lexer</span>
                    <span class="n">lexer</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="s1">&#39;INITIAL&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># Construct the python method</span>
                <span class="n">cat_meth</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">derivable</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Category&#39;</span><span class="p">:</span>
                    <span class="n">cat_meth</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">pyth_meth</span> <span class="o">=</span> <span class="n">py_from_ast</span><span class="o">.</span><span class="n">make_python_function</span><span class="p">(</span><span class="n">meth_ast</span><span class="p">,</span><span class="s2">&quot;pyfunc&quot;</span><span class="p">,</span><span class="n">target_id</span><span class="p">,</span>
                                                                           <span class="n">loopable</span><span class="o">=</span><span class="n">loop_info</span><span class="p">,</span>
                                                             <span class="n">cif_dic</span> <span class="o">=</span> <span class="bp">self</span><span class="p">,</span><span class="n">cat_meth</span><span class="o">=</span><span class="n">cat_meth</span><span class="p">)</span>
                <span class="n">all_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyth_meth</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_methods</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">save_overwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">derivable</span><span class="p">]</span><span class="o">.</span><span class="n">overwrite</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">derivable</span><span class="p">]</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">derivable</span><span class="p">][</span><span class="s2">&quot;_method.py_expression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_methods</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">derivable</span><span class="p">]</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="n">save_overwrite</span>
            <span class="c1">#print(&quot;Final result:\n &quot; + repr(self[derivable][&quot;_method.py_expression&quot;]))</span>

    <span class="k">def</span> <span class="nf">add_drel_funcs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.drel</span> <span class="kn">import</span> <span class="n">drel_ast_yacc</span>
        <span class="kn">from</span> <span class="nn">.drel</span> <span class="kn">import</span> <span class="n">py_from_ast</span>
        <span class="n">funclist</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_name.category_id&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;function&#39;</span><span class="p">]</span>
        <span class="n">funcnames</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s2">&quot;_name.object_id&quot;</span><span class="p">],</span>
                      <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">GetKeyedPacket</span><span class="p">(</span><span class="s2">&quot;_method.purpose&quot;</span><span class="p">,</span><span class="s2">&quot;Evaluation&quot;</span><span class="p">),</span><span class="s2">&quot;_method.expression&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">funclist</span><span class="p">]</span>
        <span class="c1"># create executable python code...</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">drel_ast_yacc</span><span class="o">.</span><span class="n">parser</span>
        <span class="c1"># we provide a table of loopable categories {cat_name:(key,[item_name,...]),...})</span>
        <span class="n">loopable_cats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loopable_cats</span><span class="p">()</span>
        <span class="n">loop_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s2">&quot;_category_key.name&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopable_cats</span><span class="p">]</span>
        <span class="n">loop_keys</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_name.object_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">loop_keys</span><span class="p">]</span>
        <span class="n">cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">names_in_cat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">names_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopable_cats</span><span class="p">]</span>
        <span class="n">loop_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">loopable_cats</span><span class="p">,</span><span class="nb">zip</span><span class="p">(</span><span class="n">loop_keys</span><span class="p">,</span><span class="n">cat_names</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">funcname</span><span class="p">,</span><span class="n">funcbody</span> <span class="ow">in</span> <span class="n">funcnames</span><span class="p">:</span>
            <span class="n">newline_body</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">funcbody</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">target_id</span> <span class="o">=</span> <span class="n">funcname</span>
            <span class="n">res_ast</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">newline_body</span><span class="p">)</span>
            <span class="n">py_function</span> <span class="o">=</span> <span class="n">py_from_ast</span><span class="o">.</span><span class="n">make_python_function</span><span class="p">(</span><span class="n">res_ast</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="n">targetname</span><span class="o">=</span><span class="n">funcname</span><span class="p">,</span><span class="n">func_def</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">loopable</span><span class="o">=</span><span class="n">loop_info</span><span class="p">,</span><span class="n">cif_dic</span> <span class="o">=</span> <span class="bp">self</span><span class="p">)</span>
            <span class="c1">#print(&#39;dREL library function -&gt;\n&#39; + py_function)</span>
            <span class="n">global_table</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span>
            <span class="k">exec</span><span class="p">(</span><span class="n">py_function</span><span class="p">,</span> <span class="n">global_table</span><span class="p">)</span>    <span class="c1">#add to namespace</span>
        <span class="c1">#print(&#39;Globals after dREL functions added:&#39; + repr(globals()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddlm_functions</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span>  <span class="c1">#for outside access</span>

    <span class="nd">@track_recursion</span>
    <span class="k">def</span> <span class="nf">derive_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">start_key</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">store_value</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span><span class="n">allow_defaults</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">start_key</span>   <span class="c1">#starting value</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>     <span class="c1">#success is a non-None value</span>
        <span class="n">default_result</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1">#we have not used a default value</span>
        <span class="c1"># check for aliases</span>
        <span class="c1"># check for an older form of a new value</span>
        <span class="n">found_it</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,[])</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cifdata</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_it</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">corrected_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">cifdata</span><span class="p">[</span><span class="n">found_it</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">return</span> <span class="n">corrected_type</span>
        <span class="c1"># now do the reverse check - any alternative form</span>
        <span class="n">alias_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Aliases for </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">alias_name</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alias_name</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">alias_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>   <span class="c1">#actual definition name</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cifdata</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">cifdata</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">found_it</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">alias_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cifdata</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_it</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">cifdata</span><span class="p">[</span><span class="n">found_it</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">alias_name</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s1">&#39;Dictionary error: dataname alias appears in different definitions: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">alias_name</span><span class="p">))</span>

        <span class="n">the_category</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;_name.category_id&quot;</span><span class="p">]</span>
        <span class="n">cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_name.category_id&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span><span class="o">==</span><span class="n">the_category</span><span class="p">]</span>
        <span class="n">has_cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cat_names</span> <span class="k">if</span> <span class="n">cifdata</span><span class="o">.</span><span class="n">has_key_or_alias</span><span class="p">(</span><span class="n">a</span><span class="p">)]</span>
        <span class="c1"># store any default value in case we have a problem</span>
        <span class="n">def_val</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_enumeration.default&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">def_index_val</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_enumeration.def_index_id&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">has_cat_names</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># try category method</span>
            <span class="n">cat_result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">pulled_from_cats</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;_category_construct_local.components&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
            <span class="n">pulled_from_cats</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,[</span>
                                  <span class="bp">self</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;_category_construct_local.components&#39;</span><span class="p">]]</span>
                               <span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pulled_from_cats</span><span class="p">]</span>
            <span class="n">pulled_to_cats</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pulled_from_cats</span> <span class="k">if</span> <span class="n">the_category</span> <span class="ow">in</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">if</span> <span class="s1">&#39;_category_construct_local.type&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">the_category</span><span class="p">]:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;**Now constructing category </span><span class="si">%s</span><span class="s2"> using DDLm attributes**&quot;</span> <span class="o">%</span> <span class="n">the_category</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cat_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_category</span><span class="p">(</span><span class="n">the_category</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">CifRecursionError</span><span class="p">,</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarDerivationError</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;** Failed to construct category </span><span class="si">%s</span><span class="s1"> (error)&#39;</span> <span class="o">%</span> <span class="n">the_category</span><span class="p">)</span>
            <span class="c1"># Trying a pull-back when the category is partially populated</span>
            <span class="c1"># will not work, hence we test that cat_result has no keys</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pulled_to_cats</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat_result</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;**Now populating category </span><span class="si">%s</span><span class="s2"> from pulled-back category </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">the_category</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">pulled_to_cats</span><span class="p">)))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cat_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">push_from_pullback</span><span class="p">(</span><span class="n">the_category</span><span class="p">,</span><span class="n">pulled_to_cats</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">CifRecursionError</span><span class="p">,</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarDerivationError</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;** Failed to construct category </span><span class="si">%s</span><span class="s1"> from pullback information (error)&#39;</span> <span class="o">%</span> <span class="n">the_category</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;_method.py_expression&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">the_category</span><span class="p">]</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cat_result</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;**Now applying category method for </span><span class="si">%s</span><span class="s2"> in search of </span><span class="si">%s</span><span class="s2">**&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">the_category</span><span class="p">,</span><span class="n">key</span><span class="p">))</span>
                <span class="n">cat_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derive_item</span><span class="p">(</span><span class="n">the_category</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;**Tried pullbacks, obtained for </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">the_category</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">cat_result</span><span class="p">))</span>
            <span class="c1"># do we now have our value?</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cat_result</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cat_result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># Recalculate in case it actually worked</span>
        <span class="n">has_cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cat_names</span> <span class="k">if</span> <span class="n">cifdata</span><span class="o">.</span><span class="n">has_key_or_alias</span><span class="p">(</span><span class="n">a</span><span class="p">)]</span>
        <span class="n">the_funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_method.py_expression&#39;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">the_funcs</span><span class="p">:</span>   <span class="c1">#attempt to calculate it</span>
            <span class="c1">#global_table = globals()</span>
            <span class="c1">#global_table.update(self.ddlm_functions)</span>
            <span class="k">for</span> <span class="n">one_func</span> <span class="ow">in</span> <span class="n">the_funcs</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Executing function for </span><span class="si">%s</span><span class="s1">:&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
                <span class="c1">#print(one_func)</span>
                <span class="k">exec</span><span class="p">(</span><span class="n">one_func</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>  <span class="c1">#will access dREL functions, puts &quot;pyfunc&quot; in scope</span>
                <span class="c1"># print(&#39;in following global environment: &#39; + repr(global_table))</span>
                <span class="n">stored_setting</span> <span class="o">=</span> <span class="n">cifdata</span><span class="o">.</span><span class="n">provide_value</span>
                <span class="n">cifdata</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">pyfunc</span><span class="p">(</span><span class="n">cifdata</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">CifRecursionError</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">except</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">StarDerivationError</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">cifdata</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="n">stored_setting</span>
                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="c1">#print(&quot;Function returned {!r}&quot;.format(result))</span>

        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">allow_defaults</span><span class="p">:</span>   <span class="c1"># try defaults</span>
            <span class="k">if</span> <span class="n">def_val</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">def_val</span><span class="p">)</span>
                <span class="n">default_result</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">def_index_val</span><span class="p">:</span>            <span class="c1">#derive a default value</span>
                <span class="n">index_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;_enumeration_default.index&quot;</span><span class="p">]</span>
                <span class="n">val_to_index</span> <span class="o">=</span> <span class="n">cifdata</span><span class="p">[</span><span class="n">def_index_val</span><span class="p">]</span>     <span class="c1">#what we are keying on</span>
                <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">def_index_val</span><span class="p">][</span><span class="s1">&#39;_type.contents&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Code&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span><span class="s1">&#39;Tag&#39;</span><span class="p">]:</span>
                    <span class="n">lcase_comp</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">index_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">index_vals</span><span class="p">]</span>
                <span class="c1"># Handle loops</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val_to_index</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">lcase_comp</span><span class="p">:</span>
                        <span class="n">val_to_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">val_to_index</span><span class="p">]</span>
                    <span class="n">keypos</span> <span class="o">=</span> <span class="p">[</span><span class="n">index_vals</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">val_to_index</span><span class="p">]</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;_enumeration_default.value&quot;</span><span class="p">][</span><span class="n">a</span><span class="p">]</span>  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">keypos</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">lcase_comp</span><span class="p">:</span>
                        <span class="n">val_to_index</span> <span class="o">=</span> <span class="n">val_to_index</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">keypos</span> <span class="o">=</span> <span class="n">index_vals</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">val_to_index</span><span class="p">)</span>   <span class="c1">#value error if no such value available</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;_enumeration_default.value&quot;</span><span class="p">][</span><span class="n">keypos</span><span class="p">]</span>
                    <span class="n">default_result</span> <span class="o">=</span> <span class="bp">True</span>   <span class="c1">#flag that it must be extended</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Indexed on </span><span class="si">%s</span><span class="s2"> to get </span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">def_index_val</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">val_to_index</span><span class="p">)))</span>

        <span class="c1"># read it in</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>   <span class="c1">#can&#39;t do anything else</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Warning: no way of deriving item </span><span class="si">%s</span><span class="s1">, allow_defaults is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">allow_defaults</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">StarDerivationError</span><span class="p">(</span><span class="n">start_key</span><span class="p">)</span>
        <span class="n">is_looped</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">the_category</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.class&#39;</span><span class="p">,</span><span class="s1">&#39;Set&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Loop&#39;</span><span class="p">:</span>
            <span class="n">is_looped</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">has_cat_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>   <span class="c1">#this category already exists</span>
                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">default_result</span><span class="p">:</span> <span class="c1">#need to create a list of values</span>
                    <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cifdata</span><span class="p">[</span><span class="n">has_cat_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="n">out_result</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">]</span><span class="o">*</span><span class="n">loop_len</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">out_result</span>
            <span class="k">else</span><span class="p">:</span>   <span class="c1">#nothing exists in this category, we can&#39;t store this at all</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Resetting result </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> to null list as category is empty&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">result</span><span class="p">))</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># now try to insert the new information into the right place</span>
        <span class="c1"># find if items of this category already appear...</span>
        <span class="c1"># Never cache empty values</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span>\
          <span class="n">store_value</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_definition.scope&quot;</span><span class="p">,</span><span class="s2">&quot;Item&quot;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Item&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_looped</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_new_looped_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">default_result</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_new_unlooped_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store_new_cat_values</span><span class="p">(</span><span class="n">cifdata</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">the_category</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">store_new_looped_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">default_result</span><span class="p">):</span>
          <span class="sd">&quot;&quot;&quot;Store a looped value from the dREL system into a CifFile&quot;&quot;&quot;</span>
          <span class="c1"># try to change any matrices etc. to lists</span>
          <span class="n">the_category</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;_name.category_id&quot;</span><span class="p">]</span>
          <span class="n">out_result</span> <span class="o">=</span> <span class="n">result</span>
          <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">default_result</span><span class="p">:</span>
                  <span class="c1"># find any numpy arrays</span>
                  <span class="k">def</span> <span class="nf">conv_from_numpy</span><span class="p">(</span><span class="n">one_elem</span><span class="p">):</span>
                      <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">one_elem</span><span class="p">,</span><span class="s1">&#39;dtype&#39;</span><span class="p">):</span>
                         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">one_elem</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span>
                            <span class="k">return</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">StarList</span><span class="p">([</span><span class="n">conv_from_numpy</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">one_elem</span><span class="p">])</span>
                         <span class="k">return</span> <span class="n">one_elem</span>
                      <span class="k">if</span> <span class="n">one_elem</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>   <span class="c1">#so is not a float</span>
                         <span class="k">return</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">StarList</span><span class="p">([</span><span class="n">conv_from_numpy</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">one_elem</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span>
                      <span class="k">else</span><span class="p">:</span>
                          <span class="k">try</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">one_elem</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                          <span class="k">except</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">one_elem</span>
                  <span class="n">out_result</span> <span class="o">=</span> <span class="p">[</span><span class="n">conv_from_numpy</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
          <span class="c1"># so out_result now contains a value suitable for storage</span>
          <span class="n">cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_name.category_id&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span><span class="o">==</span><span class="n">the_category</span><span class="p">]</span>
          <span class="n">has_cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cat_names</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cifdata</span><span class="p">]</span>
          <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Adding {}, found pre-existing names: &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">has_cat_names</span><span class="p">))</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">has_cat_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>   <span class="c1">#this category already exists</span>
              <span class="n">cifdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_result</span>      <span class="c1">#lengths must match or else!!</span>
              <span class="n">cifdata</span><span class="o">.</span><span class="n">AddLoopName</span><span class="p">(</span><span class="n">has_cat_names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">key</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
              <span class="n">cifdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_result</span>
              <span class="n">cifdata</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">([</span><span class="n">key</span><span class="p">])</span>
          <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Loop info:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">cifdata</span><span class="o">.</span><span class="n">loops</span><span class="p">))</span>
          <span class="k">return</span> <span class="n">out_result</span>

    <span class="k">def</span> <span class="nf">store_new_unlooped_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">result</span><span class="p">):</span>
          <span class="sd">&quot;&quot;&quot;Store a single value from the dREL system&quot;&quot;&quot;</span>
          <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="s1">&#39;dtype&#39;</span><span class="p">):</span>
              <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                  <span class="n">out_result</span> <span class="o">=</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">StarList</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                  <span class="n">cifdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_result</span>
              <span class="k">else</span><span class="p">:</span>
                  <span class="n">cifdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
              <span class="n">cifdata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
          <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">construct_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">category</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a category using DDLm attributes&quot;&quot;&quot;</span>
        <span class="n">con_type</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_category_construct_local.type&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">con_type</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">con_type</span> <span class="o">==</span> <span class="s1">&#39;Pullback&#39;</span> <span class="ow">or</span> <span class="n">con_type</span> <span class="o">==</span> <span class="s1">&#39;Filter&#39;</span><span class="p">:</span>
            <span class="n">morphisms</span>  <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="s1">&#39;_category_construct_local.components&#39;</span><span class="p">]</span>
            <span class="n">morph_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">cifdata</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">morphisms</span><span class="p">]</span> <span class="c1"># the mapped values for each cat</span>
            <span class="n">cats</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">morphisms</span><span class="p">]</span>
            <span class="n">cat_keys</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_category.key_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cats</span><span class="p">]</span>
            <span class="n">cat_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cifdata</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cat_keys</span><span class="p">]</span> <span class="c1">#the category key values for each cat</span>
            <span class="k">if</span> <span class="n">con_type</span> <span class="o">==</span> <span class="s1">&#39;Filter&#39;</span><span class="p">:</span>
                <span class="n">int_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_category_construct_local.integer_filter&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
                <span class="n">text_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_category_construct_local.text_filter&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">int_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">morph_values</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">int_filter</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">text_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">morph_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text_filter</span><span class="p">)</span>
                <span class="n">cat_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">morph_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
            <span class="c1"># create the mathematical product filtered by equality of dataname values</span>
            <span class="n">pullback_ids</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cat_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">cat_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> \
                            <span class="k">if</span> <span class="n">morph_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cat_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span><span class="o">==</span><span class="n">morph_values</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">cat_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">y</span><span class="p">)]]</span>
            <span class="c1"># now prepare for return</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pullback_ids</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{}</span>
            <span class="n">newids</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="s1">&#39;_category_construct_local.new_ids&#39;</span><span class="p">]</span>
            <span class="n">fullnewids</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_obj_lookup_table</span><span class="p">[(</span><span class="n">category</span><span class="p">,</span><span class="n">n</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">newids</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">con_type</span> <span class="o">==</span> <span class="s1">&#39;Pullback&#39;</span><span class="p">:</span>
                <span class="n">final_results</span> <span class="o">=</span> <span class="p">{</span><span class="n">fullnewids</span><span class="p">[</span><span class="mi">0</span><span class="p">]:[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pullback_ids</span><span class="p">],</span><span class="n">fullnewids</span><span class="p">[</span><span class="mi">1</span><span class="p">]:[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pullback_ids</span><span class="p">]}</span>
                <span class="n">final_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicate_datanames</span><span class="p">(</span><span class="n">cifdata</span><span class="p">,</span><span class="n">cats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">category</span><span class="p">,</span><span class="n">key_vals</span> <span class="o">=</span> <span class="n">final_results</span><span class="p">[</span><span class="n">fullnewids</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">skip_names</span><span class="o">=</span><span class="n">newids</span><span class="p">))</span>
                <span class="n">final_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicate_datanames</span><span class="p">(</span><span class="n">cifdata</span><span class="p">,</span><span class="n">cats</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">category</span><span class="p">,</span><span class="n">key_vals</span> <span class="o">=</span> <span class="n">final_results</span><span class="p">[</span><span class="n">fullnewids</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">skip_names</span><span class="o">=</span><span class="n">newids</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">con_type</span> <span class="o">==</span> <span class="s1">&#39;Filter&#39;</span><span class="p">:</span>   <span class="c1">#simple filter</span>
                <span class="n">final_results</span> <span class="o">=</span> <span class="p">{</span><span class="n">fullnewids</span><span class="p">[</span><span class="mi">0</span><span class="p">]:[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pullback_ids</span><span class="p">]}</span>
                <span class="n">final_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicate_datanames</span><span class="p">(</span><span class="n">cifdata</span><span class="p">,</span><span class="n">cats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">category</span><span class="p">,</span><span class="n">key_vals</span> <span class="o">=</span> <span class="n">final_results</span><span class="p">[</span><span class="n">fullnewids</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">skip_names</span><span class="o">=</span><span class="n">newids</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">store_value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store_new_cat_values</span><span class="p">(</span><span class="n">cifdata</span><span class="p">,</span><span class="n">final_results</span><span class="p">,</span><span class="n">category</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">final_results</span>

    <span class="k">def</span> <span class="nf">push_from_pullback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">target_category</span><span class="p">,</span><span class="n">source_categories</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">store_value</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Each of the categories in source_categories are pullbacks that include</span>
<span class="sd">        the target_category&quot;&quot;&quot;</span>
        <span class="n">target_key</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">target_category</span><span class="p">][</span><span class="s1">&#39;_category.key_id&#39;</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">target_key</span><span class="p">:[]}</span>
        <span class="n">first_time</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># for each source category, determine which element goes to the target</span>
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">source_categories</span><span class="p">:</span>
            <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">sc</span><span class="p">][</span><span class="s1">&#39;_category_construct_local.components&#39;</span><span class="p">]</span>
            <span class="n">comp_cats</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;_name.category_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">components</span><span class="p">]</span>
            <span class="n">new_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">sc</span><span class="p">][</span><span class="s1">&#39;_category_construct_local.new_ids&#39;</span><span class="p">]</span>
            <span class="n">source_ids</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_obj_lookup_table</span><span class="p">[(</span><span class="n">sc</span><span class="p">,</span><span class="n">n</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">new_ids</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># not a filter</span>
                <span class="n">element_pos</span> <span class="o">=</span> <span class="n">comp_cats</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target_category</span><span class="p">)</span>
                <span class="n">old_id</span> <span class="o">=</span> <span class="n">source_ids</span><span class="p">[</span><span class="n">element_pos</span><span class="p">]</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Using </span><span class="si">%s</span><span class="s1"> to populate </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">old_id</span><span class="p">,</span><span class="n">target_key</span><span class="p">))</span>
                <span class="n">result</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cifdata</span><span class="p">[</span><span class="n">old_id</span><span class="p">])</span>
                <span class="c1"># project through all identical names</span>
                <span class="n">extra_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_datanames</span><span class="p">(</span><span class="n">cifdata</span><span class="p">,</span><span class="n">sc</span><span class="p">,</span><span class="n">target_category</span><span class="p">,</span><span class="n">skip_names</span><span class="o">=</span><span class="n">new_ids</span><span class="o">+</span><span class="p">[</span><span class="n">target_key</span><span class="p">])</span>
                <span class="c1"># we only include keys that are common to all categories</span>
                <span class="k">if</span> <span class="n">first_time</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_result</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">extra_result</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Updating </span><span class="si">%s</span><span class="s1">: was </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">])))</span>
                            <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_result</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extra_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_datanames</span><span class="p">(</span><span class="n">cifdata</span><span class="p">,</span><span class="n">sc</span><span class="p">,</span><span class="n">target_category</span><span class="p">,</span><span class="n">skip_names</span><span class="o">=</span><span class="n">new_ids</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra_result</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">source_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cifdata</span><span class="p">:</span>  <span class="c1">#something is present</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cifdata</span><span class="p">[</span><span class="n">source_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">extra_result</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Reverse filter: Updating </span><span class="si">%s</span><span class="s1">: was </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">])))</span>
                            <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_result</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">extra_result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="c1"># Bonus derivation if there is a singleton filter</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">sc</span><span class="p">][</span><span class="s1">&#39;_category_construct_local.type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Filter&#39;</span><span class="p">:</span>
                        <span class="n">int_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">sc</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_category_construct_local.integer_filter&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
                        <span class="n">text_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">sc</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_category_construct_local.text_filter&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">int_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">filter_values</span> <span class="o">=</span> <span class="n">int_filter</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">filter_values</span> <span class="o">=</span> <span class="n">text_filter</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filter_values</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>    <span class="c1">#a singleton</span>
                            <span class="n">extra_dataname</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">sc</span><span class="p">][</span><span class="s1">&#39;_category_construct_local.components&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">int_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">new_value</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">filter_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cifdata</span><span class="p">[</span><span class="n">source_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">new_value</span> <span class="o">=</span> <span class="n">filter_values</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cifdata</span><span class="p">[</span><span class="n">source_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                            <span class="k">if</span> <span class="n">extra_dataname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                                <span class="n">result</span><span class="p">[</span><span class="n">extra_dataname</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">result</span><span class="p">[</span><span class="n">extra_dataname</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unexpected category construct type&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="n">sc</span><span class="p">][</span><span class="s1">&#39;_category_construct_local.type&#39;</span><span class="p">])</span>
            <span class="n">first_time</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># check for sanity - all dataname lengths must be identical</span>
        <span class="n">datalen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>
        <span class="k">if</span> <span class="n">datalen</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;Failed to construct equal-length category items,&#39;</span><span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">store_value</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Now storing &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store_new_cat_values</span><span class="p">(</span><span class="n">cifdata</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">target_category</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">duplicate_datanames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">from_category</span><span class="p">,</span><span class="n">to_category</span><span class="p">,</span><span class="n">key_vals</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">skip_names</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Copy across datanames for which the from_category key equals [[key_vals]]&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">s_names_in_cat</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names_in_cat</span><span class="p">(</span><span class="n">from_category</span><span class="p">,</span><span class="n">names_only</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">t_names_in_cat</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names_in_cat</span><span class="p">(</span><span class="n">to_category</span><span class="p">,</span><span class="n">names_only</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">can_project</span> <span class="o">=</span> <span class="n">s_names_in_cat</span> <span class="o">&amp;</span> <span class="n">t_names_in_cat</span>
        <span class="n">can_project</span> <span class="o">-=</span> <span class="nb">set</span><span class="p">(</span><span class="n">skip_names</span><span class="p">)</span>  <span class="c1">#already dealt with</span>
        <span class="n">source_key</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">from_category</span><span class="p">][</span><span class="s1">&#39;_category.key_id&#39;</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Source dataname set: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s_names_in_cat</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Target dataname set: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">t_names_in_cat</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Projecting through following datanames from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">from_category</span><span class="p">,</span><span class="n">to_category</span><span class="p">)</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">can_project</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">project_name</span> <span class="ow">in</span> <span class="n">can_project</span><span class="p">:</span>
            <span class="n">full_from_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_obj_lookup_table</span><span class="p">[(</span><span class="n">from_category</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="n">project_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">full_to_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_obj_lookup_table</span><span class="p">[(</span><span class="n">to_category</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="n">project_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key_vals</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">full_to_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cifdata</span><span class="p">[</span><span class="n">full_from_name</span><span class="p">]</span>
                <span class="k">except</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">StarDerivationError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_key_vals</span> <span class="o">=</span> <span class="n">cifdata</span><span class="p">[</span><span class="n">source_key</span><span class="p">]</span>
                <span class="n">filter_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_key_vals</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">key_vals</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">all_data_vals</span> <span class="o">=</span> <span class="n">cifdata</span><span class="p">[</span><span class="n">full_from_name</span><span class="p">]</span>
                <span class="k">except</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">StarDerivationError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">result</span><span class="p">[</span><span class="n">full_to_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_data_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filter_pos</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">store_new_cat_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">the_category</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store the values in [[result]] into [[cifdata]]&quot;&quot;&quot;</span>
        <span class="n">the_key</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_type.purpose&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span>
        <span class="n">double_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cifdata</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">double_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">already_present</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names_in_cat</span><span class="p">(</span><span class="n">the_category</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cifdata</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">already_present</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Category </span><span class="si">%s</span><span class="s2"> not updated, mismatched datanames: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">the_category</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">already_present</span><span class="p">)</span><span class="o">^</span><span class="nb">set</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
                <span class="k">return</span>
            <span class="c1">#check key values</span>
            <span class="n">old_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cifdata</span><span class="p">[</span><span class="n">the_key</span><span class="p">])</span>
            <span class="n">common_keys</span> <span class="o">=</span> <span class="n">old_keys</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">the_key</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">common_keys</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Category </span><span class="si">%s</span><span class="s2"> not updated, key values in common:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">common_keys</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="c1">#extend result values with old values</span>
            <span class="k">for</span> <span class="n">one_name</span><span class="p">,</span><span class="n">one_value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">result</span><span class="p">[</span><span class="n">one_name</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cifdata</span><span class="p">[</span><span class="n">one_name</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">one_name</span><span class="p">,</span> <span class="n">one_value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store_new_looped_value</span><span class="p">(</span><span class="n">one_name</span><span class="p">,</span><span class="n">cifdata</span><span class="p">,</span><span class="n">one_value</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">StarFile</span><span class="o">.</span><span class="n">StarError</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: Not replacing </span><span class="si">%s</span><span class="s1"> with calculated </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">one_name</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">cifdata</span><span class="p">[</span><span class="n">one_name</span><span class="p">]),</span><span class="nb">repr</span><span class="p">(</span><span class="n">one_value</span><span class="p">)))</span>
        <span class="c1">#put the key as the first item</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Fixing item order for {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">the_key</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="n">the_key</span><span class="p">:</span>  <span class="c1">#should only be one</span>
            <span class="n">cifdata</span><span class="o">.</span><span class="n">ChangeItemOrder</span><span class="p">(</span><span class="n">one_key</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">generate_default_packet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">catname</span><span class="p">,</span><span class="n">catkey</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a StarPacket with items from ``catname`` and a key value</span>
<span class="sd">        of ``keyvalue``&quot;&quot;&quot;</span>
        <span class="n">newpack</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">na</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names_in_cat</span><span class="p">(</span><span class="n">catname</span><span class="p">):</span>
            <span class="n">def_val</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">na</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_enumeration.default&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">def_val</span><span class="p">:</span>
                <span class="n">final_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_type</span><span class="p">(</span><span class="n">na</span><span class="p">,</span><span class="n">def_val</span><span class="p">)</span>
                <span class="n">newpack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">final_val</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">newpack</span><span class="p">,</span><span class="n">na</span><span class="p">,</span><span class="n">final_val</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newpack</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">newpack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">keyvalue</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">newpack</span><span class="p">,</span><span class="n">catkey</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newpack</span>


    <span class="k">def</span> <span class="nf">switch_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">to_val</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">change_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">,</span><span class="n">inval</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inval</span> <span class="o">==</span> <span class="s2">&quot;?&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="n">inval</span>
        <span class="n">change_function</span> <span class="o">=</span> <span class="n">convert_type</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">itemname</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inval</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inval</span><span class="p">,</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarList</span><span class="p">):</span>   <span class="c1">#from a loop</span>
            <span class="n">newval</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">change_function</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">inval</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newval</span> <span class="o">=</span> <span class="n">change_function</span><span class="p">(</span><span class="n">inval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newval</span>

    <span class="k">def</span> <span class="nf">install_validation_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Install the DDL-appropriate validation checks&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diclang</span> <span class="o">!=</span> <span class="s1">&#39;DDLm&#39;</span><span class="p">:</span>
            <span class="c1"># functions which check conformance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_validation_funs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_item_type</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_item_esd</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_item_enum</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_enum_range</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_looping</span>
            <span class="p">]</span>
            <span class="c1"># functions checking loop values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop_validation_funs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_loop_membership</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_loop_key</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_loop_references</span>
            <span class="p">]</span>
            <span class="c1"># where we need to look at other values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_validation_funs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_exclusion</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_parent</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_child</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_dependents</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_uniqueness</span>
            <span class="p">]</span>
            <span class="c1"># where only a full block will do</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_validation_funs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_mandatory_category</span>
            <span class="p">]</span>
            <span class="c1"># removal is quicker with special checks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_remove_validation_funs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_remove_parent_child</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">diclang</span> <span class="o">==</span> <span class="s1">&#39;DDLm&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_validation_funs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_item_enum</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_item_esd_ddlm</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop_validation_funs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_looping_ddlm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_loop_key_ddlm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_loop_membership</span>
                <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_validation_funs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_validation_funs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_mandatory_items</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_prohibited_items</span>
                <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_remove_validation_funs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span> <span class="o">=</span> <span class="bp">False</span>        <span class="c1"># default value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_parents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_keys</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">validate_item_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">mymatch</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="n">target_type</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type_spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_type</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>          <span class="c1"># e.g. a category definition</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>                  <span class="c1"># not restricted in any way</span>
        <span class="n">matchexpr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typedic</span><span class="p">[</span><span class="n">target_type</span><span class="p">]</span>
        <span class="n">item_values</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">item_value</span><span class="p">)</span>
        <span class="c1">#for item in item_values:</span>
            <span class="c1">#print(&quot;Type match &quot; + item_name + &quot; &quot; + item + &quot;:&quot;,)</span>
        <span class="c1">#skip dots and question marks</span>
        <span class="n">check_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item_values</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span><span class="s2">&quot;.&quot;</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">!=</span> <span class="s2">&quot;?&quot;</span><span class="p">]</span>
        <span class="n">check_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">check_all</span> <span class="k">if</span> <span class="n">mymatch</span><span class="p">(</span><span class="n">matchexpr</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="n">a</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_all</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_values&quot;</span><span class="p">:</span><span class="n">check_all</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">decide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">result_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct the return list&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_list</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
               <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
               <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_values&quot;</span><span class="p">:</span><span class="n">result_list</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_item_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
        <span class="n">container_type</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">][</span><span class="s1">&#39;_type.container&#39;</span><span class="p">]</span>
        <span class="n">item_values</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">item_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">container_type</span> <span class="o">==</span> <span class="s1">&#39;Single&#39;</span><span class="p">:</span>
           <span class="n">okcheck</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item_values</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">long</span><span class="p">,</span><span class="nb">unicode</span><span class="p">))]</span>
           <span class="k">return</span> <span class="n">decide</span><span class="p">(</span><span class="n">okcheck</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">container_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Multiple&#39;</span><span class="p">,</span><span class="s1">&#39;List&#39;</span><span class="p">):</span>
           <span class="n">okcheck</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item_values</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">StarList</span><span class="p">)]</span>
           <span class="k">return</span> <span class="n">decide</span><span class="p">(</span><span class="n">okcheck</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">container_type</span> <span class="o">==</span> <span class="s1">&#39;Array&#39;</span><span class="p">:</span>    <span class="c1">#A list with numerical values</span>
           <span class="n">okcheck</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item_values</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">StarList</span><span class="p">)]</span>
           <span class="n">first_check</span> <span class="o">=</span> <span class="n">decide</span><span class="p">(</span><span class="n">okcheck</span><span class="p">)</span>
           <span class="k">if</span> <span class="ow">not</span> <span class="n">first_check</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]:</span> <span class="k">return</span> <span class="n">first_check</span>
           <span class="c1">#num_check = [a for a in item_values if len([b for b in a if not isinstance</span>

    <span class="k">def</span> <span class="nf">validate_item_esd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">primitive_type</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;numb&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="n">can_esd</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">esd_spec</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;esd&quot;</span>
        <span class="k">if</span> <span class="n">can_esd</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>         <span class="c1">#must be OK!</span>
        <span class="n">item_values</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">item_value</span><span class="p">)</span>
        <span class="n">check_all</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item_values</span> <span class="k">if</span> <span class="n">get_number_with_esd</span><span class="p">(</span><span class="n">a</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_all</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_values&quot;</span><span class="p">:</span><span class="n">check_all</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_item_esd_ddlm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;self.primitive_type&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> \
        <span class="p">[</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span><span class="s1">&#39;Index&#39;</span><span class="p">,</span><span class="s1">&#39;Integer&#39;</span><span class="p">,</span><span class="s1">&#39;Real&#39;</span><span class="p">,</span><span class="s1">&#39;Imag&#39;</span><span class="p">,</span><span class="s1">&#39;Complex&#39;</span><span class="p">,</span><span class="s1">&#39;Binary&#39;</span><span class="p">,</span><span class="s1">&#39;Hexadecimal&#39;</span><span class="p">,</span><span class="s1">&#39;Octal&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="n">can_esd</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_type.purpose&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;Measurand&#39;</span><span class="p">:</span>
            <span class="n">can_esd</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">item_values</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">item_value</span><span class="p">)</span>
        <span class="n">check_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_number_with_esd</span><span class="p">(</span><span class="n">a</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item_values</span><span class="p">]</span>
        <span class="n">check_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">check_all</span> <span class="k">if</span> <span class="p">(</span><span class="n">can_esd</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> \
                 <span class="p">(</span><span class="ow">not</span> <span class="n">can_esd</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_all</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_values&quot;</span><span class="p">:</span><span class="n">check_all</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_enum_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;_item_range.minimum&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="s2">&quot;_item_range.maximum&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="n">minvals</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_item_range.minimum&quot;</span><span class="p">,</span><span class="n">default</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">])</span>
        <span class="n">maxvals</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_item_range.maximum&quot;</span><span class="p">,</span><span class="n">default</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">makefloat</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="n">a</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">maxvals</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">makefloat</span><span class="p">,</span> <span class="n">maxvals</span><span class="p">)</span>
        <span class="n">minvals</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">makefloat</span><span class="p">,</span> <span class="n">minvals</span><span class="p">)</span>
        <span class="n">rangelist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">minvals</span><span class="p">,</span><span class="n">maxvals</span><span class="p">))</span>
        <span class="n">item_values</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">item_value</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">map_check</span><span class="p">(</span><span class="n">rangelist</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item_value</span> <span class="o">==</span> <span class="s2">&quot;?&quot;</span> <span class="ow">or</span> <span class="n">item_value</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">True</span>
            <span class="n">iv</span><span class="p">,</span><span class="n">esd</span> <span class="o">=</span> <span class="n">get_number_with_esd</span><span class="p">(</span><span class="n">item_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iv</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>  <span class="c1">#shouldn&#39;t happen as is numb type</span>
            <span class="k">for</span> <span class="n">lower</span><span class="p">,</span><span class="n">upper</span> <span class="ow">in</span> <span class="n">rangelist</span><span class="p">:</span>
                <span class="c1">#check the minima</span>
                <span class="k">if</span> <span class="n">lower</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span> <span class="n">lower</span> <span class="o">=</span> <span class="n">iv</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">upper</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">iv</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">iv</span> <span class="o">&gt;</span> <span class="n">lower</span> <span class="ow">and</span> <span class="n">iv</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="p">:</span> <span class="k">return</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">upper</span> <span class="o">==</span> <span class="n">lower</span> <span class="ow">and</span> <span class="n">iv</span> <span class="o">==</span> <span class="n">upper</span><span class="p">:</span> <span class="k">return</span> <span class="bp">True</span>
            <span class="c1"># debug</span>
            <span class="c1"># print(&quot;Value %s fails range check %d &lt; x &lt; %d&quot; % (item_value,lower,upper))</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">check_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item_values</span> <span class="k">if</span> <span class="n">map_check</span><span class="p">(</span><span class="n">rangelist</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">True</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_all</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_values&quot;</span><span class="p">:</span><span class="n">check_all</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_item_enum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">enum_list</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">enum_spec</span><span class="p">][:]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="n">enum_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>   <span class="c1">#default value</span>
        <span class="n">enum_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">)</span>   <span class="c1">#unknown</span>
        <span class="n">item_values</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">item_value</span><span class="p">)</span>
        <span class="c1">#print(&quot;Enum check: {!r} in {!r}&quot;.format(item_values, enum_list))</span>
        <span class="n">check_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item_values</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enum_list</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_all</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_values&quot;</span><span class="p">:</span><span class="n">check_all</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_looping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">must_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">must_loop_spec</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">must_loop</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_value</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span> <span class="c1"># not looped</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">}</span>      <span class="c1">#this could be triggered</span>
        <span class="k">if</span> <span class="n">must_loop</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_value</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_looping_ddlm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loop_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that all names are loopable&quot;&quot;&quot;</span>
        <span class="n">truly_loopy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_final_cats</span><span class="p">(</span><span class="n">loop_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">truly_loopy</span><span class="p">)</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">loop_names</span><span class="p">):</span>  <span class="c1">#some are bad</span>
            <span class="n">categories</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_spec</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loop_names</span><span class="p">]</span>
            <span class="n">not_looped</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">categories</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_lookup</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">not_looped</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>


    <span class="k">def</span> <span class="nf">validate_loop_membership</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loop_names</span><span class="p">):</span>
        <span class="n">final_cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_final_cats</span><span class="p">(</span><span class="n">loop_names</span><span class="p">)</span>
        <span class="n">bad_items</span> <span class="o">=</span>  <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">final_cat</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">final_cat</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_items</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">bad_items</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_final_cats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loop_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of the uppermost parent categories for the loop_names. Names</span>
<span class="sd">        that are not from loopable categories are ignored.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_spec</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loop_names</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>       <span class="c1">#category_id is mandatory</span>
            <span class="k">raise</span> <span class="n">ValidCifError</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> missing from dictionary </span><span class="si">%s</span><span class="s2"> for item in loop containing </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_spec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dicname</span><span class="p">,</span><span class="n">loop_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">truly_looped</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">categories</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_lookup</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_lookup</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">truly_looped</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">validate_loop_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loop_names</span><span class="p">):</span>
        <span class="n">category</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">loop_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_spec</span><span class="p">]</span>
        <span class="c1"># find any unique values which must be present</span>
        <span class="n">key_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_spec</span><span class="p">,[])</span>
        <span class="k">for</span> <span class="n">names_to_check</span> <span class="ow">in</span> <span class="n">key_spec</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names_to_check</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>   <span class="c1">#only one</span>
                <span class="n">names_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">names_to_check</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">loop_key</span> <span class="ow">in</span> <span class="n">names_to_check</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">loop_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loop_names</span><span class="p">:</span>
                    <span class="c1">#is this one of those dang implicit items?</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">loop_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">must_exist_spec</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>          <span class="c1">#it is virtually there...</span>
                    <span class="n">alternates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alternates</span><span class="p">(</span><span class="n">loop_key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">alternates</span> <span class="o">==</span> <span class="p">[]:</span>
                        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">loop_key</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">alt_names</span> <span class="ow">in</span> <span class="n">alternates</span><span class="p">:</span>
                        <span class="n">alt</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alt_names</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loop_names</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">loop_key</span><span class="p">}</span>  <span class="c1"># no alternates</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_loop_key_ddlm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loop_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make sure at least one of the necessary keys are available&quot;&quot;&quot;</span>
        <span class="n">final_cats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_final_cats</span><span class="p">(</span><span class="n">loop_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_cats</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">poss_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">[</span><span class="n">final_cats</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># </span>
            <span class="n">found_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">poss_keys</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loop_names</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_keys</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">poss_keys</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_loop_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loop_names</span><span class="p">):</span>
        <span class="n">must_haves</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_ref_spec</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loop_names</span><span class="p">]</span>
        <span class="n">must_haves</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">must_haves</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">]</span>
        <span class="c1"># build a flat list.  For efficiency we don&#39;t remove duplicates,as</span>
        <span class="c1"># we expect no more than the order of 10 or 20 looped names.</span>
        <span class="k">def</span> <span class="nf">flat_func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
               <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>       <span class="c1">#single name</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">a</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>       <span class="c1">#list of names</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="n">flat_mh</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="p">[</span><span class="n">flat_func</span><span class="p">(</span><span class="n">flat_mh</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">must_haves</span><span class="p">]</span>
        <span class="n">group_mh</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="n">flat_mh</span><span class="p">)</span>
        <span class="n">single_mh</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="n">flat_mh</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">single_mh</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loop_names</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">check_gr</span><span class="p">(</span><span class="n">s_item</span><span class="p">,</span> <span class="n">name_list</span><span class="p">):</span>
            <span class="n">nl</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">a</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">s_item</span><span class="p">)],</span><span class="n">name_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s_item</span> <span class="ow">in</span> <span class="n">nl</span><span class="p">:</span> <span class="k">return</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">res_g</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">group_mh</span> <span class="k">if</span> <span class="n">check_gr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">loop_names</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">res_g</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
        <span class="c1"># construct alternate list</span>
        <span class="n">alternates</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">get_alternates</span><span class="p">(</span><span class="n">a</span><span class="p">)),</span><span class="n">res</span><span class="p">)</span>
        <span class="n">alternates</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alternates</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]]</span>
        <span class="c1"># next line purely for error reporting</span>
        <span class="n">missing_alts</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alternates</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternates</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
           <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">missing_alts</span><span class="p">}</span>   <span class="c1">#short cut; at least one</span>
                                                       <span class="c1">#doesn&#39;t have an altern</span>
        <span class="c1">#loop over alternates</span>
        <span class="k">for</span> <span class="n">orig_name</span><span class="p">,</span><span class="n">alt_names</span> <span class="ow">in</span> <span class="n">alternates</span><span class="p">:</span>
             <span class="n">alt</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alt_names</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loop_names</span><span class="p">]</span>
             <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">orig_name</span><span class="p">}</span><span class="c1"># no alternates</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>        <span class="c1">#found alternates</span>

    <span class="k">def</span> <span class="nf">get_alternates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">main_name</span><span class="p">,</span><span class="n">exclusive_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">alternates</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">main_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">related_func</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">alt_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">alternates</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">alt_names</span> <span class="o">=</span>  <span class="bp">self</span><span class="p">[</span><span class="n">main_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">related_item</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alt_names</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
                <span class="n">alt_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">alt_names</span><span class="p">]</span>
                <span class="n">alternates</span> <span class="o">=</span> <span class="p">[</span><span class="n">alternates</span><span class="p">]</span>
            <span class="n">together</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">alt_names</span><span class="p">,</span><span class="n">alternates</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exclusive_only</span><span class="p">:</span>
                <span class="n">alt_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">together</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;alternate_exclusive&quot;</span> \
                                             <span class="ow">or</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;replace&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alt_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">together</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;alternate&quot;</span> <span class="ow">or</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;replace&quot;</span><span class="p">]</span>
            <span class="n">alt_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alt_names</span><span class="p">])</span>
        <span class="c1"># now do the alias thing</span>
        <span class="n">alias_names</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">main_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_item_aliases.alias_name&quot;</span><span class="p">,[]))</span>
        <span class="n">alt_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">alias_names</span><span class="p">)</span>
        <span class="c1"># print(&quot;Alternates for {}: {!r}&quot;.format(main_name, alt_names))</span>
        <span class="k">return</span> <span class="n">alt_names</span>


    <span class="k">def</span> <span class="nf">validate_exclusion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">,</span><span class="n">whole_block</span><span class="p">,</span><span class="n">provisional_items</span><span class="o">=</span><span class="p">{},</span><span class="nb">globals</span><span class="o">=</span><span class="p">{}):</span>
       <span class="n">alternates</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alternates</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span><span class="n">exclusive_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)]</span>
       <span class="n">item_name_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">whole_block</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
       <span class="n">item_name_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">provisional_items</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
       <span class="n">bad</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alternates</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">item_name_list</span><span class="p">]</span>
       <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
           <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Bad: </span><span class="si">%s</span><span class="s2">, alternates </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">bad</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">alternates</span><span class="p">)))</span>
           <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">bad</span><span class="p">}</span>
       <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="c1"># validate that parent exists and contains matching values</span>
    <span class="k">def</span> <span class="nf">validate_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">,</span><span class="n">whole_block</span><span class="p">,</span><span class="n">provisional_items</span><span class="o">=</span><span class="p">{},</span><span class="nb">globals</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">parent_item</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_item</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>   <span class="c1">#no parent specified</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_item</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">parent_item</span> <span class="o">=</span> <span class="n">parent_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent_item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_parents</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done_parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_item</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Done parents </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">done_parents</span><span class="p">))</span>
        <span class="c1"># initialise parent/child values</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_value</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
            <span class="n">child_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">item_value</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">child_values</span> <span class="o">=</span> <span class="n">item_value</span><span class="p">[:]</span>    <span class="c1">#copy for safety</span>
        <span class="c1"># track down the parent</span>
        <span class="c1"># print(&quot;Looking for {} parent item {} in {!r}&quot;.format(item_name, parent_item, whole_block))</span>
        <span class="c1"># if globals contains the parent values, we are doing a DDL2 dictionary, and so</span>
        <span class="c1"># we have collected all parent values into the global block - so no need to search</span>
        <span class="c1"># for them elsewhere.</span>
        <span class="c1"># print(&quot;Looking for {!r}&quot;.format(parent_item))</span>
        <span class="n">parent_values</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_item</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_values</span><span class="p">:</span>
            <span class="n">parent_values</span> <span class="o">=</span> <span class="n">provisional_items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_item</span><span class="p">,</span><span class="n">whole_block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_item</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_values</span><span class="p">:</span>
            <span class="c1"># go for alternates</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">whole_block</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">namespace</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">provisional_items</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">namespace</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">globals</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">alt_names</span> <span class="o">=</span> <span class="n">filter_present</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_alternates</span><span class="p">(</span><span class="n">parent_item</span><span class="p">),</span><span class="n">namespace</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">child_values</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">!=</span> <span class="s2">&quot;?&quot;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;parent&quot;</span><span class="p">:</span><span class="n">parent_item</span><span class="p">}</span><span class="c1">#no parent available -&gt; error</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>       <span class="c1">#maybe True is more appropriate??</span>
            <span class="n">parent_item</span> <span class="o">=</span> <span class="n">alt_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>           <span class="c1">#should never be more than one??</span>
            <span class="n">parent_values</span> <span class="o">=</span> <span class="n">provisional_items</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_item</span><span class="p">,</span><span class="n">whole_block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_item</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_values</span><span class="p">:</span>   <span class="c1"># check global block</span>
                <span class="n">parent_values</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_item</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_values</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
            <span class="n">parent_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">parent_values</span><span class="p">]</span>
        <span class="c1">#print(&quot;Checking parent %s against %s, values %r/%r&quot; % (parent_item,</span>
        <span class="c1">#                                          item_name, parent_values, child_values))</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_parent_child</span><span class="p">(</span><span class="n">parent_values</span><span class="p">,</span><span class="n">child_values</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_values&quot;</span><span class="p">:</span><span class="n">missing</span><span class="p">,</span><span class="s2">&quot;parent&quot;</span><span class="p">:</span><span class="n">parent_item</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">,</span><span class="n">whole_block</span><span class="p">,</span><span class="n">provisional_items</span><span class="o">=</span><span class="p">{},</span><span class="nb">globals</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">child_items</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">child_spec</span><span class="p">][:]</span>  <span class="c1">#copy</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>    <span class="c1">#not relevant</span>
        <span class="c1"># special case for dictionaries  -&gt; we check parents of children only</span>
        <span class="k">if</span> <span class="n">item_name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">:</span>  <span class="c1">#dictionary so skip</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child_items</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span> <span class="c1"># only one child</span>
            <span class="n">child_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">child_items</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_value</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span> <span class="c1"># single value</span>
            <span class="n">parent_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">item_value</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">parent_values</span> <span class="o">=</span> <span class="n">item_value</span><span class="p">[:]</span>
        <span class="c1"># expand child list with list of alternates</span>
        <span class="k">for</span> <span class="n">child_item</span> <span class="ow">in</span> <span class="n">child_items</span><span class="p">[:]:</span>
            <span class="n">child_items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_alternates</span><span class="p">(</span><span class="n">child_item</span><span class="p">))</span>
        <span class="c1"># now loop over the children</span>
        <span class="k">for</span> <span class="n">child_item</span> <span class="ow">in</span> <span class="n">child_items</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child_item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_children</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">done_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child_item</span><span class="p">)</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Done children </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">done_children</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">child_item</span> <span class="ow">in</span> <span class="n">provisional_items</span><span class="p">:</span>
                <span class="n">child_values</span> <span class="o">=</span> <span class="n">provisional_items</span><span class="p">[</span><span class="n">child_item</span><span class="p">][:]</span>
            <span class="k">elif</span> <span class="n">child_item</span> <span class="ow">in</span> <span class="n">whole_block</span><span class="p">:</span>
                <span class="n">child_values</span> <span class="o">=</span> <span class="n">whole_block</span><span class="p">[</span><span class="n">child_item</span><span class="p">][:]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child_values</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
                <span class="n">child_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">child_values</span><span class="p">]</span>
                <span class="c1"># print(&quot;Checking child %s against %s, values %r/%r&quot; % (child_item,</span>
                <span class="c1">#       item_name, child_values, parent_values))</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_parent_child</span><span class="p">(</span><span class="n">parent_values</span><span class="p">,</span><span class="n">child_values</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_values&quot;</span><span class="p">:</span><span class="n">missing</span><span class="p">,</span><span class="s2">&quot;child&quot;</span><span class="p">:</span><span class="n">child_item</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>       <span class="c1">#could mean that no child items present</span>

    <span class="c1">#a generic checker: all child vals should appear in parent_vals</span>
    <span class="k">def</span> <span class="nf">check_parent_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent_vals</span><span class="p">,</span><span class="n">child_vals</span><span class="p">):</span>
        <span class="c1"># shield ourselves from dots and question marks</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="n">parent_vals</span><span class="p">[:]</span>
        <span class="n">pv</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="s2">&quot;?&quot;</span><span class="p">])</span>
        <span class="n">res</span> <span class="o">=</span>  <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">child_vals</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pv</span><span class="p">]</span>
        <span class="c1">#print(&quot;Missing: %s&quot; % res)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">validate_remove_parent_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">whole_block</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">child_items</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">child_spec</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child_items</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span> <span class="c1"># only one child</span>
            <span class="n">child_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">child_items</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">child_item</span> <span class="ow">in</span> <span class="n">child_items</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child_item</span> <span class="ow">in</span> <span class="n">whole_block</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;child&quot;</span><span class="p">:</span><span class="n">child_item</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_dependents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">,</span><span class="n">whole_block</span><span class="p">,</span><span class="n">prov</span><span class="o">=</span><span class="p">{},</span><span class="nb">globals</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dep_items</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">dep_spec</span><span class="p">][:]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>    <span class="c1">#not relevant</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dep_items</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
            <span class="n">dep_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">dep_items</span><span class="p">]</span>
        <span class="n">actual_names</span> <span class="o">=</span> <span class="n">whole_block</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">actual_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">prov</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">actual_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">globals</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">dep_items</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">actual_names</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">alternates</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_alternates</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="n">a</span><span class="p">],</span><span class="n">missing</span><span class="p">)</span>
            <span class="c1"># compact way to get a list of alternative items which are</span>
            <span class="c1"># present</span>
            <span class="n">have_check</span> <span class="o">=</span> <span class="p">[(</span><span class="n">filter_present</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">actual_names</span><span class="p">),</span>
                                       <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">alternates</span><span class="p">]</span>
            <span class="n">have_check</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">have_check</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">have_check</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">have_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">have_check</span><span class="p">]</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">have_check</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_uniqueness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">,</span><span class="n">whole_block</span><span class="p">,</span><span class="n">provisional_items</span><span class="o">=</span><span class="p">{},</span>
                                                                  <span class="nb">globals</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">category</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">category</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;No category found for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">item_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="c1"># print(&quot;Category {!r} for item {}&quot;.format(category, item_name))</span>
        <span class="c1"># we make a copy in the following as we will be removing stuff later!</span>
        <span class="n">unique_i</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_category_key.name&quot;</span><span class="p">,[])[:]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unique_i</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
            <span class="n">unique_i</span> <span class="o">=</span> <span class="p">[</span><span class="n">unique_i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">item_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_i</span><span class="p">:</span>       <span class="c1">#no need to verify</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_value</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>  <span class="c1">#not looped</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
        <span class="c1"># print(&quot;Checking %s -&gt; %s -&gt; %s -&gt;Unique: %r&quot; % (item_name,category,catentry, unique_i))</span>
        <span class="c1"># check that we can&#39;t optimize by not doing this check</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">unique_i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_keys</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unique_i</span><span class="p">)</span>
        <span class="n">val_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># get the matching data from any other data items</span>
        <span class="n">unique_i</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item_name</span><span class="p">)</span>
        <span class="n">other_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>            <span class="c1"># i.e. do have others to think about</span>
           <span class="k">for</span> <span class="n">other_name</span> <span class="ow">in</span> <span class="n">unique_i</span><span class="p">:</span>
           <span class="c1"># we look for the value first in the provisional dict, then the main block</span>
           <span class="c1"># the logic being that anything in the provisional dict overrides the</span>
           <span class="c1"># main block</span>
               <span class="k">if</span> <span class="n">other_name</span> <span class="ow">in</span> <span class="n">provisional_items</span><span class="p">:</span>
                   <span class="n">other_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">provisional_items</span><span class="p">[</span><span class="n">other_name</span><span class="p">])</span>
               <span class="k">elif</span> <span class="n">other_name</span> <span class="ow">in</span> <span class="n">whole_block</span><span class="p">:</span>
                   <span class="n">other_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">whole_block</span><span class="p">[</span><span class="n">other_name</span><span class="p">])</span>
               <span class="k">elif</span> <span class="bp">self</span><span class="p">[</span><span class="n">other_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">must_exist_spec</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;implicit&quot;</span><span class="p">:</span>
                   <span class="n">other_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">item_name</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">item_value</span><span class="p">))</span>  <span class="c1">#placeholder</span>
               <span class="k">else</span><span class="p">:</span>
                   <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">other_name</span><span class="p">}</span><span class="c1">#missing data name</span>
        <span class="c1"># ok, so we go through all of our values</span>
        <span class="c1"># this works by comparing lists of strings to one other, and</span>
        <span class="c1"># so could be fooled if you think that &#39;1.&#39; and &#39;1&#39; are</span>
        <span class="c1"># identical</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item_value</span><span class="p">)):</span>
            <span class="c1">#print(&quot;Value no. %d&quot; % i, end=&quot; &quot;)</span>
            <span class="n">this_entry</span> <span class="o">=</span> <span class="n">item_value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">other_data</span><span class="p">)):</span>
                <span class="n">this_entry</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">this_entry</span><span class="p">,</span><span class="n">other_data</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span>
            <span class="c1">#print(&quot;Looking for {!r} in {!r}: &quot;.format(this_entry, val_list))</span>
            <span class="k">if</span> <span class="n">this_entry</span> <span class="ow">in</span> <span class="n">val_list</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_values&quot;</span><span class="p">:</span><span class="n">this_entry</span><span class="p">}</span>
            <span class="n">val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_entry</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>


    <span class="k">def</span> <span class="nf">validate_mandatory_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">whole_block</span><span class="p">):</span>
        <span class="n">mand_cats</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_category.id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_category.mandatory_code&quot;</span><span class="p">,</span><span class="s2">&quot;no&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;yes&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mand_cats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
        <span class="c1"># print(&quot;Mandatory categories - {!r}&quot;.format(mand_cats)</span>
        <span class="c1"># find which categories each of our datanames belongs to</span>
        <span class="n">all_cats</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_spec</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">whole_block</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mand_cats</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_cats</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="nb">repr</span><span class="p">(</span><span class="n">missing</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">check_mandatory_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">whole_block</span><span class="p">,</span><span class="n">default_scope</span><span class="o">=</span><span class="s1">&#39;Item&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an error if any mandatory items are missing&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scopes_mandatory</span><span class="p">)</span><span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">default_scope</span> <span class="o">==</span> <span class="s1">&#39;Datablock&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>     <span class="c1">#is a data file</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">whole_block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="n">default_scope</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;_dictionary.title&#39;</span> <span class="ow">in</span> <span class="n">whole_block</span><span class="p">:</span>
           <span class="n">scope</span> <span class="o">=</span> <span class="s1">&#39;Dictionary&#39;</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes_mandatory</span><span class="p">[</span><span class="n">scope</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">whole_block</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">missing</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">check_prohibited_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">whole_block</span><span class="p">,</span><span class="n">default_scope</span><span class="o">=</span><span class="s1">&#39;Item&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an error if any prohibited items are present&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scopes_naughty</span><span class="p">)</span><span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">default_scope</span> <span class="o">==</span> <span class="s1">&#39;Datablock&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>     <span class="c1">#is a data file</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">whole_block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_definition.scope&#39;</span><span class="p">,</span><span class="n">default_scope</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;_dictionary.title&#39;</span> <span class="ow">in</span> <span class="n">whole_block</span><span class="p">:</span>
           <span class="n">scope</span> <span class="o">=</span> <span class="s1">&#39;Dictionary&#39;</span>
        <span class="n">present</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes_naughty</span><span class="p">[</span><span class="n">scope</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">whole_block</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">present</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s2">&quot;bad_items&quot;</span><span class="p">:</span><span class="n">present</span><span class="p">}</span>


    <span class="k">def</span> <span class="nf">run_item_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">item_name</span><span class="p">:</span><span class="nb">list</span><span class="p">([(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="n">f</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_validation_funs</span><span class="p">])}</span>

    <span class="k">def</span> <span class="nf">run_loop_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loop_names</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">loop_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="nb">list</span><span class="p">([(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="n">f</span><span class="p">(</span><span class="n">loop_names</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_validation_funs</span><span class="p">])}</span>

    <span class="k">def</span> <span class="nf">run_global_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">,</span><span class="n">data_block</span><span class="p">,</span><span class="n">provisional_items</span><span class="o">=</span><span class="p">{},</span><span class="nb">globals</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="n">f</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">,</span><span class="n">data_block</span><span class="p">,</span><span class="n">provisional_items</span><span class="p">,</span><span class="nb">globals</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_validation_funs</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">item_name</span><span class="p">:</span><span class="n">results</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">run_block_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">whole_block</span><span class="p">,</span><span class="n">block_scope</span><span class="o">=</span><span class="s1">&#39;Item&#39;</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="n">f</span><span class="p">(</span><span class="n">whole_block</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_validation_funs</span><span class="p">])</span>
        <span class="c1"># fix up the return values</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;whole_block&quot;</span><span class="p">:</span><span class="n">results</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">optimize_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_parents</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">optimize_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_parents</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.CifFile_module.CifDic">CifDic</a></li>
          <li>CifFile.StarFile.StarFile</li>
          <li>CifFile.StarFile.BlockCollection</li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifDic.DDL1_normalise">
    <p>def <span class="ident">DDL1_normalise</span>(</p><p>self)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifDic.DDL1_normalise', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifDic.DDL1_normalise" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">DDL1_normalise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># switch off block name collision checks</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># add default type information in DDL2 style</span>
    <span class="c1"># initial types and constructs</span>
    <span class="n">base_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;char&quot;</span><span class="p">,</span><span class="s2">&quot;numb&quot;</span><span class="p">,</span><span class="s2">&quot;null&quot;</span><span class="p">]</span>
    <span class="n">prim_types</span> <span class="o">=</span> <span class="n">base_types</span><span class="p">[:]</span>
    <span class="n">base_constructs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.*&quot;</span><span class="p">,</span>
        <span class="s1">&#39;(-?(([0-9]*[.][0-9]+)|([0-9]+)[.]?)([(][0-9]+[)])?([eEdD][+-]?[0-9]+)?)|\?|\.&#39;</span><span class="p">,</span>
        <span class="s2">&quot;</span><span class="se">\&quot;\&quot;</span><span class="s2"> &quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
       <span class="n">newnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c1">#keep by default</span>
       <span class="k">if</span> <span class="s2">&quot;_name&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
           <span class="n">real_name</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_name&quot;</span><span class="p">]</span>
           <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">real_name</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>        <span class="c1">#looped values</span>
               <span class="k">for</span> <span class="n">looped_name</span> <span class="ow">in</span> <span class="n">real_name</span><span class="p">:</span>
                  <span class="n">new_value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                  <span class="n">new_value</span><span class="p">[</span><span class="s2">&quot;_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">looped_name</span>  <span class="c1">#only looped name</span>
                  <span class="bp">self</span><span class="p">[</span><span class="n">looped_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
               <span class="n">newnames</span> <span class="o">=</span> <span class="n">real_name</span>
           <span class="k">else</span><span class="p">:</span>
                  <span class="bp">self</span><span class="p">[</span><span class="n">real_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                  <span class="n">newnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">real_name</span><span class="p">]</span>
       <span class="c1"># delete the old one</span>
       <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">newnames</span><span class="p">:</span>
          <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="c1"># loop again to normalise the contents of each definition</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
       <span class="c1">#unlock the block</span>
       <span class="n">save_overwrite</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">overwrite</span>
       <span class="n">value</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="bp">True</span>
       <span class="c1"># deal with a missing _list, _type_conditions</span>
       <span class="k">if</span> <span class="s2">&quot;_list&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
       <span class="k">if</span> <span class="s2">&quot;_type_conditions&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_type_conditions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
       <span class="c1"># deal with enumeration ranges</span>
       <span class="k">if</span> <span class="s2">&quot;_enumeration_range&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
           <span class="nb">max</span><span class="p">,</span><span class="nb">min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmaxmin</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;_enumeration_range&quot;</span><span class="p">])</span>
           <span class="k">if</span> <span class="nb">min</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
               <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">(((</span><span class="s2">&quot;_item_range.maximum&quot;</span><span class="p">,</span><span class="s2">&quot;_item_range.minimum&quot;</span><span class="p">),((</span><span class="nb">max</span><span class="p">,</span><span class="nb">max</span><span class="p">),(</span><span class="nb">max</span><span class="p">,</span><span class="nb">min</span><span class="p">))))</span>
           <span class="k">elif</span> <span class="nb">max</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
               <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">(((</span><span class="s2">&quot;_item_range.maximum&quot;</span><span class="p">,</span><span class="s2">&quot;_item_range.minimum&quot;</span><span class="p">),((</span><span class="nb">max</span><span class="p">,</span><span class="nb">min</span><span class="p">),(</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">))))</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">(((</span><span class="s2">&quot;_item_range.maximum&quot;</span><span class="p">,</span><span class="s2">&quot;_item_range.minimum&quot;</span><span class="p">),((</span><span class="nb">max</span><span class="p">,</span><span class="nb">max</span><span class="p">,</span><span class="nb">min</span><span class="p">),(</span><span class="nb">max</span><span class="p">,</span><span class="nb">min</span><span class="p">,</span><span class="nb">min</span><span class="p">))))</span>
       <span class="c1">#add any type construct information</span>
       <span class="k">if</span> <span class="s2">&quot;_type_construct&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
           <span class="n">base_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;_name&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_type&quot;</span><span class="p">)</span>   <span class="c1">#ie dataname_type</span>
           <span class="n">base_constructs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;_type_construct&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;$&quot;</span><span class="p">)</span>
           <span class="n">prim_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;_type&quot;</span><span class="p">])</span>     <span class="c1">#keep a record</span>
           <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_types</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>   <span class="c1">#the new type name</span>
    <span class="c1">#make categories conform with ddl2</span>
    <span class="c1">#note that we must remove everything from the last underscore</span>
       <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_category&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;category_overview&quot;</span><span class="p">:</span>
            <span class="n">last_under</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">catid</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_name&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="n">last_under</span><span class="p">]</span>
            <span class="n">value</span><span class="p">[</span><span class="s2">&quot;_category.id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catid</span>  <span class="c1">#remove square bracks</span>
            <span class="k">if</span> <span class="n">catid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_list</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">catid</span><span class="p">)</span>
       <span class="n">value</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="n">save_overwrite</span>
    <span class="c1"># we now add any missing categories before filling in the rest of the</span>
    <span class="c1"># information</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1">#print(&#39;processing ddl1 definition %s&#39; % key)</span>
        <span class="k">if</span> <span class="s2">&quot;_category&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;_category&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_list</span><span class="p">:</span>
                <span class="c1"># rogue category, add it in</span>
                <span class="n">newcat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;_category&quot;</span><span class="p">]</span>
                <span class="n">fake_name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">newcat</span> <span class="o">+</span> <span class="s2">&quot;_[]&quot;</span>
                <span class="n">newcatdata</span> <span class="o">=</span> <span class="n">CifBlock</span><span class="p">()</span>
                <span class="n">newcatdata</span><span class="p">[</span><span class="s2">&quot;_category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;category_overview&quot;</span>
                <span class="n">newcatdata</span><span class="p">[</span><span class="s2">&quot;_category.id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newcat</span>
                <span class="n">newcatdata</span><span class="p">[</span><span class="s2">&quot;_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;null&quot;</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">fake_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">newcatdata</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cat_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newcat</span><span class="p">)</span>
    <span class="c1"># write out the type information in DDL2 style</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">master_block</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">((</span>
        <span class="p">(</span><span class="s2">&quot;_item_type_list.code&quot;</span><span class="p">,</span><span class="s2">&quot;_item_type_list.construct&quot;</span><span class="p">,</span>
          <span class="s2">&quot;_item_type_list.primitive_code&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">base_types</span><span class="p">,</span><span class="n">base_constructs</span><span class="p">,</span><span class="n">prim_types</span><span class="p">)</span>
        <span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifDic.DDL2_normalise">
    <p>def <span class="ident">DDL2_normalise</span>(</p><p>self)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifDic.DDL2_normalise', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifDic.DDL2_normalise" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">DDL2_normalise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
   <span class="n">listed_defs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_item.name&#39;</span><span class="p">),</span><span class="nb">list</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
   <span class="c1"># now filter out all the single element lists!</span>
   <span class="n">dodgy_defs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_item.name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">listed_defs</span><span class="p">)</span>
   <span class="k">for</span> <span class="n">item_def</span> <span class="ow">in</span> <span class="n">dodgy_defs</span><span class="p">:</span>
            <span class="c1"># print(&quot;DDL2 norm: processing %s&quot; % item_def)</span>
            <span class="n">thisdef</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_def</span><span class="p">]</span>
            <span class="n">packet_no</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item_def</span><span class="p">)</span>
            <span class="n">realcat</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.category_id&#39;</span><span class="p">][</span><span class="n">packet_no</span><span class="p">]</span>
            <span class="n">realmand</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.mandatory_code&#39;</span><span class="p">][</span><span class="n">packet_no</span><span class="p">]</span>
            <span class="c1"># first add in all the missing categories</span>
            <span class="c1"># we don&#39;t replace the entry in the list corresponding to the</span>
            <span class="c1"># current item, as that would wipe out the information we want</span>
            <span class="k">for</span> <span class="n">child_no</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.name&#39;</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">child_no</span> <span class="o">==</span> <span class="n">packet_no</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">child_name</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.name&#39;</span><span class="p">][</span><span class="n">child_no</span><span class="p">]</span>
                <span class="n">child_cat</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.category_id&#39;</span><span class="p">][</span><span class="n">child_no</span><span class="p">]</span>
                <span class="n">child_mand</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item.mandatory_code&#39;</span><span class="p">][</span><span class="n">child_no</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">child_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">child_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">CifBlock</span><span class="p">()</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">child_name</span><span class="p">][</span><span class="s1">&#39;_item.name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">child_name</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">child_name</span><span class="p">][</span><span class="s1">&#39;_item.category_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">child_cat</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">child_name</span><span class="p">][</span><span class="s1">&#39;_item.mandatory_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">child_mand</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">item_def</span><span class="p">][</span><span class="s1">&#39;_item.name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_def</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">item_def</span><span class="p">][</span><span class="s1">&#39;_item.category_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">realcat</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">item_def</span><span class="p">][</span><span class="s1">&#39;_item.mandatory_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">realmand</span>
   <span class="n">target_defs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;_item_linked.child_name&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">or</span> \
                                 <span class="s1">&#39;_item_linked.parent_name&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
   <span class="c1"># now dodgy_defs contains all definition blocks with more than one child/parent link</span>
   <span class="k">for</span> <span class="n">item_def</span> <span class="ow">in</span> <span class="n">dodgy_defs</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_pcloop</span><span class="p">(</span><span class="n">item_def</span><span class="p">)</span>           <span class="c1">#regularise appearance</span>
   <span class="k">for</span> <span class="n">item_def</span> <span class="ow">in</span> <span class="n">dodgy_defs</span><span class="p">:</span>
         <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Processing </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">item_def</span><span class="p">)</span>
         <span class="n">thisdef</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">item_def</span><span class="p">]</span>
         <span class="n">child_list</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">]</span>
         <span class="n">parents</span> <span class="o">=</span> <span class="n">thisdef</span><span class="p">[</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">]</span>
         <span class="c1"># for each parent, find the list of children.</span>
         <span class="n">family</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">parents</span><span class="p">,</span><span class="n">child_list</span><span class="p">))</span>
         <span class="n">notmychildren</span> <span class="o">=</span> <span class="n">family</span>         <span class="c1">#We aim to remove non-children</span>
         <span class="c1"># Loop over the parents, relocating as necessary</span>
         <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">notmychildren</span><span class="p">):</span>
            <span class="c1"># get all children of first entry</span>
            <span class="n">mychildren</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">family</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">notmychildren</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Parent </span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2"> children&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">notmychildren</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">mychildren</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">parent</span><span class="p">,</span><span class="n">child</span> <span class="ow">in</span> <span class="n">mychildren</span><span class="p">:</span>   <span class="c1">#parent is the same for all</span>
                     <span class="c1"># Make sure that we simply add in the new entry for the child, not replace it,</span>
                     <span class="c1"># otherwise we might spoil the child entry loop structure</span>
                     <span class="k">try</span><span class="p">:</span>
                         <span class="n">childloop</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">child</span><span class="p">]</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">)</span>
                     <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                         <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Creating new parent entry </span><span class="si">%s</span><span class="s1"> for definition </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">child</span><span class="p">))</span>
                         <span class="bp">self</span><span class="p">[</span><span class="n">child</span><span class="p">][</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">parent</span><span class="p">]</span>
                         <span class="n">childloop</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">child</span><span class="p">]</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">)</span>
                         <span class="n">childloop</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">((</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,[</span><span class="n">child</span><span class="p">]))</span>
                         <span class="k">continue</span>
                     <span class="k">else</span><span class="p">:</span>
                         <span class="c1"># A parent loop already exists and so will a child loop due to the</span>
                         <span class="c1"># call to create_pcloop above</span>
                         <span class="n">pars</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">childloop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">==</span><span class="n">child</span><span class="p">]</span>
                         <span class="n">goodpars</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">pars</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">==</span><span class="n">parent</span><span class="p">]</span>
                         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">goodpars</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>   <span class="c1">#no need to add it</span>
                             <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Skipping duplicated parent - child entry in </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">child</span><span class="p">))</span>
                             <span class="k">continue</span>
                         <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Adding </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> entry&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">child</span><span class="p">))</span>
                         <span class="n">newpacket</span> <span class="o">=</span> <span class="n">childloop</span><span class="o">.</span><span class="n">GetPacket</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>   <span class="c1">#essentially a copy, I hope</span>
                         <span class="nb">setattr</span><span class="p">(</span><span class="n">newpacket</span><span class="p">,</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,</span><span class="n">child</span><span class="p">)</span>
                         <span class="nb">setattr</span><span class="p">(</span><span class="n">newpacket</span><span class="p">,</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">,</span><span class="n">parent</span><span class="p">)</span>
                         <span class="n">childloop</span><span class="o">.</span><span class="n">AddPacket</span><span class="p">(</span><span class="n">newpacket</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Make sure the parent also points to the children.  We get</span>
            <span class="c1"># the current entry, then add our</span>
            <span class="c1"># new values if they are not there already</span>
            <span class="c1">#</span>
            <span class="n">parent_name</span> <span class="o">=</span> <span class="n">mychildren</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">old_children</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,[])</span>
            <span class="n">old_parents</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">,[])</span>
            <span class="n">oldfamily</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">old_parents</span><span class="p">,</span><span class="n">old_children</span><span class="p">)</span>
            <span class="n">newfamily</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Old parents -&gt; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">old_parents</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">childname</span> <span class="ow">in</span> <span class="n">mychildren</span><span class="p">:</span>
                <span class="n">alreadythere</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">oldfamily</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">parent_name</span> <span class="ow">and</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span><span class="n">childname</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alreadythere</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                <span class="s1">&#39;Adding new child </span><span class="si">%s</span><span class="s1"> to parent definition at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">childname</span><span class="p">,</span><span class="n">parent_name</span><span class="p">)</span>
                <span class="n">old_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">childname</span><span class="p">)</span>
                <span class="n">old_parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_name</span><span class="p">)</span>
            <span class="c1"># Now output the loop, blowing away previous definitions.  If there is something</span>
            <span class="c1"># else in this category, we are destroying it.</span>
            <span class="n">newloop</span> <span class="o">=</span> <span class="n">CifLoopBlock</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">newloop</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">((</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">,</span><span class="n">old_parents</span><span class="p">))</span>
            <span class="n">newloop</span><span class="o">.</span><span class="n">AddLoopItem</span><span class="p">((</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">,</span><span class="n">old_children</span><span class="p">))</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_name</span><span class="p">][</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">parent_name</span><span class="p">][</span><span class="s1">&#39;_item_linked.child_name&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">insert_loop</span><span class="p">(</span><span class="n">newloop</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;New parents -&gt; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">parent_name</span><span class="p">][</span><span class="s1">&#39;_item_linked.parent_name&#39;</span><span class="p">]))</span>
            <span class="c1"># now make a new,smaller list</span>
            <span class="n">notmychildren</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">notmychildren</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="n">mychildren</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
   <span class="c1"># now flatten any single element lists</span>
   <span class="n">single_defs</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="s1">&#39;_item.name&#39;</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="n">listed_defs</span><span class="p">)</span>
   <span class="k">for</span> <span class="n">flat_def</span> <span class="ow">in</span> <span class="n">single_defs</span><span class="p">:</span>
       <span class="n">flat_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">flat_def</span><span class="p">]</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="s1">&#39;_item.name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
       <span class="k">for</span> <span class="n">flat_key</span> <span class="ow">in</span> <span class="n">flat_keys</span><span class="p">:</span> <span class="bp">self</span><span class="p">[</span><span class="n">flat_def</span><span class="p">][</span><span class="n">flat_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">flat_def</span><span class="p">][</span><span class="n">flat_key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
   <span class="c1"># now deal with the multiple lists</span>
   <span class="c1"># next we do aliases</span>
   <span class="n">all_aliases</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;_item_aliases.alias_name&#39;</span><span class="p">)]</span>
   <span class="k">for</span> <span class="n">aliased</span> <span class="ow">in</span> <span class="n">all_aliases</span><span class="p">:</span>
      <span class="n">my_aliases</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">aliased</span><span class="p">][</span><span class="s1">&#39;_item_aliases.alias_name&#39;</span><span class="p">])</span>
      <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">my_aliases</span><span class="p">:</span>
          <span class="bp">self</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">aliased</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>   <span class="c1">#we are going to delete stuff...</span>
          <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">alias</span><span class="p">][</span><span class="s2">&quot;_item_aliases.alias_name&quot;</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifDic.NewBlock">
    <p>def <span class="ident">NewBlock</span>(</p><p>self, *args, **kwargs)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifDic.NewBlock', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifDic.NewBlock" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">NewBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">newname</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">NewBlock</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_id_table</span><span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">newname</span><span class="p">][</span><span class="s1">&#39;_definition.id&#39;</span><span class="p">]]</span><span class="o">=</span><span class="n">newname</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> <span class="c1">#no block_id table</span>
        <span class="k">pass</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifDic.SetTemplate">
    <p>def <span class="ident">SetTemplate</span>(</p><p>self, template_file)</p>
    </div>
    

    
  
    <div class="desc"><p>Use <code>template_file</code> as a template for all block output</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifDic.SetTemplate', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifDic.SetTemplate" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">SetTemplate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">template_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use `template_file` as a template for all block output&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span> <span class="o">=</span> <span class="n">process_template</span><span class="p">(</span><span class="n">template_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">b</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifDic.WriteOut">
    <p>def <span class="ident">WriteOut</span>(</p><p>self, **kwargs)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifDic.WriteOut', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifDic.WriteOut" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">WriteOut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">myblockorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_child_list</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">=</span> <span class="s1">&#39;Dic&#39;</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CifDic</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">WriteOut</span><span class="p">(</span><span class="n">blockorder</span> <span class="o">=</span> <span class="n">myblockorder</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.CifFile_module.CifError" class="name">class <span class="ident">CifError</span></p>
      
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifError', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifError" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CifError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Cif Format error: &#39;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.CifFile_module.CifError">CifError</a></li>
          <li>exceptions.Exception</li>
          <li>exceptions.BaseException</li>
          <li>__builtin__.object</li>
          </ul>
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.CifFile_module.CifFile" class="name">class <span class="ident">CifFile</span></p>
      
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifFile', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifFile" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CifFile</span><span class="p">(</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarFile</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">datasource</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">strict</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">standard</span><span class="o">=</span><span class="s1">&#39;CIF&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CifFile</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">datasource</span><span class="o">=</span><span class="n">datasource</span><span class="p">,</span><span class="n">standard</span><span class="o">=</span><span class="n">standard</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strict</span> <span class="o">=</span> <span class="n">strict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_comment</span> <span class="o">=</span> \
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">##########################################################################</span>
<span class="sd">#               Crystallographic Information Format file</span>
<span class="sd">#               Produced by PyCifRW module</span>
<span class="sd">#</span>
<span class="sd">#  This is a CIF file.  CIF has been adopted by the International</span>
<span class="sd">#  Union of Crystallography as the standard for data archiving and</span>
<span class="sd">#  transmission.</span>
<span class="sd">#</span>
<span class="sd">#  For information on this file format, follow the CIF links at</span>
<span class="sd">#  http://www.iucr.org</span>
<span class="sd">##########################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.CifFile_module.CifFile">CifFile</a></li>
          <li>CifFile.StarFile.StarFile</li>
          <li>CifFile.StarFile.BlockCollection</li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifFile.NewBlock">
    <p>def <span class="ident">NewBlock</span>(</p><p>self, blockname, blockcontents=None, fix=True, parent=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Add a new block named <code>blockname</code> with contents <code>blockcontents</code>. If <code>fix</code>
is True, <code>blockname</code> will have spaces and tabs replaced by underscores. <code>parent</code>
allows a parent block to be set so that block hierarchies can be created.  Depending on
the output standard, these blocks will be printed out as nested save frames or
ignored.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifFile.NewBlock', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifFile.NewBlock" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">NewBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blockname</span><span class="p">,</span><span class="n">blockcontents</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">fix</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add a new block named `blockname` with contents `blockcontents`. If `fix`</span>
<span class="sd">    is True, `blockname` will have spaces and tabs replaced by underscores. `parent`</span>
<span class="sd">    allows a parent block to be set so that block hierarchies can be created.  Depending on</span>
<span class="sd">    the output standard, these blocks will be printed out as nested save frames or</span>
<span class="sd">    ignored.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">blockcontents</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">blockcontents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocktype</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">==</span> <span class="s2">&quot;CIF&quot;</span><span class="p">:</span>
        <span class="n">blockcontents</span><span class="o">.</span><span class="n">setmaxnamelength</span><span class="p">(</span><span class="mi">75</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blockname</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">75</span><span class="p">:</span>
             <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Blockname </span><span class="si">%s</span><span class="s1"> is longer than 75 characters&#39;</span> <span class="o">%</span> <span class="n">blockname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fix</span><span class="p">:</span>
        <span class="n">newblockname</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[  </span><span class="se">\t</span><span class="s1">]&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="n">blockname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">newblockname</span> <span class="o">=</span> <span class="n">blockname</span>
    <span class="n">new_lowerbn</span> <span class="o">=</span> <span class="n">newblockname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">new_lowerbn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>   <span class="c1">#already there</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
           <span class="n">toplevelnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">==</span><span class="bp">None</span><span class="p">]</span>
           <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">new_lowerbn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">toplevelnames</span><span class="p">:</span>  <span class="c1">#can give a new key to this one</span>
              <span class="k">while</span> <span class="n">new_lowerbn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span> <span class="n">new_lowerbn</span> <span class="o">=</span> <span class="n">new_lowerbn</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span>
           <span class="k">elif</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">new_lowerbn</span> <span class="ow">in</span> <span class="n">toplevelnames</span><span class="p">:</span> <span class="c1">#can fix a different one</span>
              <span class="n">replace_name</span> <span class="o">=</span> <span class="n">new_lowerbn</span>
              <span class="k">while</span> <span class="n">replace_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span> <span class="n">replace_name</span> <span class="o">=</span> <span class="n">replace_name</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">_rekey</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">,</span><span class="n">replace_name</span><span class="p">)</span>
              <span class="c1"># now continue on to add in the new block</span>
              <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">new_lowerbn</span><span class="p">:</span>        <span class="c1">#the new block&#39;s requested parent just got renamed!!</span>
                  <span class="n">parent</span> <span class="o">=</span> <span class="n">replace_name</span>
           <span class="k">else</span><span class="p">:</span>
              <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s2">&quot;Attempt to replace existing block &quot;</span> <span class="o">+</span> <span class="n">blockname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">new_lowerbn</span><span class="p">:</span><span class="n">blockcontents</span><span class="p">})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">newblockname</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
       <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_keys</span><span class="p">:</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoping</span> <span class="o">==</span> <span class="s1">&#39;instance&#39;</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">newblockname</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
          <span class="k">else</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PC</span><span class="p">(</span><span class="n">newblockname</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">visible_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_lowerbn</span><span class="p">)</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Warning:Parent block </span><span class="si">%s</span><span class="s1"> does not exist for child </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">newblockname</span><span class="p">))</span>
    <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">.</span><span class="n">set_characterset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">characterset</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">[</span><span class="n">new_lowerbn</span><span class="p">]</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span>
    <span class="k">return</span> <span class="n">new_lowerbn</span>  <span class="c1">#in case calling routine wants to know</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifFile.SetTemplate">
    <p>def <span class="ident">SetTemplate</span>(</p><p>self, template_file)</p>
    </div>
    

    
  
    <div class="desc"><p>Use <code>template_file</code> as a template for all block output</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifFile.SetTemplate', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifFile.SetTemplate" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">SetTemplate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">template_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use `template_file` as a template for all block output&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span> <span class="o">=</span> <span class="n">process_template</span><span class="p">(</span><span class="n">template_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">b</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifFile.WriteOut">
    <p>def <span class="ident">WriteOut</span>(</p><p>self, comment=u&#39;&#39;, wraplength=80, maxoutlength=0, blockorder=None, saves_after=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Return the contents of this file as a string, wrapping if possible at <code>wraplength</code>
characters and restricting maximum line length to <code>maxoutlength</code>.  Delimiters and
save frame nesting are controlled by <code>self.grammar</code>. If <code>blockorder</code> is
provided, blocks are output in this order unless nested save frames have been
requested (STAR2). The default block order is the order in which blocks were input.
<code>saves_after</code> inserts all save frames after the given dataname,
which allows less important items to appear later.  Useful in conjunction with a
template for dictionary files.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifFile.WriteOut', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifFile.WriteOut" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">WriteOut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">comment</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">wraplength</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">maxoutlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">blockorder</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">saves_after</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the contents of this file as a string, wrapping if possible at `wraplength`</span>
<span class="sd">    characters and restricting maximum line length to `maxoutlength`.  Delimiters and</span>
<span class="sd">    save frame nesting are controlled by `self.grammar`. If `blockorder` is</span>
<span class="sd">    provided, blocks are output in this order unless nested save frames have been</span>
<span class="sd">    requested (STAR2). The default block order is the order in which blocks were input.</span>
<span class="sd">    `saves_after` inserts all save frames after the given dataname,</span>
<span class="sd">    which allows less important items to appear later.  Useful in conjunction with a</span>
<span class="sd">    template for dictionary files.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">maxoutlength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetOutputLength</span><span class="p">(</span><span class="n">maxoutlength</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">comment</span><span class="p">:</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_comment</span>
    <span class="n">outstring</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">==</span> <span class="s2">&quot;2.0&quot;</span> <span class="ow">and</span> <span class="n">comment</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">!=</span> <span class="sa">r</span><span class="s2">&quot;#\#CIF_2.0&quot;</span><span class="p">:</span>
        <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;#\#CIF_2.0&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
    <span class="c1"># prepare all blocks</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span>
        <span class="n">b</span><span class="o">.</span><span class="n">SetOutputLength</span><span class="p">(</span><span class="n">wraplength</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span><span class="p">)</span>
    <span class="c1"># loop over top-level</span>
    <span class="c1"># monitor output</span>
    <span class="n">all_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>   <span class="c1">#i.e. lower case</span>
    <span class="k">if</span> <span class="n">blockorder</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">blockorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span>
    <span class="n">top_block_names</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">blockorder</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">blockref</span><span class="p">,</span><span class="n">blockname</span> <span class="ow">in</span> <span class="n">top_block_names</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">%s</span><span class="s1">, &#39;</span> <span class="o">%</span> <span class="n">blockname</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]))</span>
        <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;data_&#39;</span> <span class="o">+</span><span class="n">blockname</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">all_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">blockref</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">==</span> <span class="s1">&#39;Dic&#39;</span><span class="p">:</span>              <span class="c1">#put contents before save frames</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]</span><span class="o">.</span><span class="n">printsection</span><span class="p">(</span><span class="n">finish_at</span><span class="o">=</span><span class="s1">&#39;_dictionary_valid.application&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">==</span> <span class="s1">&#39;STAR2&#39;</span><span class="p">:</span>  <span class="c1">#nested save frames</span>
            <span class="n">child_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_immediate_children</span><span class="p">(</span><span class="n">blockref</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">child_ref</span><span class="p">,</span><span class="n">child_info</span> <span class="ow">in</span> <span class="n">child_refs</span><span class="p">:</span>
                <span class="n">child_name</span> <span class="o">=</span> <span class="n">child_info</span><span class="o">.</span><span class="n">block_id</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="n">child_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">block_to_string_nested</span><span class="p">(</span><span class="n">child_ref</span><span class="p">,</span><span class="n">child_name</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span><span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span><span class="s1">&#39;1.1&#39;</span><span class="p">,</span><span class="s1">&#39;2.0&#39;</span><span class="p">):</span>                   <span class="c1">#non-nested save frames</span>
            <span class="n">child_refs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">blockorder</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_child_of_parent</span><span class="p">(</span><span class="n">blockref</span><span class="p">,</span><span class="n">a</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">child_ref</span> <span class="ow">in</span> <span class="n">child_refs</span><span class="p">:</span>
                <span class="n">child_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">child_ref</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="n">child_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">child_ref</span><span class="p">]))</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">all_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">child_ref</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Grammar </span><span class="si">%s</span><span class="s1"> is not recognised for output&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">!=</span> <span class="s1">&#39;Dic&#39;</span><span class="p">:</span>              <span class="c1">#put contents after save frames</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]</span><span class="o">.</span><span class="n">printsection</span><span class="p">(</span><span class="n">start_from</span><span class="o">=</span><span class="s1">&#39;_dictionary_valid.application&#39;</span><span class="p">))</span>
    <span class="n">returnstring</span> <span class="o">=</span>  <span class="n">outstring</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="n">outstring</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;WARNING: following blocks not output: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">all_names</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;All blocks output.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">returnstring</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.CifFile_module.CifLoopBlock" class="name">class <span class="ident">CifLoopBlock</span></p>
      
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifLoopBlock', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifLoopBlock" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CifLoopBlock</span><span class="p">(</span><span class="n">StarFile</span><span class="o">.</span><span class="n">LoopBlock</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="p">(),</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CifLoopBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.CifFile_module.CifLoopBlock">CifLoopBlock</a></li>
          <li>CifFile.StarFile.LoopBlock</li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifLoopBlock.AddPacket">
    <p>def <span class="ident">AddPacket</span>(</p><p>self, packet)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifLoopBlock.AddPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifLoopBlock.AddPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">packet</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">myitem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]:</span>
        <span class="n">old_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="p">[</span><span class="n">myitem</span><span class="p">]</span>
        <span class="n">old_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">myitem</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="p">[</span><span class="n">myitem</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_values</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifLoopBlock.AddToLoop">
    <p>def <span class="ident">AddToLoop</span>(</p><p>self, dataname, loopdata)</p>
    </div>
    

    
  
    <div class="desc"><p><em>Deprecated</em>. Use <code>AddItem</code> followed by calls to <code>AddLoopName</code>.</p>
<p>Add multiple columns to the loop containing <code>dataname</code>. <code>loopdata</code> is a
collection of (key,value) pairs, where <code>key</code> is the new dataname and <code>value</code>
is a list of values for that dataname</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifLoopBlock.AddToLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifLoopBlock.AddToLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` followed by calls to `AddLoopName`.</span>
<span class="sd">    Add multiple columns to the loop containing `dataname`. `loopdata` is a</span>
<span class="sd">    collection of (key,value) pairs, where `key` is the new dataname and `value`</span>
<span class="sd">    is a list of values for that dataname&quot;&quot;&quot;</span>
    <span class="c1"># check lengths</span>
    <span class="n">thisloop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
    <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">dataname</span><span class="p">])</span>
    <span class="n">bad_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">!=</span><span class="n">loop_len</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_vals</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
       <span class="k">raise</span> <span class="n">StarLengthError</span><span class="p">(</span><span class="s2">&quot;Number of values for looped datanames </span><span class="si">%s</span><span class="s2"> not equal to </span><span class="si">%d</span><span class="s2">&quot;</span> \
           <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">bad_vals</span> <span class="p">),</span><span class="n">loop_len</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loopdata</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">thisloop</span><span class="p">]</span><span class="o">+=</span><span class="n">loopdata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifLoopBlock.ChangeItemOrder">
    <p>def <span class="ident">ChangeItemOrder</span>(</p><p>self, itemname, newpos)</p>
    </div>
    

    
  
    <div class="desc"><p>Change the position at which <code>itemname</code> appears when printing out to <code>newpos</code>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifLoopBlock.ChangeItemOrder', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifLoopBlock.ChangeItemOrder" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">ChangeItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">,</span><span class="n">newpos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Change the position at which `itemname` appears when printing out to `newpos`.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">newpos</span><span class="p">,</span><span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifLoopBlock.GetItemOrder">
    <p>def <span class="ident">GetItemOrder</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a list of datanames in this <code>LoopBlock</code> in the order that they will be
printed</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifLoopBlock.GetItemOrder', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifLoopBlock.GetItemOrder" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a list of datanames in this `LoopBlock` in the order that they will be</span>
<span class="sd">    printed&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">][:]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifLoopBlock.GetItemPosition">
    <p>def <span class="ident">GetItemPosition</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p>A utility function to get the numerical order in the printout
of <code>itemname</code>.  An item has coordinate <code>(loop_no,pos)</code> with
the top level having a <code>loop_no</code> of -1.  If an integer is passed to
the routine then it will return the position of the loop
referenced by that number.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifLoopBlock.GetItemPosition', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifLoopBlock.GetItemPosition" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetItemPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A utility function to get the numerical order in the printout</span>
<span class="sd">    of `itemname`.  An item has coordinate `(loop_no,pos)` with</span>
<span class="sd">    the top level having a `loop_no` of -1.  If an integer is passed to</span>
<span class="sd">    the routine then it will return the position of the loop</span>
<span class="sd">    referenced by that number.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemname</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
        <span class="c1"># return loop position</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">itemname</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">itemname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No such dataname </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">itemname</span><span class="p">)</span>
    <span class="n">testname</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">testname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">))</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
    <span class="n">loop_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loop_no</span><span class="p">,</span><span class="n">loop_pos</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifLoopBlock.GetLoop">
    <p>def <span class="ident">GetLoop</span>(</p><p>self, keyname)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a <code>StarFile.LoopBlock</code> object constructed from the loop containing <code>keyname</code>.
<code>keyname</code> is only significant as a way to specify the loop.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifLoopBlock.GetLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifLoopBlock.GetLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a `StarFile.LoopBlock` object constructed from the loop containing `keyname`.</span>
<span class="sd">    `keyname` is only significant as a way to specify the loop.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">LoopBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifLoopBlock.GetLoopNames">
    <p>def <span class="ident">GetLoopNames</span>(</p><p>self, keyname)</p>
    </div>
    

    
  
    <div class="desc"><p>Return all datanames appearing together with <code>keyname</code></p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifLoopBlock.GetLoopNames', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifLoopBlock.GetLoopNames" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetLoopNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return all datanames appearing together with `keyname`&quot;&quot;&quot;</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not in any loop&#39;</span> <span class="o">%</span> <span class="n">keyname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifLoopBlock.GetPacket">
    <p>def <span class="ident">GetPacket</span>(</p><p>self, index)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifLoopBlock.GetPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifLoopBlock.GetPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>
    <span class="n">thispack</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">myitem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_block</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loop_no</span><span class="p">]:</span>
        <span class="n">thispack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">myitem</span><span class="p">][</span><span class="n">index</span><span class="p">])</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">thispack</span><span class="p">,</span><span class="n">myitem</span><span class="p">,</span><span class="n">thispack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">thispack</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifLoopBlock.RemoveItem">
    <p>def <span class="ident">RemoveItem</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p>Remove <code>itemname</code> from the block.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifLoopBlock.RemoveItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifLoopBlock.RemoveItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">RemoveItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove `itemname` from the block.&quot;&quot;&quot;</span>
    <span class="c1"># first check any loops</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>
    <span class="n">testkey</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">testkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
        <span class="c1"># now remove from loop</span>
        <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">loop_no</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1">#will appear in order list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.CifLoopBlock.RemoveLoopItem">
    <p>def <span class="ident">RemoveLoopItem</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p><em>Deprecated</em>. Use <code>RemoveItem</code> instead</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifLoopBlock.RemoveLoopItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifLoopBlock.RemoveLoopItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">RemoveLoopItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `RemoveItem` instead&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">RemoveItem</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.CifFile_module.CifRecursionError" class="name">class <span class="ident">CifRecursionError</span></p>
      
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.CifRecursionError', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.CifRecursionError" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CifRecursionError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key_value</span><span class="p">,</span><span class="n">call_stack</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_value</span> <span class="o">=</span> <span class="n">key_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span> <span class="o">=</span> <span class="n">call_stack</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Derivation has recursed, </span><span class="si">%s</span><span class="s2"> seen twice (call stack </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_value</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="p">))</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.CifFile_module.CifRecursionError">CifRecursionError</a></li>
          <li>exceptions.Exception</li>
          <li>exceptions.BaseException</li>
          <li>__builtin__.object</li>
          </ul>
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.CifFile_module.DicBlock" class="name">class <span class="ident">DicBlock</span></p>
      
  
    <div class="desc"><p>A definition block within a dictionary, which allows imports
to be transparently followed</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">DicBlock</span><span class="p">(</span><span class="n">StarFile</span><span class="o">.</span><span class="n">StarBlock</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A definition block within a dictionary, which allows imports</span>
<span class="sd">    to be transparently followed&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DicBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_import_cache</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">super</span><span class="p">(</span><span class="n">DicBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;_import.get&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_import_cache</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">follow_import</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">DicBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="s2">&quot;_import.get&quot;</span><span class="p">),</span><span class="n">dataname</span><span class="p">)</span> 
        <span class="k">try</span><span class="p">:</span>
            <span class="n">final_value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">DicBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>    <span class="c1">#not there</span>
            <span class="n">final_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">final_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not found&quot;</span> <span class="o">%</span> <span class="n">dataname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_value</span>

    <span class="k">def</span> <span class="nf">has_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">add_dict_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">cached</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a loaded dictionary to this block&#39;s cache&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_import_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="n">cached</span>
        
    <span class="k">def</span> <span class="nf">follow_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">import_info</span><span class="p">,</span><span class="n">dataname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the dataname values from the imported dictionary. `import_info`</span>
<span class="sd">        is a list of import locations&quot;&quot;&quot;</span>
        <span class="n">latest_value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">import_ref</span> <span class="ow">in</span> <span class="n">import_info</span><span class="p">:</span>
            <span class="n">file_loc</span> <span class="o">=</span> <span class="n">import_ref</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">file_loc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_import_cache</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dictionary for import </span><span class="si">%s</span><span class="s2"> not found&quot;</span> <span class="o">%</span> <span class="n">file_loc</span><span class="p">)</span>
            <span class="n">import_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_import_cache</span><span class="p">[</span><span class="n">file_loc</span><span class="p">]</span>
            <span class="n">miss</span> <span class="o">=</span> <span class="n">import_ref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;miss&#39;</span><span class="p">,</span><span class="s1">&#39;Exit&#39;</span><span class="p">)</span>
            <span class="n">target_key</span> <span class="o">=</span> <span class="n">import_ref</span><span class="p">[</span><span class="s2">&quot;save&quot;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">import_target</span> <span class="o">=</span> <span class="n">import_from</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">miss</span> <span class="o">==</span> <span class="s1">&#39;Exit&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CifError</span><span class="p">(</span><span class="s1">&#39;Import frame </span><span class="si">%s</span><span class="s1"> not found in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target_key</span><span class="p">,</span><span class="n">file_loc</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">continue</span>
            <span class="c1"># now import appropriately</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">import_ref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span><span class="s1">&#39;Contents&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;contents&quot;</span><span class="p">:</span>   <span class="c1">#only this is used at this level</span>
                <span class="n">latest_value</span> <span class="o">=</span> <span class="n">import_target</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dataname</span><span class="p">,</span><span class="n">latest_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">latest_value</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.CifFile_module.DicBlock">DicBlock</a></li>
          <li>CifFile.StarFile.StarBlock</li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.AddItem">
    <p>def <span class="ident">AddItem</span>(</p><p>self, key, value, precheck=False)</p>
    </div>
    

    
  
    <div class="desc"><p>Add dataname <code>key</code> to block with value <code>value</code>.  <code>value</code> may be
a single value, a list or a tuple. If <code>precheck</code> is False (the default),
all values will be checked and converted to unicode strings as necessary. If
<code>precheck</code> is True, this checking is bypassed.  No checking is necessary
when values are read from a CIF file as they are already in correct form.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.AddItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.AddItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">precheck</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add dataname `key` to block with value `value`.  `value` may be</span>
<span class="sd">    a single value, a list or a tuple. If `precheck` is False (the default),</span>
<span class="sd">    all values will be checked and converted to unicode strings as necessary. If</span>
<span class="sd">    `precheck` is True, this checking is bypassed.  No checking is necessary</span>
<span class="sd">    when values are read from a CIF file as they are already in correct form.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
         <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Star datanames are strings only (got </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">key</span> <span class="p">))</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>    <span class="c1">#everything is unicode internally</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">precheck</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">check_data_name</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxnamelength</span><span class="p">)</span>    <span class="c1"># make sure no nasty characters</span>
    <span class="c1"># check for overwriting</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
             <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span> <span class="s1">&#39;Attempt to insert duplicate item name </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">precheck</span><span class="p">:</span>   <span class="c1">#need to sanitise</span>
        <span class="n">regval</span><span class="p">,</span><span class="n">empty_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularise_data</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">pure_string</span> <span class="o">=</span> <span class="n">check_stringiness</span><span class="p">(</span><span class="n">regval</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_item_value</span><span class="p">(</span><span class="n">regval</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">regval</span><span class="p">,</span><span class="n">empty_val</span> <span class="o">=</span> <span class="n">value</span><span class="p">,</span><span class="bp">None</span>
        <span class="n">pure_string</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c1"># update ancillary information first</span>
    <span class="n">lower_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lower_key</span> <span class="ow">in</span> <span class="bp">self</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">lower_key</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>      <span class="c1">#need to add to order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lower_key</span><span class="p">)</span>
    <span class="c1"># always remove from our case table in case the case is different</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">lower_key</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">lower_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
    <span class="k">if</span> <span class="n">pure_string</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">lower_key</span><span class="p">:[</span><span class="n">regval</span><span class="p">,</span><span class="n">empty_val</span><span class="p">]})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">lower_key</span><span class="p">:[</span><span class="n">empty_val</span><span class="p">,</span><span class="n">regval</span><span class="p">]})</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.AddLoopItem">
    <p>def <span class="ident">AddLoopItem</span>(</p><p>self, incomingdata, precheck=False, maxlength=-1)</p>
    </div>
    

    
  
    <div class="desc"><p><em>Deprecated</em>. Use <code>AddItem</code> followed by <code>CreateLoop</code> if
necessary.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.AddLoopItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.AddLoopItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddLoopItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">incomingdata</span><span class="p">,</span><span class="n">precheck</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">maxlength</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` followed by `CreateLoop` if</span>
<span class="sd">    necessary.&quot;&quot;&quot;</span>
    <span class="c1"># print &quot;Received data %s&quot; % `incomingdata`</span>
    <span class="c1"># we accept tuples, strings, lists and dicts!!</span>
    <span class="c1"># Direct insertion: we have a string-valued key, with an array</span>
    <span class="c1"># of values -&gt; single-item into our loop</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
       <span class="c1"># a whole loop</span>
       <span class="n">keyvallist</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
       <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">keyvallist</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
         <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Star datanames are strings only (got </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.AddLoopName">
    <p>def <span class="ident">AddLoopName</span>(</p><p>self, oldname, newname)</p>
    </div>
    

    
  
    <div class="desc"><p>Add <code>newname</code> to the loop containing <code>oldname</code>. If it is already in the new loop, no
error is raised.  If <code>newname</code> is in a different loop, it is removed from that loop.
The number of values associated with <code>newname</code> must match the number of values associated
with all other columns of the new loop or a <code>ValueError</code> will be raised.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.AddLoopName', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.AddLoopName" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddLoopName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldname</span><span class="p">,</span> <span class="n">newname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add `newname` to the loop containing `oldname`. If it is already in the new loop, no</span>
<span class="sd">    error is raised.  If `newname` is in a different loop, it is removed from that loop.</span>
<span class="sd">    The number of values associated with `newname` must match the number of values associated</span>
<span class="sd">    with all other columns of the new loop or a `ValueError` will be raised.&quot;&quot;&quot;</span>
    <span class="n">lower_newname</span> <span class="o">=</span> <span class="n">newname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">oldname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not in loop&#39;</span> <span class="o">%</span> <span class="n">oldname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lower_newname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]:</span>
        <span class="k">return</span>
    <span class="c1"># check length</span>
    <span class="n">old_provides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">oldname</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="n">old_provides</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">newname</span><span class="p">])</span> <span class="o">!=</span> <span class="n">loop_len</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Mismatch of loop column lengths for </span><span class="si">%s</span><span class="s1">: should be </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="n">loop_len</span><span class="p">))</span>
    <span class="c1"># remove from any other loops</span>
    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="k">if</span> <span class="n">lower_newname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
    <span class="c1"># and add to this loop</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span>
    <span class="c1"># remove from item_order if present</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.AddToLoop">
    <p>def <span class="ident">AddToLoop</span>(</p><p>self, dataname, loopdata)</p>
    </div>
    

    
  
    <div class="desc"><p><em>Deprecated</em>. Use <code>AddItem</code> followed by calls to <code>AddLoopName</code>.</p>
<p>Add multiple columns to the loop containing <code>dataname</code>. <code>loopdata</code> is a
collection of (key,value) pairs, where <code>key</code> is the new dataname and <code>value</code>
is a list of values for that dataname</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.AddToLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.AddToLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` followed by calls to `AddLoopName`.</span>
<span class="sd">    Add multiple columns to the loop containing `dataname`. `loopdata` is a</span>
<span class="sd">    collection of (key,value) pairs, where `key` is the new dataname and `value`</span>
<span class="sd">    is a list of values for that dataname&quot;&quot;&quot;</span>
    <span class="c1"># check lengths</span>
    <span class="n">thisloop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
    <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">dataname</span><span class="p">])</span>
    <span class="n">bad_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">!=</span><span class="n">loop_len</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_vals</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
       <span class="k">raise</span> <span class="n">StarLengthError</span><span class="p">(</span><span class="s2">&quot;Number of values for looped datanames </span><span class="si">%s</span><span class="s2"> not equal to </span><span class="si">%d</span><span class="s2">&quot;</span> \
           <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">bad_vals</span> <span class="p">),</span><span class="n">loop_len</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loopdata</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">thisloop</span><span class="p">]</span><span class="o">+=</span><span class="n">loopdata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.ChangeItemOrder">
    <p>def <span class="ident">ChangeItemOrder</span>(</p><p>self, itemname, newpos)</p>
    </div>
    

    
  
    <div class="desc"><p>Move the printout order of <code>itemname</code> to <code>newpos</code>. If <code>itemname</code> is
in a loop, <code>newpos</code> refers to the order within the loop.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.ChangeItemOrder', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.ChangeItemOrder" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">ChangeItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">,</span><span class="n">newpos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Move the printout order of `itemname` to `newpos`. If `itemname` is</span>
<span class="sd">    in a loop, `newpos` refers to the order within the loop.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemname</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
        <span class="n">true_name</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">true_name</span> <span class="o">=</span> <span class="n">itemname</span>
    <span class="n">loopno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">true_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loopno</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1">#top level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">true_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">newpos</span><span class="p">,</span><span class="n">true_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loopno</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">true_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loopno</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">newpos</span><span class="p">,</span><span class="n">true_name</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.CreateLoop">
    <p>def <span class="ident">CreateLoop</span>(</p><p>self, datanames, order=-1, length_check=True)</p>
    </div>
    

    
  
    <div class="desc"><p>Create a loop in the datablock. <code>datanames</code> is a list of datanames that
together form a loop.  If length_check is True, they should have been initialised in the block
to have the same number of elements (possibly 0). If <code>order</code> is given,
the loop will appear at this position in the block when printing
out. A loop counts as a single position.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.CreateLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.CreateLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">CreateLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">datanames</span><span class="p">,</span><span class="n">order</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">length_check</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;Create a loop in the datablock. `datanames` is a list of datanames that</span>
<span class="sd">       together form a loop.  If length_check is True, they should have been initialised in the block</span>
<span class="sd">       to have the same number of elements (possibly 0). If `order` is given,</span>
<span class="sd">       the loop will appear at this position in the block when printing</span>
<span class="sd">       out. A loop counts as a single position.&quot;&quot;&quot;</span>
       <span class="k">if</span> <span class="n">length_check</span><span class="p">:</span>
           <span class="c1"># check lengths: these datanames should exist</span>
           <span class="n">listed_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">datanames</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">StarList</span><span class="p">)]</span>
           <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listed_values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">datanames</span><span class="p">):</span>
               <span class="n">len_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">datanames</span><span class="p">])</span>
               <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">len_set</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                   <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Request to loop datanames </span><span class="si">%s</span><span class="s1"> with different lengths: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">datanames</span> <span class="p">),</span><span class="nb">repr</span><span class="p">(</span> <span class="n">len_set</span> <span class="p">)))</span>
           <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">listed_values</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
               <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Request to loop datanames where some are single values and some are not&#39;</span><span class="p">)</span>
       <span class="c1"># store as lower case</span>
       <span class="n">lc_datanames</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datanames</span><span class="p">]</span>
       <span class="c1"># remove these datanames from all other loops</span>
       <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">lc_datanames</span> <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
       <span class="c1"># remove empty loops</span>
       <span class="n">empty_loops</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
       <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">empty_loops</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
           <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
       <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
           <span class="n">loopno</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="n">loopno</span> <span class="o">=</span> <span class="mi">1</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loopno</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lc_datanames</span><span class="p">)</span>
       <span class="k">if</span> <span class="n">order</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="n">loopno</span><span class="p">)</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loopno</span><span class="p">)</span>
       <span class="c1"># remove these datanames from item ordering</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lc_datanames</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.FindLoop">
    <p>def <span class="ident">FindLoop</span>(</p><p>self, keyname)</p>
    </div>
    

    
  
    <div class="desc"><p>Find the loop that contains <code>keyname</code> and return its numerical index or
-1 if not present. The numerical index can be used to refer to the loop in
other routines.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.FindLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.FindLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">FindLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the loop that contains `keyname` and return its numerical index or</span>
<span class="sd">    -1 if not present. The numerical index can be used to refer to the loop in</span>
<span class="sd">    other routines.&quot;&quot;&quot;</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">keyname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loop_no</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">loop_no</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.GetCompoundKeyedPacket">
    <p>def <span class="ident">GetCompoundKeyedPacket</span>(</p><p>self, keydict)</p>
    </div>
    

    
  
    <div class="desc"><p>Return the loop packet (a <code>StarPacket</code> object) where the <code>{key:(value,caseless)}</code> pairs
in <code>keydict</code> take the appropriate values. Ignore case for a given <code>key</code> if <code>caseless</code> is
True.  <code>ValueError</code> is raised if no packet is found or more than one packet is found.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.GetCompoundKeyedPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.GetCompoundKeyedPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetCompoundKeyedPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keydict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the loop packet (a `StarPacket` object) where the `{key:(value,caseless)}` pairs</span>
<span class="sd">    in `keydict` take the appropriate values. Ignore case for a given `key` if `caseless` is</span>
<span class="sd">    True.  `ValueError` is raised if no packet is found or more than one packet is found.&quot;&quot;&quot;</span>
    <span class="c1">#print &quot;Looking for %s in %s&quot; % (keyvalue, self.parent_block[keyname])</span>
    <span class="n">keynames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keydict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">my_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">keynames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="n">keynames</span><span class="p">:</span>
        <span class="n">keyval</span><span class="p">,</span><span class="n">no_case</span> <span class="o">=</span> <span class="n">keydict</span><span class="p">[</span><span class="n">one_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">no_case</span><span class="p">:</span>
           <span class="n">my_loop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">one_key</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="nb">str</span><span class="p">(</span><span class="n">keyval</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">my_loop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">one_key</span><span class="p">)</span><span class="o">==</span><span class="n">keyval</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_loop</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad packet keys </span><span class="si">%s</span><span class="s2">: returned </span><span class="si">%d</span><span class="s2"> packets&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">keydict</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">my_loop</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Compound keyed packet: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">my_loop</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">my_loop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.GetFullItemValue">
    <p>def <span class="ident">GetFullItemValue</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p>Return the value associated with <code>itemname</code>, and a boolean flagging whether
(True) or not (False) it is in a form suitable for calculation.  False is
always returned for strings and <code>StarList</code> objects.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.GetFullItemValue', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.GetFullItemValue" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetFullItemValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the value associated with `itemname`, and a boolean flagging whether</span>
<span class="sd">    (True) or not (False) it is in a form suitable for calculation.  False is</span>
<span class="sd">    always returned for strings and `StarList` objects.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Itemname </span><span class="si">%s</span><span class="s1"> not in datablock&#39;</span> <span class="o">%</span> <span class="n">itemname</span><span class="p">)</span>
    <span class="c1"># prefer string value unless all are None</span>
    <span class="c1"># are we a looped value?</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">StarList</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">not_none</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">,</span><span class="bp">False</span>    <span class="c1">#a string value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">StarList</span><span class="p">)</span>  <span class="c1">#a StarList is not calculation-ready</span>
    <span class="k">elif</span> <span class="n">not_none</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">,</span><span class="bp">False</span>         <span class="c1">#a list of string values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">StarList</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="bp">True</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.GetItemOrder">
    <p>def <span class="ident">GetItemOrder</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a list of datanames in the order in which they will be printed.  Loops are
referred to by numerical index</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.GetItemOrder', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.GetItemOrder" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a list of datanames in the order in which they will be printed.  Loops are</span>
<span class="sd">    referred to by numerical index&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">[:]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.GetItemPosition">
    <p>def <span class="ident">GetItemPosition</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p>A utility function to get the numerical order in the printout
of <code>itemname</code>.  An item has coordinate <code>(loop_no,pos)</code> with
the top level having a <code>loop_no</code> of -1.  If an integer is passed to
the routine then it will return the position of the loop
referenced by that number.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.GetItemPosition', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.GetItemPosition" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetItemPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A utility function to get the numerical order in the printout</span>
<span class="sd">    of `itemname`.  An item has coordinate `(loop_no,pos)` with</span>
<span class="sd">    the top level having a `loop_no` of -1.  If an integer is passed to</span>
<span class="sd">    the routine then it will return the position of the loop</span>
<span class="sd">    referenced by that number.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemname</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
        <span class="c1"># return loop position</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">itemname</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">itemname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No such dataname </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">itemname</span><span class="p">)</span>
    <span class="n">testname</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">testname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">))</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
    <span class="n">loop_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loop_no</span><span class="p">,</span><span class="n">loop_pos</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.GetItemValue">
    <p>def <span class="ident">GetItemValue</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p>Return value of <code>itemname</code>.  If <code>itemname</code> is looped, a list
of all values will be returned.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.GetItemValue', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.GetItemValue" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetItemValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return value of `itemname`.  If `itemname` is looped, a list</span>
<span class="sd">    of all values will be returned.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetFullItemValue</span><span class="p">(</span><span class="n">itemname</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.GetKeyedPacket">
    <p>def <span class="ident">GetKeyedPacket</span>(</p><p>self, keyname, keyvalue, no_case=False)</p>
    </div>
    

    
  
    <div class="desc"><p>Return the loop packet (a <code>StarPacket</code> object) where <code>keyname</code> has value
<code>keyvalue</code>. Ignore case in <code>keyvalue</code> if <code>no_case</code> is True.  <code>ValueError</code>
is raised if no packet is found or more than one packet is found.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.GetKeyedPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.GetKeyedPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetKeyedPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">no_case</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the loop packet (a `StarPacket` object) where `keyname` has value</span>
<span class="sd">    `keyvalue`. Ignore case in `keyvalue` if `no_case` is True.  `ValueError`</span>
<span class="sd">    is raised if no packet is found or more than one packet is found.&quot;&quot;&quot;</span>
    <span class="n">my_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
    <span class="c1">#print(&quot;Looking for %s in %s&quot; % (keyvalue, my_loop.parent_block))</span>
    <span class="c1">#print(&#39;Packet check on:&#39; + keyname)</span>
    <span class="c1">#[print(repr(getattr(a,keyname))) for a in my_loop]</span>
    <span class="k">if</span> <span class="n">no_case</span><span class="p">:</span>
       <span class="n">one_pack</span><span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="n">keyvalue</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
       <span class="n">one_pack</span><span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span><span class="o">==</span><span class="n">keyvalue</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">one_pack</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad packet key </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">: returned </span><span class="si">%d</span><span class="s2"> packets&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">keyname</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">one_pack</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Keyed packet: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">one_pack</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">one_pack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.GetKeyedSemanticPacket">
    <p>def <span class="ident">GetKeyedSemanticPacket</span>(</p><p>self, keyvalue, cat_id)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a complete packet for category <code>cat_id</code> where the
category key for the category equals <code>keyvalue</code>.  This routine
will understand any joined loops, so if separate loops in the
datafile belong to the
same category hierarchy (e.g. <code>_atom_site</code> and <code>_atom_site_aniso</code>),
the returned <code>StarPacket</code> object will contain datanames from
both categories.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.GetKeyedSemanticPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.GetKeyedSemanticPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetKeyedSemanticPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">cat_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a complete packet for category `cat_id` where the</span>
<span class="sd">    category key for the category equals `keyvalue`.  This routine</span>
<span class="sd">    will understand any joined loops, so if separate loops in the</span>
<span class="sd">    datafile belong to the</span>
<span class="sd">    same category hierarchy (e.g. `_atom_site` and `_atom_site_aniso`),</span>
<span class="sd">    the returned `StarPacket` object will contain datanames from</span>
<span class="sd">    both categories.&quot;&quot;&quot;</span>
    <span class="n">target_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">[</span><span class="n">cat_id</span><span class="p">]</span>
    <span class="n">target_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">]</span> <span class="c1">#one only in each list</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">()</span>
    <span class="c1"># set case-sensitivity flag</span>
    <span class="n">lcase</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;_type.contents&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Code&#39;</span><span class="p">,</span><span class="s1">&#39;Tag&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">]:</span>
        <span class="n">lcase</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">cat_key</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">extra_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetKeyedPacket</span><span class="p">(</span><span class="n">cat_key</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">no_case</span><span class="o">=</span><span class="n">lcase</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>        <span class="c1">#missing key</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">test_key</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">cat_key</span><span class="p">]</span>  <span class="c1">#generate key if possible</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Test key is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">test_key</span> <span class="p">))</span>
                <span class="k">if</span> <span class="n">test_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>\
                <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">test_key</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">None</span> <span class="ow">in</span> <span class="n">test_key</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_key</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Getting packet for key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">keyvalue</span> <span class="p">))</span>
                    <span class="n">extra_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetKeyedPacket</span><span class="p">(</span><span class="n">cat_key</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">no_case</span><span class="o">=</span><span class="n">lcase</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>             <span class="c1">#cannot be generated</span>
                <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>      <span class="c1">#none/more than one, assume none</span>
            <span class="k">continue</span>
            <span class="c1">#extra_packet = self.dictionary.generate_default_packet(cat_id,cat_key,keyvalue)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">merge_packet</span><span class="p">(</span><span class="n">extra_packet</span><span class="p">)</span>
    <span class="c1"># the following attributes used to calculate missing values</span>
    <span class="k">for</span> <span class="n">keyname</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="n">keyname</span><span class="p">]</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No key found for </span><span class="si">%s</span><span class="s2">, packet is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cat_id</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">cif_dictionary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span>
    <span class="n">p</span><span class="o">.</span><span class="n">fulldata</span> <span class="o">=</span> <span class="bp">self</span>
    <span class="k">return</span> <span class="n">p</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.GetLoop">
    <p>def <span class="ident">GetLoop</span>(</p><p>self, keyname)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a <code>StarFile.LoopBlock</code> object constructed from the loop containing <code>keyname</code>.
<code>keyname</code> is only significant as a way to specify the loop.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.GetLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.GetLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a `StarFile.LoopBlock` object constructed from the loop containing `keyname`.</span>
<span class="sd">    `keyname` is only significant as a way to specify the loop.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">LoopBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.GetLoopNames">
    <p>def <span class="ident">GetLoopNames</span>(</p><p>self, keyname)</p>
    </div>
    

    
  
    <div class="desc"><p>Return all datanames appearing together with <code>keyname</code></p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.GetLoopNames', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.GetLoopNames" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetLoopNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return all datanames appearing together with `keyname`&quot;&quot;&quot;</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not in any loop&#39;</span> <span class="o">%</span> <span class="n">keyname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.GetMultiKeyedSemanticPacket">
    <p>def <span class="ident">GetMultiKeyedSemanticPacket</span>(</p><p>self, keydict, cat_id)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a complete packet for category <code>cat_id</code> where the keyvalues are
provided as a dictionary of key:(value,caseless) pairs
This routine
will understand any joined loops, so if separate loops in the
datafile belong to the
same category hierarchy (e.g. <code>_atom_site</code> and <code>_atom_site_aniso</code>),
the returned <code>StarPacket</code> object will contain datanames from
the requested category and any children.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.GetMultiKeyedSemanticPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.GetMultiKeyedSemanticPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetMultiKeyedSemanticPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keydict</span><span class="p">,</span><span class="n">cat_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a complete packet for category `cat_id` where the keyvalues are</span>
<span class="sd">    provided as a dictionary of key:(value,caseless) pairs</span>
<span class="sd">    This routine</span>
<span class="sd">    will understand any joined loops, so if separate loops in the</span>
<span class="sd">    datafile belong to the</span>
<span class="sd">    same category hierarchy (e.g. `_atom_site` and `_atom_site_aniso`),</span>
<span class="sd">    the returned `StarPacket` object will contain datanames from</span>
<span class="sd">    the requested category and any children.&quot;&quot;&quot;</span>
    <span class="c1">#if len(keyvalues)==1:   #simplification</span>
    <span class="c1">#    return self.GetKeyedSemanticPacket(keydict[1][0],cat_id)</span>
    <span class="n">target_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">[</span><span class="n">cat_id</span><span class="p">]</span>
    <span class="c1"># update the dictionary passed to us with all equivalents, for</span>
    <span class="c1"># simplicity.</span>
    <span class="n">parallel_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">target_keys</span><span class="p">))</span>  <span class="c1">#transpose</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Parallel keys:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">parallel_keys</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Keydict:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">keydict</span><span class="p">))</span>
    <span class="n">start_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keydict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">one_name</span> <span class="ow">in</span> <span class="n">start_keys</span><span class="p">:</span>
        <span class="n">key_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">parallel_keys</span> <span class="k">if</span> <span class="n">one_name</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="n">key_set</span><span class="p">:</span>
            <span class="n">keydict</span><span class="p">[</span><span class="n">one_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">keydict</span><span class="p">[</span><span class="n">one_name</span><span class="p">]</span>
    <span class="c1"># target_keys is a list of lists, each of which is a compound key</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">()</span>
    <span class="c1"># a little function to return the dataname for a key</span>
    <span class="k">def</span> <span class="nf">find_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">key_equivs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,[])</span><span class="o">+</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">one_key</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">one_key</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">one_set</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">:</span> <span class="c1">#loop down the categories</span>
        <span class="n">true_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">find_key</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">one_set</span><span class="p">]</span>
        <span class="n">true_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">true_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_keys</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">one_set</span><span class="p">):</span>
            <span class="n">truekeydict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">t</span><span class="p">,</span><span class="n">keydict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">true_keys</span><span class="p">,</span><span class="n">one_set</span><span class="p">)])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">extra_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetCompoundKeyedPacket</span><span class="p">(</span><span class="n">truekeydict</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>     <span class="c1">#one or more are missing</span>
                <span class="k">continue</span>         <span class="c1">#should try harder?</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Merging packet for keys &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">one_set</span><span class="p">))</span>
        <span class="n">p</span><span class="o">.</span><span class="n">merge_packet</span><span class="p">(</span><span class="n">extra_packet</span><span class="p">)</span>
    <span class="c1"># the following attributes used to calculate missing values</span>
    <span class="n">p</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">true_keys</span>
    <span class="n">p</span><span class="o">.</span><span class="n">cif_dictionary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span>
    <span class="n">p</span><span class="o">.</span><span class="n">fulldata</span> <span class="o">=</span> <span class="bp">self</span>
    <span class="k">return</span> <span class="n">p</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.RemoveItem">
    <p>def <span class="ident">RemoveItem</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p>Remove <code>itemname</code> from the block.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.RemoveItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.RemoveItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">RemoveItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove `itemname` from the block.&quot;&quot;&quot;</span>
    <span class="c1"># first check any loops</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>
    <span class="n">testkey</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">testkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
        <span class="c1"># now remove from loop</span>
        <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">loop_no</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1">#will appear in order list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.RemoveKeyedPacket">
    <p>def <span class="ident">RemoveKeyedPacket</span>(</p><p>self, keyname, keyvalue)</p>
    </div>
    

    
  
    <div class="desc"><p>Remove the packet for which dataname <code>keyname</code> takes
value <code>keyvalue</code>.  Only the first such occurrence is
removed.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.RemoveKeyedPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.RemoveKeyedPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">RemoveKeyedPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove the packet for which dataname `keyname` takes</span>
<span class="sd">    value `keyvalue`.  Only the first such occurrence is</span>
<span class="sd">    removed.&quot;&quot;&quot;</span>
    <span class="n">packet_coord</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">keyname</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">keyvalue</span><span class="p">)</span>
    <span class="n">loopnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoopNames</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dataname</span> <span class="ow">in</span> <span class="n">loopnames</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">packet_coord</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">packet_coord</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.RemoveLoopItem">
    <p>def <span class="ident">RemoveLoopItem</span>(</p><p>self, itemname)</p>
    </div>
    

    
  
    <div class="desc"><p><em>Deprecated</em>. Use <code>RemoveItem</code> instead</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.RemoveLoopItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.RemoveLoopItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">RemoveLoopItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `RemoveItem` instead&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">RemoveItem</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.DicBlock.SetOutputLength">
    <p>def <span class="ident">SetOutputLength</span>(</p><p>self, wraplength=80, maxoutlength=2048)</p>
    </div>
    

    
  
    <div class="desc"><p>Set the maximum output line length (<code>maxoutlength</code>) and the line length to
wrap at (<code>wraplength</code>).  The wrap length is a target only and may not always be
possible.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.DicBlock.SetOutputLength', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.DicBlock.SetOutputLength" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">SetOutputLength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wraplength</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">maxoutlength</span><span class="o">=</span><span class="mi">2048</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the maximum output line length (`maxoutlength`) and the line length to</span>
<span class="sd">    wrap at (`wraplength`).  The wrap length is a target only and may not always be</span>
<span class="sd">    possible.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">wraplength</span> <span class="o">&gt;</span> <span class="n">maxoutlength</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;Wrap length (requested </span><span class="si">%d</span><span class="s2">) must be &lt;= Maximum line length (requested </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wraplength</span><span class="p">,</span><span class="n">maxoutlength</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wraplength</span> <span class="o">=</span> <span class="n">wraplength</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span> <span class="o">=</span> <span class="n">maxoutlength</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.CifFile_module.ValidCifBlock" class="name">class <span class="ident">ValidCifBlock</span></p>
      
  
    <div class="desc"><p>A <code>CifBlock</code> that is valid with respect to a given CIF dictionary.  Methods
of <code>CifBlock</code> are overridden where necessary to disallow addition of invalid items to the
<code>CifBlock</code>.</p>
<h2>Initialisation</h2>
<ul>
<li><code>dic</code> is a <code>CifDic</code> object to be used for validation.</li>
</ul></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ValidCifBlock</span><span class="p">(</span><span class="n">CifBlock</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A `CifBlock` that is valid with respect to a given CIF dictionary.  Methods</span>
<span class="sd">    of `CifBlock` are overridden where necessary to disallow addition of invalid items to the</span>
<span class="sd">    `CifBlock`.</span>

<span class="sd">    ## Initialisation</span>

<span class="sd">    * `dic` is a `CifDic` object to be used for validation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dic</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">diclist</span><span class="o">=</span><span class="p">[],</span> <span class="n">mergemode</span> <span class="o">=</span> <span class="s2">&quot;replace&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwords</span><span class="p">):</span>
        <span class="n">CifBlock</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwords</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dic</span> <span class="ow">and</span> <span class="n">diclist</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Warning: diclist argument ignored when initialising ValidCifBlock&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span><span class="n">CifDic</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span> <span class="o">=</span> <span class="n">dic</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span> <span class="s2">&quot;ValidCifBlock passed non-CifDic type in dic argument&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diclist</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dic</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidCifError</span><span class="p">(</span> <span class="s2">&quot;At least one dictionary must be specified&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">diclist</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span> <span class="o">=</span> <span class="n">merge_dic</span><span class="p">(</span><span class="n">diclist</span><span class="p">,</span><span class="n">mergemode</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_data_checks</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">ValidCifError</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">run_data_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">optimize_on</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dataname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">update_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">run_item_validation</span><span class="p">(</span><span class="n">dataname</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="n">dataname</span><span class="p">]))</span>
            <span class="n">update_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">run_global_validation</span><span class="p">(</span><span class="n">dataname</span><span class="p">,</span><span class="bp">self</span><span class="p">[</span><span class="n">dataname</span><span class="p">],</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">loop_names</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">update_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">run_loop_validation</span><span class="p">(</span><span class="n">loop_names</span><span class="p">))</span>
        <span class="c1"># now run block-level checks</span>
        <span class="n">update_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">run_block_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="c1"># return false and list of baddies if anything didn&#39;t match</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">optimize_off</span><span class="p">()</span>
        <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="c1">#dictionary will change</span>
        <span class="k">for</span> <span class="n">test_key</span> <span class="ow">in</span> <span class="n">all_keys</span><span class="p">:</span>
            <span class="c1">#print(&quot;%s: %r&quot; % (test_key, self.v_result[test_key]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">[</span><span class="n">test_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">[</span><span class="n">test_key</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">==</span><span class="bp">False</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">[</span><span class="n">test_key</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">[</span><span class="n">test_key</span><span class="p">]</span>
        <span class="n">isvalid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span>
        <span class="c1">#if not isvalid:</span>
        <span class="c1">#    print(&quot;Baddies: {!r}&quot;.format(self.v_result))</span>
        <span class="k">return</span> <span class="n">isvalid</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">v_result</span>

    <span class="k">def</span> <span class="nf">single_item_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">):</span>
        <span class="c1">#self.match_single_item(item_name)</span>
        <span class="k">if</span> <span class="n">item_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">item_name</span><span class="p">:[]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">run_item_validation</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">)</span>
        <span class="n">baddies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">==</span><span class="bp">False</span><span class="p">])</span>
        <span class="c1"># if even one false one is found, this should trigger</span>
        <span class="n">isvalid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">baddies</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># if not isvalid: print(&quot;Failures for {}: {!r}&quot;.format(item_name, baddies))</span>
        <span class="k">return</span> <span class="n">isvalid</span><span class="p">,</span><span class="n">baddies</span>

    <span class="k">def</span> <span class="nf">loop_item_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loop_names</span><span class="p">):</span>
        <span class="n">in_dic_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loop_names</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_dic_names</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">loop_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:[]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">run_loop_validation</span><span class="p">(</span><span class="n">in_dic_names</span><span class="p">)</span>
        <span class="n">baddies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">in_dic_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">==</span><span class="bp">False</span><span class="p">])</span>
        <span class="c1"># if even one false one is found, this should trigger</span>
        <span class="n">isvalid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">baddies</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># if not isvalid: print(&quot;Failures for {}: {!r}&quot;.format(loop_names, baddies))</span>
        <span class="k">return</span> <span class="n">isvalid</span><span class="p">,</span><span class="n">baddies</span>

    <span class="k">def</span> <span class="nf">global_item_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">,</span><span class="n">item_value</span><span class="p">,</span><span class="n">provisional_items</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">if</span> <span class="n">item_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">item_name</span><span class="p">:[]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">run_global_validation</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span>
               <span class="n">item_value</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="n">provisional_items</span> <span class="o">=</span> <span class="n">provisional_items</span><span class="p">)</span>
        <span class="n">baddies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">])</span>
        <span class="c1"># if even one false one is found, this should trigger</span>
        <span class="n">isvalid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">baddies</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># if not isvalid: print(&quot;Failures for {}: {!r}&quot;.format(item_name, baddies))</span>
        <span class="k">return</span> <span class="n">isvalid</span><span class="p">,</span><span class="n">baddies</span>

    <span class="k">def</span> <span class="nf">remove_global_item_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">item_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">item_name</span><span class="p">:[]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fulldic</span><span class="o">.</span><span class="n">run_remove_global_validation</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span><span class="bp">self</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">baddies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">]</span><span class="o">==</span><span class="bp">False</span><span class="p">])</span>
        <span class="c1"># if even one false one is found, this should trigger</span>
        <span class="n">isvalid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">baddies</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># if not isvalid: print(&quot;Failures for {}: {!r}&quot;.format(item_name, baddies))</span>
        <span class="k">return</span> <span class="n">isvalid</span><span class="p">,</span><span class="n">baddies</span>

    <span class="k">def</span> <span class="nf">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">):</span>
        <span class="c1"># single item checks</span>
        <span class="n">paired_data</span> <span class="o">=</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">paired_data</span><span class="p">:</span>
            <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_item_check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">)</span>
        <span class="c1"># loop item checks; merge with current loop</span>
        <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">aloop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="s2">&quot;loops&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">dataname</span> <span class="ow">in</span> <span class="n">aloop</span><span class="p">:</span>
                <span class="n">loopnames</span> <span class="o">=</span> <span class="n">aloop</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">new_name</span> <span class="ow">in</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">new_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loopnames</span><span class="p">:</span> <span class="n">loopnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>
                <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">looped_item_check</span><span class="p">(</span><span class="n">loopnames</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">)</span>
        <span class="n">prov_dict</span> <span class="o">=</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">paired_data</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">prov_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>   <span class="c1"># remove temporarily</span>
            <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_item_check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">prov_dict</span><span class="p">)</span>
            <span class="n">prov_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>  <span class="c1"># add back in</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">)</span>
        <span class="n">CifBlock</span><span class="o">.</span><span class="n">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">AddCifItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>   <span class="c1"># single item</span>
            <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_item_check</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_item_check</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">paired_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">paired_data</span><span class="p">:</span>
                <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_item_check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
            <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_item_check</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">prov_dict</span> <span class="o">=</span> <span class="p">{}</span>            <span class="c1"># for storing temporary items</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">paired_data</span><span class="p">:</span> <span class="n">prov_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="n">value</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">paired_data</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">prov_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>   <span class="c1"># remove temporarily</span>
                <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_item_check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">prov_dict</span><span class="p">)</span>
                <span class="n">prov_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>  <span class="c1"># add back in</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Programming error: AddCifItem passed non-tuple,non-string item&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ValidCifBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">AddCifItem</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">AddItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set value of dataname `key` to `value` after checking for conformance with CIF dictionary&quot;&quot;&quot;</span>
        <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_item_check</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
        <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_item_check</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ValidCifBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># utility function</span>
    <span class="k">def</span> <span class="nf">report_if_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">valid</span><span class="p">,</span><span class="n">bad_list</span><span class="p">,</span><span class="n">data_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
            <span class="n">bad_tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">bad_list</span><span class="p">]</span>
            <span class="n">error_string</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bad_tests</span><span class="p">)</span>
            <span class="n">error_string</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">data_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; fails following validity checks: &quot;</span>  <span class="o">+</span> <span class="n">error_string</span>
            <span class="k">raise</span> <span class="n">ValidCifError</span><span class="p">(</span> <span class="n">error_string</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="c1"># we don&#39;t need to run single item checks; we do need to run loop and</span>
        <span class="c1"># global checks.</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">loop_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">loop_items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">loop_items</span><span class="p">:</span>             <span class="c1">#need to check loop conformance</span>
                <span class="n">loop_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">loop_items</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_item_check</span><span class="p">(</span><span class="n">loop_names</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">)</span>
            <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_global_item_check</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RemoveCifItem</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="n">outstr</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
       <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;Validation results</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
       <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
       <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> invalid items found</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="p">))</span>
       <span class="k">for</span> <span class="n">item_name</span><span class="p">,</span><span class="n">val_func_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
           <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> fails following tests:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">item_name</span><span class="p">)</span>
           <span class="k">for</span> <span class="n">val_func</span> <span class="ow">in</span> <span class="n">val_func_list</span><span class="p">:</span>
               <span class="n">outstr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
       <span class="k">return</span> <span class="n">outstr</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.CifFile_module.ValidCifBlock">ValidCifBlock</a></li>
          <li><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></li>
          <li>CifFile.StarFile.StarBlock</li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.AddCifItem">
    <p>def <span class="ident">AddCifItem</span>(</p><p>self, data)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.AddCifItem">AddCifItem</a></code>
    </p>

    
  
    <div class="desc inherited"><p><em>DEPRECATED</em>. Use <code>AddItem</code> instead.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.AddCifItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.AddCifItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddCifItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>   <span class="c1"># single item</span>
        <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_item_check</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_item_check</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">paired_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">paired_data</span><span class="p">:</span>
            <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_item_check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop_item_check</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">prov_dict</span> <span class="o">=</span> <span class="p">{}</span>            <span class="c1"># for storing temporary items</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">paired_data</span><span class="p">:</span> <span class="n">prov_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="n">value</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">paired_data</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">prov_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>   <span class="c1"># remove temporarily</span>
            <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_item_check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">prov_dict</span><span class="p">)</span>
            <span class="n">prov_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>  <span class="c1"># add back in</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Programming error: AddCifItem passed non-tuple,non-string item&quot;</span><span class="p">)</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">ValidCifBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">AddCifItem</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.AddItem">
    <p>def <span class="ident">AddItem</span>(</p><p>self, key, value, **kwargs)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.AddItem">AddItem</a></code>
    </p>

    
  
    <div class="desc"><p>Set value of dataname <code>key</code> to <code>value</code> after checking for conformance with CIF dictionary</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.AddItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.AddItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set value of dataname `key` to `value` after checking for conformance with CIF dictionary&quot;&quot;&quot;</span>
    <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_item_check</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
    <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_item_check</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">ValidCifBlock</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.AddLoopItem">
    <p>def <span class="ident">AddLoopItem</span>(</p><p>self, incomingdata, precheck=False, maxlength=-1)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.AddLoopItem">AddLoopItem</a></code>
    </p>

    
  
    <div class="desc inherited"><p><em>Deprecated</em>. Use <code>AddItem</code> followed by <code>CreateLoop</code> if
necessary.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.AddLoopItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.AddLoopItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddLoopItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">incomingdata</span><span class="p">,</span><span class="n">precheck</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">maxlength</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` followed by `CreateLoop` if</span>
<span class="sd">    necessary.&quot;&quot;&quot;</span>
    <span class="c1"># print &quot;Received data %s&quot; % `incomingdata`</span>
    <span class="c1"># we accept tuples, strings, lists and dicts!!</span>
    <span class="c1"># Direct insertion: we have a string-valued key, with an array</span>
    <span class="c1"># of values -&gt; single-item into our loop</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
       <span class="c1"># a whole loop</span>
       <span class="n">keyvallist</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
       <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">keyvallist</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">CreateLoop</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
         <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Star datanames are strings only (got </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">incomingdata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.AddLoopName">
    <p>def <span class="ident">AddLoopName</span>(</p><p>self, oldname, newname)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.AddLoopName">AddLoopName</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Add <code>newname</code> to the loop containing <code>oldname</code>. If it is already in the new loop, no
error is raised.  If <code>newname</code> is in a different loop, it is removed from that loop.
The number of values associated with <code>newname</code> must match the number of values associated
with all other columns of the new loop or a <code>ValueError</code> will be raised.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.AddLoopName', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.AddLoopName" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddLoopName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldname</span><span class="p">,</span> <span class="n">newname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add `newname` to the loop containing `oldname`. If it is already in the new loop, no</span>
<span class="sd">    error is raised.  If `newname` is in a different loop, it is removed from that loop.</span>
<span class="sd">    The number of values associated with `newname` must match the number of values associated</span>
<span class="sd">    with all other columns of the new loop or a `ValueError` will be raised.&quot;&quot;&quot;</span>
    <span class="n">lower_newname</span> <span class="o">=</span> <span class="n">newname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">oldname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not in loop&#39;</span> <span class="o">%</span> <span class="n">oldname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lower_newname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]:</span>
        <span class="k">return</span>
    <span class="c1"># check length</span>
    <span class="n">old_provides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">loop_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">oldname</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">provide_value</span> <span class="o">=</span> <span class="n">old_provides</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">newname</span><span class="p">])</span> <span class="o">!=</span> <span class="n">loop_len</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Mismatch of loop column lengths for </span><span class="si">%s</span><span class="s1">: should be </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="n">loop_len</span><span class="p">))</span>
    <span class="c1"># remove from any other loops</span>
    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="k">if</span> <span class="n">lower_newname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
    <span class="c1"># and add to this loop</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span>
    <span class="c1"># remove from item_order if present</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lower_newname</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.AddSingleCifItem">
    <p>def <span class="ident">AddSingleCifItem</span>(</p><p>self, key, value)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.AddSingleCifItem">AddSingleCifItem</a></code>
    </p>

    
  
    <div class="desc inherited"><p><em>Deprecated</em>. Use <code>AddItem</code> instead</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.AddSingleCifItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.AddSingleCifItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddSingleCifItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `AddItem` instead&quot;&quot;&quot;</span>
    <span class="sd">&quot;&quot;&quot;Add a single data item. If it is part of a loop, a separate call should be made&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">AddItem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.AddToLoop">
    <p>def <span class="ident">AddToLoop</span>(</p><p>self, dataname, loopdata)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.AddToLoop">AddToLoop</a></code>
    </p>

    
  
    <div class="desc inherited"><p><em>Deprecated</em>. Use <code>AddItem</code> followed by calls to <code>AddLoopName</code>.</p>
<p>Add multiple columns to the loop containing <code>dataname</code>. <code>loopdata</code> is a
collection of (key,value) pairs, where <code>key</code> is the new dataname and <code>value</code>
is a list of values for that dataname</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.AddToLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.AddToLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">):</span>
    <span class="c1"># single item checks</span>
    <span class="n">paired_data</span> <span class="o">=</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">paired_data</span><span class="p">:</span>
        <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_item_check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">)</span>
    <span class="c1"># loop item checks; merge with current loop</span>
    <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">aloop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="s2">&quot;loops&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">dataname</span> <span class="ow">in</span> <span class="n">aloop</span><span class="p">:</span>
            <span class="n">loopnames</span> <span class="o">=</span> <span class="n">aloop</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">new_name</span> <span class="ow">in</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">new_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loopnames</span><span class="p">:</span> <span class="n">loopnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>
            <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">looped_item_check</span><span class="p">(</span><span class="n">loopnames</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">)</span>
    <span class="n">prov_dict</span> <span class="o">=</span> <span class="n">loopdata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">paired_data</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">prov_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>   <span class="c1"># remove temporarily</span>
        <span class="n">valid</span><span class="p">,</span><span class="n">problems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_item_check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">prov_dict</span><span class="p">)</span>
        <span class="n">prov_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>  <span class="c1"># add back in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_if_invalid</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span><span class="n">problems</span><span class="p">)</span>
    <span class="n">CifBlock</span><span class="o">.</span><span class="n">AddToLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataname</span><span class="p">,</span><span class="n">loopdata</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.ChangeItemOrder">
    <p>def <span class="ident">ChangeItemOrder</span>(</p><p>self, itemname, newpos)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.ChangeItemOrder">ChangeItemOrder</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Move the printout order of <code>itemname</code> to <code>newpos</code>. If <code>itemname</code> is
in a loop, <code>newpos</code> refers to the order within the loop.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.ChangeItemOrder', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.ChangeItemOrder" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">ChangeItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">,</span><span class="n">newpos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Move the printout order of `itemname` to `newpos`. If `itemname` is</span>
<span class="sd">    in a loop, `newpos` refers to the order within the loop.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemname</span><span class="p">,(</span><span class="nb">unicode</span><span class="p">,</span><span class="nb">str</span><span class="p">)):</span>
        <span class="n">true_name</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">true_name</span> <span class="o">=</span> <span class="n">itemname</span>
    <span class="n">loopno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">true_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loopno</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1">#top level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">true_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">newpos</span><span class="p">,</span><span class="n">true_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loopno</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">true_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loopno</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">newpos</span><span class="p">,</span><span class="n">true_name</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.CreateLoop">
    <p>def <span class="ident">CreateLoop</span>(</p><p>self, datanames, order=-1, length_check=True)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.CreateLoop">CreateLoop</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Create a loop in the datablock. <code>datanames</code> is a list of datanames that
together form a loop.  If length_check is True, they should have been initialised in the block
to have the same number of elements (possibly 0). If <code>order</code> is given,
the loop will appear at this position in the block when printing
out. A loop counts as a single position.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.CreateLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.CreateLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">CreateLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">datanames</span><span class="p">,</span><span class="n">order</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">length_check</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;Create a loop in the datablock. `datanames` is a list of datanames that</span>
<span class="sd">       together form a loop.  If length_check is True, they should have been initialised in the block</span>
<span class="sd">       to have the same number of elements (possibly 0). If `order` is given,</span>
<span class="sd">       the loop will appear at this position in the block when printing</span>
<span class="sd">       out. A loop counts as a single position.&quot;&quot;&quot;</span>
       <span class="k">if</span> <span class="n">length_check</span><span class="p">:</span>
           <span class="c1"># check lengths: these datanames should exist</span>
           <span class="n">listed_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">datanames</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">StarList</span><span class="p">)]</span>
           <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listed_values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">datanames</span><span class="p">):</span>
               <span class="n">len_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">datanames</span><span class="p">])</span>
               <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">len_set</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                   <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Request to loop datanames </span><span class="si">%s</span><span class="s1"> with different lengths: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span> <span class="n">datanames</span> <span class="p">),</span><span class="nb">repr</span><span class="p">(</span> <span class="n">len_set</span> <span class="p">)))</span>
           <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">listed_values</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
               <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Request to loop datanames where some are single values and some are not&#39;</span><span class="p">)</span>
       <span class="c1"># store as lower case</span>
       <span class="n">lc_datanames</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datanames</span><span class="p">]</span>
       <span class="c1"># remove these datanames from all other loops</span>
       <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">lc_datanames</span> <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
       <span class="c1"># remove empty loops</span>
       <span class="n">empty_loops</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
       <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">empty_loops</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
           <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
       <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
           <span class="n">loopno</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="n">loopno</span> <span class="o">=</span> <span class="mi">1</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loopno</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lc_datanames</span><span class="p">)</span>
       <span class="k">if</span> <span class="n">order</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="n">loopno</span><span class="p">)</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loopno</span><span class="p">)</span>
       <span class="c1"># remove these datanames from item ordering</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lc_datanames</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.FindLoop">
    <p>def <span class="ident">FindLoop</span>(</p><p>self, keyname)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.FindLoop">FindLoop</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Find the loop that contains <code>keyname</code> and return its numerical index or
-1 if not present. The numerical index can be used to refer to the loop in
other routines.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.FindLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.FindLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">FindLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the loop that contains `keyname` and return its numerical index or</span>
<span class="sd">    -1 if not present. The numerical index can be used to refer to the loop in</span>
<span class="sd">    other routines.&quot;&quot;&quot;</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">keyname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loop_no</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">loop_no</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.GetCompoundKeyedPacket">
    <p>def <span class="ident">GetCompoundKeyedPacket</span>(</p><p>self, keydict)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.GetCompoundKeyedPacket">GetCompoundKeyedPacket</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Return the loop packet (a <code>StarPacket</code> object) where the <code>{key:(value,caseless)}</code> pairs
in <code>keydict</code> take the appropriate values. Ignore case for a given <code>key</code> if <code>caseless</code> is
True.  <code>ValueError</code> is raised if no packet is found or more than one packet is found.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.GetCompoundKeyedPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.GetCompoundKeyedPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetCompoundKeyedPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keydict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the loop packet (a `StarPacket` object) where the `{key:(value,caseless)}` pairs</span>
<span class="sd">    in `keydict` take the appropriate values. Ignore case for a given `key` if `caseless` is</span>
<span class="sd">    True.  `ValueError` is raised if no packet is found or more than one packet is found.&quot;&quot;&quot;</span>
    <span class="c1">#print &quot;Looking for %s in %s&quot; % (keyvalue, self.parent_block[keyname])</span>
    <span class="n">keynames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keydict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">my_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">keynames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="n">keynames</span><span class="p">:</span>
        <span class="n">keyval</span><span class="p">,</span><span class="n">no_case</span> <span class="o">=</span> <span class="n">keydict</span><span class="p">[</span><span class="n">one_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">no_case</span><span class="p">:</span>
           <span class="n">my_loop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">one_key</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="nb">str</span><span class="p">(</span><span class="n">keyval</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">my_loop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">one_key</span><span class="p">)</span><span class="o">==</span><span class="n">keyval</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_loop</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad packet keys </span><span class="si">%s</span><span class="s2">: returned </span><span class="si">%d</span><span class="s2"> packets&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">keydict</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">my_loop</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Compound keyed packet: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">my_loop</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">my_loop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.GetFullItemValue">
    <p>def <span class="ident">GetFullItemValue</span>(</p><p>self, itemname)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.GetFullItemValue">GetFullItemValue</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Return the value associated with <code>itemname</code>, and a boolean flagging whether
(True) or not (False) it is in a form suitable for calculation.  False is
always returned for strings and <code>StarList</code> objects.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.GetFullItemValue', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.GetFullItemValue" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetFullItemValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the value associated with `itemname`, and a boolean flagging whether</span>
<span class="sd">    (True) or not (False) it is in a form suitable for calculation.  False is</span>
<span class="sd">    always returned for strings and `StarList` objects.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Itemname </span><span class="si">%s</span><span class="s1"> not in datablock&#39;</span> <span class="o">%</span> <span class="n">itemname</span><span class="p">)</span>
    <span class="c1"># prefer string value unless all are None</span>
    <span class="c1"># are we a looped value?</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">StarList</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">not_none</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">,</span><span class="bp">False</span>    <span class="c1">#a string value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">StarList</span><span class="p">)</span>  <span class="c1">#a StarList is not calculation-ready</span>
    <span class="k">elif</span> <span class="n">not_none</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">,</span><span class="bp">False</span>         <span class="c1">#a list of string values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">StarList</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="bp">True</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.GetItemOrder">
    <p>def <span class="ident">GetItemOrder</span>(</p><p>self)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.GetItemOrder">GetItemOrder</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Return a list of datanames in the order in which they will be printed.  Loops are
referred to by numerical index</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.GetItemOrder', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.GetItemOrder" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetItemOrder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a list of datanames in the order in which they will be printed.  Loops are</span>
<span class="sd">    referred to by numerical index&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">[:]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.GetItemPosition">
    <p>def <span class="ident">GetItemPosition</span>(</p><p>self, itemname)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.GetItemPosition">GetItemPosition</a></code>
    </p>

    
  
    <div class="desc inherited"><p>A utility function to get the numerical order in the printout
of <code>itemname</code>.  An item has coordinate <code>(loop_no,pos)</code> with
the top level having a <code>loop_no</code> of -1.  If an integer is passed to
the routine then it will return the position of the loop
referenced by that number.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.GetItemPosition', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.GetItemPosition" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetItemPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A utility function to get the numerical order in the printout</span>
<span class="sd">    of `itemname`.  An item has coordinate `(loop_no,pos)` with</span>
<span class="sd">    the top level having a `loop_no` of -1.  If an integer is passed to</span>
<span class="sd">    the routine then it will return the position of the loop</span>
<span class="sd">    referenced by that number.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itemname</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
        <span class="c1"># return loop position</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">itemname</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">itemname</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No such dataname </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">itemname</span><span class="p">)</span>
    <span class="n">testname</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">testname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">))</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
    <span class="n">loop_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loop_no</span><span class="p">,</span><span class="n">loop_pos</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.GetItemValue">
    <p>def <span class="ident">GetItemValue</span>(</p><p>self, itemname)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.GetItemValue">GetItemValue</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Return value of <code>itemname</code>.  If <code>itemname</code> is looped, a list
of all values will be returned.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.GetItemValue', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.GetItemValue" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetItemValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return value of `itemname`.  If `itemname` is looped, a list</span>
<span class="sd">    of all values will be returned.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetFullItemValue</span><span class="p">(</span><span class="n">itemname</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.GetKeyedPacket">
    <p>def <span class="ident">GetKeyedPacket</span>(</p><p>self, keyname, keyvalue, no_case=False)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.GetKeyedPacket">GetKeyedPacket</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Return the loop packet (a <code>StarPacket</code> object) where <code>keyname</code> has value
<code>keyvalue</code>. Ignore case in <code>keyvalue</code> if <code>no_case</code> is True.  <code>ValueError</code>
is raised if no packet is found or more than one packet is found.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.GetKeyedPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.GetKeyedPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetKeyedPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">no_case</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the loop packet (a `StarPacket` object) where `keyname` has value</span>
<span class="sd">    `keyvalue`. Ignore case in `keyvalue` if `no_case` is True.  `ValueError`</span>
<span class="sd">    is raised if no packet is found or more than one packet is found.&quot;&quot;&quot;</span>
    <span class="n">my_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
    <span class="c1">#print(&quot;Looking for %s in %s&quot; % (keyvalue, my_loop.parent_block))</span>
    <span class="c1">#print(&#39;Packet check on:&#39; + keyname)</span>
    <span class="c1">#[print(repr(getattr(a,keyname))) for a in my_loop]</span>
    <span class="k">if</span> <span class="n">no_case</span><span class="p">:</span>
       <span class="n">one_pack</span><span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="n">keyvalue</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
       <span class="n">one_pack</span><span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">my_loop</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span><span class="o">==</span><span class="n">keyvalue</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">one_pack</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad packet key </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">: returned </span><span class="si">%d</span><span class="s2"> packets&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">keyname</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">one_pack</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Keyed packet: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">one_pack</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">one_pack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.GetKeyedSemanticPacket">
    <p>def <span class="ident">GetKeyedSemanticPacket</span>(</p><p>self, keyvalue, cat_id)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.GetKeyedSemanticPacket">GetKeyedSemanticPacket</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Return a complete packet for category <code>cat_id</code> where the
category key for the category equals <code>keyvalue</code>.  This routine
will understand any joined loops, so if separate loops in the
datafile belong to the
same category hierarchy (e.g. <code>_atom_site</code> and <code>_atom_site_aniso</code>),
the returned <code>StarPacket</code> object will contain datanames from
both categories.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.GetKeyedSemanticPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.GetKeyedSemanticPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetKeyedSemanticPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">cat_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a complete packet for category `cat_id` where the</span>
<span class="sd">    category key for the category equals `keyvalue`.  This routine</span>
<span class="sd">    will understand any joined loops, so if separate loops in the</span>
<span class="sd">    datafile belong to the</span>
<span class="sd">    same category hierarchy (e.g. `_atom_site` and `_atom_site_aniso`),</span>
<span class="sd">    the returned `StarPacket` object will contain datanames from</span>
<span class="sd">    both categories.&quot;&quot;&quot;</span>
    <span class="n">target_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">[</span><span class="n">cat_id</span><span class="p">]</span>
    <span class="n">target_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">]</span> <span class="c1">#one only in each list</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">()</span>
    <span class="c1"># set case-sensitivity flag</span>
    <span class="n">lcase</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">target_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;_type.contents&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Code&#39;</span><span class="p">,</span><span class="s1">&#39;Tag&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">]:</span>
        <span class="n">lcase</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">cat_key</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">extra_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetKeyedPacket</span><span class="p">(</span><span class="n">cat_key</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">no_case</span><span class="o">=</span><span class="n">lcase</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>        <span class="c1">#missing key</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">test_key</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">cat_key</span><span class="p">]</span>  <span class="c1">#generate key if possible</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Test key is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">test_key</span> <span class="p">))</span>
                <span class="k">if</span> <span class="n">test_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>\
                <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">test_key</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">None</span> <span class="ow">in</span> <span class="n">test_key</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_key</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Getting packet for key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span> <span class="n">keyvalue</span> <span class="p">))</span>
                    <span class="n">extra_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetKeyedPacket</span><span class="p">(</span><span class="n">cat_key</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">,</span><span class="n">no_case</span><span class="o">=</span><span class="n">lcase</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>             <span class="c1">#cannot be generated</span>
                <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>      <span class="c1">#none/more than one, assume none</span>
            <span class="k">continue</span>
            <span class="c1">#extra_packet = self.dictionary.generate_default_packet(cat_id,cat_key,keyvalue)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">merge_packet</span><span class="p">(</span><span class="n">extra_packet</span><span class="p">)</span>
    <span class="c1"># the following attributes used to calculate missing values</span>
    <span class="k">for</span> <span class="n">keyname</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="n">keyname</span><span class="p">]</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No key found for </span><span class="si">%s</span><span class="s2">, packet is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cat_id</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">cif_dictionary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span>
    <span class="n">p</span><span class="o">.</span><span class="n">fulldata</span> <span class="o">=</span> <span class="bp">self</span>
    <span class="k">return</span> <span class="n">p</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.GetLoop">
    <p>def <span class="ident">GetLoop</span>(</p><p>self, keyname)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.GetLoop">GetLoop</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Return a <code>StarFile.LoopBlock</code> object constructed from the loop containing <code>keyname</code>.
<code>keyname</code> is only significant as a way to specify the loop.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.GetLoop', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.GetLoop" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a `StarFile.LoopBlock` object constructed from the loop containing `keyname`.</span>
<span class="sd">    `keyname` is only significant as a way to specify the loop.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">LoopBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.GetLoopNames">
    <p>def <span class="ident">GetLoopNames</span>(</p><p>self, keyname)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.GetLoopNames">GetLoopNames</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Return all datanames appearing together with <code>keyname</code></p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.GetLoopNames', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.GetLoopNames" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetLoopNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return all datanames appearing together with `keyname`&quot;&quot;&quot;</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not in any loop&#39;</span> <span class="o">%</span> <span class="n">keyname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.GetMultiKeyedSemanticPacket">
    <p>def <span class="ident">GetMultiKeyedSemanticPacket</span>(</p><p>self, keydict, cat_id)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.GetMultiKeyedSemanticPacket">GetMultiKeyedSemanticPacket</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Return a complete packet for category <code>cat_id</code> where the keyvalues are
provided as a dictionary of key:(value,caseless) pairs
This routine
will understand any joined loops, so if separate loops in the
datafile belong to the
same category hierarchy (e.g. <code>_atom_site</code> and <code>_atom_site_aniso</code>),
the returned <code>StarPacket</code> object will contain datanames from
the requested category and any children.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.GetMultiKeyedSemanticPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.GetMultiKeyedSemanticPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">GetMultiKeyedSemanticPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keydict</span><span class="p">,</span><span class="n">cat_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a complete packet for category `cat_id` where the keyvalues are</span>
<span class="sd">    provided as a dictionary of key:(value,caseless) pairs</span>
<span class="sd">    This routine</span>
<span class="sd">    will understand any joined loops, so if separate loops in the</span>
<span class="sd">    datafile belong to the</span>
<span class="sd">    same category hierarchy (e.g. `_atom_site` and `_atom_site_aniso`),</span>
<span class="sd">    the returned `StarPacket` object will contain datanames from</span>
<span class="sd">    the requested category and any children.&quot;&quot;&quot;</span>
    <span class="c1">#if len(keyvalues)==1:   #simplification</span>
    <span class="c1">#    return self.GetKeyedSemanticPacket(keydict[1][0],cat_id)</span>
    <span class="n">target_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">cat_key_table</span><span class="p">[</span><span class="n">cat_id</span><span class="p">]</span>
    <span class="c1"># update the dictionary passed to us with all equivalents, for</span>
    <span class="c1"># simplicity.</span>
    <span class="n">parallel_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">target_keys</span><span class="p">))</span>  <span class="c1">#transpose</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Parallel keys:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">parallel_keys</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Keydict:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">keydict</span><span class="p">))</span>
    <span class="n">start_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keydict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">one_name</span> <span class="ow">in</span> <span class="n">start_keys</span><span class="p">:</span>
        <span class="n">key_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">parallel_keys</span> <span class="k">if</span> <span class="n">one_name</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="n">key_set</span><span class="p">:</span>
            <span class="n">keydict</span><span class="p">[</span><span class="n">one_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">keydict</span><span class="p">[</span><span class="n">one_name</span><span class="p">]</span>
    <span class="c1"># target_keys is a list of lists, each of which is a compound key</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">StarPacket</span><span class="p">()</span>
    <span class="c1"># a little function to return the dataname for a key</span>
    <span class="k">def</span> <span class="nf">find_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">one_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">key_equivs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,[])</span><span class="o">+</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">one_key</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">one_key</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">one_set</span> <span class="ow">in</span> <span class="n">target_keys</span><span class="p">:</span> <span class="c1">#loop down the categories</span>
        <span class="n">true_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">find_key</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">one_set</span><span class="p">]</span>
        <span class="n">true_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">true_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_keys</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">one_set</span><span class="p">):</span>
            <span class="n">truekeydict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">t</span><span class="p">,</span><span class="n">keydict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">true_keys</span><span class="p">,</span><span class="n">one_set</span><span class="p">)])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">extra_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetCompoundKeyedPacket</span><span class="p">(</span><span class="n">truekeydict</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>     <span class="c1">#one or more are missing</span>
                <span class="k">continue</span>         <span class="c1">#should try harder?</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Merging packet for keys &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">one_set</span><span class="p">))</span>
        <span class="n">p</span><span class="o">.</span><span class="n">merge_packet</span><span class="p">(</span><span class="n">extra_packet</span><span class="p">)</span>
    <span class="c1"># the following attributes used to calculate missing values</span>
    <span class="n">p</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">true_keys</span>
    <span class="n">p</span><span class="o">.</span><span class="n">cif_dictionary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span>
    <span class="n">p</span><span class="o">.</span><span class="n">fulldata</span> <span class="o">=</span> <span class="bp">self</span>
    <span class="k">return</span> <span class="n">p</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.RemoveCifItem">
    <p>def <span class="ident">RemoveCifItem</span>(</p><p>self, itemname)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.RemoveCifItem">RemoveCifItem</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Remove <code>itemname</code> from the CifBlock</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.RemoveCifItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.RemoveCifItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">RemoveCifItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove `itemname` from the CifBlock&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">RemoveItem</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.RemoveItem">
    <p>def <span class="ident">RemoveItem</span>(</p><p>self, itemname)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.RemoveItem">RemoveItem</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Remove <code>itemname</code> from the block.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.RemoveItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.RemoveItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">RemoveItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove `itemname` from the block.&quot;&quot;&quot;</span>
    <span class="c1"># first check any loops</span>
    <span class="n">loop_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FindLoop</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>
    <span class="n">testkey</span> <span class="o">=</span> <span class="n">itemname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">testkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_case</span><span class="p">[</span><span class="n">testkey</span><span class="p">]</span>
        <span class="c1"># now remove from loop</span>
        <span class="k">if</span> <span class="n">loop_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">loop_no</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">loop_no</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1">#will appear in order list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">item_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">testkey</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.RemoveKeyedPacket">
    <p>def <span class="ident">RemoveKeyedPacket</span>(</p><p>self, keyname, keyvalue)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.RemoveKeyedPacket">RemoveKeyedPacket</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Remove the packet for which dataname <code>keyname</code> takes
value <code>keyvalue</code>.  Only the first such occurrence is
removed.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.RemoveKeyedPacket', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.RemoveKeyedPacket" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">RemoveKeyedPacket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keyname</span><span class="p">,</span><span class="n">keyvalue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove the packet for which dataname `keyname` takes</span>
<span class="sd">    value `keyvalue`.  Only the first such occurrence is</span>
<span class="sd">    removed.&quot;&quot;&quot;</span>
    <span class="n">packet_coord</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">keyname</span><span class="p">])</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">keyvalue</span><span class="p">)</span>
    <span class="n">loopnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetLoopNames</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dataname</span> <span class="ow">in</span> <span class="n">loopnames</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">packet_coord</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">packet_coord</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.RemoveLoopItem">
    <p>def <span class="ident">RemoveLoopItem</span>(</p><p>self, itemname)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.RemoveLoopItem">RemoveLoopItem</a></code>
    </p>

    
  
    <div class="desc inherited"><p><em>Deprecated</em>. Use <code>RemoveItem</code> instead</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.RemoveLoopItem', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.RemoveLoopItem" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">RemoveLoopItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itemname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;*Deprecated*. Use `RemoveItem` instead&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">RemoveItem</span><span class="p">(</span><span class="n">itemname</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifBlock.SetOutputLength">
    <p>def <span class="ident">SetOutputLength</span>(</p><p>self, wraplength=80, maxoutlength=2048)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifBlock">CifBlock</a></code>.<code><a href="#CifFile.CifFile_module.CifBlock.SetOutputLength">SetOutputLength</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Set the maximum output line length (<code>maxoutlength</code>) and the line length to
wrap at (<code>wraplength</code>).  The wrap length is a target only and may not always be
possible.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifBlock.SetOutputLength', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifBlock.SetOutputLength" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">SetOutputLength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wraplength</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">maxoutlength</span><span class="o">=</span><span class="mi">2048</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the maximum output line length (`maxoutlength`) and the line length to</span>
<span class="sd">    wrap at (`wraplength`).  The wrap length is a target only and may not always be</span>
<span class="sd">    possible.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">wraplength</span> <span class="o">&gt;</span> <span class="n">maxoutlength</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s2">&quot;Wrap length (requested </span><span class="si">%d</span><span class="s2">) must be &lt;= Maximum line length (requested </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wraplength</span><span class="p">,</span><span class="n">maxoutlength</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wraplength</span> <span class="o">=</span> <span class="n">wraplength</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span> <span class="o">=</span> <span class="n">maxoutlength</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.CifFile_module.ValidCifError" class="name">class <span class="ident">ValidCifError</span></p>
      
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifError', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifError" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ValidCifError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Cif Validity error: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.CifFile_module.ValidCifError">ValidCifError</a></li>
          <li>exceptions.Exception</li>
          <li>exceptions.BaseException</li>
          <li>__builtin__.object</li>
          </ul>
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.CifFile_module.ValidCifFile" class="name">class <span class="ident">ValidCifFile</span></p>
      
  
    <div class="desc"><p>A CIF file for which all datablocks are valid.  Argument <code>dic</code> to
initialisation specifies a <code>CifDic</code> object to use for validation.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifFile', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifFile" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ValidCifFile</span><span class="p">(</span><span class="n">CifFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CIF file for which all datablocks are valid.  Argument `dic` to</span>
<span class="sd">    initialisation specifies a `CifDic` object to use for validation.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dic</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">diclist</span><span class="o">=</span><span class="p">[],</span><span class="n">mergemode</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">diclist</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dic</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;bigdic&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidCifError</span><span class="p">(</span> <span class="s2">&quot;At least one dictionary is required to create a ValidCifFile object&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dic</span> <span class="ow">and</span> <span class="n">diclist</span><span class="p">:</span>     <span class="c1">#merge here for speed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bigdic</span> <span class="o">=</span> <span class="n">merge_dic</span><span class="p">(</span><span class="n">diclist</span><span class="p">,</span><span class="n">mergemode</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dic</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">diclist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bigdic</span> <span class="o">=</span> <span class="n">dic</span>
        <span class="n">CifFile</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">blockname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">blockname</span><span class="p">]</span><span class="o">=</span><span class="n">ValidCifBlock</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">blockname</span><span class="p">],</span><span class="n">dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bigdic</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">NewBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blockname</span><span class="p">,</span><span class="n">blockcontents</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">CifFile</span><span class="o">.</span><span class="n">NewBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blockname</span><span class="p">,</span><span class="n">blockcontents</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># dictionary[blockname] is now a CifBlock object.  We</span>
        <span class="c1"># turn it into a ValidCifBlock object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">blockname</span><span class="p">]</span> <span class="o">=</span> <span class="n">ValidCifBlock</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bigdic</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">blockname</span><span class="p">])</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.CifFile_module.ValidCifFile">ValidCifFile</a></li>
          <li><a href="#CifFile.CifFile_module.CifFile">CifFile</a></li>
          <li>CifFile.StarFile.StarFile</li>
          <li>CifFile.StarFile.BlockCollection</li>
          <li>__builtin__.object</li>
          </ul>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifFile.NewBlock">
    <p>def <span class="ident">NewBlock</span>(</p><p>self, blockname, blockcontents, **kwargs)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifFile">CifFile</a></code>.<code><a href="#CifFile.CifFile_module.CifFile.NewBlock">NewBlock</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Add a new block named <code>blockname</code> with contents <code>blockcontents</code>. If <code>fix</code>
is True, <code>blockname</code> will have spaces and tabs replaced by underscores. <code>parent</code>
allows a parent block to be set so that block hierarchies can be created.  Depending on
the output standard, these blocks will be printed out as nested save frames or
ignored.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifFile.NewBlock', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifFile.NewBlock" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">NewBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blockname</span><span class="p">,</span><span class="n">blockcontents</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">CifFile</span><span class="o">.</span><span class="n">NewBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blockname</span><span class="p">,</span><span class="n">blockcontents</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># dictionary[blockname] is now a CifBlock object.  We</span>
    <span class="c1"># turn it into a ValidCifBlock object</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">blockname</span><span class="p">]</span> <span class="o">=</span> <span class="n">ValidCifBlock</span><span class="p">(</span><span class="n">dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bigdic</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">[</span><span class="n">blockname</span><span class="p">])</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifFile.SetTemplate">
    <p>def <span class="ident">SetTemplate</span>(</p><p>self, template_file)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifFile">CifFile</a></code>.<code><a href="#CifFile.CifFile_module.CifFile.SetTemplate">SetTemplate</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Use <code>template_file</code> as a template for all block output</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifFile.SetTemplate', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifFile.SetTemplate" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">SetTemplate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">template_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use `template_file` as a template for all block output&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span> <span class="o">=</span> <span class="n">process_template</span><span class="p">(</span><span class="n">template_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">b</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="CifFile.CifFile_module.ValidCifFile.WriteOut">
    <p>def <span class="ident">WriteOut</span>(</p><p>self, comment=u&#39;&#39;, wraplength=80, maxoutlength=0, blockorder=None, saves_after=None)</p>
    </div>
    
    <p class="inheritance">
     <strong>Inheritance:</strong>
       <code><a href="#CifFile.CifFile_module.CifFile">CifFile</a></code>.<code><a href="#CifFile.CifFile_module.CifFile.WriteOut">WriteOut</a></code>
    </p>

    
  
    <div class="desc inherited"><p>Return the contents of this file as a string, wrapping if possible at <code>wraplength</code>
characters and restricting maximum line length to <code>maxoutlength</code>.  Delimiters and
save frame nesting are controlled by <code>self.grammar</code>. If <code>blockorder</code> is
provided, blocks are output in this order unless nested save frames have been
requested (STAR2). The default block order is the order in which blocks were input.
<code>saves_after</code> inserts all save frames after the given dataname,
which allows less important items to appear later.  Useful in conjunction with a
template for dictionary files.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidCifFile.WriteOut', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidCifFile.WriteOut" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">WriteOut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">comment</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">wraplength</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">maxoutlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">blockorder</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">saves_after</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the contents of this file as a string, wrapping if possible at `wraplength`</span>
<span class="sd">    characters and restricting maximum line length to `maxoutlength`.  Delimiters and</span>
<span class="sd">    save frame nesting are controlled by `self.grammar`. If `blockorder` is</span>
<span class="sd">    provided, blocks are output in this order unless nested save frames have been</span>
<span class="sd">    requested (STAR2). The default block order is the order in which blocks were input.</span>
<span class="sd">    `saves_after` inserts all save frames after the given dataname,</span>
<span class="sd">    which allows less important items to appear later.  Useful in conjunction with a</span>
<span class="sd">    template for dictionary files.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">maxoutlength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetOutputLength</span><span class="p">(</span><span class="n">maxoutlength</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">comment</span><span class="p">:</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_comment</span>
    <span class="n">outstring</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">==</span> <span class="s2">&quot;2.0&quot;</span> <span class="ow">and</span> <span class="n">comment</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">!=</span> <span class="sa">r</span><span class="s2">&quot;#\#CIF_2.0&quot;</span><span class="p">:</span>
        <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;#\#CIF_2.0&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
    <span class="c1"># prepare all blocks</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">formatting_hints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_template</span>
        <span class="n">b</span><span class="o">.</span><span class="n">SetOutputLength</span><span class="p">(</span><span class="n">wraplength</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxoutlength</span><span class="p">)</span>
    <span class="c1"># loop over top-level</span>
    <span class="c1"># monitor output</span>
    <span class="n">all_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>   <span class="c1">#i.e. lower case</span>
    <span class="k">if</span> <span class="n">blockorder</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">blockorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_input_order</span>
    <span class="n">top_block_names</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">blockorder</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">blockref</span><span class="p">,</span><span class="n">blockname</span> <span class="ow">in</span> <span class="n">top_block_names</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">%s</span><span class="s1">, &#39;</span> <span class="o">%</span> <span class="n">blockname</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]))</span>
        <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;data_&#39;</span> <span class="o">+</span><span class="n">blockname</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">all_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">blockref</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">==</span> <span class="s1">&#39;Dic&#39;</span><span class="p">:</span>              <span class="c1">#put contents before save frames</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]</span><span class="o">.</span><span class="n">printsection</span><span class="p">(</span><span class="n">finish_at</span><span class="o">=</span><span class="s1">&#39;_dictionary_valid.application&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">==</span> <span class="s1">&#39;STAR2&#39;</span><span class="p">:</span>  <span class="c1">#nested save frames</span>
            <span class="n">child_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_immediate_children</span><span class="p">(</span><span class="n">blockref</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">child_ref</span><span class="p">,</span><span class="n">child_info</span> <span class="ow">in</span> <span class="n">child_refs</span><span class="p">:</span>
                <span class="n">child_name</span> <span class="o">=</span> <span class="n">child_info</span><span class="o">.</span><span class="n">block_id</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="n">child_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">block_to_string_nested</span><span class="p">(</span><span class="n">child_ref</span><span class="p">,</span><span class="n">child_name</span><span class="p">,</span><span class="n">outstring</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span><span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span><span class="s1">&#39;1.1&#39;</span><span class="p">,</span><span class="s1">&#39;2.0&#39;</span><span class="p">):</span>                   <span class="c1">#non-nested save frames</span>
            <span class="n">child_refs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">blockorder</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_child_of_parent</span><span class="p">(</span><span class="n">blockref</span><span class="p">,</span><span class="n">a</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">child_ref</span> <span class="ow">in</span> <span class="n">child_refs</span><span class="p">:</span>
                <span class="n">child_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_table</span><span class="p">[</span><span class="n">child_ref</span><span class="p">]</span><span class="o">.</span><span class="n">block_id</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="n">child_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">child_ref</span><span class="p">]))</span>
                <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;save_&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">all_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">child_ref</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StarError</span><span class="p">(</span><span class="s1">&#39;Grammar </span><span class="si">%s</span><span class="s1"> is not recognised for output&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard</span> <span class="o">!=</span> <span class="s1">&#39;Dic&#39;</span><span class="p">:</span>              <span class="c1">#put contents after save frames</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outstring</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">blockref</span><span class="p">]</span><span class="o">.</span><span class="n">printsection</span><span class="p">(</span><span class="n">start_from</span><span class="o">=</span><span class="s1">&#39;_dictionary_valid.application&#39;</span><span class="p">))</span>
    <span class="n">returnstring</span> <span class="o">=</span>  <span class="n">outstring</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="n">outstring</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;WARNING: following blocks not output: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">all_names</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;All blocks output.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">returnstring</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>
      
      <div class="item">
      <p id="CifFile.CifFile_module.ValidationResult" class="name">class <span class="ident">ValidationResult</span></p>
      
  
    <div class="desc"><p>Represents validation result. It is initialised with</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-CifFile.CifFile_module.ValidationResult', this);">Show source &equiv;</a></p>
  <div id="source-CifFile.CifFile_module.ValidationResult" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ValidationResult</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents validation result. It is initialised with &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;results is return value of validate function&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_matches</span> <span class="o">=</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">use_html</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return string with human-readable description of validation result&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">validate_report</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_matches</span><span class="p">),</span><span class="n">use_html</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">block_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True for valid CIF file, otherwise False&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">block_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">block_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">block_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">block_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_result</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">block_name</span> <span class="ow">in</span> <span class="n">block_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_result</span><span class="p">[</span><span class="n">block_name</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="bp">True</span><span class="p">,{}):</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">valid</span>

    <span class="k">def</span> <span class="nf">has_no_match_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">block_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return true if some items are not found in dictionary&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">block_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">block_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">block_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">block_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_matches</span><span class="o">.</span><span class="n">iter_keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">block_name</span> <span class="ow">in</span> <span class="n">block_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_matches</span><span class="p">[</span><span class="n">block_name</span><span class="p">]:</span>
                <span class="n">has_no_match_items</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">has_no_match_items</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">has_no_match_items</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#CifFile.CifFile_module.ValidationResult">ValidationResult</a></li>
          </ul>
      </div>
      </div>

  </section>

    </article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Documentation generated by
      <a href="https://github.com/BurntSushi/pdoc">pdoc 0.3.2</a>
    </p>

    <p>pdoc is in the public domain with the
      <a href="http://unlicense.org">UNLICENSE</a></p>

    <p>Design by <a href="http://nadh.in">Kailash Nadh</a></p>
  </footer>
</div>
</body>
</html>
